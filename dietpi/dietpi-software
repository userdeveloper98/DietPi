#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Software
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - filename /DietPi/dietpi/dietpi-software
	# - Installs "ready to run" software with optimizations unique to the device.
	# - Runs dietpi-update during 1st run setup.
	# - Generates and uses /DietPi/dietpi/.installed (software list) # -1=selected for uninstall, 0=not installed, 1=selected for install, 2=installed
	#
	# Usage:
	# - dietpi-software
	# - /DietPi/dietpi/dietpi-software install		iUNIQUEID (OR) sINDEX_{SSHSERVER,FILESERVER,LOGGING,WEBSERVER}_TARGET=-int
	# - /DietPi/dietpi/dietpi-software reinstall		#Same as installed, however, only reinstalls if state =2. Does not uninstall due to package removal danger (eg: xserver removes kodi), simply flags to be installed (=1).
	# - /DietPi/dietpi/dietpi-software uninstall		iUNIQUEID
	# - /DietPi/dietpi/dietpi-software list			#Lists UNIQUEIDs for software.
	#////////////////////////////////////

	#Import DietPi-Globals ---------------------------------------------------------------
	. /DietPi/dietpi/func/dietpi-globals
	G_PROGRAM_NAME='DietPi-Software'
	G_CHECK_ROOT_USER
	G_CHECK_ROOTFS_RW
	G_INIT
	#Import DietPi-Globals ---------------------------------------------------------------

	# Custom exit trap
	G_EXIT_CUSTOM(){

		unset aSOFTWARE_CATEGORIES_DIETPI
		unset aSOFTWARE_CATEGORIES_LINUX

		unset aSOFTWARE_CATEGORY_INDEX
		unset aSOFTWARE_TYPE
		unset aSOFTWARE_WHIP_NAME
		unset aSOFTWARE_WHIP_DESC
		unset aSOFTWARE_ONLINEDOC_URL
		unset aSOFTWARE_INSTALL_STATE

		unset aSOFTWARE_REQUIRES_USERINPUT

		unset aSOFTWARE_REQUIRES_ALSA
		unset aSOFTWARE_REQUIRES_XSERVERXORG
		unset aSOFTWARE_REQUIRES_MYSQL
		unset aSOFTWARE_REQUIRES_SQLITE
		unset aSOFTWARE_REQUIRES_WEBSERVER
		unset aSOFTWARE_REQUIRES_PHP
		unset aSOFTWARE_REQUIRES_DESKTOP
		unset aSOFTWARE_REQUIRES_GIT
		unset aSOFTWARE_REQUIRES_BUILDESSENTIAL
		unset aSOFTWARE_REQUIRES_RSYSLOG
		unset aSOFTWARE_REQUIRES_FFMPEG
		unset aSOFTWARE_REQUIRES_JAVA_JRE_JDK
		unset aSOFTWARE_REQUIRES_NODEJS

		unset aSOFTWARE_AVAIL_G_HW_MODEL
		unset aSOFTWARE_AVAIL_G_HW_ARCH
		unset aSOFTWARE_AVAIL_G_DISTRO

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	#Filepath
	#/////////////////////////////////////////////////////////////////////////////////////
	FP_INSTALLED_FILE='/DietPi/dietpi/.installed'
	FP_INSTALLED_FILE_TEMP='.installed'

	#Used to set user/personal data directories (eg: usbdrive)
	FP_DIETPI_DEDICATED_USBDRIVE=''

	#Default user content folders used in DietPi.
	FOLDER_MUSIC='Music'
	FOLDER_PICTURES='Pictures'
	FOLDER_VIDEO='Video'
	FOLDER_DOWNLOADS='downloads'

	Write_InstallFileList(){

		local write_software_in_pending_state=0

		local fp_target=$FP_INSTALLED_FILE
		if [[ $1 == 'temp' ]]; then

			fp_target=$FP_INSTALLED_FILE_TEMP
			write_software_in_pending_state=1

		fi

		> $fp_target

		#Save installed states
		for i in ${!aSOFTWARE_INSTALL_STATE[@]}
		do

			# - Never save pending state for software (=1). Excluding temp saves.
			if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 && ! $write_software_in_pending_state )); then

				echo "aSOFTWARE_INSTALL_STATE[$i]=0" >> $fp_target

			else

				echo "aSOFTWARE_INSTALL_STATE[$i]=${aSOFTWARE_INSTALL_STATE[$i]}" >> $fp_target

			fi

		done

		#Misc
		cat << _EOF_ >> $fp_target

#DietPi Choice System: SSH Server
INDEX_SSHSERVER_CURRENT=$INDEX_SSHSERVER_CURRENT
INDEX_SSHSERVER_TARGET=$INDEX_SSHSERVER_TARGET

#DietPi Choice System: File Server
INDEX_FILESERVER_CURRENT=$INDEX_FILESERVER_CURRENT
INDEX_FILESERVER_TARGET=$INDEX_FILESERVER_TARGET

#DietPi Choice System: Logging
INDEX_LOGGING_CURRENT=$INDEX_LOGGING_CURRENT
INDEX_LOGGING_TARGET=$INDEX_LOGGING_TARGET

#DietPi Preference System: Webserver base
INDEX_WEBSERVER_CURRENT=$INDEX_WEBSERVER_CURRENT
INDEX_WEBSERVER_TARGET=$INDEX_WEBSERVER_TARGET
_EOF_

	}

	Read_InstallFileList(){

		#Load Software states
		G_DIETPI-NOTIFY -2 'Reading database'

		local fp_target=$FP_INSTALLED_FILE
		[[ $1 == 'temp' ]] && fp_target=$FP_INSTALLED_FILE_TEMP

		#Load
		[[ -f $fp_target ]] && . $fp_target

		#Always reset choice system during first run to defaults: https://github.com/Fourdee/DietPi/issues/1122
		if (( $G_DIETPI_INSTALL_STAGE == 0 )); then

			INDEX_SSHSERVER_CURRENT=-1
			INDEX_SSHSERVER_TARGET=-1

			INDEX_FILESERVER_CURRENT=0
			INDEX_FILESERVER_TARGET=0

			INDEX_LOGGING_CURRENT=-1
			INDEX_LOGGING_TARGET=-1

			INDEX_WEBSERVER_CURRENT=-2
			INDEX_WEBSERVER_TARGET=-2

		fi

		G_DIETPI-NOTIFY 0 'Reading database'

	}

	Reset_Timesync(){ killall -w /DietPi/dietpi/func/run_ntpd &> /dev/null; }

	Check_Internet_and_NTPD(){

		# Internet
		# - Use /etc/apt/sources.list for connection test
		local internet_url_test="$(grep -m1 '^[[:blank:]]*deb ' /etc/apt/sources.list | awk '{print $2}')"
		optional_cmd_inputs='--no-check-certificate' G_CHECK_URL "$internet_url_test" # Will exit on failure here then prompt user to configure network

		# Timesync
		until /DietPi/dietpi/func/run_ntpd
		do

			# - Ask
			if (( $G_USER_INPUTS )); then

				G_WHIP_MENU_ARRAY=(

					'Retry' ': (Recommended) Rerun network time sync'
					'NTP mirror' ': Change the NTP mirror used'
					'NTP mode' ': Change the NTP mode (eg: daemon + drift)'
					'Override' ': (NOT RECOMMENDED) Ignore failure and override time sync status'

				)

				G_WHIP_MENU 'Network time sync has not yet completed, or, failed to update.\nTo prevent issues with outdated system time during installations, please select an option below.\n
NB: We highly recommend choosing "Retry" first. Failing that, "NTP mirror" then "NTP mode".\n"Override" is a last resort and may cause follow-up issues due to incorrect system clock time.'
				if (( ! $? )); then

					if [[ $G_WHIP_RETURNED_VALUE == 'Retry' ]]; then

						Reset_Timesync

					elif [[ $G_WHIP_RETURNED_VALUE == 'NTP mirror' ]]; then

						G_WHIP_MSG 'DietPi-Config will now be launched, on the next screen:\n - Select "NTP Mirror"\n - Select a different NTP mirror\n\nOnce completed, exit dietpi-config to resume setup'
						/DietPi/dietpi/dietpi-config 16 1

					elif [[ $G_WHIP_RETURNED_VALUE == 'NTP mode' ]]; then

						G_WHIP_MSG 'DietPi-Config will now be launched, on the next screen:\n - Select "Time sync mode"\n - Select a different time sync mode (eg: Daemon + Drift)\n\nOnce completed, exit dietpi-config to resume setup'
						/DietPi/dietpi/dietpi-config 3 1

					elif [[ $G_WHIP_RETURNED_VALUE == 'Override' ]]; then

						Reset_Timesync
						echo 0 > /DietPi/dietpi/.timesync_exit_status
						echo 1 > /var/lib/dietpi/.ntpd_override

					fi

				fi

			# - Endless retry
			else

				Reset_Timesync

			fi

		done

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Installation System
	#/////////////////////////////////////////////////////////////////////////////////////
	#Reboot after installation has finished.
	DISABLE_REBOOT=0

	#uninstall flag, used in software installations + removals, runs Uninstall_Software()
	UNINSTALL_REQUIRED=0

	#Global Password for software installs
	GLOBAL_PW=''
	Update_Global_Pw(){

		GLOBAL_PW=''
		# - Encrypted
		if [[ -r '/var/lib/dietpi/dietpi-software/.GLOBAL_PW.bin' ]]; then

			GLOBAL_PW="$(cat /var/lib/dietpi/dietpi-software/.GLOBAL_PW.bin | openssl enc -base64 -d -aes-256-cbc -nosalt -pass pass:'DietPiRocks!')"

		# - 1st run automated setup only
		else

			GLOBAL_PW="$(grep -m1 '^[[:blank:]]*AUTO_SETUP_GLOBAL_PASSWORD=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')"

		fi

		# - Failsafe
		if [[ -z $GLOBAL_PW ]]; then

			GLOBAL_PW='dietpi'
			G_DIETPI-NOTIFY 1 "Unable to obtain GLOBAL_PW from dietpi.txt (1st run automation only), and, /var/lib/dietpi/dietpi-software/.GLOBAL_PW.bin\n\nThe following fallback GLOBAL_PW will be used:\n - $GLOBAL_PW"

		fi

	}

	#Total system RAM (used to calculate percentage based value for software cache levels, eg: opcache/apcu max sizes)
	RAM_TOTAL=$(free -m | grep -m1 'Mem:' | awk '{print $2}')

	#Run Installation Flag (1 = run installs)
	GOSTARTINSTALL=0

	# Install variables
	INSTALL_URL_ADDRESS=''
	UNINSTALL_URL_ADDRESS=''
	DEPS_LIST=''

	#Special installation Vars
	USER_EMONHUB_APIKEY_COMPLETED=0
	USER_EMONHUB_APIKEY_CURRENT=0
	WIFIHOTSPOT_RTL8188C_DEVICE=0
	USER_LINUX_AUTOINSTALL_PROMPT_DISPLAYED=0

	#PHP5/7 specific directories, apt package-, module- and command names
	# - and Distro specific MariaDB service name
	FP_PHP_BASE_DIR='/etc/php/7.0'
	PHP_APT_PACKAGE_NAME='php'
	PHP_BINARY='php'
	MARIADB_SERVICE='mariadb'
	if (( $G_DISTRO < 4 )); then

		FP_PHP_BASE_DIR='/etc/php5'
		PHP_APT_PACKAGE_NAME='php5'
		PHP_BINARY='php5'
		MARIADB_SERVICE='mysql'

	elif (( $G_DISTRO > 4 )); then

		FP_PHP_BASE_DIR='/etc/php/7.3'
		PHP_APT_PACKAGE_NAME='php7.3'

	fi

	USBDRIVE=0

	#Choices Made?
	INSTALL_SOFTWARE_CHOICESMADE=0

	#DietPi Choice System: SSH Server
	#NB: Update Read_InstallFileList with defaults
	INSTALL_SSHSERVER_CHOICESMADE=0
	INDEX_SSHSERVER_CURRENT=-1
	INDEX_SSHSERVER_TARGET=-1

	#DietPi Choice System: Fileserver
	#NB: Update Read_InstallFileList with defaults
	INSTALL_FILESERVER_CHOICESMADE=0
	INDEX_FILESERVER_CURRENT=0
	INDEX_FILESERVER_TARGET=0

	#DietPi Choice System: Logging
	#NB: Update Read_InstallFileList with defaults
	INSTALL_LOGGING_CHOICESMADE=0
	INDEX_LOGGING_CURRENT=-1
	INDEX_LOGGING_TARGET=-1

	#DietPi Preference System: Webserver base
	#NB: Update Read_InstallFileList with defaults
	INDEX_WEBSERVER_CURRENT=-2
	INDEX_WEBSERVER_TARGET=-2

	FP_ONLINEDOC_URL='https://dietpi.com/phpbb/viewtopic.php?'

	# - Available for
	MAX_G_HW_MODEL=71	#This needs to match highest G_HW_MODEL value in dietpi-obtain_hw_model
	MAX_G_HW_ARCH=10	#This needs to match highest G_HW_ARCH value in dietpi-obtain_hw_model
	MAX_G_DISTRO=5		#This needs to match highest G_DISTRO value in dietpi-obtain_hw_model
	#	2D array (well, bash style)
	declare -A aSOFTWARE_AVAIL_G_HW_MODEL
	declare -A aSOFTWARE_AVAIL_G_HW_ARCH
	declare -A aSOFTWARE_AVAIL_G_DISTRO

	#/////////////////////////////////////////////////////////////////////////////////////
	# This function generates the array for all the software available for installation.
	#
	# Reference:
	# - Adding new software to DietPi-Software:
	#   https://github.com/Fourdee/DietPi/issues/490#issuecomment-244416570
	#
	# Adding software to the install list:
	# ------------------------------------
	# - software_id:
	#   This is the next number in the sequence. Each software install has a unique number,
	#   so it can be referenced in all arrays. This has to be the same for install, uninstall
	#   and setting up the service. Run "dietpi-software list | grep '<software_id>'" to
	#   get the next number in the sequence. Ensure that you are running a testing build, as
	#   release may be behind the testing branch and available software packages.
	#
	# - aSOFTWARE_WHIP_NAME[$software_id]:
	#   This is the name to display in the UI.
	#
	# - aSOFTWARE_WHIP_DESC[$software_id]:
	#   This is the description to place next to the name in the UI.
	#
	# - aSOFTWARE_CATEGORY_INDEX[$software_id]:
	#   If you are adding a new piece of software, first choose the category it belongs to
	#   (see aSOFTWARE_CATEGORIES_DIETPI and aSOFTWARE_CATEGORIES_LINUX below), which will
	#   give you the aSOFTWARE_CATEGORY_INDEX to set. In the example below this is 0.
	#
	# - aSOFTWARE_TYPE[$software_id]:
	#   If this is aSOFTWARE_CATEGORIES_DIETPI then aSOFTWARE_TYPE=0, if it is
	#   aSOFTWARE_CATEGORIES_LINUX then it is 1. In the example it is 0.
	#
	# - aSOFTWARE_ONLINEDOC_URL[$software_id]:
	#   This is appended to FP_ONLINEDOC_URL to make a URL for help on this software.
	#
	# Specifying other software as dependencies:
	#   If your software needs other software to be available, look under the 'Requires software
	#   to be installed' heading and then add that to the section you create. In the example
	#   below ALSA and XSERVERXORG are needed. The system will check their presence
	#   and install as needed.
	#
	# Dealing with Hardware types:
	#   If you have hardware requirements, like must not/only be installed on a Pi, then you need
	#   to add something like below. Look for other examples in the existing software
	#   installations. Full list of models can be found in 'dietpi-obtain_hw_model'.
	#
	#	# - Disable for All non-RPi
	#	for ((i=10; i<=$MAX_G_HW_MODEL; i++))
	#	do
	#		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0
	#	done
	#
	# Example:
	#  #------------------ Desktops: LXDE ------------------
	#  software_id=23
	# 		       aSOFTWARE_WHIP_NAME[$software_id]='LXDE'
	#	           aSOFTWARE_WHIP_DESC[$software_id]='ultra lightweight desktop'
	#         aSOFTWARE_CATEGORY_INDEX[$software_id]=0
	#			        aSOFTWARE_TYPE[$software_id]=0
	#	       aSOFTWARE_REQUIRES_ALSA[$software_id]=1
  	#   aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1
	#	       aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p42'
	#
	#/////////////////////////////////////////////////////////////////////////////////////
	Software_Arrays_Init(){

		G_DIETPI-NOTIFY -2 'Initializing database'

		#--------------------------------------------------------------------------------
		#Categories
		#NB: Unique IDs, do not re-arrange or re-order.
		#--------------------------------------------------------------------------------
		#DietPi software
		aSOFTWARE_CATEGORIES_DIETPI=(

			'●─ Desktops ' #0
			'●─ Remote Desktop Access ' #1
			'●─ Media Systems ' #2
			'●─ BitTorrent / Download Tools ' #3
			'●─ Cloud / Backups ' #4
			'●─ Emulation & Gaming ' #5
			'●─ Social / Search ' #6
			'●─ Camera / Surveillance ' #7
			'●─ WiFi Hotspot ' #8
			'●─ System Stats / Management ' #9
			'●─ Remote Access ' #10
			'●─ Hardware Projects ' #11
			'●─ System Security ' #12
			'●─ Webserver Stacks ' #13
			'●─ Pi-hole ' #14
			'●─ File Servers ' #15
			'●─ VPN Servers ' #16
			'●─ Advanced Networking ' #17
			'●─ Home Automation ' #18
			'●─ Printing ' #19
			'●─ Computational Science ' #20

		)

		#Linux software
		aSOFTWARE_CATEGORIES_LINUX=(

			'●─ SSH Clients ' #0
			'●─ Fileserver Clients ' #1
			'●─ File Managers ' #2
			'●─ System ' #3
			'●─ Shared Libraries ' #4
			'●─ Networking / Tools ' #5
			'●─ Development / Programming ' #6
			'●─ Text Editors ' #7
			'●─ Desktop Utilities ' #8

		)

		#--------------------------------------------------------------------------------
		#DietPi software items
		#--------------------------------------------------------------------------------
		#Before adding, please check 'dietpi-software list | grep null' to list NULL (available) IDs for use.

		#Assign UNIQUE ID to each item
		local software_id=0

		#Desktops
		#--------------------------------------------------------------------------------
		software_id=23

			aSOFTWARE_WHIP_NAME[$software_id]='LXDE'
			aSOFTWARE_WHIP_DESC[$software_id]='ultra lightweight desktop'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
			aSOFTWARE_TYPE[$software_id]=0
			aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1
			aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p42'

		#------------------
		software_id=24

			aSOFTWARE_WHIP_NAME[$software_id]='MATE'
			aSOFTWARE_WHIP_DESC[$software_id]='desktop enviroment'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
			aSOFTWARE_TYPE[$software_id]=0
			aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1
			aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=60#p2073'

		#------------------
		software_id=25

				 aSOFTWARE_WHIP_NAME[$software_id]='XFCE'
				 aSOFTWARE_WHIP_DESC[$software_id]='lightweight desktop environment'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=70#p2203'

		#------------------
		software_id=26

				 aSOFTWARE_WHIP_NAME[$software_id]='GNUStep'
				 aSOFTWARE_WHIP_DESC[$software_id]='lightweight based on OpenStep'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=60#p2072'

		#------------------
		software_id=113

				 aSOFTWARE_WHIP_NAME[$software_id]='Chromium'
				 aSOFTWARE_WHIP_DESC[$software_id]='web browser for desktop or autostart'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=3011#p3011'

		# - ARMv6
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,1]=0

		# - VM
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,20]=0

		#Remote Desktops
		#--------------------------------------------------------------------------------
		software_id=27

				 aSOFTWARE_WHIP_NAME[$software_id]='TightVNC Server'
				 aSOFTWARE_WHIP_DESC[$software_id]='desktop for remote connection'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=1
					  aSOFTWARE_TYPE[$software_id]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=30#p408'

		# - ARMv8
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0

		# - Stretch+: replaced by tigervnc (vnc4)
		for ((i=4; i<=$MAX_G_DISTRO; i++))
		do

			aSOFTWARE_AVAIL_G_DISTRO[$software_id,$i]=0

		done

		#------------------
		software_id=28

				 aSOFTWARE_WHIP_NAME[$software_id]='VNC4 Server'
				 aSOFTWARE_WHIP_DESC[$software_id]='desktop for remote connection'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=1
					  aSOFTWARE_TYPE[$software_id]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=30#p408'

		#------------------
		software_id=29

				 aSOFTWARE_WHIP_NAME[$software_id]='XRDP'
				 aSOFTWARE_WHIP_DESC[$software_id]='remote desktop protocol (rdp) server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=1
					  aSOFTWARE_TYPE[$software_id]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=70#p2074'

		#------------------
		software_id=30

				 aSOFTWARE_WHIP_NAME[$software_id]='NoMachine'
				 aSOFTWARE_WHIP_DESC[$software_id]='multi-platform server and client access'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=1
					  aSOFTWARE_TYPE[$software_id]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=60#p2071'

		# - ARMv8
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0

		#------------------
		software_id=120

				 aSOFTWARE_WHIP_NAME[$software_id]='RealVNC Server'
				 aSOFTWARE_WHIP_DESC[$software_id]='desktop for remote connection'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=1
					  aSOFTWARE_TYPE[$software_id]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=4149#p4149'

		# - License RPi only
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#Media Systems
		#--------------------------------------------------------------------------------
		software_id=31

				 aSOFTWARE_WHIP_NAME[$software_id]='Kodi'
				 aSOFTWARE_WHIP_DESC[$software_id]='the media centre for linux'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p43'

		# - Only RPi + Odroid
		for ((i=20; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		# - Re-enable Native PC
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,21]=1

		# + ASUS TB
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,52]=1

		# + NanoPC T4
		# aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,68]=1

		#------------------
		software_id=32

				 aSOFTWARE_WHIP_NAME[$software_id]='YMPD'
				 aSOFTWARE_WHIP_DESC[$software_id]='lightweight web interface music player for mpd'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p50'

		#------------------
		software_id=148

				 aSOFTWARE_WHIP_NAME[$software_id]='myMPD'
				 aSOFTWARE_WHIP_DESC[$software_id]='fork of ympd with improved features'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=13978#p13978'

		#------------------
		software_id=119

				 aSOFTWARE_WHIP_NAME[$software_id]='CAVA'
				 aSOFTWARE_WHIP_DESC[$software_id]='optional: console audio vis for mpd'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=3928#p3928'

		#------------------
		software_id=33

				 aSOFTWARE_WHIP_NAME[$software_id]='AirSonic'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
	   aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$software_id]=1
		   aSOFTWARE_REQUIRES_FFMPEG[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=11280#p11280'

		#------------------
		software_id=34

				 aSOFTWARE_WHIP_NAME[$software_id]='SubSonic 6'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
		   aSOFTWARE_REQUIRES_FFMPEG[$software_id]=1
	   aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=30#p213'

		#------------------
		software_id=35

				 aSOFTWARE_WHIP_NAME[$software_id]='SqueezeBox'
				 aSOFTWARE_WHIP_DESC[$software_id]='logitech media server (lms)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1009#p1009'

		#------------------
		software_id=36

				 aSOFTWARE_WHIP_NAME[$software_id]='SqueezeLite'
				 aSOFTWARE_WHIP_DESC[$software_id]='audio player for lms & squeezebox'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1009#p1009'

		#------------------
		software_id=37

				 aSOFTWARE_WHIP_NAME[$software_id]='Shairport Sync'
				 aSOFTWARE_WHIP_DESC[$software_id]='airplay audio player with multiroom sync'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1221#p1221'

		#------------------
		software_id=39

				 aSOFTWARE_WHIP_NAME[$software_id]='ReadyMedia'
				 aSOFTWARE_WHIP_DESC[$software_id]='(MiniDLNA) media streaming server (dlna, upnp)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p49'

		#------------------
		software_id=40

				 aSOFTWARE_WHIP_NAME[$software_id]='Ampache'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			  aSOFTWARE_REQUIRES_GIT[$software_id]=1
		   aSOFTWARE_REQUIRES_FFMPEG[$software_id]=1
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=40#p554'

		#------------------
		software_id=41

				 aSOFTWARE_WHIP_NAME[$software_id]='Emby Server'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1789#p1789'

		# - Disable for ARM6: https://github.com/Fourdee/DietPi/issues/534#issuecomment-416405968
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,1]=0

		#------------------
		software_id=42

				 aSOFTWARE_WHIP_NAME[$software_id]='Plex Media Server'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1949#p1949'

		# - Disable for ARMv6: https://github.com/Fourdee/DietPi/issues/648
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,1]=0

		#------------------
		software_id=43

				 aSOFTWARE_WHIP_NAME[$software_id]='Murmur'
				 aSOFTWARE_WHIP_DESC[$software_id]='mumble voip server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1691#p1691'

		#------------------
		software_id=118

				 aSOFTWARE_WHIP_NAME[$software_id]='Mopidy'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface music & radio player'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=80#p3611'
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1

		#------------------
		software_id=121

				 aSOFTWARE_WHIP_NAME[$software_id]='Roon Bridge'
				 aSOFTWARE_WHIP_DESC[$software_id]='Turns device into Roon capable audio player'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=80#p4153'
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1

		# - Disable for ARMv6
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,1]=0

		#------------------
		software_id=124

				 aSOFTWARE_WHIP_NAME[$software_id]='NAA daemon'
				 aSOFTWARE_WHIP_DESC[$software_id]='signalyst network audio adaptor (naa)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=90#p4294'
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1

		#------------------
		software_id=128

				 aSOFTWARE_WHIP_NAME[$software_id]='MPD'
				 aSOFTWARE_WHIP_DESC[$software_id]='music player daemon'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]=''

		#------------------
		software_id=129

				 aSOFTWARE_WHIP_NAME[$software_id]='O!MPD'
				 aSOFTWARE_WHIP_DESC[$software_id]='feature-rich, web interface audio player for mpd'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=5171#p5171'
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
 			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1

		# - VM
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,20]=0

		#------------------
		software_id=135

				 aSOFTWARE_WHIP_NAME[$software_id]='IceCast'
				 aSOFTWARE_WHIP_DESC[$software_id]='Shoutcast streaming server (+DarkIce)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=6526#p6526'

		# - VM
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,20]=0

		#------------------
		software_id=141

				 aSOFTWARE_WHIP_NAME[$software_id]='Spotify Connect Web'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface for spotify premium'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=7013#p7013'
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1

		# - Currently ARMv7+ only, so disable all archs, then re-enable armv7+
		for ((i=1; i<=$MAX_G_HW_ARCH; i++))
		do

			aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,$i]=0

		done
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,2]=1

		#------------------
		software_id=143

				 aSOFTWARE_WHIP_NAME[$software_id]='Koel'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface audio streamer'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=7305#p7305'
		aSOFTWARE_REQUIRES_PHP[$software_id]=1
 			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
		   aSOFTWARE_REQUIRES_NODEJS[$software_id]=1
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
		   aSOFTWARE_REQUIRES_FFMPEG[$software_id]=1
		# Currently user prompt asks for admin user credentials:
		aSOFTWARE_REQUIRES_USERINPUT[$software_id]=1

		#------------------
		software_id=146

				 aSOFTWARE_WHIP_NAME[$software_id]='Tautulli'
				 aSOFTWARE_WHIP_DESC[$software_id]='monitoring and tracking tool for Plex'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=7463#p7463'
 			  aSOFTWARE_REQUIRES_GIT[$software_id]=1

		#------------------
		software_id=154

				 aSOFTWARE_WHIP_NAME[$software_id]='Roon Server'
				 aSOFTWARE_WHIP_DESC[$software_id]='Roon capable audio player and core'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=7966#p7966'
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
		   aSOFTWARE_REQUIRES_FFMPEG[$software_id]=1

		# - x86_64 only
		for ((i=1; i<=$MAX_G_HW_ARCH; i++))
		do

			aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,$i]=0

		done
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,10]=1

		#------------------
		software_id=159

				 aSOFTWARE_WHIP_NAME[$software_id]='Allo'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]=''
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
 			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1

		#------------------
		software_id=160

				 aSOFTWARE_WHIP_NAME[$software_id]='Allo_update'
				 aSOFTWARE_WHIP_DESC[$software_id]='quick reinstall/update web only'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]=''

		#------------------
		software_id=163

				 aSOFTWARE_WHIP_NAME[$software_id]='Gmediarender'
				 aSOFTWARE_WHIP_DESC[$software_id]='DLNA audio render/endpoint'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=9012#p9012'

		#------------------
		software_id=167

				 aSOFTWARE_WHIP_NAME[$software_id]='Raspotify'
				 aSOFTWARE_WHIP_DESC[$software_id]='spotify connect client'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=9368#p9368'

		# Disable for ARMv8 + x86_64:
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,10]=0

		#------------------
		software_id=80

				 aSOFTWARE_WHIP_NAME[$software_id]='Ubooquity'
				 aSOFTWARE_WHIP_DESC[$software_id]='a free home server for your comics and ebooks library'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
	 aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=12969#p12969'

		#------------------
		software_id=86

				 aSOFTWARE_WHIP_NAME[$software_id]='Roon Extension Manager'
				 aSOFTWARE_WHIP_DESC[$software_id]='Manage extensions from within Roon'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=0
			  aSOFTWARE_REQUIRES_GIT[$software_id]=1
		   aSOFTWARE_REQUIRES_NODEJS[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=13160#p13160'

		#BitTorrent
		#--------------------------------------------------------------------------------
		software_id=44

				 aSOFTWARE_WHIP_NAME[$software_id]='Transmission'
				 aSOFTWARE_WHIP_DESC[$software_id]='bittorrent server with web interface (c)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p46'

		#------------------
		software_id=45

				 aSOFTWARE_WHIP_NAME[$software_id]='Deluge'
				 aSOFTWARE_WHIP_DESC[$software_id]='bittorrent server with web interface (python)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p61'

		#------------------
		software_id=46

				 aSOFTWARE_WHIP_NAME[$software_id]='qBitTorrent'
				 aSOFTWARE_WHIP_DESC[$software_id]='bittorrent server with web interface (c++)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=70#p2272'

		#------------------
		software_id=107

				 aSOFTWARE_WHIP_NAME[$software_id]='rTorrent'
				 aSOFTWARE_WHIP_DESC[$software_id]='bittorrent server with rutorrent web interface'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=2603#p2603'

		#------------------
		software_id=116

				 aSOFTWARE_WHIP_NAME[$software_id]='SiCKRAGE'
				 aSOFTWARE_WHIP_DESC[$software_id]='automatically download TV shows'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=-1
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=3327#p3327'

		#------------------
		software_id=132

				 aSOFTWARE_WHIP_NAME[$software_id]='Aria2'
				 aSOFTWARE_WHIP_DESC[$software_id]='download manager with web interface'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=6177#p6177'
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
		   aSOFTWARE_REQUIRES_SQLITE[$software_id]=1

		#------------------
		software_id=139

				 aSOFTWARE_WHIP_NAME[$software_id]='SABnzbd'
				 aSOFTWARE_WHIP_DESC[$software_id]='nzb download manager'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=6747#p6747'
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1

		#------------------
		software_id=142

				 aSOFTWARE_WHIP_NAME[$software_id]='CouchPotato'
				 aSOFTWARE_WHIP_DESC[$software_id]='automatically download movies'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=6747#p6747'
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
			  aSOFTWARE_REQUIRES_GIT[$software_id]=1

		#------------------
		software_id=144

				 aSOFTWARE_WHIP_NAME[$software_id]='Sonarr'
				 aSOFTWARE_WHIP_DESC[$software_id]='automatically download TV shows'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=7455#p7455'
		   aSOFTWARE_REQUIRES_SQLITE[$software_id]=1

		#------------------
		software_id=145

				 aSOFTWARE_WHIP_NAME[$software_id]='Radarr'
				 aSOFTWARE_WHIP_DESC[$software_id]='automatically download movies'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=7457#p7457'
		   aSOFTWARE_REQUIRES_SQLITE[$software_id]=1

		#------------------
		software_id=106

				 aSOFTWARE_WHIP_NAME[$software_id]='Lidarr'
				 aSOFTWARE_WHIP_DESC[$software_id]='automatically download music'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=13580#p13580'
		   aSOFTWARE_REQUIRES_SQLITE[$software_id]=1

		#------------------
		software_id=147

				 aSOFTWARE_WHIP_NAME[$software_id]='Jackett'
				 aSOFTWARE_WHIP_DESC[$software_id]='api Support for your torrent trackers.'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=7503#p7503'

		#------------------
		software_id=149

				 aSOFTWARE_WHIP_NAME[$software_id]='NZBget'
				 aSOFTWARE_WHIP_DESC[$software_id]='nzb download manager'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=7575#p7575'

		#------------------ BitTorrent: HTPC Manager ------------------
		software_id=155

				 aSOFTWARE_WHIP_NAME[$software_id]='HTPC Manager'
				 aSOFTWARE_WHIP_DESC[$software_id]='manage your HTPC from anywhere'
			  aSOFTWARE_REQUIRES_GIT[$software_id]=1
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=8043#p8043'

		#Cloud / Backups
		#--------------------------------------------------------------------------------
		software_id=47

				 aSOFTWARE_WHIP_NAME[$software_id]='ownCloud'
				 aSOFTWARE_WHIP_DESC[$software_id]='your very own cloud (eg: dropbox)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p47'

		#------------------
		software_id=114

				 aSOFTWARE_WHIP_NAME[$software_id]='Nextcloud'
				 aSOFTWARE_WHIP_DESC[$software_id]='A safe home for all your data'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=3026#p3026'

		#------------------
		software_id=168

				 aSOFTWARE_WHIP_NAME[$software_id]='Nextcloud Talk'
				 aSOFTWARE_WHIP_DESC[$software_id]='Video calls with configured TURN server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0
		#Currently requires manual domain and TURN server port input.
		# - To resolve: Default port 5349 could be used, but reliable method to get external domain/static IP is required.
		aSOFTWARE_REQUIRES_USERINPUT[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=15227#p15227'

		#------------------
		software_id=48

				 aSOFTWARE_WHIP_NAME[$software_id]='Pydio'
				 aSOFTWARE_WHIP_DESC[$software_id]='feature-rich backup and sync server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1064#p1064'

		#------------------
		software_id=111

				 aSOFTWARE_WHIP_NAME[$software_id]='UrBackup server'
				 aSOFTWARE_WHIP_DESC[$software_id]='full system backup server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=65#p65'

		# No deb packages for ARMv6:
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,1]=0

		#------------------
		software_id=49

				 aSOFTWARE_WHIP_NAME[$software_id]='Gogs'
				 aSOFTWARE_WHIP_DESC[$software_id]='personal github server with web interface'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0
			  aSOFTWARE_REQUIRES_GIT[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=70#p2187'

		# - ARMv8
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0

		#------------------
		software_id=50

				 aSOFTWARE_WHIP_NAME[$software_id]='Syncthing'
				 aSOFTWARE_WHIP_DESC[$software_id]='backup and sync server with web interface'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=70#p2363'

		#------------------
		software_id=134

				 aSOFTWARE_WHIP_NAME[$software_id]='Tonido'
				 aSOFTWARE_WHIP_DESC[$software_id]='lightweight cloud based backup system'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=6476#p6476'

		# - ARMv6
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,1]=0

		# - ARMv8
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0

		#------------------
		software_id=158
				 aSOFTWARE_WHIP_NAME[$software_id]='Minio'
				 aSOFTWARE_WHIP_DESC[$software_id]='S3 compatible distributed object server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0

		#------------------
 		software_id=161
 				 aSOFTWARE_WHIP_NAME[$software_id]='FuguHub'
 				 aSOFTWARE_WHIP_DESC[$software_id]='Lightweight WebDAV cloud (eg: dropbox) with a CMS'
 			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=0

		 # - ARMv8
 		 aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0

		 #------------------
		 software_id=165

					aSOFTWARE_WHIP_NAME[$software_id]='Gitea'
					aSOFTWARE_WHIP_DESC[$software_id]='Git with a cup of tea'
			 aSOFTWARE_CATEGORY_INDEX[$software_id]=4
						 aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_GIT[$software_id]=1
			 aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=9863#p9863'


		#Emulation / Gaming
		#--------------------------------------------------------------------------------
		software_id=108

				 aSOFTWARE_WHIP_NAME[$software_id]='AmiBerry'
				 aSOFTWARE_WHIP_DESC[$software_id]='amiga emulator'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=64#p64'
	  aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,52]=1 # ASUS TB

		# - XU4 test
		#aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,11]=1 #Requires Stretch due to libc requirements

		#------------------
		software_id=51

				 aSOFTWARE_WHIP_NAME[$software_id]='OpenTyrian'
				 aSOFTWARE_WHIP_DESC[$software_id]='a classic retro game, addictive'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p45'

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=112

				 aSOFTWARE_WHIP_NAME[$software_id]='DXX-Rebirth'
				 aSOFTWARE_WHIP_DESC[$software_id]='Descent 1/2'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=2963#p2963'

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=52

				 aSOFTWARE_WHIP_NAME[$software_id]='Cuberite'
				 aSOFTWARE_WHIP_DESC[$software_id]='minecraft server with web interface (c++)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=60#p2068'

		# - ARMv8
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0

		#------------------
		software_id=53

				 aSOFTWARE_WHIP_NAME[$software_id]='MineOS'
				 aSOFTWARE_WHIP_DESC[$software_id]='minecraft servers with web interface (java)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
			  aSOFTWARE_REQUIRES_GIT[$software_id]=1
	   aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$software_id]=1
		   aSOFTWARE_REQUIRES_NODEJS[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=60#p2069'

		#------------------
		software_id=156

				 aSOFTWARE_WHIP_NAME[$software_id]='Steam'
				 aSOFTWARE_WHIP_DESC[$software_id]='client'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=8016#p8016'
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1
		  aSOFTWARE_REQUIRES_DESKTOP[$software_id]=1

		#Native PC only
		for ((i=0; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,21]=1

		#------------------
		software_id=164
				 aSOFTWARE_WHIP_NAME[$software_id]='Nukkit'
				 aSOFTWARE_WHIP_DESC[$software_id]='A nuclear-powered server for Minecraft Pocket Edition'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=0
	   aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=10675#p10675'

		#Social Media
		#--------------------------------------------------------------------------------
		software_id=54

				 aSOFTWARE_WHIP_NAME[$software_id]='Forums'
				 aSOFTWARE_WHIP_DESC[$software_id]='phpbb forums'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=6
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=5#p51'

		#------------------
		software_id=55

				 aSOFTWARE_WHIP_NAME[$software_id]='Wordpress'
				 aSOFTWARE_WHIP_DESC[$software_id]='website blog and publishing platform'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=6
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=30#p395'

		#------------------
		software_id=38

				 aSOFTWARE_WHIP_NAME[$software_id]='FreshRSS'
				 aSOFTWARE_WHIP_DESC[$software_id]='self-hosted RSS feed aggregator'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=6
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=130#p13918'

		#------------------
		software_id=56

				 aSOFTWARE_WHIP_NAME[$software_id]='Image Gallery'
				 aSOFTWARE_WHIP_DESC[$software_id]='website to host / browse your images'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=6
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=40#p480'

		#------------------
		software_id=57

				 aSOFTWARE_WHIP_NAME[$software_id]='BaiKal'
				 aSOFTWARE_WHIP_DESC[$software_id]='lightweight caldav + carddav server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=6
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=50#p1502'

		#------------------
		software_id=58

				 aSOFTWARE_WHIP_NAME[$software_id]='OpenBazaar'
				 aSOFTWARE_WHIP_DESC[$software_id]='decentralized peer to peer bitcoin market'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=6
					  aSOFTWARE_TYPE[$software_id]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
			  aSOFTWARE_REQUIRES_GIT[$software_id]=1
		  aSOFTWARE_REQUIRES_USERINPUT[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1796#p1796'

		#------------------
		software_id=133

				 aSOFTWARE_WHIP_NAME[$software_id]='YaCy'
				 aSOFTWARE_WHIP_DESC[$software_id]='decentralized open source search engine'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=6
					  aSOFTWARE_TYPE[$software_id]=0
	   aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=6202#p6202'

		#------------------
		software_id=2

		aSOFTWARE_WHIP_NAME[$software_id]='Folding@Home'
		aSOFTWARE_WHIP_DESC[$software_id]='distributed disease research project'
		aSOFTWARE_CATEGORY_INDEX[$software_id]=20
		aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=13704#p13704'
		# - x86_64 only
		for ((i=1; i<$MAX_G_HW_ARCH; i++))
		do

			aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,$i]=0

		done
		# - Not supported on Jessie: https://github.com/Fourdee/DietPi/pull/1992#issuecomment-410772255
		aSOFTWARE_AVAIL_G_DISTRO[$software_id,3]=0

		#------------------

		#Camera
		#--------------------------------------------------------------------------------
		software_id=59

				 aSOFTWARE_WHIP_NAME[$software_id]='RPi Cam Control'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface & controls for your rpi camera'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=7
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p48'

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=136

				 aSOFTWARE_WHIP_NAME[$software_id]='MotionEye'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface & surveillance for your camera'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=7
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=6610#p6610'
 		   aSOFTWARE_REQUIRES_FFMPEG[$software_id]=1
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1

		# - Disable for Jessie
		if (( $G_DISTRO == 3 )); then

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$G_HW_MODEL]=0

		fi

		#------------------

		#WiFi Hotspot
		#--------------------------------------------------------------------------------
		software_id=60

				 aSOFTWARE_WHIP_NAME[$software_id]='WiFi Hotspot'
				 aSOFTWARE_WHIP_DESC[$software_id]='turn your device into a wifi hotspot'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=8
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1207#p1207'

		# - VM
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,20]=0

		#------------------
		software_id=61

				 aSOFTWARE_WHIP_NAME[$software_id]='Tor Hotspot'
				 aSOFTWARE_WHIP_DESC[$software_id]='optional: route hotspot traffic through tor'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=8
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1529#p1529'

		# - VM
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,20]=0

		#------------------

		#System stats
		#--------------------------------------------------------------------------------
		software_id=62

				 aSOFTWARE_WHIP_NAME[$software_id]='DietPi-Cloudshell'
				 aSOFTWARE_WHIP_DESC[$software_id]='system stats displayed on lcd/panel'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=9
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=20#p204'

		#------------------
		software_id=63

				 aSOFTWARE_WHIP_NAME[$software_id]='LinuxDash'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface system stats'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=9
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=20#p108'

		#------------------
		software_id=64

				 aSOFTWARE_WHIP_NAME[$software_id]='PhpSysInfo'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface system stats'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=9
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=30#p451'

		#------------------
		software_id=65

				 aSOFTWARE_WHIP_NAME[$software_id]='NetData'
				 aSOFTWARE_WHIP_DESC[$software_id]='real-time performance monitoring'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=9
					  aSOFTWARE_TYPE[$software_id]=0
		   aSOFTWARE_REQUIRES_NODEJS[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=60#p1611'

		#------------------
		software_id=66

				 aSOFTWARE_WHIP_NAME[$software_id]='RPi-Monitor'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface system stats'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=9
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=50#p1503'

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=115

				 aSOFTWARE_WHIP_NAME[$software_id]='Webmin'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface system management'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=9
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=80#p3047'
		  aSOFTWARE_REQUIRES_RSYSLOG[$software_id]=1

		#------------------
		software_id=162

				 aSOFTWARE_WHIP_NAME[$software_id]='Docker'
				 aSOFTWARE_WHIP_DESC[$software_id]='Build, ship, and run distributed applications'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=9
					  aSOFTWARE_TYPE[$software_id]=0


		#Remote Access
		#--------------------------------------------------------------------------------
		software_id=67

				 aSOFTWARE_WHIP_NAME[$software_id]='NoIp'
				 aSOFTWARE_WHIP_DESC[$software_id]='url website address for your device'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=10
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p58'

		#------------------
		software_id=68

				 aSOFTWARE_WHIP_NAME[$software_id]='Remot3.it'
				 aSOFTWARE_WHIP_DESC[$software_id]='(Weaved) access your device over the internet'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=10
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=20#p188'

		# - Currently ARMv6/7 only
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,10]=0

		#------------------
		software_id=138

				 aSOFTWARE_WHIP_NAME[$software_id]='VirtualHere'
				 aSOFTWARE_WHIP_DESC[$software_id]='server: share USB devices over the network'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=10
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=6709#p6709'

		#------------------

		#Hardware projects
		#--------------------------------------------------------------------------------
		software_id=69

				 aSOFTWARE_WHIP_NAME[$software_id]='RPi.GPIO'
				 aSOFTWARE_WHIP_DESC[$software_id]='gpio interface library for rpi (python)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=40#p1065'

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=70

				 aSOFTWARE_WHIP_NAME[$software_id]='WiringPi'
				 aSOFTWARE_WHIP_DESC[$software_id]='gpio interface library (c)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1066#p1066'

		# - RPi / Odroids
		for ((i=20; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#+ BPi Pro
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,51]=1

		#------------------
		software_id=71

				 aSOFTWARE_WHIP_NAME[$software_id]='WebIOPi'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface to control rpi.gpio'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=20#p189'

		# - Disable for All non-RPi and RPi3
		for ((i=3; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=72

				 aSOFTWARE_WHIP_NAME[$software_id]='I2c'
				 aSOFTWARE_WHIP_DESC[$software_id]='enables support for i2c based hardware'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=100

				 aSOFTWARE_WHIP_NAME[$software_id]='PiJuice'
				 aSOFTWARE_WHIP_DESC[$software_id]='pisupply ups'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=10740#p10740'

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=122

				 aSOFTWARE_WHIP_NAME[$software_id]='Node-Red'
				 aSOFTWARE_WHIP_DESC[$software_id]='tool for wiring devices, APIs and online services'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
		   aSOFTWARE_REQUIRES_NODEJS[$software_id]=1
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=80#p4292'

		#------------------
		software_id=123

				 aSOFTWARE_WHIP_NAME[$software_id]='Mosquitto '
				 aSOFTWARE_WHIP_DESC[$software_id]='MQTT messaging broker'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=90#p4293'

		#------------------
		software_id=131

				 aSOFTWARE_WHIP_NAME[$software_id]='Blynk Server'
				 aSOFTWARE_WHIP_DESC[$software_id]='msg controller for blynk mobile app and sbcs'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=5901#p5901'
	   aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$software_id]=1
		   aSOFTWARE_REQUIRES_NODEJS[$software_id]=1
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1

		#------------------
		software_id=166

				 aSOFTWARE_WHIP_NAME[$software_id]='PI-SPC'
				 aSOFTWARE_WHIP_DESC[$software_id]='audiophonics pi-spc power control module'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=9359#p9359'

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=169

				 aSOFTWARE_WHIP_NAME[$software_id]='Google AIY'
				 aSOFTWARE_WHIP_DESC[$software_id]='voice kit'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_REQUIRES_ALSA[$software_id]=1
 			  aSOFTWARE_REQUIRES_GIT[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=9486#p9486'

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=74

				 aSOFTWARE_WHIP_NAME[$software_id]='InfluxDB'
				 aSOFTWARE_WHIP_DESC[$software_id]='time-series database'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=120#p12523'

		#------------------
		software_id=77

				 aSOFTWARE_WHIP_NAME[$software_id]='Grafana'
				 aSOFTWARE_WHIP_DESC[$software_id]='platform for analytics and monitoring'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=11
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=12524#p12524'


		#System security
		#--------------------------------------------------------------------------------
		software_id=73

				 aSOFTWARE_WHIP_NAME[$software_id]='Fail2Ban'
				 aSOFTWARE_WHIP_DESC[$software_id]='prevents brute-force attacks with ip ban'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=12
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=30#p452'
		#------------------

		#Webserver stacks
		#--------------------------------------------------------------------------------
		software_id=75

				 aSOFTWARE_WHIP_NAME[$software_id]='LASP'
				 aSOFTWARE_WHIP_DESC[$software_id]='apache2  | sqlite  | php'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p52'

		#------------------
		software_id=76

				 aSOFTWARE_WHIP_NAME[$software_id]='LAMP'
				 aSOFTWARE_WHIP_DESC[$software_id]='apache2  | mariadb | php'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p52'

		#------------------
		software_id=78

				 aSOFTWARE_WHIP_NAME[$software_id]='LESP'
				 aSOFTWARE_WHIP_DESC[$software_id]='nginx    | sqlite  | php'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p5'

		#------------------
		software_id=79

				 aSOFTWARE_WHIP_NAME[$software_id]='LEMP'
				 aSOFTWARE_WHIP_DESC[$software_id]='nginx    | mariadb | php'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p5'

		#------------------
		software_id=81

				 aSOFTWARE_WHIP_NAME[$software_id]='LLSP'
				 aSOFTWARE_WHIP_DESC[$software_id]='lighttpd | sqlite  | php'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1335#p1335'

		#------------------
		software_id=82

				 aSOFTWARE_WHIP_NAME[$software_id]='LLMP'
				 aSOFTWARE_WHIP_DESC[$software_id]='lighttpd | mariadb | php'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1335#p1335'

		#------------------
		software_id=83

				 aSOFTWARE_WHIP_NAME[$software_id]='Apache2'
				 aSOFTWARE_WHIP_DESC[$software_id]='webserver'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=-1
			aSOFTWARE_REQUIRES_PHP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p52'

		#------------------
		software_id=84

				 aSOFTWARE_WHIP_NAME[$software_id]='Lighttpd'
				 aSOFTWARE_WHIP_DESC[$software_id]='webserver'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=-1
			aSOFTWARE_REQUIRES_PHP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1335#p1335'

		#------------------
		software_id=85

				 aSOFTWARE_WHIP_NAME[$software_id]='Nginx'
				 aSOFTWARE_WHIP_DESC[$software_id]='webserver'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=-1
			aSOFTWARE_REQUIRES_PHP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5#p5'

		#------------------
		software_id=87

				 aSOFTWARE_WHIP_NAME[$software_id]='SQlite'
				 aSOFTWARE_WHIP_DESC[$software_id]='database'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1335#p1335'

		#------------------
		software_id=88

				 aSOFTWARE_WHIP_NAME[$software_id]='MariaDB'
				 aSOFTWARE_WHIP_DESC[$software_id]='database'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1335#p1335'

		#------------------
		software_id=89

				 aSOFTWARE_WHIP_NAME[$software_id]='PHP'
				 aSOFTWARE_WHIP_DESC[$software_id]='webserver'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1335#p1335'

		#------------------
		software_id=90

				 aSOFTWARE_WHIP_NAME[$software_id]='phpMyAdmin'
				 aSOFTWARE_WHIP_DESC[$software_id]='optional mysql admin tools'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			aSOFTWARE_REQUIRES_MYSQL[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p54'

		#------------------
		software_id=91

				 aSOFTWARE_WHIP_NAME[$software_id]='Redis'
				 aSOFTWARE_WHIP_DESC[$software_id]='optional non-sql database store'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0

		#------------------
		software_id=92

				 aSOFTWARE_WHIP_NAME[$software_id]='CertBot'
				 aSOFTWARE_WHIP_DESC[$software_id]='free, ssl cert install allowing https://'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1061#p1062'

		#------------------
		software_id=125

				 aSOFTWARE_WHIP_NAME[$software_id]='Tomcat8'
				 aSOFTWARE_WHIP_DESC[$software_id]='apache tomcat server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=13
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=4316#p4316'
	 aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$software_id]=1

		#PiHole
		#--------------------------------------------------------------------------------
		software_id=93

				 aSOFTWARE_WHIP_NAME[$software_id]='Pi-hole'
				 aSOFTWARE_WHIP_DESC[$software_id]='block adverts for any device on your network'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=14
					  aSOFTWARE_TYPE[$software_id]=0
			  aSOFTWARE_REQUIRES_GIT[$software_id]=1
		aSOFTWARE_REQUIRES_WEBSERVER[$software_id]=1
			  aSOFTWARE_REQUIRES_PHP[$software_id]=1
		   aSOFTWARE_REQUIRES_SQLITE[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=20#p174'
		aSOFTWARE_REQUIRES_USERINPUT[$software_id]=1

		#File servers
		#--------------------------------------------------------------------------------
		software_id=94

				 aSOFTWARE_WHIP_NAME[$software_id]='ProFTP'
				 aSOFTWARE_WHIP_DESC[$software_id]='lightweight ftp server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=15
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p55'

		#------------------
		software_id=95

				 aSOFTWARE_WHIP_NAME[$software_id]='vsFTPD'
				 aSOFTWARE_WHIP_DESC[$software_id]='alternative ftp server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=15
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='?f=8&t=5&p=2820#p2820'

		#------------------
		software_id=96

				 aSOFTWARE_WHIP_NAME[$software_id]='Samba'
				 aSOFTWARE_WHIP_DESC[$software_id]='feature-rich file server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=15
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p56'

		#------------------
		software_id=109

				 aSOFTWARE_WHIP_NAME[$software_id]='NFS'
				 aSOFTWARE_WHIP_DESC[$software_id]='network file system server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=15
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p56'

		#------------------

		#VPN servers
		#--------------------------------------------------------------------------------
		software_id=97

				 aSOFTWARE_WHIP_NAME[$software_id]='OpenVPN'
				 aSOFTWARE_WHIP_DESC[$software_id]='vpn server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=16
					  aSOFTWARE_TYPE[$software_id]=0
		  aSOFTWARE_REQUIRES_RSYSLOG[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=613#p613'

		#------------------
		software_id=117

				 aSOFTWARE_WHIP_NAME[$software_id]='PiVPN'
				 aSOFTWARE_WHIP_DESC[$software_id]='openvpn installer & management tool'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=16
					  aSOFTWARE_TYPE[$software_id]=0
		  aSOFTWARE_REQUIRES_RSYSLOG[$software_id]=1
			  aSOFTWARE_REQUIRES_GIT[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='https://dietpi.com/phpbb/viewtopic.php?f=8&t=5&p=3469#p3469'
		aSOFTWARE_REQUIRES_USERINPUT[$software_id]=1

		#------------------


		#Advanced Networking
		#--------------------------------------------------------------------------------
		software_id=98

				 aSOFTWARE_WHIP_NAME[$software_id]='HaProxy'
				 aSOFTWARE_WHIP_DESC[$software_id]='high performance tcp/http load balancer'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=17
					  aSOFTWARE_TYPE[$software_id]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=30#p221'

		#Home automation
		#--------------------------------------------------------------------------------
		software_id=99

				 aSOFTWARE_WHIP_NAME[$software_id]='EmonPi'
				 aSOFTWARE_WHIP_DESC[$software_id]='energy usage addon board with web interface'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=18
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=1529#p1525'

		# - Disable for All non-RPi
		for ((i=10; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done

		#------------------
		software_id=157

				 aSOFTWARE_WHIP_NAME[$software_id]='Home Assistant'
				 aSOFTWARE_WHIP_DESC[$software_id]='open-source home automation platform'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=18
					  aSOFTWARE_TYPE[$software_id]=0
		      aSOFTWARE_REQUIRES_GIT[$software_id]=1
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
		   aSOFTWARE_REQUIRES_SQLITE[$software_id]=1
		   aSOFTWARE_REQUIRES_FFMPEG[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=20#p70'

		#------------------

		#Printing
		#--------------------------------------------------------------------------------
		software_id=137

				 aSOFTWARE_WHIP_NAME[$software_id]='CloudPrint'
				 aSOFTWARE_WHIP_DESC[$software_id]='print server for google cloud print'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=19
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=6630#p6630'
 		  aSOFTWARE_REQUIRES_RSYSLOG[$software_id]=1 #Not required, but comes in as package dep

		#Disabled for ARMv8 on Jessie only: https://github.com/Fourdee/DietPi/issues/855#issuecomment-292712002
		(( $G_DISTRO == 3 )) && aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0

		#------------------
		software_id=153

				 aSOFTWARE_WHIP_NAME[$software_id]='OctoPrint'
				 aSOFTWARE_WHIP_DESC[$software_id]='web interface for controlling 3d printers'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=19
					  aSOFTWARE_TYPE[$software_id]=0
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&p=7958#p7958'
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$software_id]=1
   			  aSOFTWARE_REQUIRES_GIT[$software_id]=1 # Required for updates

		#--------------------------------------------------------------------------------
		#Additional linux software items
		#--------------------------------------------------------------------------------

		#SSH clients
		#--------------------------------------------------------------------------------
		software_id=0

				 aSOFTWARE_WHIP_NAME[$software_id]='OpenSSH Client'
				 aSOFTWARE_WHIP_DESC[$software_id]=''
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------

		#File server clients
		#--------------------------------------------------------------------------------
		software_id=1

				 aSOFTWARE_WHIP_NAME[$software_id]='Samba Client'
				 aSOFTWARE_WHIP_DESC[$software_id]='access network shares'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=1
					  aSOFTWARE_TYPE[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]=' dietpi-config > Network Options: NAS/Misc'
		#------------------
		software_id=110

				 aSOFTWARE_WHIP_NAME[$software_id]='NFS Client'
				 aSOFTWARE_WHIP_DESC[$software_id]='network file system client'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=1
					  aSOFTWARE_TYPE[$software_id]=1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]=' dietpi-config > Network Options: NAS/Misc'
		#------------------

		#File managers
		#--------------------------------------------------------------------------------
		software_id=3

				 aSOFTWARE_WHIP_NAME[$software_id]='MC'
				 aSOFTWARE_WHIP_DESC[$software_id]='midnight commander, powerful file manager'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=4

				 aSOFTWARE_WHIP_NAME[$software_id]='ViFM'
				 aSOFTWARE_WHIP_DESC[$software_id]='file manager with vi bindings'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=2
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------

		#System
		#--------------------------------------------------------------------------------
		software_id=5

				 aSOFTWARE_WHIP_NAME[$software_id]='ALSA'
				 aSOFTWARE_WHIP_DESC[$software_id]='linux sound system'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=6

				 aSOFTWARE_WHIP_NAME[$software_id]='Xserver'
				 aSOFTWARE_WHIP_DESC[$software_id]='linux display system'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=1

		#------------------
		software_id=151

				 aSOFTWARE_WHIP_NAME[$software_id]='Nvidia'
				 aSOFTWARE_WHIP_DESC[$software_id]='display driver'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=3
					  aSOFTWARE_TYPE[$software_id]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1

		# NativePC only
		for ((i=0; i<=$MAX_G_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,$i]=0

		done
		aSOFTWARE_AVAIL_G_HW_MODEL[$software_id,21]=1

		#Shared Libs
		#--------------------------------------------------------------------------------
		software_id=7

				 aSOFTWARE_WHIP_NAME[$software_id]='FFmpeg'
				 aSOFTWARE_WHIP_DESC[$software_id]='audio & visual libary'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=8

				 aSOFTWARE_WHIP_NAME[$software_id]='Java'
				 aSOFTWARE_WHIP_DESC[$software_id]='OpenJDK 8 + JRE libary'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=9

				 aSOFTWARE_WHIP_NAME[$software_id]='Node.js'
				 aSOFTWARE_WHIP_DESC[$software_id]='javascript runtime'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=130

				 aSOFTWARE_WHIP_NAME[$software_id]='Python Pip'
				 aSOFTWARE_WHIP_DESC[$software_id]='python pip package installer'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=140

				 aSOFTWARE_WHIP_NAME[$software_id]='SDL2'
				 aSOFTWARE_WHIP_DESC[$software_id]='simple direct layer 2'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=1
	   SOFTWARE_REQUIRES_XSERVERXORG[$software_id]=1

		# Disable for ARMv8
		aSOFTWARE_AVAIL_G_HW_ARCH[$software_id,3]=0

		#------------------
		software_id=150

				 aSOFTWARE_WHIP_NAME[$software_id]='Mono'
				 aSOFTWARE_WHIP_DESC[$software_id]='runtime libraries and repo'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=1


		#------------------
		software_id=126

				 aSOFTWARE_WHIP_NAME[$software_id]='LibSSL1.0.0'
				 aSOFTWARE_WHIP_DESC[$software_id]='backwards compatibility (stretch)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=4
					  aSOFTWARE_TYPE[$software_id]=1

		#Networking
		#--------------------------------------------------------------------------------
		software_id=10

				 aSOFTWARE_WHIP_NAME[$software_id]='iftop'
				 aSOFTWARE_WHIP_DESC[$software_id]='displays bandwidth usage information'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=11

				 aSOFTWARE_WHIP_NAME[$software_id]='IPTraf'
				 aSOFTWARE_WHIP_DESC[$software_id]='interactive colorful ip lan monitor'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=12

				 aSOFTWARE_WHIP_NAME[$software_id]='Iperf'
				 aSOFTWARE_WHIP_DESC[$software_id]='internet protocol bandwidth measuring tool'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=13

				 aSOFTWARE_WHIP_NAME[$software_id]='MTR-Tiny'
				 aSOFTWARE_WHIP_DESC[$software_id]='full screen ncurses traceroute tool'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=14

				 aSOFTWARE_WHIP_NAME[$software_id]='nLoad'
				 aSOFTWARE_WHIP_DESC[$software_id]='realtime console network usage monitor'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=15

				 aSOFTWARE_WHIP_NAME[$software_id]='tcpdump'
				 aSOFTWARE_WHIP_DESC[$software_id]='command-line network traffic analyzer'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=152

				 aSOFTWARE_WHIP_NAME[$software_id]='Avahi-Daemon'
				 aSOFTWARE_WHIP_DESC[$software_id]='hostname broadcast (mac, pc bonjour)'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=5
					  aSOFTWARE_TYPE[$software_id]=1


		#Development / Programming
		#--------------------------------------------------------------------------------
		software_id=16

				 aSOFTWARE_WHIP_NAME[$software_id]='Build-Essentials'
				 aSOFTWARE_WHIP_DESC[$software_id]='common packages for compile'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=6
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=17

				 aSOFTWARE_WHIP_NAME[$software_id]='Git Client'
				 aSOFTWARE_WHIP_DESC[$software_id]='git clone etc'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=6
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------

		#Text Editors
		#--------------------------------------------------------------------------------
		software_id=18

				 aSOFTWARE_WHIP_NAME[$software_id]='Emacs'
				 aSOFTWARE_WHIP_DESC[$software_id]='gnu emacs editor'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=7
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=19

				 aSOFTWARE_WHIP_NAME[$software_id]='Jed'
				 aSOFTWARE_WHIP_DESC[$software_id]='editor for programmers'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=7
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=20

				 aSOFTWARE_WHIP_NAME[$software_id]='Vim'
				 aSOFTWARE_WHIP_DESC[$software_id]='vi enhanced text editor'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=7
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=21

				 aSOFTWARE_WHIP_NAME[$software_id]='Vim-Tiny'
				 aSOFTWARE_WHIP_DESC[$software_id]='compact release of vim'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=7
					  aSOFTWARE_TYPE[$software_id]=1
		#------------------
		software_id=127

				 aSOFTWARE_WHIP_NAME[$software_id]='NeoVim'
				 aSOFTWARE_WHIP_DESC[$software_id]='heavily refactored vim fork'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=7
					  aSOFTWARE_TYPE[$software_id]=1

		# - Stretch only
		for ((i=3; i<=$MAX_G_DISTRO; i++))
		do

			aSOFTWARE_AVAIL_G_DISTRO[$software_id,$G_DISTRO]=0

		done
		aSOFTWARE_AVAIL_G_DISTRO[$software_id,4]=1

		#------------------

		#Desktop Utilities
		#--------------------------------------------------------------------------------
		software_id=22

				 aSOFTWARE_WHIP_NAME[$software_id]='QuiteRSS'
				 aSOFTWARE_WHIP_DESC[$software_id]='cross-platform, free rss reader'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=8
					  aSOFTWARE_TYPE[$software_id]=1
		  aSOFTWARE_REQUIRES_DESKTOP[$software_id]=1

		#------------------

		#--------------------------------------------------------------------------------
		#Logging (hidden)
		#--------------------------------------------------------------------------------
		software_id=101

				 aSOFTWARE_WHIP_NAME[$software_id]='Log Rotate'
				 aSOFTWARE_WHIP_DESC[$software_id]='rotates log files'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=20#p68'
		#------------------
		software_id=102

				 aSOFTWARE_WHIP_NAME[$software_id]='Rsyslog'
				 aSOFTWARE_WHIP_DESC[$software_id]='system logging'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=20#p68'
		#------------------
		software_id=103

				 aSOFTWARE_WHIP_NAME[$software_id]='DietPi-RAMlog'
				 aSOFTWARE_WHIP_DESC[$software_id]='minimal, optimized logging'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=20#p68'
		#------------------

		#--------------------------------------------------------------------------------
		#SSH servers (hidden from install menu)
		#--------------------------------------------------------------------------------
		software_id=104

				 aSOFTWARE_WHIP_NAME[$software_id]='Dropbear'
				 aSOFTWARE_WHIP_DESC[$software_id]='lightweight ssh server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p62'
		#------------------
		software_id=105

				 aSOFTWARE_WHIP_NAME[$software_id]='OpenSSH Server'
				 aSOFTWARE_WHIP_DESC[$software_id]='feature rich ssh server'
			aSOFTWARE_CATEGORY_INDEX[$software_id]=0
					  aSOFTWARE_TYPE[$software_id]=-1
			 aSOFTWARE_ONLINEDOC_URL[$software_id]='f=8&t=5&start=10#p63'
		#------------------

		#--------------------------------------------------------------------------------
		#Init install state for defined software
		for i in ${!aSOFTWARE_WHIP_NAME[@]}
		do

			aSOFTWARE_INSTALL_STATE[$i]=0

		done
		# - By default installed on DietPi images:
		aSOFTWARE_INSTALL_STATE[103]=2 # DietPi-RAMlog
		aSOFTWARE_INSTALL_STATE[104]=2 # Dropbear
		#--------------------------------------------------------------------------------

		G_DIETPI-NOTIFY 0 'Initialized database'

	}

	#Disable software installation, if user input is required for automated installs
	Install_Disable_Requires_UserInput(){

		if (( ! $G_USER_INPUTS )); then

			for i in ${!aSOFTWARE_INSTALL_STATE[@]}
			do

				if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 && ${aSOFTWARE_REQUIRES_USERINPUT[$i]:-0} == 1 )); then

					# - Disable
					aSOFTWARE_INSTALL_STATE[$i]=0
					G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$i]}: Install requires user input and cannot be automated."
					G_DIETPI-NOTIFY 1 "${aSOFTWARE_WHIP_NAME[$i]}: Please run 'dietpi-software' to install manually."

				fi

			done

		fi

	}

	#Work out which additional software we need to install
	#	- We do reinstall =2 marked software as well, just to be sure.
	Install_Flag_Prereq_Software(){

		G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" "Checking for prerequisite software"

		local software_id=0

		#-------------------------------------------------------------------------
		#Pre-req software, for items that do not have their own array aSOFTWARE_REQUIRES_SOFTWARENAME

		#Nextcloud extensions
		#	Nextcloud Talk
		software_id=114
		if (( ${aSOFTWARE_INSTALL_STATE[168]} == 1 &&
			${aSOFTWARE_INSTALL_STATE[$software_id]} < 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#Additional software that requires VNC4server
		#	XRDP: https://github.com/Fourdee/DietPi/issues/1727
		software_id=28
		if (( $G_DISTRO >= 4 && ${aSOFTWARE_INSTALL_STATE[29]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#Additional software that requires WiringPi
		#	AudioPhonics Pi-SPC
		software_id=70
		if (( ${aSOFTWARE_INSTALL_STATE[166]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#Additional software required by Allo Web Interface
		if (( ${aSOFTWARE_INSTALL_STATE[159]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[36]=1 # Squeezelite
			aSOFTWARE_INSTALL_STATE[37]=1 # Shairport Sync

			# if (( $G_HW_MODEL == 70 )); then

				# aSOFTWARE_INSTALL_STATE[60]=1 # WiFi Hotspot

			# fi

			aSOFTWARE_INSTALL_STATE[65]=1 # Netdata
			aSOFTWARE_INSTALL_STATE[96]=1 # Samba

			aSOFTWARE_INSTALL_STATE[121]=1 # Roon Bridge
			aSOFTWARE_INSTALL_STATE[124]=1 # NAA Daemon
			#aSOFTWARE_INSTALL_STATE[128]=1 # MPD (pulled in by O!MPD)
			aSOFTWARE_INSTALL_STATE[129]=1 # O!MPD
			#aSOFTWARE_INSTALL_STATE[152]=1 # Avahi (pulled in by O!MPD)
			aSOFTWARE_INSTALL_STATE[163]=1 # Gmrender

		fi

		#Additional software required by Google AIY
		if (( ${aSOFTWARE_INSTALL_STATE[169]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[69]=1 # RPi.GPIO
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[69]} will be installed"
			#aSOFTWARE_INSTALL_STATE[130]=1 # python-pip, enabled in #Software that requires Python-Pip

		fi

		#Software that requires Avahi-Daemon
		software_id=152
		if (( ${aSOFTWARE_INSTALL_STATE[31]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[37]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[128]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[138]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[163]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1

			#aSOFTWARE_WHIP_NAME
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#Software that requires LibSSL1.0.0
		software_id=126
		if (( ${aSOFTWARE_INSTALL_STATE[37]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[60]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[97]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[134]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1

			#aSOFTWARE_WHIP_NAME
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#Software that requires Mono
		software_id=150
		if (( ${aSOFTWARE_INSTALL_STATE[106]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[144]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[145]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[147]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#Software that requires SDL2:
		software_id=140
		if (( ${aSOFTWARE_INSTALL_STATE[108]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#Software that requires Python-Pip: https://github.com/Fourdee/DietPi/issues/784
		software_id=130
		if (( ${aSOFTWARE_INSTALL_STATE[99]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[118]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[136]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[139]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[142]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[153]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[169]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#Software that requires MPD
		#	YMPD
		#	Cava
		#	OMPD
		#	myMPD
		software_id=128
		if (( ${aSOFTWARE_INSTALL_STATE[32]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[119]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[129]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[148]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#Software that requires Redis
		#	ownCloud
		#	Nextcloud
		software_id=91
		if (( ${aSOFTWARE_INSTALL_STATE[47]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[114]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[$software_id]=1
			G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

		fi

		#-------------------------------------------------------------------------
		#WEBSERVER - Manual stack install
		# - Define extra DietPi install flags for WEBSERVER_STACKS
		#LLMP
		if (( ${aSOFTWARE_INSTALL_STATE[82]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[84]=1
			aSOFTWARE_INSTALL_STATE[88]=1
			aSOFTWARE_INSTALL_STATE[89]=1

		fi

		#LLSP
		if (( ${aSOFTWARE_INSTALL_STATE[81]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[84]=1
			aSOFTWARE_INSTALL_STATE[87]=1
			aSOFTWARE_INSTALL_STATE[89]=1

		fi

		#LEMP
		if (( ${aSOFTWARE_INSTALL_STATE[79]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[85]=1
			aSOFTWARE_INSTALL_STATE[88]=1
			aSOFTWARE_INSTALL_STATE[89]=1

		fi

		#LESP
		if (( ${aSOFTWARE_INSTALL_STATE[78]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[85]=1
			aSOFTWARE_INSTALL_STATE[87]=1
			aSOFTWARE_INSTALL_STATE[89]=1

		fi

		#LAMP
		if (( ${aSOFTWARE_INSTALL_STATE[76]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[83]=1
			aSOFTWARE_INSTALL_STATE[88]=1
			aSOFTWARE_INSTALL_STATE[89]=1

		fi

		#LASP
		if (( ${aSOFTWARE_INSTALL_STATE[75]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[83]=1
			aSOFTWARE_INSTALL_STATE[87]=1
			aSOFTWARE_INSTALL_STATE[89]=1

		fi

		#-------------------------------------------------------------------------
		#Pre-req software, for items that do DO have their own array aSOFTWARE_REQUIRES_SOFTWARENAME

		for i in ${!aSOFTWARE_INSTALL_STATE[@]}
		do

			(( ${aSOFTWARE_INSTALL_STATE[$i]} != 1 )) && continue

			#WEBSERVER - Auto install via choice system
			# - Check for existing webserver base (Apache2,Nginx,Lighttpd) installation
			if (( ${aSOFTWARE_REQUIRES_WEBSERVER[$i]:=0} &&
				${aSOFTWARE_INSTALL_STATE[83]} < 1 &&
				${aSOFTWARE_INSTALL_STATE[84]} < 1 &&
				${aSOFTWARE_INSTALL_STATE[85]} < 1 )); then

				# - None found, select one for install, based on user preference
				if (( $INDEX_WEBSERVER_TARGET == 0 )); then

					#WEBSERVER_APACHE
					aSOFTWARE_INSTALL_STATE[83]=1
					G_DIETPI-NOTIFY 2 'Apache2 will be installed'

				elif (( $INDEX_WEBSERVER_TARGET == -1 )); then

					#WEBSERVER_NGINX
					aSOFTWARE_INSTALL_STATE[85]=1
					G_DIETPI-NOTIFY 2 'Nginx will be installed'

				else

					#WEBSERVER_LIGHTTPD
					aSOFTWARE_INSTALL_STATE[84]=1
					G_DIETPI-NOTIFY 2 'Lighttpd will be installed'

				fi

				# Pretent software requiring PHP, to mark it below, in case webserver ID already passed:
				aSOFTWARE_REQUIRES_PHP[$i]=1

			fi

			#WEBSERVER_PHP
			software_id=89
			if (( ${aSOFTWARE_REQUIRES_PHP[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

			fi

			#WEBSERVER_MARIADB
			software_id=88
			if (( ${aSOFTWARE_REQUIRES_MYSQL[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

			fi

			#WEBSERVER_SQLITE
			software_id=87
			if (( ${aSOFTWARE_REQUIRES_SQLITE[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 'SQlite will be installed'

			fi

			#DESKTOP
			if (( ${aSOFTWARE_REQUIRES_DESKTOP[$i]:=0} &&
				${aSOFTWARE_INSTALL_STATE[23]} < 1 &&
				${aSOFTWARE_INSTALL_STATE[24]} < 1 &&
				${aSOFTWARE_INSTALL_STATE[25]} < 1 &&
				${aSOFTWARE_INSTALL_STATE[26]} < 1)); then

				# - If no desktop is selected or installed (0), default to LXDE
				aSOFTWARE_INSTALL_STATE[23]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

				# Pretent software requiring Xserver, to mark it below, in case desktop ID already passed:
				aSOFTWARE_REQUIRES_XSERVERXORG[$i]=1

			fi

			#GIT
			software_id=17
			if (( ${aSOFTWARE_REQUIRES_GIT[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"
			fi

			#BUILDESSENTIAL
			software_id=16
			if (( ${aSOFTWARE_REQUIRES_BUILDESSENTIAL[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

			fi

			#RSYSLOG
			software_id=102
			if (( ${aSOFTWARE_REQUIRES_RSYSLOG[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

			fi
			#FFMPEG
			software_id=7
			if (( ${aSOFTWARE_REQUIRES_FFMPEG[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

			fi

			#ORACLEJAVA
			software_id=8
			if (( ${aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

			fi

			#NODEJS
			software_id=9
			if (( ${aSOFTWARE_REQUIRES_NODEJS[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

			fi

			#ALSA
			software_id=5
			if (( ${aSOFTWARE_REQUIRES_ALSA[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

			fi

			#XSERVERXORG
			software_id=6
			if (( ${aSOFTWARE_REQUIRES_XSERVERXORG[$i]:=0} && aSOFTWARE_INSTALL_STATE[$software_id] != 1 )); then

				aSOFTWARE_INSTALL_STATE[$software_id]=1
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} will be installed"

			fi

		done

		#WEBSERVER - Check for stacks and flag as installing
		#WEBSERVER_APACHE
		if (( ${aSOFTWARE_INSTALL_STATE[83]} > 0 )); then

			#SQLite
			if (( ${aSOFTWARE_INSTALL_STATE[87]} > 0 )); then

				#WEBSERVER_LASP
				aSOFTWARE_INSTALL_STATE[75]=1

			fi

			#MariaDB
			if (( ${aSOFTWARE_INSTALL_STATE[88]} > 0 )); then

				#WEBSERVER_LAMP
				aSOFTWARE_INSTALL_STATE[76]=1

			fi


		#WEBSERVER_NGINX
		elif (( ${aSOFTWARE_INSTALL_STATE[85]} > 0 )); then

			#SQLite
			if (( ${aSOFTWARE_INSTALL_STATE[87]} > 0 )); then

				#WEBSERVER_LESP
				aSOFTWARE_INSTALL_STATE[78]=1

			fi

			#MariaDB
			if (( ${aSOFTWARE_INSTALL_STATE[88]} > 0 )); then

				#WEBSERVER_LEMP
				aSOFTWARE_INSTALL_STATE[79]=1

			fi

		#WEBSERVER_LIGHTTPD
		elif (( ${aSOFTWARE_INSTALL_STATE[84]} > 0 )); then

			#SQLite
			if (( ${aSOFTWARE_INSTALL_STATE[87]} > 0 )); then

				#WEBSERVER_LLSP
				aSOFTWARE_INSTALL_STATE[81]=1

			fi

			#MariaDB
			if (( ${aSOFTWARE_INSTALL_STATE[88]} > 0 )); then

				#WEBSERVER_LLMP
				aSOFTWARE_INSTALL_STATE[82]=1

			fi


		fi

	}

	Create_Desktop_Shared_Items(){

		# - Pre-create dirs
		mkdir -p $HOME/Desktop
		mkdir -p /usr/share/applications
		mkdir -p /var/lib/dietpi/dietpi-software/installed/desktop/icons
		mkdir -p /var/lib/dietpi/dietpi-software/installed/desktop/wallpapers

		# - Copy DietPi favourite links
		G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/gtk/.gtk-bookmarks -O $HOME/.gtk-bookmarks

		# - DietPi Apps to download
		local adesktop_items=(

			'dietpi-software.desktop'
			'dietpi-drive_manager.desktop'
			'dietpi-update.desktop'
			'dietpi-config.desktop'
			'dietpi-backup.desktop'
			'dietpi-sync.desktop'
			#'dietpi-bugreport.desktop'
			'dietpi-process_tool.desktop'
			'dietpi-cleaner.desktop'
			'dietpi-cron.desktop'
			'dietpi-launcher.desktop'
			'dietpi-justboom.desktop'

			'es2_info.desktop'
			'es2_gears.desktop'
			'glx_info.desktop'
			'glx_gears.desktop'

		)

		for (( i=0; i<${#adesktop_items[@]}; i++))
		do

			G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/apps/${adesktop_items[$i]} -O /usr/share/applications/${adesktop_items[$i]}

		done

		unset adesktop_items

		# - icons
		G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/icons/dietpi-icon.png -O /var/lib/dietpi/dietpi-software/installed/desktop/icons/dietpi-icon.png
		G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/icons/grey_16x16.png -O /var/lib/dietpi/dietpi-software/installed/desktop/icons/grey_16x16.png
		G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/icons/kodi-icon.png -O /var/lib/dietpi/dietpi-software/installed/desktop/icons/kodi-icon.png
		G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/icons/justboom.png -O /var/lib/dietpi/dietpi-software/installed/desktop/icons/justboom.png

		# - Wallpapers
		G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/wallpapers/dietpi-logo_inverted_1080p.png -O /var/lib/dietpi/dietpi-software/installed/desktop/wallpapers/dietpi-logo_inverted_1080p.png
		G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/wallpapers/dietpi-logo_1080p.png -O /var/lib/dietpi/dietpi-software/installed/desktop/wallpapers/dietpi-logo_1080p.png

		G_THREAD_WAIT

		# - Desktop app symlinks
		ln -sf /usr/share/applications/htop.desktop $HOME/Desktop/htop.desktop
		ln -sf /usr/share/applications/dietpi-software.desktop $HOME/Desktop/dietpi-software.desktop
		ln -sf /usr/share/applications/dietpi-config.desktop $HOME/Desktop/dietpi-config.desktop
		ln -sf /usr/share/applications/dietpi-launcher.desktop $HOME/Desktop/dietpi-launcher.desktop

	}

	Create_UserContent_Folders(){

		mkdir -p $G_FP_DIETPI_USERDATA/$FOLDER_MUSIC
		mkdir -p $G_FP_DIETPI_USERDATA/$FOLDER_PICTURES
		mkdir -p $G_FP_DIETPI_USERDATA/$FOLDER_VIDEO
		mkdir -p $G_FP_DIETPI_USERDATA/$FOLDER_DOWNLOADS

		mkdir -p /var/www

	}

	Download_Test_Media(){

		if [[ ! -f $G_FP_DIETPI_USERDATA/$FOLDER_MUSIC/fourdee_tech.ogg ]]; then

			#Grab My test music
			wget https://dietpi.com/downloads/audio/fourdee_tech.ogg -O $G_FP_DIETPI_USERDATA/$FOLDER_MUSIC/fourdee_tech.ogg
			#wget https://dietpi.com/downloads/audio/fourdee_space.mp3 -O $G_FP_DIETPI_USERDATA/$FOLDER_MUSIC/fourdee_space.mp3

		fi

	}

	#Return optimization values for BitTorrent servers based on device and hardware capabilities.
	Optimize_BitTorrent(){

		local output=0

		local gigabit_device=1
		# - Lets hope the next RPi device is finally gigabit capable. I'll cry if it is not.
		if (( $G_HW_MODEL <= 3 || $G_HW_MODEL == 30 || $G_HW_MODEL == 32 || $G_HW_MODEL == 40 || $G_HW_MODEL == 60 || $G_HW_MODEL == 70 )); then

			gigabit_device=0

		fi

		#Cache size (MB) 1/10th of total mem
		if (( $1 == 0 )); then

			output=$(( $RAM_TOTAL / 10 ))

		#Max active downloads
		elif (( $1 == 1 )); then

			output=2

			# - Bump up for x86
			if (( $G_HW_MODEL == 20 || $G_HW_MODEL == 21 )); then

				output=3

			fi

		#Max global connections
		elif (( $1 == 2 )); then

			output=20

			# - Bump up for x86
			if (( $G_HW_MODEL == 20 || $G_HW_MODEL == 21 )); then

				output=40

			# - 1Gbit SBC's
			elif (( $gigabit_device )); then

				output=30

			# - Reduce for RPi's. This is due to the USB bus ethernet in the ARM SoC, which cripples network throughput/performance/latency.
			# - RPi v3
			elif (( $G_HW_MODEL == 3 )); then

				output=15

			# - RPi v2
			elif (( $G_HW_MODEL == 2 )); then

				output=13

			# - RPi v1 256/512
			elif (( $G_HW_MODEL <= 1 )); then

				output=7

			fi

		#Max upload slots
		elif (( $1 == 3 )); then

			output=3

			# - Bump up for x86
			if (( $G_HW_MODEL == 20 || $G_HW_MODEL == 21 )); then

				output=5

			# - 1Gbit devices
			elif (( $gigabit_device )); then

				output=4

			# - Reduce for RPi's. This is due to the USB bus ethernet in the ARM SoC, which cripples network throughput/performance/latency.
			elif (( $G_HW_MODEL <= 3 )); then

				output=2

			fi

		fi

		echo $output

	}

	#NB: This does not support installs that require user input (eg: a whiptail prompt for deb installs)
	#	Download_Install 'https://file.com/file' /etc/install_here
	#	dps_index=$software_id Download_Install 'conf_0' /etc/conf.conf
	Download_Install(){

		#no_check_url = Optional disable URL check
		local url="$1"
		local target="$2" # Extract target
		local type="${url##*.}" # grab ext from URL | compatbile with >> deb|zip|tar(.gz|.bz2)|7z
		if [[ $type == 'gz' || $type == 'bz2' ]]; then

			type='tar'

		fi

		# - DietPi-Software conf/service mode
		local dps_index=${dps_index:--1}
		if (( $dps_index >= 0 )); then

			type="$url"
			url="https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/dps_$dps_index/$type"

		fi

		local file="$software_id.$type"

		(( $no_check_url )) || G_CHECK_URL "$url"
		unset no_check_url

		cd /tmp/$G_PROGRAM_NAME

		# Download file (+thread if APT pre-reqs are to be installed)
		if [[ $DEPS_LIST ]]; then

			G_THREAD_START wget "$url" -O $file
			G_AGI $DEPS_LIST
			DEPS_LIST=''
			G_THREAD_WAIT

		else

			G_RUN_CMD wget "$url" -O $file

		fi

		# Process downloaded file
		if (( $dps_index >= 0 )); then

			# - Precreate dir
			local fp_dir="${target%/*}"
			if [[ ! -d $fp_dir ]]; then

				G_RUN_CMD mkdir -p $fp_dir

			fi

			G_RUN_CMD cp -f $file $target

		elif [[ $type == deb ]]; then

			# Allow error on first attempt, giving APT fix a change to resolve e.g. dependencies
			l_message='Installing deb package' G_USER_INPUTS=0 G_ERROR_HANDLER_INFO_ONLY=1 G_RUN_CMD dpkg -i $file
			(( $G_ERROR_HANDLER_EXITCODE_RETURN )) && G_DIETPI-NOTIFY 2 'Trying automated APT fix' && G_AGF

			#(( $G_ERROR_HANDLER_EXITCODE_RETURN )) && error?

		elif [[ $type == zip ]]; then

			[[ $target ]] && target="-d $target"
			l_message='Unzipping archive' G_RUN_CMD unzip -o $file $target

		elif [[ $type == tar ]]; then

			[[ $target ]] && mkdir -p $target && target="-C $target"
			l_message='Unpacking tarball' G_RUN_CMD tar xf $file $target

		elif [[ $type == 7z ]]; then

			[[ $target ]] && target="-o$target"
			l_message='Extracting 7zip archive' G_RUN_CMD 7za x -y $file $target

		else

			G_DIETPI-NOTIFY 1 'Download_Install: Invalid file type, needs to be one of: deb|zip|tar(.gz|.bz2)|7z'

		fi

		[[ -f $file ]] && l_message='Cleaning download directory' G_RUN_CMD rm $file

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# This function handles the installation of the selected software.
	#
	# Reference:
	# - Adding new software to DietPi-Software
	#   https://github.com/Fourdee/DietPi/issues/490#issuecomment-244416570
	#
	# Installing the software:
	# ------------------------------------
	# - software_id:
	#   This has to be the same number as software_id for the software list above.
	#
	# - INSTALL_URL_ADDRESS:
	#   This can be used to check conectivity to items you need to download later.
	#   A good example would also be a git repo.
	#
	# - Use Download_Install() (see code above) to check URL, download and install/extract
	#   deb|zip|tar(.gz|.bz2)|7z sources automatically and consistent, e.g.
	#   	Download_Install 'https://www.phpbb.com/files/release/phpBB-3.2.2.zip' /var/www
	#   will check the URL, download phpBB archive, extract it to /var/www(/phpBB3)
	#   and remove the archieve afterwards.
	#
	# Example:
	#	#------------------ Bittorrent: HTPC Manager ------------------
	#	software_id=155
	#	if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then
	#
	#		Banner_Installing
	#
	#		INSTALL_URL_ADDRESS='https://github.com/Hellowlol/HTPC-Manager.git'
	#
	#		G_CHECK_URL "$INSTALL_URL_ADDRESS"
	#
	#		#Install Python and PIP
	#		G_AGI python python-pip python-imaging
	#
	#		cd $HOME
	#		git clone --depth=1 "$INSTALL_URL_ADDRESS"
	#
	#		# - Move HTPC Manager to a 'better' location
	#		mkdir -p $G_FP_DIETPI_USERDATA/htpc-manager
	#		mv $HOME/HTPC-Manager/* $G_FP_DIETPI_USERDATA/htpc-manager/
	#		rm -R $HOME/HTPC-Manager
	#
	#	fi
	#
	#/////////////////////////////////////////////////////////////////////////////////////
	Install_Dietpi_Software(){

		#--------------------------------------------------------------
		#Install Software

		local software_id=0

		#Desktop LXDE
		software_id=23
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - For desktop entries/icons hosted on dietpi.com
			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/conf/desktop'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			G_AGI lxde upower policykit-1 firefox-esr
			#upower policykit-1. Needed for LXDE logout menu item to show shutdown/restart ...

			#RPi, revert to Debian pcmanfm install package: https://github.com/Fourdee/DietPi/issues/1558#issuecomment-390328173
			if (( $G_HW_MODEL < 10 )); then

				Download_Install 'https://dietpi.com/downloads/binaries/all/pcmanfm_1.2.5-3_armhf.deb'
				apt-mark hold pcmanfm

			fi

		fi

		#Desktop MATE
		software_id=24
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - For desktop entries/icons hosted on dietpi.com
			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/conf/desktop'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			G_AGI mate-desktop-environment-extras upower policykit-1 firefox-esr

		fi

		#Desktop GNUStep
		software_id=26
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - For desktop entries/icons hosted on dietpi.com
			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/conf/desktop'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			G_AGI x-window-system-core wmaker gnustep gnustep-devel gnustep-games libc-dbg upower policykit-1 firefox-esr

		fi

		#DESKTOP_XFCE
		software_id=25
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - For desktop entries/icons hosted on dietpi.com
			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/conf/desktop'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			G_AGI xfce4 xfce4-terminal gnome-icon-theme tango-icon-theme upower policykit-1 firefox-esr

		fi

		#XRDP
		software_id=29
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI xrdp

		fi

		#NOMACHINE
		software_id=30
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/nomachine_6.1.6_'
			#x86_64
			if (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS+='9_amd64.deb'

			#arm6 (RPi1)
			elif (( $G_HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS+='4_armv6hf.deb'

			#arm7+ (RPi 2/3)
			elif (( $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS+='4_armhf.deb'

			fi

			Download_Install "$INSTALL_URL_ADDRESS"

		fi

		#BitTorrent Transmission
		software_id=44
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI transmission-daemon

		fi

		#ProFTPd
		software_id=94
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			debconf-set-selections <<< 'proftpd-basic shared/proftpd/inetd_or_standalone select standalone'
			G_AGI proftpd-basic

		fi

		#Samba Server
		software_id=96
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI samba

		fi

		#vsFTPD
		software_id=95
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI vsftpd

		fi

		#NFS_SERVER
		software_id=109
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			local package_list='nfs-kernel-server rpcbind'

			# On Jessie, nfs-kernel-server does not depend on netbase, which is needed for NFS server to start: https://packages.debian.org/jessie/nfs-kernel-server
			(( $G_DISTRO < 4 )) && package_list+=' netbase'

			G_AGI $package_list

		fi

		#WEBSERVER_APACHE
		software_id=83
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			local package_list='apache2'
			# - Install certbot module on Stretch+, if certbot was already installed
			(( ${aSOFTWARE_INSTALL_STATE[93]} == 2 && $G_DISTRO > 3 )) && package_list+=' python-certbot-apache'
			G_AGI $package_list

		fi

		#WEBSERVER_NGINX
		software_id=85
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			local package_list='nginx-light'
			# - Install certbot module on Stretch+, if certbot was already installed
			(( ${aSOFTWARE_INSTALL_STATE[93]} == 2 && $G_DISTRO > 3 )) && package_list+=' python-certbot-nginx'
			G_AGI $package_list

		fi

		#WEBSERVER_LIGHTTPD
		software_id=84
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			# - NB: RPi | Perl required, else 'lighttpd-enable-mod fastcgi' = Can't locate Term/ReadLine.pm
			G_AGI lighttpd perl

		fi

		#WEBSERVER_MARIADB
		software_id=88
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			G_DIETPI-NOTIFY 2 'Preparing database folder'
			if [[ -d $G_FP_DIETPI_USERDATA/mysql ]]; then

				G_DIETPI-NOTIFY 2 "$G_FP_DIETPI_USERDATA/mysql exists, will migrate containing databases"

			else
				# Otherwise use possibly existent /var/lib/mysql
				# - Remove possible dead symlinks/files:
				rm $G_FP_DIETPI_USERDATA/mysql &> /dev/null
				mkdir -p $G_FP_DIETPI_USERDATA/mysql
				if [[ -d /var/lib/mysql ]]; then

					G_DIETPI-NOTIFY 2 '/var/lib/mysql exists, will migrate containing databases'
					G_RUN_CMD cp -a /var/lib/mysql/. $G_FP_DIETPI_USERDATA/mysql

				fi

			fi

			G_DIETPI-NOTIFY 2 'Removing /var/lib/mysql, if existent'
			[[ -L /var/lib/mysql && ! $(readlink /var/lib/mysql) =~ $G_FP_DIETPI_USERDATA/mysql ]] &&
				rm -R "$(readlink /var/lib/mysql)" &> /dev/null
			rm -R /var/lib/mysql &> /dev/null

			l_message="Creating symlink: /var/lib/mysql -> $G_FP_DIETPI_USERDATA/mysql" G_RUN_CMD ln -sf $G_FP_DIETPI_USERDATA/mysql /var/lib/mysql
			chown mysql:mysql -h /var/lib/mysql &> /dev/null
			chown mysql:mysql -RL /var/lib/mysql &> /dev/null

			local package_list='mariadb-server'
			# Install php-mysql module, if PHP was already installed
			if (( ${aSOFTWARE_INSTALL_STATE[89]} == 2 )); then

				if (( $G_DISTRO < 4 )); then
					# For <= Jessie, php5-mysqlnd provides the newer mysql client libraries compared to php5-mysql.
					package_list+=' php5-mysqlnd'

				else
					# For >= Stretch, php(7.X)-mysqlnd does not exist, thus php-mysql need to be installed: https://packages.debian.org/de/stretch/php-mysql
					package_list+=" $PHP_APT_PACKAGE_NAME-mysql"

				fi

			fi
			G_AGI "$package_list"

			# - Remove mysql.service as we use mariadb.service, both cannot exist: https://github.com/Fourdee/DietPi/issues/1913#issuecomment-441343798
			if [[ -f /etc/init.d/mysql ]] && (( $G_DISTRO >= 4 )); then

				G_DIETPI-NOTIFY 2 'Switching from /etc/init.d/mysql to mariadb.service'
				systemctl stop mysql
				rm /etc/init.d/mysql
				systemctl daemon-reload

			fi

		fi

		#WEBSERVER_SQLITE
		software_id=87
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			local package_list='sqlite3'
			# Install php-sqlite module, if PHP was already installed
			(( ${aSOFTWARE_INSTALL_STATE[89]} == 2 )) && package_list+=" $PHP_APT_PACKAGE_NAME-sqlite*"
			G_AGI "$package_list"

		fi

		#WEBSERVER_REDIS
		software_id=91
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			local package_list='redis-server'
			# Install php-redis module, if PHP was already installed
			(( ${aSOFTWARE_INSTALL_STATE[89]} == 2 )) && package_list+=" $PHP_APT_PACKAGE_NAME-redis"
			G_AGI $package_list

		fi

		#WEBSERVER_PHP
		software_id=89
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# Install base PHP packages/modules
			# - Apache
			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

				local package_list="libapache2-mod-$PHP_APT_PACKAGE_NAME"

			# - Lighttpd or Nginx
			elif (( ${aSOFTWARE_INSTALL_STATE[84]} >= 1 || ${aSOFTWARE_INSTALL_STATE[85]} >= 1 )); then

				local package_list="$PHP_APT_PACKAGE_NAME-fpm"

			# - No webserver, /usr/bin/php cmd usage
			else

				local package_list="$PHP_APT_PACKAGE_NAME-cli"

			fi

			# php-common modules, used by most web software
			package_list+=" $PHP_APT_PACKAGE_NAME-curl $PHP_APT_PACKAGE_NAME-gd $PHP_BINARY-apcu"

			# + Stretch extras
			(( $G_DISTRO > 3 )) && package_list+=" $PHP_APT_PACKAGE_NAME-mbstring $PHP_APT_PACKAGE_NAME-opcache $PHP_APT_PACKAGE_NAME-zip $PHP_APT_PACKAGE_NAME-xml"

			# PHP7.2/Buster dropped support for mcrypt: https://liorkaplan.wordpress.com/2017/09/10/php-7-2-is-coming-mcrypt-extension-isnt/
			(( $G_DISTRO < 5 )) && package_list+=" $PHP_APT_PACKAGE_NAME-mcrypt"

			# MySQL/MariaDB php module
			if (( ${aSOFTWARE_INSTALL_STATE[88]} >= 1 )); then

				if (( $G_DISTRO < 4 )); then
					# For <= Jessie, php5-mysqlnd provides the newer mysql client libraries compared to php5-mysql.
					package_list+=' php5-mysqlnd'

				else
					# For >= Stretch, php(7.X)-mysqlnd does not exist, thus php-mysql need to be installed: https://packages.debian.org/de/stretch/php-mysql
					package_list+=" $PHP_APT_PACKAGE_NAME-mysql"

				fi

			fi

			# SQLite php module
			(( ${aSOFTWARE_INSTALL_STATE[87]} >= 1 )) && package_list+=" $PHP_APT_PACKAGE_NAME-sqlite*" # Wildcard for version (eg:3)

			# Redis php module
			(( ${aSOFTWARE_INSTALL_STATE[91]} >= 1 )) && package_list+=" $PHP_BINARY-redis"

			G_AGI $package_list

		fi

		#WEBSERVER_MYADMINPHP
		software_id=90
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#MySQL must be running during install to allow debconf setup.
			G_RUN_CMD systemctl start $MARIADB_SERVICE

			# Set password parameters before installing
			debconf-set-selections <<< 'phpmyadmin phpmyadmin/dbconfig-install boolean true'
			debconf-set-selections <<< "phpmyadmin phpmyadmin/mysql/app-pass password $GLOBAL_PW"
			debconf-set-selections <<< "phpmyadmin phpmyadmin/app-password-confirm password $GLOBAL_PW"

			if (( ${aSOFTWARE_INSTALL_STATE[83]} == 1 )); then

				debconf-set-selections <<< 'phpmyadmin phpmyadmin/reconfigure-webserver multiselect apache2'

			elif (( ${aSOFTWARE_INSTALL_STATE[84]} == 1 )); then

				debconf-set-selections <<< 'phpmyadmin phpmyadmin/reconfigure-webserver multiselect lighttpd'
				# Workaround an APT error, when installing lighttpd and phpmyadmin in the same session: https://github.com/Fourdee/DietPi/issues/316
				G_ERROR_HANDLER_NO_FAIL=1 G_AGI phpmyadmin
				G_WHIP_MSG 'Working around Lighttpd + phpMyAdmin APT errors:\n\nYou may have seen an error during the phpMyAdmin APT installation. This occurs, when Lighttpd webserver was installed within the same session.\n
We work around this error by running APT a second time. Please do not worry and ignore any error or failure message within this install steps. After DietPi-Software finished, Lighttpd should start up and phpMyAdmin web UI should be available as expected.'

			else

				debconf-set-selections <<< 'phpmyadmin phpmyadmin/reconfigure-webserver multiselect none'

			fi

			G_AGI phpmyadmin

		fi

		#MPD
		software_id=128
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#Jessie-
			if (( $G_DISTRO < 4 )); then

				#MPD not available in Jessie Repo for ARMv8
				if (( $G_HW_ARCH == 3 )); then

					#libupnp6 for net discov with upnp/avahi
					DEPS_LIST='libupnp6 libwrap0 libmpdclient2 libao-common libao4 libasound2 libasound2-data libasyncns0 libaudiofile1 libavahi-client3 libavahi-common-data libavahi-common3 libavcodec56 libavformat56 libavresample2 libavutil54 libbinio1ldbl libcaca0 libcdio-cdda1 libcdio-paranoia1 libcdio13 libcups2 libcurl3-gnutls libdirectfb-1.2-9 libdnet libfaad2 libflac8 libfluidsynth1 libgme0 libgomp1 libgsm1 libice6 libid3tag0 libiso9660-8 libjack-jackd2-0 libjson-c2 libldb1 libmad0 libmikmod3 libmms0 libmodplug1 libmp3lame0 libmpcdec6 libmpg123-0 libnfs4 libntdb1 libogg0 libopenal-data libopenal1 libopenjpeg5 libopus0 liborc-0.4-0 libpulse0 libresid-builder0c2a libroar2 libsamplerate0 libschroedinger-1.0-0 libsdl1.2debian libshout3 libsidplay2 libsidutils0 libslp1 libsm6 libsmbclient libsndfile1 libsoxr0 libspeex1 libspeexdsp1 libsqlite3-0 libtalloc2 libtdb1 libtevent0 libtheora0 libupnp6 libva1 libvorbis0a libvorbisenc2 libvorbisfile3 libvpx1 libwavpack1 libwbclient0 libwildmidi-config libwildmidi1 libx11-6 libx11-data libx11-xcb1 libx264-142 libxau6 libxcb1 libxdmcp6 libxext6 libxi6 libxtst6 libxvidcore4 libyajl2 libzzip-0-13 mime-support python python-talloc python2.7 samba-libs x11-common file'
					Download_Install 'https://dietpi.com/downloads/binaries/all/mpd_0.19.21_arm64.deb'

				else

					G_AGI mpd

				fi

			#Stretch
			elif (( $G_DISTRO == 4 )); then

				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/mpd_0.20.21-1_'
				#armv6
				if (( $G_HW_ARCH == 1 )); then

					INSTALL_URL_ADDRESS+='armv6.deb'

				#armv7+
				elif (( $G_HW_ARCH == 2 )); then

					INSTALL_URL_ADDRESS+='armv7.deb'

				#ARMv8
				elif (( $G_HW_ARCH == 3 )); then

					INSTALL_URL_ADDRESS+='armv8.deb'

				#x86_64
				elif (( $G_HW_ARCH == 10 )); then

					INSTALL_URL_ADDRESS+='amd64.deb'

				fi

				apt-mark unhold mpd &> /dev/null #??? Not required for dpkg -i installs

				DEPS_LIST='libsqlite3-0 libupnp6 libwrap0 libmpdclient2 libflac8 libyajl2 libavahi-client3 libvorbisfile3 libwavpack1 libmad0 libmpg123-0 libopus0 libavformat57 libfaad2 libcdio-paranoia1 libiso9660-8 libshout3 libid3tag0'
				Download_Install "$INSTALL_URL_ADDRESS"

				apt-mark hold mpd # prevent repo updates from overwriting

			#Buster+
			else

				# libcdio-paranoia1 and libiso9660-8 not available, but ibcdio-paranoia2 and libiso9660-11 instead
				# Buster repo version > 0.20.18, thus stay with APT for now:
				G_AGI mpd

			fi

		fi

		#Forums PHPBB
		software_id=54
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# Skip install, if already present
			if [[ -d /var/www/phpBB3 ]]; then

				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} install dir \"/var/www/phpBB3\" already exists. Download and install steps will be skipped.
 - If you want to update ${aSOFTWARE_WHIP_NAME[$software_id]}, please follow the instructions from WebUI ACP.
 - if you need to reinstall (e.g. broken instance), please manually backup your config files+data, remove the install dir and rerun \"dietpi-software (re)install $software_id\"."

			else

				Download_Install 'https://www.phpbb.com/files/release/phpBB-3.2.4.tar.bz2' /var/www

			fi

		fi

		#OPENBAZAAR
		software_id=58
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - Install go
			#	x86_64
			if (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='https://dl.google.com/go/go1.11.2.linux-amd64.tar.gz'

			#	ARMv8
			elif (( $G_HW_ARCH == 3 )); then

				INSTALL_URL_ADDRESS='https://dl.google.com/go/go1.11.2.linux-arm64.tar.gz'

			#	ARMv6/7
			else

				INSTALL_URL_ADDRESS='https://dl.google.com/go/go1.11.2.linux-armv6l.tar.gz'

			fi

			Download_Install "$INSTALL_URL_ADDRESS" /usr/local/

			mkdir -p $G_FP_DIETPI_USERDATA/go
			cat << _EOF_ > /etc/bashrc.d/go.sh
#!/bin/bash
export GOPATH=$G_FP_DIETPI_USERDATA/go
export PATH=\$PATH:/usr/local/go/bin:$G_FP_DIETPI_USERDATA/go/bin
_EOF_

			. /etc/bashrc.d/go.sh

			# - Install OB
			G_DIETPI-NOTIFY 2 "Installing ${aSOFTWARE_WHIP_NAME[$software_id]}, please wait, this will take some time (1-5 minutes)"
			G_RUN_CMD go get github.com/OpenBazaar/openbazaar-go

		fi

		#YACY
		software_id=133
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			Download_Install 'http://yacy.net/release/yacy_v1.92_20161226_9000.tar.gz' /etc

		fi

		#Folding@Home
		software_id=2
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - We must uninstall previous package for reinstall, else it will fail: https://github.com/Fourdee/DietPi/issue_comments#issuecomment-411688073
			if dpkg-query -s 'fahclient' &> /dev/null; then

				G_DIETPI-NOTIFY 2 'Removing previous package before installing the latest version'
				G_AGP fahclient

			fi

			G_DIETPI-NOTIFY 2 'Pre-configuring FAHClient deb package'
			debconf-set-selections <<< 'fahclient fahclient/autostart boolean true' # external bug with setting false https://github.com/FoldingAtHome/fah-issues/issues/1193
			debconf-set-selections <<< 'fahclient fahclient/power select light'
			debconf-set-selections <<< 'fahclient fahclient/team string 234437' # Team "DietPi"
			debconf-set-selections <<< 'fahclient fahclient/user string DietPi' # Default, until user chooses an own username
			debconf-set-selections <<< 'fahclient fahclient/passkey string 06c869246e88c00cb05cc4d1758a97f9'

			Download_Install 'https://download.foldingathome.org/releases/public/release/fahclient/debian-stable-64bit/v7.5/latest.deb'

			killall -w FAHClient #due to https://github.com/FoldingAtHome/fah-issues/issues/1193

		fi

		#ownCloud
		software_id=47
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			DEPS_LIST="$PHP_APT_PACKAGE_NAME-intl" # https://doc.owncloud.org/server/latest/admin_manual/installation/source_installation.html#php-extensions

			if [[ -f /var/www/owncloud/occ ]]; then

				G_DIETPI-NOTIFY 2 'Existing ownCloud installation found, will NOT overwrite...'

			else

				local datadir="$(grep -m1 '^[[:blank:]]*SOFTWARE_OWNCLOUD_DATADIR=' /DietPi/dietpi.txt | sed 's/^[^=]*=//' | sed 's|/$||')"
				[[ $datadir ]] || datadir="$G_FP_DIETPI_USERDATA/owncloud_data"
				if [[ -f $datadir/dietpi-owncloud-installation-backup/occ ]]; then

					G_DIETPI-NOTIFY 2 'ownCloud installation backup found, starting recovery...'
					G_RUN_CMD cp -a "$datadir"/dietpi-owncloud-installation-backup/. /var/www/owncloud
					# Correct config.php data directory entry, in case it changed due to server migration:
					G_CONFIG_INJECT "'datadirectory'" "'datadirectory' => '$datadir'," /var/www/owncloud/config/config.php "'dbtype'"

				else

					Download_Install 'https://download.owncloud.org/community/owncloud-latest.zip' /var/www

				fi

			fi

			chown -R www-data:www-data /var/www/owncloud

			[[ $DEPS_LIST ]] && G_DIETPI-NOTIFY 2 'Installing required PHP modules' && G_AGI "$DEPS_LIST"

		fi

		#Nextcloud
		software_id=114
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			DEPS_LIST="$PHP_APT_PACKAGE_NAME-intl" # https://docs.nextcloud.com/server/13/admin_manual/installation/source_installation.html#prerequisites-label

			if [[ -f /var/www/nextcloud/occ ]]; then

				G_DIETPI-NOTIFY 2 'Existing Nextcloud installation found, will NOT overwrite...'

			else

				local datadir="$(grep -m1 '^[[:blank:]]*SOFTWARE_NEXTCLOUD_DATADIR=' /DietPi/dietpi.txt | sed 's/^[^=]*=//' | sed 's|/$||')"
				[[ $datadir ]] || datadir="$G_FP_DIETPI_USERDATA/nextcloud_data"
				if [[ -f $datadir/dietpi-nextcloud-installation-backup/occ ]]; then

					G_DIETPI-NOTIFY 2 'Nextcloud installation backup found, starting recovery...'
					G_RUN_CMD cp -a "$datadir"/dietpi-nextcloud-installation-backup/. /var/www/nextcloud
					# Correct config.php data directory entry, in case it changed due to server migration:
					G_CONFIG_INJECT "'datadirectory'" "'datadirectory' => '$datadir'," /var/www/nextcloud/config/config.php "'dbtype'"

				elif (( $G_DISTRO < 4 )); then

					G_DIETPI-NOTIFY 2 'PHP5 support was dropped with NC14, latest NC13 will be installed instead'
					Download_Install 'https://download.nextcloud.com/server/releases/latest-13.zip' /var/www

				else

					Download_Install 'https://download.nextcloud.com/server/releases/latest.zip' /var/www

				fi

			fi

			chown -R www-data:www-data /var/www/nextcloud

			[[ $DEPS_LIST ]] && G_DIETPI-NOTIFY 2 'Installing required PHP modules' && G_AGI "$DEPS_LIST"

		fi

		#Nextcloud Talk
		software_id=168
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# Install "coturn" TURN server only, install Nextcloud Talk app after Nextcloud has been fully configured
			G_AGI coturn

		fi

		#YMPD
		software_id=32
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			Download_Install 'https://dietpi.com/downloads/binaries/all/ympd_1.2.3.7z'

			local binary_name='ympd_'
			# - armv6
			if (( $G_HW_ARCH == 1 )); then

				binary_name+='armv6'

			# - armv7
			elif (( $G_HW_ARCH == 2 )); then

				binary_name+='armv7'

			# - arm64
			elif (( $G_HW_ARCH == 3 )); then

				binary_name+='armv8'

			# - x86_64
			elif (( $G_HW_ARCH == 10 )); then

				binary_name+='amd64'

			fi
			binary_name+="_$G_DISTRO_NAME"

			mv "$binary_name" /usr/bin/ympd
			chmod +x /usr/bin/ympd
			rm ympd_*

		fi

		#myMPD
		software_id=148
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#Sourcebuild pre-reqs
			DEPS_LIST='cppcheck pkg-config libssl-dev libmpdclient-dev libmpdclient2 cmake'

			#Download_Install 'https://github.com/jcorporation/myMPD/archive/master.zip'
			Download_Install 'https://github.com/jcorporation/myMPD/archive/006eb6d28ce3a124abcbf531f0b3cd3e680837df.zip'

			cd myMPD*
			G_RUN_CMD ./mkrelease.sh
			cd /tmp/$G_PROGRAM_NAME

		fi

		#Roon Bridge
		software_id=121
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#x86_64
			if (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='http://download.roonlabs.com/builds/RoonBridge_linuxx64.tar.bz2'

			#ARMv8
			elif (( $G_HW_ARCH == 3 )); then

				INSTALL_URL_ADDRESS='http://download.roonlabs.com/builds/RoonBridge_linuxarmv8.tar.bz2'

			#ARMv7
			else

				INSTALL_URL_ADDRESS='http://download.roonlabs.com/builds/RoonBridge_linuxarmv7hf.tar.bz2'

			fi

			Download_Install "$INSTALL_URL_ADDRESS"

			# - reinstall, clear dir, prevent mv fail on non-empty dir
			rm -R /etc/roonbridge &> /dev/null

			mkdir -p /etc/roonbridge
			mv RoonBridge/* /etc/roonbridge
			rm -R RoonBridge

		fi

		#CAVA
		software_id=119
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - armv6
			if (( $G_HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/cava_0.6.1-1_armv6.deb'

			# - armv7
			elif (( $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/cava_0.6.1-1_armv7.deb'

			# - arm64
			elif (( $G_HW_ARCH == 3 )); then

				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/cava_0.6.1-1_arm64.deb'
				# Using older binary for Odroid C2 due to: https://github.com/Fourdee/DietPi/issues/1340#issuecomment-393225267
				if (( $G_HW_MODEL == 12 )); then

					INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/cava_0.4.2_arm64.deb'

				fi

			# - x86_64
			elif (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/cava_0.6.1-1_amd64.deb'

			fi

			G_THREAD_START wget https://dietpi.com/downloads/binaries/all/cava.psf -O $HOME/cava.psf # + Font for cava, nice bars

			DEPS_LIST='libpulse0 libfftw3-3'
			Download_Install "$INSTALL_URL_ADDRESS"

		fi

		#Mopidy
		software_id=118
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://apt.mopidy.com/mopidy.gpg'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			wget -q -O - "$INSTALL_URL_ADDRESS" | apt-key add -
			# No Buster list available yet, use stretch.list for testing:
			if (( $G_DISTRO > 4 )); then

				wget https://apt.mopidy.com/stretch.list -O /etc/apt/sources.list.d/mopidy.list

			else

				wget https://apt.mopidy.com/"$G_DISTRO_NAME".list -O /etc/apt/sources.list.d/mopidy.list

			fi
			G_AGUP
			G_AGI mopidy gstreamer1.0-alsa

			#ARMv8
			#NB: No ARM64 packages currently exist in mopidy repo. So it will throw a minor error when updating apt.
			#Mopidy web client extensions not loading in webpage...
			# if (( $G_HW_ARCH == 3 )); then

				# G_AGI build-essential python-dev
				# pip install mopidy #no effect, claims already upto date.

			# fi

			pip install Mopidy-MusicBox-Webclient Mopidy-Local-Images

		fi

		#Kodi
		software_id=31
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#Odroids
			if (( $G_HW_MODEL >= 10 )) && (( $G_HW_MODEL < 20 )); then

				local package_list='kodi-odroid'

				#XU4 - requires pulse audio (fixes corrupt sound)
				if (( $G_HW_MODEL == 11 )); then

					package_list+=' pulseaudio'

				fi

			#Everything else
			else

				local package_list='kodi'

			fi

			# - libcurl3-gnutls required for C2. But lets apply to all: https://github.com/Fourdee/DietPi/issues/446
			package_list+=' libcurl3-gnutls'

			# - NFS/CEC support
			if (( $G_DISTRO < 4 )); then

				package_list+=' libnfs4 libcec3v4'

			elif (( $G_DISTRO == 4 )); then

				package_list+=' libnfs8 libcec4'

			else

				package_list+=' libnfs11 libcec4'

			fi

			G_AGI $package_list

		fi

		#MINIDLNA
		software_id=39
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI minidlna

		fi

		#NoIp
		software_id=67
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#x32 x64
			if (( $G_HW_MODEL == 20 || $G_HW_MODEL == 21 )); then

				INSTALL_URL_ADDRESS="https://dietpi.com/downloads/binaries/all/noip_x32_x64.zip"

			#ARMv8
			elif (( ( $G_HW_MODEL == 12 ) || ( $G_HW_MODEL >= 40 && $G_HW_MODEL < 50 ) )); then

				INSTALL_URL_ADDRESS="https://dietpi.com/downloads/binaries/all/noip_arm64.zip"

			#armv6+
			else

				INSTALL_URL_ADDRESS="https://dietpi.com/downloads/binaries/all/noip_armhf.zip"

			fi

			#NoIp Binary install
			Download_Install "$INSTALL_URL_ADDRESS"

			mv noip_binary /usr/local/bin/noip2
			chmod +x /usr/local/bin/noip2

		fi

		#amiberry
		software_id=108
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - Backup existing autostart.uae for user
			G_BACKUP_FP $G_FP_DIETPI_USERDATA/amiberry/conf/autostart.uae

			DEPS_LIST='libmpg123-0 libxml2 mpeg2dec libmpeg2-4 libsndio6.1'
			Download_Install 'https://dietpi.com/downloads/binaries/all/amiberry_v2.19.7z' $G_FP_DIETPI_USERDATA

		fi

		#dxx-rebirth
		software_id=112
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='libsdl-mixer1.2 libsdl1.2debian libphysfs1'
			Download_Install 'https://dietpi.com/downloads/binaries/rpi/dxx-rebirth.7z' $G_FP_DIETPI_USERDATA

		fi

		#urbackup server
		software_id=111
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			if (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='https://hndl.urbackup.org/Server/2.2.11/urbackup-server_2.2.11_amd64.deb'

			elif (( $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS='https://hndl.urbackup.org/Server/2.2.11/urbackup-server_2.2.11_armhf.deb'

			#ARMv8 sourcebuild
			elif (( $G_HW_ARCH == 3 )); then

				INSTALL_URL_ADDRESS='https://hndl.urbackup.org/Server/2.2.11/urbackup-server-2.2.11.tar.gz'

			fi

			#ARMv8 source build
			if (( $G_HW_ARCH == 3 )); then

				DEPS_LIST='build-essential zlib1g-dev libcurl4-openssl-dev libcrypto++-dev sqlite3'
				Download_Install "$INSTALL_URL_ADDRESS"

				cd urbackup-server-*
				./configure

				G_RUN_CMD make -j $G_HW_CPU_CORES
				G_RUN_CMD make install

				sed -i "/ExecStart=/c ExecStart=/usr/local/bin/urbackupsrv run --config /etc/default/urbackupsrv --no-consoletime" urbackup-server.service
				cp urbackup-server.service /etc/systemd/system/urbackupsrv.service
				cp defaults_server /etc/default/urbackupsrv
				cp logrotate_urbackupsrv /etc/logrotate.d/urbackupsrv

				cd /tmp/$G_PROGRAM_NAME
				rm -R urbackup-server-*

			#Deb
			else

				debconf-set-selections <<< "urbackup-server urbackup/backuppath string $G_FP_DIETPI_USERDATA/urbackup"
				Download_Install "$INSTALL_URL_ADDRESS"

			fi

		fi

		#OpenTyrian
		software_id=51
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='ibsdl1.2debian libsdl-net1.2'
			Download_Install 'https://dietpi.com/downloads/binaries/rpi/opentyrian_armhf.zip' /
			chmod +x /usr/local/games/opentyrian/opentyrian

		fi

		#RPi Cam Control
		software_id=59
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='gpac motion'
			Download_Install 'https://github.com/silvanmelchior/RPi_Cam_Web_Interface/archive/master.zip'

			cd RPi_Cam*

			#Config /etc/motion
			mkdir -p /etc/motion
			cp etc/motion/motion.conf.1 /etc/motion/motion.conf

			#Config /etc/raspimjpeg
			cp etc/raspimjpeg/raspimjpeg.1 /etc/raspimjpeg

			#Setup /var/www/rpicam
			mkdir -p /var/www/rpicam/media
			cp -R www/* /var/www/rpicam/
			#chmod +x /var/www/rpicam/raspizip.sh
			mknod /var/www/rpicam/FIFO p
			mknod /var/www/rpicam/FIFO1 p

			#symlink cam preview and status
			ln -sf /run/shm/mjpeg/cam.jpg /var/www/rpicam/cam.jpg
			ln -sf /run/shm/mjpeg/status_mjpeg.txt /var/www/rpicam/status_mjpeg.txt

			#Setup Raspimjpeg binary
			cp bin/raspimjpeg /opt/vc/bin/raspimjpeg
			chmod +x /opt/vc/bin/raspimjpeg
			ln -s /opt/vc/bin/raspimjpeg /usr/bin/raspimjpeg

			#Cleanup / remove extracted source
			cd /tmp/$G_PROGRAM_NAME
			rm -R RPi_Cam*

		fi

		#DELUGE
		software_id=45
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI deluged deluge-web deluge-webui deluge-console

		fi

		#WEBMIN
		software_id=115
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='perl python'
			Download_Install 'http://www.webmin.com/download/deb/webmin-current.deb'

		fi

		#O!MPD
		software_id=129
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# Download_Install 'https://github.com/ArturSierzant/OMPD/archive/master.zip' /var/www
			Download_Install 'https://github.com/ArturSierzant/OMPD/archive/2a2909be2d7abc8cce7dff741f529c7d876d4094.zip' /var/www

			rm -R /var/www/ompd &> /dev/null #Replace/upgrade existing installs
			mv /var/www/OMPD* /var/www/ompd

		fi

		#IceCast + DarkIce
		software_id=135
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI darkice icecast2

		fi

		#LINUXDASH
		software_id=63
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			Download_Install 'https://github.com/afaqurk/linux-dash/archive/master.zip'
			mkdir -p /var/www/linuxdash
			cp -R linux-dash-master/* /var/www/linuxdash
			rm -R linux-dash-master

		fi

		#PIHOLE
		software_id=93
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://install.pi-hole.net'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			# - Check free available memory. Increase swapfile size to prevent gravity running out of mem.
			if (( $(free -m | grep -m1 'Mem:' | awk '{print $4}') < 512 &&
				$(grep -m1 '^[[:blank:]]*AUTO_SETUP_SWAPFILE_SIZE=' /DietPi/dietpi.txt | sed 's/^[^=]*=//') < 512 )); then

				G_DIETPI-NOTIFY 2 'Increasing swapfile size to 512MB before running gravity.sh, please wait...\n'
				/DietPi/dietpi/func/dietpi-set_dphys-swapfile 512

			fi

			# - Install
			wget "$INSTALL_URL_ADDRESS" -O install.sh
			chmod +x install.sh
			#	Skip Lighttpd install, since user properly has chosen a different one, which was installed as pre-req.
			./install.sh --disable-install-webserver
			#	We can't do reasonable exit code check, since installer always returns 5!
			rm install.sh

		fi

		#AirSonic
		software_id=33
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			Download_Install 'https://dietpi.com/downloads/binaries/all/airsonic.7z' $G_FP_DIETPI_USERDATA/airsonic

		fi

		#SUBSONIC 6
		software_id=34
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#G_AGI lame #conflicts with our ffmpeg package: https://github.com/Fourdee/DietPi/issues/946#issuecomment-300738228
			Download_Install 'https://dietpi.com/downloads/binaries/all/subsonic-6.1.3.deb'

		fi

		#WEAVED
		software_id=68
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			Download_Install 'https://github.com/weaved/installer/raw/master/Raspbian%20deb/1.3-07/weavedconnectd_1.3-07z1_armhf.deb'

		fi

		#WEBIOPI requires RPIGPIO
		if (( ${aSOFTWARE_INSTALL_STATE[71]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[69]=1

		fi

		#RPIGPIO
		software_id=69
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI python-rpi.gpio python3-rpi.gpio

		fi

		#WIRINGPI
		software_id=70
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - RPi
			if (( $G_HW_MODEL < 10 )); then

				#	http://git.drogon.net/?p=wiringPi;a=shortlog;h=refs/heads/master snapshot
				Download_Install 'https://dietpi.com/downloads/binaries/all/wiringPi-8d188fa.tar.gz'

			# - Odroid's
			elif (( $G_HW_MODEL < 20 )); then

				Download_Install 'https://github.com/hardkernel/wiringPi/archive/master.zip'

			# - BPiPro
			elif (( $G_HW_MODEL == 51 )); then

				Download_Install 'https://github.com/LeMaker/WiringBP/archive/bananapro.zip'

			fi

			mv WiringBP* wiringPi &> /dev/null #BPi
			mv wiringPi* wiringPi &> /dev/null #eg: RPi, wiringPi-HEAD-8d188fa

			cd wiringPi
			chmod +x build
			./build

			cd /tmp/$G_PROGRAM_NAME
			mv wiringPi $HOME/

		fi

		#RPII2C
		software_id=72
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			/DietPi/dietpi/func/dietpi-set_hardware i2c enable

		fi

		#nodered
		software_id=122
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			local package_list='python python3'
			# - RPi, pre-reqs GPIO control for Node-Red
			if (( $G_HW_MODEL < 10 )); then

				package_list+=' python-rpi.gpio'

			fi
			G_AGI $package_list

			# - Serialport fails to build unless below flags are provided
			npm i -g --unsafe-perm node-red

		fi

		#mosquitto
		software_id=123
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI mosquitto

		fi

		#Blynk Server
		software_id=131
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://api.github.com/repos/blynkkk/blynk-server/releases/latest'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			INSTALL_URL_ADDRESS="$(curl -s $INSTALL_URL_ADDRESS | grep -m1 'browser_download_url' | cut -d \" -f 4)"
			mkdir -p $G_FP_DIETPI_USERDATA/blynk/data
			G_THREAD_START wget "$INSTALL_URL_ADDRESS" -O $G_FP_DIETPI_USERDATA/blynk/blynkserver.jar

			# - Install Blynk JS Libary
			G_AGI python
			npm i -g --unsafe-perm onoff
			npm i -g --unsafe-perm blynk-library

			G_THREAD_WAIT

		fi

		#NAA Daemon
		software_id=124
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - Skip license for NAA daemon:
			debconf-set-selections <<< 'networkaudiod networkaudiod/license note false'

			#Packages
			local apackages=()

			#	Jessie - requires stretch packages
			if (( $G_DISTRO == 3 )); then

				apackages+=('https://dietpi.com/downloads/binaries/all/gcc-6-base_6.3.0-6_armhf.deb')
				apackages+=('https://dietpi.com/downloads/binaries/all/libstdc++6_6.3.0-6_armhf.deb')

			fi

			# - ARMv6/7
			if (( $G_HW_ARCH <= 2 )); then

				apackages+=('https://www.signalyst.eu/bins/naa/linux/stretch/networkaudiod_3.5.4-38_armhf.deb')

			# - ARMv8
			elif (( $G_HW_ARCH == 3 )); then

				apackages+=('https://www.signalyst.eu/bins/naa/linux/xenial/networkaudiod_3.5.4-38_arm64.deb')

			# - x86_64
			else

				apackages+=('https://www.signalyst.eu/bins/naa/linux/stretch/networkaudiod_3.5.4-38_amd64.deb')

			fi

			# - check online
			for ((i=0; i<${#apackages[@]}; i++))
			do

				G_CHECK_URL "${apackages[$i]}"

			done

			# - Prereqs
			DEPS_LIST='libasound2'

			# - Stretch, install additional packages
			if (( $G_DISTRO >= 4 )); then

				DEPS_LIST+=' gcc-6-base libstdc++6'

			fi

			for ((i=0; i<${#apackages[@]}; i++))
			do

				no_check_url=1 Download_Install "${apackages[$i]}"

			done

			unset apackages

			#Enable logging for NAA Daemon
			#echo -e "NETWORKAUDIOD_LOGFILE='/var/log/naadaemon.log'" > /etc/default/networkaudiod

		fi

		#Tomcat8
		software_id=125
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI tomcat8

		fi

		#WEBIOPI
		software_id=71
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='python-dev python-setuptools'
			Download_Install 'https://sourceforge.net/projects/webiopi/files/WebIOPi-0.7.1.tar.gz/download'

			cd WebIOPi*

			#Automate Weaved prompt
			sed -i '/read response/c\response="n"' setup.sh

			#Run setup script
			./setup.sh
			printf '\ec' # clear current terminal screen

			cd /tmp/$G_PROGRAM_NAME

			#Cleanup
			rm -R WebIOPi*

		fi

		#DIETPICLOUDSHELL
		software_id=62
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#LCD panels can be enabled in Dietpi-config > display options
			#	XU4 enable cloudshell
			if (( $G_HW_MODEL == 11 )); then

				/DietPi/dietpi/func/dietpi-set_hardware lcdpanel odroid-cloudshell

			fi

		fi

		#HAPROXY
		software_id=98
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='libpcre3-dev libssl-dev zlib1g-dev'
			Download_Install 'https://www.haproxy.org/download/1.8/src/haproxy-1.8.8.tar.gz'

			cd haproxy-*

			#Compile and install
			make -j $G_HW_CPU_CORES TARGET=linux2628 CPU=generic USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_LINUX_SPLICE=1
			make install

			mkdir /etc/haproxy

			#Exit directory
			cd /tmp/$G_PROGRAM_NAME

			#Clean up
			rm -R haproxy-*

			#Install init script as service
			dps_index=$software_id Download_Install 'haproxy.service' /etc/init.d/haproxy
			chmod +x /etc/init.d/haproxy
			update-rc.d haproxy defaults

		fi

		#SQUEEZEBOXSERVER
		software_id=35
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - ARMv8 under ARMv6/7
			if (( $G_HW_ARCH == 3 )); then

				dpkg --add-architecture armhf
				G_AGUP

			fi

			Download_Install 'https://dietpi.com/downloads/binaries/all/logitechmediaserver_7.9.1_all.deb'

			# - ARMv8, CPAN
			if (( $G_HW_ARCH == 3 )); then

				if (( $G_DISTRO == 3 )); then

					INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/DietPi-LMS7.9-CPAN_arm64.zip'

				else

					INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/logitechmediaserver_7.9.1_CPAN-armv8-stretch.zip'

				fi

				DEPS_LIST='libxml-parser-perl zlib1g-dev libjpeg-dev libpng-dev libjpeg62-turbo-dev' # shared libs needed for Image::Scale@0.08
				Download_Install "$INSTALL_URL_ADDRESS" /usr/share/squeezeboxserver

			fi

		fi

		#WORDPRESS
		software_id=55
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			Download_Install 'https://wordpress.org/latest.zip' /var/www

		fi

		#FRESHRSS
		software_id=38
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# Install required PHP modules: https://github.com/FreshRSS/FreshRSS#example-of-full-installation-on-linux-debianubuntu
			DEPS_LIST="$PHP_APT_PACKAGE_NAME-curl $PHP_APT_PACKAGE_NAME-gmp $PHP_APT_PACKAGE_NAME-intl $PHP_APT_PACKAGE_NAME-json"
			(( $G_DISTRO > 3 )) && DEPS_LIST+=" $PHP_APT_PACKAGE_NAME-mbstring $PHP_APT_PACKAGE_NAME-xml $PHP_APT_PACKAGE_NAME-zip"

			Download_Install 'https://github.com/FreshRSS/FreshRSS/archive/master.zip' /opt
			mv /opt/FreshRSS-master /opt/FreshRSS

		fi

		#TIGHTVNCSERVER
		software_id=27
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI tightvncserver x11vnc

		fi

		#VNC4SERVER
		software_id=28
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			local package_list='vnc4server x11vnc'

			# - Stretch+
			if (( $G_DISTRO >= 4 )); then

				package_list+=' tigervnc-common'

			fi

			G_AGI $package_list

		fi

		#REALVNCSERVER
		software_id=120
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# INSTALL_URL_ADDRESS='https://www.realvnc.com/download/binary/latest/debian/arm/'
			# G_CHECK_URL "$INSTALL_URL_ADDRESS"

			# wget "$INSTALL_URL_ADDRESS" -O package.tar.gz
			# G_RUN_CMD tar xvf package.tar.gz
			# rm package.tar.gz

			# dpkg -i VNC*.deb

			# rm VNC*.deb

			# - Available in Raspbian apt
			G_AGI realvnc-vnc-server

		fi

		#FAIL2BAN
		software_id=73
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			>> /var/log/auth.log #: https://github.com/Fourdee/DietPi/issues/475#issuecomment-310873879

			G_AGI python3-systemd fail2ban

		fi

		#InfluxDB
		software_id=74
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://repos.influxdata.com/influxdb.key'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			curl -sL "$INSTALL_URL_ADDRESS" | apt-key add -
			echo "deb https://repos.influxdata.com/debian $G_DISTRO_NAME stable" > /etc/apt/sources.list.d/influxdb.list
			G_AGUP

			G_AGI influxdb

		fi

		#Grafana
		software_id=77
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			if (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='https://packagecloud.io/install/repositories/grafana/stable/script.deb.sh'
				G_CHECK_URL "$INSTALL_URL_ADDRESS"

				wget "$INSTALL_URL_ADDRESS" -O $software_id.sh
				chmod +x $software_id.sh
				./$software_id.sh

				rm $software_id.sh

			else

				INSTALL_URL_ADDRESS='https://bintray.com/user/downloadSubjectPublicKey?username=bintray'
				G_CHECK_URL "$INSTALL_URL_ADDRESS"

				curl -sL "$INSTALL_URL_ADDRESS" | apt-key add -

				local deb_address=''
				if (( $G_HW_ARCH == 3 )); then

					deb_address='https://bintray.com/fg2it/deb-arm64/grafana-on-raspberry/'

				elif (( $G_HW_ARCH == 1 )); then

					deb_address='https://dl.bintray.com/fg2it/deb-rpi-1b'

				else

					deb_address='https://dl.bintray.com/fg2it/deb'

				fi

				echo "deb $deb_address $G_DISTRO_NAME main" > /etc/apt/sources.list.d/grafana.list
				G_AGUP

			fi

			G_AGI grafana

		fi

		#PHPSYSINFO
		software_id=64
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			Download_Install 'https://github.com/phpsysinfo/phpsysinfo/archive/master.zip' /var/www
			mv /var/www/phpsysinfo-* /var/www/phpsysinfo

		fi

		#Ubooquity
		software_id=80
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/Ubooquity.jar'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			mkdir -p $G_FP_DIETPI_USERDATA/ubooquity
			G_RUN_CMD wget "$INSTALL_URL_ADDRESS" -O $G_FP_DIETPI_USERDATA/ubooquity/Ubooquity.jar

		fi

		#PHPIMAGEGALLERY
		software_id=56
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			Download_Install 'https://dietpi.com/downloads/binaries/all/Single_File_PHP_Gallery_4.7.0.zip' /var/www/gallery

		fi

		#AMPACHE
		software_id=40
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			Download_Install 'https://github.com/ampache/ampache/archive/master.zip'
			mkdir -p /var/www/ampache
			cp -R ampache-*/* /var/www/ampache
			rm -R ampache-*

			#composer install required for 3.8.2
			php -r "readfile('https://getcomposer.org/installer');" > composer-setup.php
			php composer-setup.php
			php -r "unlink('composer-setup.php');"

			mv composer.phar /usr/local/bin/composer

			cd /var/www/ampache
			composer install --prefer-source --no-interaction
			cd /tmp/$G_PROGRAM_NAME

		fi

		#OPENVPNSERVER
		software_id=97
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI openvpn easy-rsa iptables

		fi

		#PiVPN
		software_id=117
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://install.pivpn.io'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			G_AGI lsb-release iptables-persistent dnsutils expect net-tools openvpn

			# - Requires underpriv user: https://github.com/Fourdee/DietPi/issues/570#issuecomment-255588307
			useradd pivpn
			mkdir -p /home/pivpn

			wget "$INSTALL_URL_ADDRESS" -O pivpn_install.sh
			chmod +x pivpn_install.sh

			# - Disable reboot
			sed -i '/shutdown[[:space:]]/d' pivpn_install.sh

			until ./pivpn_install.sh
			do

				if ! G_WHIP_YESNO "The PiVPN installer was not successful and/or cancelled prior to its completion.\n\nWould you like DietPi to run the PiVPN installer again?"; then

					aSOFTWARE_INSTALL_STATE[$software_id]=0
					break

				fi

			done

			rm pivpn_install.sh

		fi

		#LETSENCRYPT
		software_id=92
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			if (( $G_DISTRO > 3 )); then

				if (( ${aSOFTWARE_INSTALL_STATE[83]} > 0 )); then

  					G_AGI certbot python-certbot-apache

				elif (( ${aSOFTWARE_INSTALL_STATE[85]} > 0 )); then

  					G_AGI certbot python-certbot-nginx

				else

					G_AGI certbot

				fi

			else

				# - Remove/Update existing certbot installer scripts
				[[ -d /etc/certbot_scripts ]] && rm -R /etc/certbot_scripts

				Download_Install 'https://github.com/certbot/certbot/archive/master.zip' /etc
				mv /etc/certbot* /etc/certbot_scripts

				# - Install packages
				cd /etc/certbot_scripts
				./certbot-auto -n --os-packages-only
				cd /tmp/$G_PROGRAM_NAME

			fi

		fi

		#TORHOTSPOT requires WIFIHOTSPOT:
		if (( ${aSOFTWARE_INSTALL_STATE[61]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[60]=1

		fi

		#WIFIHOTSPOT
		software_id=60
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='hostapd isc-dhcp-server iptables libnl-3-200'
			Download_Install 'https://dietpi.com/downloads/binaries/all/hostapd_2.5_all.zip'

			# - Check for RTL8188C* device, use the patched binary I compiled: https://github.com/pritambaral/hostapd-rtl871xdrv#why
			if lsusb | grep -qi 'RTL8188C' || (( $G_HW_MODEL == 70 )); then #Force RTL for allo provided WiFi dongle

				WIFIHOTSPOT_RTL8188C_DEVICE=1

			fi

			#Which binary to install
			local filename_hostapd=''
			local filename_hostapd_cli=''

			# - armv6
			if (( $G_HW_ARCH == 1 )); then

				filename_hostapd='hostapd-nl80211-armv6'
				(( $WIFIHOTSPOT_RTL8188C_DEVICE )) && filename_hostapd='hostapd-rtl8188c-armv6'
				filename_hostapd_cli='hostapd_cli-armv6'

			# - armv7+
			elif (( $G_HW_ARCH == 2 )); then

				filename_hostapd='hostapd-nl80211-armv7'
				(( $WIFIHOTSPOT_RTL8188C_DEVICE )) && filename_hostapd='hostapd-rtl8188c-armv7'
				filename_hostapd_cli='hostapd_cli-armv7'

			# - arm64
			elif (( $G_HW_ARCH == 3 )); then

				filename_hostapd='hostapd-nl80211-arm64'
				(( $WIFIHOTSPOT_RTL8188C_DEVICE )) && filename_hostapd='hostapd-rtl8188c-arm64'
				filename_hostapd_cli='hostapd_cli-arm64'

			fi

			mv "$filename_hostapd" /usr/sbin/hostapd
			mv "$filename_hostapd_cli" /usr/sbin/hostapd_cli

			chmod +x /usr/sbin/hostapd
			chmod +x /usr/sbin/hostapd_cli

			rm hostapd-*

			#Enable wifi modules
			/DietPi/dietpi/func/dietpi-set_hardware wifimodules enable

		fi


		#TORHOTSPOT
		software_id=61
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - Prereqs
			G_AGI tor

		fi

		#SHAIRPORTSYNC
		software_id=37
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/shairport-sync_3.1.7_'

			# - ARMv6
			if (( $G_HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS+='armv6.7z'

			# - ARMv7
			elif (( $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS+='armv7.7z'

			# - ARM64
			elif (( $G_HW_ARCH == 3 )); then

				INSTALL_URL_ADDRESS+='armv8.7z'

			# - x86_64
			elif (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS+='amd64.7z'

			fi

			# This occured on C2: shairport-sync : Depends: libpopt-dev but it is not installed
			#G_AGI libpopt-dev
			DEPS_LIST='openssl libsoxr0 libavahi-client3 libtool libconfig9 libpopt0 libdaemon0'
			Download_Install "$INSTALL_URL_ADDRESS" /

			# Jessie: https://github.com/Fourdee/DietPi/issues/1620#issuecomment-373086888
			if (( $G_DISTRO == 3 )); then

				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/libssl1.1_1.1.0f-3+deb9u1_'

				# - ARMv7
				if (( $G_HW_ARCH == 2 )); then

					INSTALL_URL_ADDRESS+='armhf.deb'

				# - ARM64
				elif (( $G_HW_ARCH == 3 )); then

					INSTALL_URL_ADDRESS+='arm64.deb'

				# - x86_64
				elif (( $G_HW_ARCH == 10 )); then

					INSTALL_URL_ADDRESS+='amd64.deb'

				fi

				Download_Install "$INSTALL_URL_ADDRESS"

			fi

		fi

		#PYDIO
		software_id=48
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# Install required PHP modules
			DEPS_LIST="$PHP_BINARY-apcu $PHP_APT_PACKAGE_NAME-gd $PHP_APT_PACKAGE_NAME-intl"

			# - Stretch extras
			(( $G_DISTRO > 3 )) && DEPS_LIST+=" $PHP_APT_PACKAGE_NAME-mbstring $PHP_APT_PACKAGE_NAME-opcache $PHP_APT_PACKAGE_NAME-xml"

			# Skip install, if already present
			if [[ -d /var/www/pydio ]]; then

				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} install dir \"/var/www/pydio\" already exists. Download and install steps will be skipped.
 - Please manually backup your config files+data, remove the install dir and rerun \"dietpi-software (re)install $software_id\" if you need to reinstall.
 - If you want to update the ${aSOFTWARE_WHIP_NAME[$software_id]} instance, please use the internal updater from WebUI."
				G_AGI $DEPS_LIST
				unset DEPS_LIST

			else

				Download_Install 'https://download.pydio.com/pub/core/ci/pydio-latest.tar.gz' /var/www
				mv /var/www/pydio-latest /var/www/pydio

			fi

		fi

		#SQUEEZELITE
		software_id=36
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='squeezelite'
			Download_Install 'https://dietpi.com/downloads/binaries/all/squeezelite-1.8_all.7z' /usr/bin

			rm /usr/bin/squeezelite

			local target_binary=''

			if (( $G_HW_ARCH == 1 )); then

				target_binary='squeezelite_armv6'

			# - ARMv7
			elif (( $G_HW_ARCH == 2 )); then

				target_binary='squeezelite_armv7'

			# - ARM64
			elif (( $G_HW_ARCH == 3 )); then

				target_binary='squeezelite_arm64'

			# - x86_64
			elif (( $G_HW_ARCH == 10 )); then

				target_binary='squeezelite_amd64'

			fi

			ln -sf /usr/bin/"$target_binary" /usr/bin/squeezelite
			chmod +x /usr/bin/squeezelite

		fi

		#EMONHUB
		software_id=99
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='minicom python-serial python-configobj'
			Download_Install 'https://github.com/Fourdee/emonhub/archive/emon-pi.zip'

			pip install paho-mqtt pydispatcher

			# - move everything to /etc/emonhub
			rm -R /etc/emonhub
			mv emonhub-* /etc/emonhub

		fi

		#RPIMONITOR
		software_id=66
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			Download_Install 'https://github.com/XavierBerger/RPi-Monitor-deb/raw/master/packages/rpimonitor_2.12-r0_all.deb'

		fi

		#NETDATA
		software_id=65
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/netdata_1.9.0_'

			#armv6
			if (( $G_HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS+='armv6.deb'

			#armv7+
			elif (( $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS+='armv7.deb'

			#ARMv8
			elif (( $G_HW_ARCH == 3 )); then

				INSTALL_URL_ADDRESS+='armv8.deb'

			#amd64
			elif (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS+='amd64.deb'

			fi

			DEPS_LIST='zlib1g-dev'
			Download_Install "$INSTALL_URL_ADDRESS"

		fi

		#BAIKAL
		software_id=57
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			Download_Install 'https://github.com/fruux/Baikal/archive/master.zip' /var/www
			mv /var/www/Baikal* /var/www/baikal

		fi

		#MUMBLESERVER
		software_id=43
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI mumble-server

		fi

		#EMBYSERVER
		software_id=41
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			G_CHECK_URL 'https://github.com/MediaBrowser'

			#X86_64
			if (( $G_HW_ARCH == 10 )); then

				no_check_url=1 Download_Install 'https://github.com/MediaBrowser/Emby.Releases/releases/download/3.5.2.0/emby-server-deb_3.5.2.0_amd64.deb'

			#ARM
			else

				#ARMv8
				if (( $G_HW_ARCH == 3 )); then

					dpkg --add-architecture armhf
					G_AGUP
					G_AGI gcc-6-base:armhf libc6:armhf libgcc1:armhf zlib1g:armhf

				fi

				no_check_url=1 Download_Install 'https://github.com/MediaBrowser/Emby.Releases/releases/download/3.5.2.0/emby-server-deb_3.5.2.0_armhf.deb'

			fi

		fi

		#PLEXMEDIASERVER
		software_id=42
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#x86_64
			if (( $G_HW_ARCH == 10 )); then

				Download_Install 'https://downloads.plex.tv/plex-media-server/1.14.0.5470-9d51fdfaa/plexmediaserver_1.14.0.5470-9d51fdfaa_amd64.deb'

			#ARM
			else

				INSTALL_URL_ADDRESS='https://dev2day.de/pms/'
				G_CHECK_URL "$INSTALL_URL_ADDRESS"

				echo "deb [arch=armhf] $INSTALL_URL_ADDRESS $G_DISTRO_NAME main" > /etc/apt/sources.list.d/plex.list
				wget -O - "$INSTALL_URL_ADDRESS"dev2day-pms.gpg.key | apt-key add -

				# Buster: Revert repo to Stretch, as Buster is not yet available
				sed -i 's/buster/stretch/g' /etc/apt/sources.list.d/plex.list

				#ARMv8: Install 32bit binaries
				if (( $G_HW_ARCH == 3 )); then

					dpkg --add-architecture armhf
					G_AGUP
					G_AGI libstdc++6:armhf plexmediaserver-installer:armhf

				#ARM32
				else

					G_AGUP
					G_AGI plexmediaserver-installer

				fi

			fi

		fi

		#CUBERITE
		software_id=52
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#x86_64
			if (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='http://builds.cuberite.org/job/Cuberite%20Linux%20x64%20Master/lastSuccessfulBuild/artifact/Cuberite.tar.gz'

			#32bit ARM
			elif (( $G_HW_ARCH == 1 || $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS='http://builds.cuberite.org/job/Cuberite%20Linux%20raspi-armhf%20Master/lastSuccessfulBuild/artifact/Cuberite.tar.gz'

			fi

			Download_Install "$INSTALL_URL_ADDRESS" $G_FP_DIETPI_USERDATA/cubrite

			# - Move everything into base directory (cuberite)
			mv $G_FP_DIETPI_USERDATA/cubrite/Server/* $G_FP_DIETPI_USERDATA/cubrite/
			rm -R $G_FP_DIETPI_USERDATA/cubrite/Server

		fi

		#MINEOS
		software_id=53
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#check folder is online
			INSTALL_URL_ADDRESS='https://github.com/hexparrot/mineos-node.git'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			#prereqs
			G_AGI python python3 supervisor rdiff-backup screen rsync

			mkdir -p $G_FP_DIETPI_USERDATA/mineos
			cd $G_FP_DIETPI_USERDATA/mineos
			git clone "$INSTALL_URL_ADDRESS" minecraft

			cd minecraft
			git config core.filemode false
			chmod +x service.js mineos_console.js generate-sslcert.sh webui.js

			#Install Node 8, as MineOS is currently not compatible with Node 10
			npm i -g --unsafe-perm n
			n 8

			npm i --unsafe-perm

			cd /tmp/$G_PROGRAM_NAME

		fi

		#GOGS
		software_id=49
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/gogs_'

			#armv6
			if (( $G_HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS+='armv6.zip'

			#armv7+
			elif (( $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS+='armv7.zip'

			#x86_64
			elif (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS+='amd64.zip'
			fi

			Download_Install "$INSTALL_URL_ADDRESS" /etc
			mv /etc/gogs* /etc/gogs

		fi

		#QBITTORRENT
		software_id=46
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI qbittorrent-nox

		fi

		#RTORRENT
		software_id=107
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='rtorrent screen' #mediainfo
			# On Jessie, nginx-full is needed for SCGI module: https://github.com/Fourdee/DietPi/issues/1240
			(( $G_DISTRO < 4 && ${aSOFTWARE_INSTALL_STATE[85]} >= 1 )) && DEPS_LIST+=' nginx-full'

			Download_Install 'http://bintray.com/novik65/generic/download_file?file_path=ruTorrent-3.7.zip'

			mkdir -p /var/www/rutorrent
			mv ruTorrent-*/* /var/www/rutorrent/
			rm -R ruTorrent-*

			#Raspbian "unrar-free" only available in repos
			if (( $G_HW_MODEL < 10 )); then

				#G_AGI unrar-free #Does not support all rar formats, better use "unrar-nonfree" from Debian repo
				Download_Install "https://dietpi.com/downloads/binaries/rpi/unrar-armhf-$G_DISTRO_NAME.deb"

			else

				G_AGI unrar #https://github.com/Fourdee/DietPi/issues/176#issuecomment-240101365

			fi

		fi

		#Aria2
		software_id=132
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			if (( $G_DISTRO >= 4 )); then

				G_AGI aria2

			else

				#aria2 binary
				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/aria2_'

				# - armv6
				if (( $G_HW_ARCH == 1 )); then

					INSTALL_URL_ADDRESS+='armv6.7z'

				# - armv7+
				elif (( $G_HW_ARCH == 2 )); then

					INSTALL_URL_ADDRESS+='armv7.7z'

				# - arm64
				elif (( $G_HW_ARCH == 3 )); then

					INSTALL_URL_ADDRESS+='arm64.7z'

				# - x86_64
				elif (( $G_HW_ARCH == 10 )); then

					INSTALL_URL_ADDRESS+='x86_64.7z'

				fi

				# - prereqs
				DEPS_LIST='libc-ares2'
				Download_Install "$INSTALL_URL_ADDRESS"

				mv aria2_* /usr/local/bin/aria2c
				chmod +x /usr/local/bin/aria2c

			fi

			#Web interface
			Download_Install 'https://github.com/ziahamza/webui-aria2/archive/master.zip'

			cp -R webui-aria2* /var/www/aria2
			rm -R webui-aria2*

		fi

 		#SICKRAGE
		software_id=116
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='python python-pip python-dev python-setuptools libffi-dev libssl-dev libxmlsec1-dev libxml2-dev'
			Download_Install 'https://github.com/SiCKRAGE/SiCKRAGE/archive/master.zip'

			mkdir -p $G_FP_DIETPI_USERDATA/sickrage
			cp -R SiCKRAGE-*/* $G_FP_DIETPI_USERDATA/sickrage/
			rm -R SiCKRAGE-*

			#Raspbian "unrar-free" only available in repos
			if (( $G_HW_MODEL < 10 )); then

				#G_AGI unrar-free #Does not support all rar formats, better use "unrar-nonfree" from Debian repo
				Download_Install "https://dietpi.com/downloads/binaries/rpi/unrar-armhf-$G_DISTRO_NAME.deb"

			else

				G_AGI unrar #https://github.com/Fourdee/DietPi/issues/176#issuecomment-240101365

			fi

			G_RUN_CMD pip install wheel

			G_DIETPI-NOTIFY 2 'Installing/building pre-reqs for SiCKRAGE, this can take up to 10 minutes on a NanoPC-T4/RK3399, please wait and do NOT interrupt the process...'
			G_RUN_CMD pip install -r $G_FP_DIETPI_USERDATA/sickrage/requirements.txt

		fi

		#SYNCTHING
		software_id=50
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			if [[ -d /etc/syncthing ]]; then

				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} install dir \"/etc/syncthing\" already exists. Download and install steps will be skipped.
 - If you want to update ${aSOFTWARE_WHIP_NAME[$software_id]}, please use the internal updater from WebUI.
 - if you need to reinstall (e.g. broken instance), please manually backup your config files+data, remove the install dir \"/etc/syncthing\" and rerun \"dietpi-software (re)install $software_id\"."

			else

				INSTALL_URL_ADDRESS='https://api.github.com/repos/syncthing/syncthing/releases/latest'
				G_CHECK_URL "$INSTALL_URL_ADDRESS"

				# - armv6+
				if (( $G_HW_ARCH == 1 || $G_HW_ARCH == 2 )); then

					local arch='arm'

				# - arm64
				elif (( $G_HW_ARCH == 3 )); then

					local arch='arm64'

				# - x86_64
				elif (( $G_HW_ARCH == 10 )); then

					local arch='amd64'

				fi

				no_check_url=1 Download_Install "$(curl -s $INSTALL_URL_ADDRESS | grep -m1 "browser_download_url.*linux-$arch-v[0-9.]*tar\.gz" | cut -d \" -f 4)" /etc
				mv /etc/syncthing-* /etc/syncthing

			fi

		fi

		#TONIDO
		software_id=134
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			### Pre-reqs
			DEPS_LIST='libfontconfig1'
			## libjpeg8, libpng12
			# https://github.com/Fourdee/DietPi/issues/1428#issuecomment-361099496
			# - armv6/7
			if (( $G_HW_ARCH == 1 || $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS1='https://dietpi.com/downloads/binaries/all/libjpeg8_8d1-2_armhf.deb'
				INSTALL_URL_ADDRESS2='https://dietpi.com/downloads/binaries/all/libpng12-0_1.2.50-2+deb8u3_armhf.deb'
				INSTALL_URL_ADDRESS3='http://patch.codelathe.com/tonido/live/installer/armv6l-rpi/tonido.tar.gz'

			# - x86_64
			elif (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS1='https://dietpi.com/downloads/binaries/all/libjpeg8_8d1-2_amd64.deb'
				(( $G_DISTRO > 3 )) && INSTALL_URL_ADDRESS2='https://dietpi.com/downloads/binaries/all/libpng12-0_1.2.50-2+deb8u3_amd64.deb' || DEPS_LIST+=' libpng12-0'
				INSTALL_URL_ADDRESS3='http://www.tonido.com/download.php?tonido64.tar.gz'

			fi

			Download_Install "$INSTALL_URL_ADDRESS1"
			[[ $INSTALL_URL_ADDRESS2 ]] && no_check_url=1 Download_Install "$INSTALL_URL_ADDRESS2"
			no_check_url=1 Download_Install "$INSTALL_URL_ADDRESS3" $G_FP_DIETPI_USERDATA/tonido

			unset INSTALL_URL_ADDRESS1 INSTALL_URL_ADDRESS2 INSTALL_URL_ADDRESS3

		fi

		#CHROMIUM
		software_id=113
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#Pre-Req's
			G_AG_CHECK_INSTALL_PREREQ lsb-release

			#Stretch via apt
			if (( $G_DISTRO >= 4 )); then

				if (( $G_HW_MODEL < 10 )); then

					G_AGI chromium-browser

				else

					G_AGI chromium

				fi

			else

				#armv6+
				if (( $G_HW_ARCH == 1 || $G_HW_ARCH == 2 )); then

					INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/chromium_52.0.2743.116-1-deb8u1.1_armhf.deb'

				#ARMv8
				elif (( $G_HW_ARCH == 3 )); then

					INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/chromium_52.0.2743.116-1-deb8u1.1_arm64.deb'

				fi

				# - Odroid's, 'apt-get install -f' removes chromium package, rather than install required deps...
				if (( $G_HW_MODEL >= 10 && $G_HW_MODEL < 20 )); then

					DEPS_LIST='libgnome-keyring0 libnspr4 libnss3 libnss3-1d libspeechd2 libxslt1.1 libxss1 xdg-utils libgnome-keyring-common libltdl7'

				fi

				Download_Install "$INSTALL_URL_ADDRESS"

				Download_Install 'https://dietpi.com/downloads/binaries/all/chromium-l10n_52.0.2743.116-1-deb8u1.1_all.deb'

				#	armv6+
				if (( $G_HW_ARCH == 1 || $G_HW_ARCH == 2 )); then

					Download_Install 'https://dietpi.com/downloads/binaries/all/chromedriver_52.0.2743.116-1-deb8u1.1_armhf.deb'

				#	arm64
				elif (( $G_HW_ARCH == 3 )); then

					Download_Install 'https://dietpi.com/downloads/binaries/all/chromedriver_52.0.2743.116-1-deb8u1.1_arm64.deb'

				fi

				# - Prevent Debian repo from replacing our chromium packages: https://github.com/Fourdee/DietPi/issues/658
				apt-mark hold chromium chromedriver

			fi

		fi

		#MotionEye
		software_id=136
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - Prereqs + Motion
			G_AGI v4l-utils python python-dev curl libssl-dev libcurl4-openssl-dev libjpeg-dev zlib1g-dev motion

			# - Motioneye
			pip install motioneye

		fi

		#CloudPrint
		software_id=137
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			if (( $G_DISTRO == 3 )); then #https://github.com/Fourdee/DietPi/issues/855#issuecomment-292712002

				INSTALL_URL_ADDRESS='http://davesteele.github.io/cloudprint-service'

				#url/redirect fails wget spider test...
				G_CHECK_URL "$INSTALL_URL_ADDRESS"

				INSTALL_URL_ADDRESS+='/repo'

				echo -e "deb $INSTALL_URL_ADDRESS cloudprint-jessie main" > /etc/apt/sources.list.d/cloudprint.list
				wget -q -O - https://davesteele.github.io/key-366150CE.pub.txt | apt-key add -
				G_AGUP

				G_AGI cloudprint-service

			else

				G_AGI cloudprint-service

			fi

		fi

		#VirtualHere
		software_id=138
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://virtualhere.com/sites/default/files/usbserver/vhusbd'

			#armv6+
			if (( $G_HW_ARCH == 1 || $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS+='arm'

			#ARMv8
			elif (( $G_HW_ARCH == 3 )); then

				INSTALL_URL_ADDRESS+='arm64'

			#x86_64
			elif (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS+='x86_64'

			fi

			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			mkdir -p /etc/vhusbd
			wget "$INSTALL_URL_ADDRESS" -O /etc/vhusbd/vhusbd
			chmod +x /etc/vhusbd/vhusbd

		fi

		#sabnzbd
		software_id=139
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			local version='2.3.5'

			#prereqs
			DEPS_LIST='par2 python-dev libffi-dev libssl-dev'

			Download_Install "https://github.com/sabnzbd/sabnzbd/archive/$version.zip" /etc/sabnzbd

			mv /etc/sabnzbd/sabnzbd-"$version"/* /etc/sabnzbd/
			rm -R /etc/sabnzbd/sabnzbd-"$version"

			#Raspbian "unrar-free" only available in repos
			if (( $G_HW_MODEL < 10 )); then

				#G_AGI unrar-free #Does not support all rar formats, better use "unrar-nonfree" from Debian repo
				Download_Install "https://dietpi.com/downloads/binaries/rpi/unrar-armhf-$G_DISTRO_NAME.deb"

			else

				G_AGI unrar #https://github.com/Fourdee/DietPi/issues/176#issuecomment-240101365

			fi

			pip install cheetah cryptography sabyenc

		fi

		#spotifyconnectweb
		software_id=141
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/Fornoth/spotify-connect-web/releases' #full path fails wget spider test...
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			no_check_url=1 Download_Install "$INSTALL_URL_ADDRESS/download/0.0.4-alpha/spotify-connect-web_0.0.4-alpha.tar.gz" $G_FP_DIETPI_USERDATA

		fi

		#couchpotato
		software_id=142
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/CouchPotato/CouchPotatoServer/archive/master.zip'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			G_AGI libffi-dev libssl-dev python-lxml python3-lxml

			wget "$INSTALL_URL_ADDRESS" -O package.zip
			G_RUN_CMD unzip -o package.zip
			rm package.zip

			rm -R /etc/couchpotato &> /dev/null
			mv CouchPotato* /etc/couchpotato

			pip install --upgrade pyopenssl

		fi

		#Koel
		software_id=143
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# Needed PHP modules, (re)install to be failsafe: https://koel.phanan.net/docs/#/?id=server, https://laravel.com/docs/5.6/installation#server-requirements
			DEPS_LIST="python $PHP_APT_PACKAGE_NAME-json"
			(( $G_DISTRO > 3 )) && DEPS_LIST+=" $PHP_APT_PACKAGE_NAME-mbstring $PHP_APT_PACKAGE_NAME-xml"

			Download_Install 'https://github.com/phanan/koel/archive/v3.7.2.zip'
			mv koel-* $G_FP_DIETPI_USERDATA/koel

			# Install pre-req yarn and "n" to downgrade to Node 8, as Node 10 is not (yet) compatible with Koel build.
			npm i -g --unsafe-perm yarn n
			n 8

			# Download and install Composer:
			php -r "readfile('https://getcomposer.org/installer');" > composer-setup.php
			php composer-setup.php
			php -r "unlink('composer-setup.php');"
			mv composer.phar /usr/local/bin/composer
			rm composer-setup.php &> /dev/null

			cd $G_FP_DIETPI_USERDATA/koel
			composer install
			cd /tmp/$G_PROGRAM_NAME

		fi

		#Sonarr
		software_id=144
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#ARMv8 binary install: https://github.com/Fourdee/DietPi/issues/1502
			if (( $G_HW_ARCH == 3 )); then

				Download_Install 'http://update.sonarr.tv/v2/develop/mono/NzbDrone.develop.tar.gz' /opt
				G_AGI mediainfo

			#Repo install
			else

				apt-key adv --keyserver keyserver.ubuntu.com --recv-keys FDA5DFFC
				echo 'deb http://apt.sonarr.tv/ develop main' > /etc/apt/sources.list.d/sonarr.list
				G_AGUP
				G_AGI nzbdrone

			fi

		fi

		#Radarr
		software_id=145
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://api.github.com/repos/Radarr/Radarr/releases'
			G_CHECK_URL "$INSTALL_URL_ADDRESS" #full filepath below, returns --spider error :(
			INSTALL_URL_ADDRESS="$(curl -s $INSTALL_URL_ADDRESS | grep -m1 'browser_download_url.*linux.tar.gz' | cut -d \" -f 4)"

			DEPS_LIST='mediainfo'
			no_check_url=1 Download_Install "$INSTALL_URL_ADDRESS" /opt

		fi

		#Lidarr
		software_id=106
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://api.github.com/repos/Lidarr/Lidarr/releases'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"
			INSTALL_URL_ADDRESS="$(curl -s $INSTALL_URL_ADDRESS | grep -m1 'browser_download_url.*linux.tar.gz' | cut -d \" -f 4)"

			DEPS_LIST='mediainfo'
			no_check_url=1 Download_Install "$INSTALL_URL_ADDRESS" /opt

		fi

		#PlexPy
		software_id=146
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			if [[ -d /opt/plexpy ]]; then

				G_AGI python python-setuptools
				G_DIETPI-NOTIFY 2 "${aSOFTWARE_WHIP_NAME[$software_id]} install dir \"/opt/plexpy\" already exists. Download and install steps will be skipped.
 - If you want to update ${aSOFTWARE_WHIP_NAME[$software_id]}, please use the internal updater from WebUI.
 - if you need to reinstall (e.g. broken instance), please manually backup your config files+data, remove the install dir \"/opt/plexpy\" and rerun \"dietpi-software (re)install $software_id\"."

			else

				INSTALL_URL_ADDRESS='https://github.com/JonnyWong16/plexpy.git'
				G_CHECK_URL "$INSTALL_URL_ADDRESS"
				G_THREAD_START git clone --depth=1 "$INSTALL_URL_ADDRESS"
				G_AGI python python-setuptools
				G_THREAD_WAIT
				mv plexpy /opt/

			fi

		fi

		#Jackett
		software_id=147
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://api.github.com/repos/Jackett/Jackett/releases'
			G_CHECK_URL "$INSTALL_URL_ADDRESS" #full filepath below, returns --spider error :(
			INSTALL_URL_ADDRESS="$(curl -s $INSTALL_URL_ADDRESS | grep -m1 'browser_download_url.*Jackett.Binaries.Mono.tar.gz' | cut -d \" -f 4)"

			no_check_url=1 Download_Install "$INSTALL_URL_ADDRESS" /opt

			# Move existing configs to unpacked install dir
			[[ -d /opt/jackett/.mono ]] && mv /opt/jackett/.mono /opt/Jackett/
			[[ -d /opt/jackett/.config ]] && mv /opt/jackett/.config /opt/Jackett/

			# Remove existing install dir
			[[ -d /opt/jackett ]] && rm -R /opt/jackett

			# Move unpacked install dir in place
			mv /opt/Jackett /opt/jackett

		fi

		#NZBget
		software_id=149
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://nzbget.net'

			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			INSTALL_URL_ADDRESS+='/download/nzbget-latest-bin-linux.run'

			wget "$INSTALL_URL_ADDRESS" -O package.run
			mkdir -p $G_FP_DIETPI_USERDATA/nzbget
			sh package.run --destdir $G_FP_DIETPI_USERDATA/nzbget
			rm package.run

		fi

		#------------------ Bittorrent: HTPC Manager ------------------
		software_id=155
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/Hellowlol/HTPC-Manager.git'

			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			#Install Python and PIP
			G_AGI python python-pip python-imaging python-dev

			git clone --depth=1 "$INSTALL_URL_ADDRESS"

			# - Move HTPC Manager to a 'better' location
			mkdir -p $G_FP_DIETPI_USERDATA/htpc-manager
			cp -R HTPC-Manager/* $G_FP_DIETPI_USERDATA/htpc-manager/
			rm -R HTPC-Manager

			# - psutil for system stats
			pip install psutil

		fi

		#OctoPrint
		software_id=153
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/foosel/OctoPrint.git'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			G_THREAD_START git clone "$INSTALL_URL_ADDRESS"

			G_AGI python python-dev libjpeg-dev

			G_THREAD_WAIT
			mv OctoPrint* $G_FP_DIETPI_USERDATA/octoprint
			cd $G_FP_DIETPI_USERDATA/octoprint

			G_DIETPI-NOTIFY 2 'OctoPrint is now installing, please be patient and do not terminate this process, it may take some time...'
			G_RUN_CMD python setup.py install

			cd /tmp/$G_PROGRAM_NAME

		fi

		#RoonServer
		software_id=154
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			DEPS_LIST='libav-tools cifs-utils'

			# Skip download and install, if already existent, manual removal or internal updater can be used:
			if [[ ! -d $G_FP_DIETPI_USERDATA/roonserver ]]; then

				Download_Install 'http://download.roonlabs.com/builds/RoonServer_linuxx64.tar.bz2' $G_FP_DIETPI_USERDATA
				mv $G_FP_DIETPI_USERDATA/RoonServer $G_FP_DIETPI_USERDATA/roonserver

			else

				G_WHIP_MSG "[WARNING] Existing install found\n
The ${aSOFTWARE_WHIP_NAME[$software_id]} target install directory $G_FP_DIETPI_USERDATA/roonserver already exists. This will not be overwritten.\n
If the existing instance is broken or obsolete, please manually backup config files and data, then remove this directory and rerun "dietpi-software".\n
If you want to update ${aSOFTWARE_WHIP_NAME[$software_id]}, please use it's internal updater."

			fi

		fi

		#Steam
		software_id=156
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			debconf-set-selections <<< 'steam steam/question select I AGREE'

			G_AGI steam

		fi

		#Minio
		software_id=158
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# Download the proper Minio executable and put it in the proper location

			# Check to see if this is a n x86 or x64 box. If so download the x86 Minio if not download 32bit ARM linux version
			if (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='https://dl.minio.io/server/minio/release/linux-amd64/minio'

			else

				INSTALL_URL_ADDRESS='https://dl.minio.io/server/minio/release/linux-arm/minio'

			fi

			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			#Download executable
			[ -d /usr/local/bin ] || mkdir /usr/local/bin
			wget -O /usr/local/bin/minio $INSTALL_URL_ADDRESS
			chmod +x /usr/local/bin/minio

			# Check, Download, Install startup script
			INSTALL_URL_ADDRESS='https://github.com/minio/minio-service/raw/master/linux-systemd/minio.service'

			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			# Download the systemd service script
			wget -O /etc/systemd/system/minio.service $INSTALL_URL_ADDRESS

			# Create no login, with home directory, with group of same name, user to run Minio in
			adduser --system --group minio-user

			# Create default data directory & grant minio-user proper access
			mkdir $G_FP_DIETPI_USERDATA/minio-data

		fi

		#Docker
		software_id=162
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://get.docker.com'

			# Current workaround for faulty docker-ce repo version on RPi: https://github.com/Fourdee/DietPi/issues/2282
			(( $G_HW_MODEL < 10 )) && echo 'Package: docker-ce
Pin: version 5:18.09.0~3-0~raspbian-stretch
Pin-Priority: -1' > /etc/apt/preferences.d/dietpi-docker_fix

			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			# Offical Docker recommended install command
			wget -O DockerInstall.sh "$INSTALL_URL_ADDRESS"
			chmod +x DockerInstall.sh
			./DockerInstall.sh
			#rm DockerInstall.sh

		fi

		#FuguHub
		software_id=161
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			if (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='http://FuguHub.com/install/FuguHub.linux.install'

			else

				INSTALL_URL_ADDRESS='http://FuguHub.com/releases/raspberrypi/install.sh'

			fi

			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			wget -O FHinstall.sh "$INSTALL_URL_ADDRESS"
			chmod +x FHinstall.sh
			./FHinstall.sh
			rm FHinstall.sh
			wget http://fuguhub.com/box.zip -O /home/bd/applications/box.zip

		fi

		#Nukkit
		software_id=164
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://ci.nukkitx.com/job/NukkitX/job/Nukkit/job/master/lastSuccessfulBuild/artifact/target/nukkit-1.0-SNAPSHOT.jar'

			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			mkdir /usr/local/bin/nukkit
			wget -O /usr/local/bin/nukkit/nukkit.jar "$INSTALL_URL_ADDRESS"

		fi

		#GITEA
		software_id=165
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://dl.gitea.io/gitea/1.4/gitea-1.4-'

			#armv6
			if (( $G_HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS+='linux-arm-6'

			#armv7
			elif (( $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS+='linux-arm-7'

			#armv8
			elif (( $G_HW_ARCH == 3 )); then

				INSTALL_URL_ADDRESS+='linux-arm64'

			#x86_64
			elif (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS+='linux-amd64'

			fi

			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			# - Data storage / user data
			mkdir -p $G_FP_DIETPI_USERDATA/gitea/gitea-repositories

			wget "$INSTALL_URL_ADDRESS" -O $G_FP_DIETPI_USERDATA/gitea/gitea
			chmod +x $G_FP_DIETPI_USERDATA/gitea/gitea

		fi

		#Allo Web Interface
		software_id=159 #160 for quick reinstall
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[160]} == 1 )); then

			Banner_Installing
			Download_Install 'https://dietpi.com/downloads/binaries/all/allo_web_interface_v12.7z' /var/www

		fi

		#Gmediarender
		software_id=163
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/gmrender_1_'
			if (( $G_HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS+='amd64.deb'

			elif (( $G_HW_ARCH == 3 )); then

				INSTALL_URL_ADDRESS+='arm64.deb'

			elif (( $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS+='armv7.deb'

			elif (( $G_HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS+='armv6.deb'

			fi

			DEPS_LIST='libupnp6 gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-alsa'
			Download_Install "$INSTALL_URL_ADDRESS"

		fi

		#AudioPhonics Pi-SPC
		software_id=166
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - required for systemd-logind, used by dtoverlay=gpio-shutdown,gpio_pin=22,active_low=0
			#	dtoverlay=gpio-poweroff,gpiopin=17
			G_AGI dbus

		fi

		#Raspotify
		software_id=167
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://dtcooper.github.io/raspotify/key.asc'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			wget -O - "$INSTALL_URL_ADDRESS" | apt-key add -
			echo 'deb https://dtcooper.github.io/raspotify jessie main' > /etc/apt/sources.list.d/raspotify.list
			G_AGUP

			G_AGI raspotify

		fi

		#Google AIY
		software_id=169
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/google/aiyprojects-raspbian.git'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			git clone -b voicekit "$INSTALL_URL_ADDRESS" $G_FP_DIETPI_USERDATA/voice-recognizer-raspi
			cd $G_FP_DIETPI_USERDATA/voice-recognizer-raspi

			pip3 install --upgrade pip virtualenv
			virtualenv --system-site-packages -p python3 env
			env/bin/pip install -r requirements.txt

			#??? ARMv7 only
			if (( $G_HW_ARCH == 2 )); then

				env/bin/pip install google-assistant-library==0.0.3

			fi

			# - Services
			sed -i "s#/home/pi#$G_FP_DIETPI_USERDATA#g" systemd/voice-recognizer.service
			sed -i '/^User=/c\User=dietpi' systemd/voice-recognizer.service

			cp systemd/voice-recognizer.service /etc/systemd/system/
			cp systemd/alsa-init.service /etc/systemd/system/
			#cp systemd/ntpdate.service /etc/systemd/system/

			source env/bin/activate

			# - Enable default app for service start
			cp src/assistant_library_with_button_demo.py src/main.py

			cd /tmp/$G_PROGRAM_NAME

		fi

		#Roon Extension Manager
		software_id=86
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/TheAppgineer/roon-extension-manager-packaging/raw/master/linux/setup.sh'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			wget -O setup.sh "$INSTALL_URL_ADDRESS"
			chmod +x setup.sh
			./setup.sh
			rm setup.sh

		fi

		#-------------------------------------------------------------------
		#Reset error handler (eg: for usermsg clear set in Banner_Installing)
		G_ERROR_HANDLER_RESET
		#-------------------------------------------------------------------

	}

	Install_Linux_Software(){

		local software_id=0

		software_id=5
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			G_AGI alsa-utils

			#Apply soundcard
			local soundcard="$(grep -m1 '^[[:blank:]]*CONFIG_SOUNDCARD=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')"

			# - RPi enable internal HDMI+Analogue if currently set to 'none'
			if (( $G_HW_MODEL < 10 )) &&
				[[ $soundcard == 'none' || $soundcard == 'default' ]]; then

				soundcard='rpi-bcm2835-ultrahq'

			fi

			# - Apply
			/DietPi/dietpi/func/dietpi-set_hardware soundcard "$soundcard"

		fi

		#LibSSL1.0.0
		software_id=126
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# - Stretch, libssl1.0.0 no longer available: https://github.com/Fourdee/DietPi/issues/1299
			if (( $G_DISTRO >= 4 )); then

				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/'

				# - ARMv6/7
				if (( $G_HW_ARCH == 1 || $G_HW_ARCH == 2 )); then

					INSTALL_URL_ADDRESS+='libssl1.0.0_1.0.1t-1+deb8u7_armhf.deb'

				# - ARM64
				elif (( $G_HW_ARCH == 3 )); then

					INSTALL_URL_ADDRESS+='libssl1.0.0_1.0.1t-1+deb8u7_arm64.deb'

				# - x86_64
				elif (( $G_HW_ARCH == 10 )); then

					INSTALL_URL_ADDRESS+='libssl1.0.0_1.0.1t-1+deb8u7_amd64.deb'

				fi

				Download_Install "$INSTALL_URL_ADDRESS"

			fi

		fi

		software_id=6
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#Xserver Prereqs (ALL)
			G_AGI xserver-xorg xinit xcompmgr xterm dbus-x11 xfonts-base x11-xserver-utils x11-utils libgl1-mesa-dri mesa-utils mesa-utils-extra

			G_BACKUP_FP /etc/X11/xorg.conf

			# - Improve performance on all desktops and devices (eg: removes window lag in desktops) by limiting compositions
			dps_index=$software_id Download_Install 'xcompmgr.desktop' /etc/xdg/autostart/xcompmgr.desktop

			# - Disable DPMS and all screen blanking
			dps_index=$software_id Download_Install '99-dietpi-dpms_off.conf' /etc/X11/xorg.conf.d/99-dietpi-dpms_off.conf

			#RPI
			if (( $G_HW_MODEL < 10 )); then

				:

			#Odroid N1
			elif (( $G_HW_MODEL == 14 )); then

				DEPS_LIST='libmali-rk-midgard-t86x-r14p0 xserver-xorg-video-armsoc-rk3399-odroid'
				dps_index=$software_id Download_Install 'xorg_n1.conf' /etc/X11/xorg.conf

			#Odroid C2
			elif (( $G_HW_MODEL == 12 )); then

				DEPS_LIST='aml-libs-odroid mali450-odroid xf86-video-mali-odroid libump-odroid xf86-video-fbturbo-odroid'
				dps_index=$software_id Download_Install 'xorg_c2.conf' /etc/X11/xorg.conf

			#Odroid XU4
			elif (( $G_HW_MODEL == 11 )); then

				DEPS_LIST='firmware-samsung xf86-video-armsoc-odroid malit628-odroid'
				dps_index=$software_id Download_Install 'xorg_xu4.conf' /etc/X11/xorg.conf

			#Odroid C1
			elif (( $G_HW_MODEL == 10 )); then

				DEPS_LIST='aml-libs-odroid xf86-video-mali-odroid libump-odroid mali450-odroid'
				dps_index=$software_id Download_Install 'xorg_c1.conf' /etc/X11/xorg.conf

			#Pine64
			elif (( $G_HW_MODEL == 40 )); then

				Download_Install 'https://dietpi.com/downloads/binaries/all/libump_1-1_arm64.deb'
				mv /usr/local/lib/libUMP* /usr/lib/
				Download_Install 'https://dietpi.com/downloads/binaries/all/xf86-video-fbturbo_1-1_arm64.deb'

				dps_index=$software_id Download_Install 'xorg_pine64.conf' /etc/X11/xorg.conf

			#RK3399
			# elif (( $G_HW_MODEL == 42 || $G_HW_MODEL == 68 )); then

				#/usr/lib/xorg/Xorg: symbol lookup error: /usr/lib/xorg/modules/libglamoregl.so: undefined symbol: gbm_create_device
				#Retry with kernel/uboot from Ubuntu image???

				# dps_index=$software_id Download_Install 'xorg_rk3399.conf' /etc/X11/xorg.conf
				# dps_index=$software_id Download_Install '50-dietpi-rk3399.rules' /etc/udev/rules.d/50-rk3399.rules

				## wget https://github.com/rockchip-linux/libmali/raw/29mirror/lib/aarch64-linux-gnu/libmali-midgard-t86x-r14p0-x11-fbdev.so -O /usr/lib/aarch64-linux-gnu/libMali.so
				## wget https://github.com/rockchip-linux/libmali/raw/29mirror/lib/aarch64-linux-gnu/libmali-midgard-t86x-r14p0-fbdev.so -O /usr/lib/aarch64-linux-gnu/libMali.so
				## wget https://github.com/rockchip-linux/libmali/raw/29mirror/lib/aarch64-linux-gnu/libmali-midgard-t86x-r14p0-gbm.so -O /usr/lib/aarch64-linux-gnu/libMali.so #works but no GLES
				# wget https://github.com/rockchip-linux/libmali/raw/29mirror/lib/aarch64-linux-gnu/libmali-midgard-t86x-r14p0.so -O /usr/lib/aarch64-linux-gnu/libMali.so
				# rm $(ls /usr/lib/aarch64-linux-gnu/libGLESv2.*)
				# rm $(ls /usr/lib/aarch64-linux-gnu/libEGL.*)
				# ln -sf /usr/lib/aarch64-linux-gnu/libMali.so /usr/lib/aarch64-linux-gnu/libEGL.so.1
				# ln -sf /usr/lib/aarch64-linux-gnu/libMali.so /usr/lib/aarch64-linux-gnu/libEGL.so.1.0.0
				# ln -sf /usr/lib/aarch64-linux-gnu/libMali.so /usr/lib/aarch64-linux-gnu/libGLESv2.so.2
				# ln -sf /usr/lib/aarch64-linux-gnu/libMali.so /usr/lib/aarch64-linux-gnu/libGLESv2.so.2.0.0
				# ln -sf /usr/lib/aarch64-linux-gnu/libMali.so /usr/lib/aarch64-linux-gnu/libgbm.so.1
				# ln -sf /usr/lib/aarch64-linux-gnu/libMali.so /usr/lib/aarch64-linux-gnu/libgbm.so.1.0.0
				# ln -sf /usr/lib/aarch64-linux-gnu/libMali.so /usr/lib/aarch64-linux-gnu/libmali.so
				# ln -sf /usr/lib/aarch64-linux-gnu/libMali.so /usr/lib/aarch64-linux-gnu/libMaliOpenCL.so
				# ln -sf /usr/lib/aarch64-linux-gnu/libMali.so /usr/lib/aarch64-linux-gnu/libOpenCL.so

			#ASUS TB
			elif (( $G_HW_MODEL == 52 )); then

				Download_Install 'https://dietpi.com/downloads/binaries/asus/ASUSTB_GPU.7z' gpu_driver

				cd gpu_driver
				dpkg -i *.deb
				G_AGF

				# - Hold GPU installed packages
				apt-mark hold xserver-common xserver-xorg-core

				cd /tmp/$G_PROGRAM_NAME
				rm -R gpu_driver

				dps_index=$software_id Download_Install 'xorg_asustb.conf' /etc/X11/xorg.conf

				rm $(ls /usr/lib/arm-linux-gnueabihf/libGLESv2.*)
				rm $(ls /usr/lib/arm-linux-gnueabihf/libEGL.*)
				mv /usr/lib/arm-linux-gnueabihf/libmali-midgard-r13p0-r0p0.so /usr/lib/arm-linux-gnueabihf/libMali.so
				ln -sf /usr/lib/arm-linux-gnueabihf/libMali.so /usr/lib/arm-linux-gnueabihf/libEGL.so.1
				ln -sf /usr/lib/arm-linux-gnueabihf/libMali.so /usr/lib/arm-linux-gnueabihf/libEGL.so.1.0.0
				ln -sf /usr/lib/arm-linux-gnueabihf/libMali.so /usr/lib/arm-linux-gnueabihf/libGLESv2.so.2
				ln -sf /usr/lib/arm-linux-gnueabihf/libMali.so /usr/lib/arm-linux-gnueabihf/libGLESv2.so.2.0.0
				ln -sf /usr/lib/arm-linux-gnueabihf/libMali.so /usr/lib/arm-linux-gnueabihf/libgbm.so.1
				ln -sf /usr/lib/arm-linux-gnueabihf/libMali.so /usr/lib/arm-linux-gnueabihf/libgbm.so.1.0.0
				ln -sf /usr/lib/arm-linux-gnueabihf/libMali.so /usr/lib/arm-linux-gnueabihf/libmali.so
				ln -sf /usr/lib/arm-linux-gnueabihf/libMali.so /usr/lib/arm-linux-gnueabihf/libMaliOpenCL.so
				ln -sf /usr/lib/arm-linux-gnueabihf/libMali.so /usr/lib/arm-linux-gnueabihf/libOpenCL.so

			fi

		fi

		#Nvidia driver
		software_id=151
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			#Install + i386 OpenGL
			G_AGI nvidia-driver nvidia-xconfig libgl1-nvidia-glx:i386

		fi

		#Avahi-Daemon
		software_id=152
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI avahi-daemon

		fi

		software_id=16
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI build-essential make autoconf automake

		fi

		software_id=100
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI pijuice-base python-smbus i2c-tools

		fi

		software_id=17
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI git

		fi

		software_id=4
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI vifm

		fi

		software_id=20
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI vim

		fi

		software_id=21
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI vim-tiny

		fi

		software_id=127
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI neovim

		fi

		software_id=18
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI emacs

		fi

		software_id=12
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI iperf

		fi

		software_id=3
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI mc

		fi

		software_id=19
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI jed

		fi

		software_id=10
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI iftop

		fi

		software_id=11
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI iptraf

		fi

		software_id=13
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI mtr-tiny

		fi

		software_id=14
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI nload

		fi

		software_id=15
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI tcpdump

		fi

		software_id=0
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI openssh-client

		fi

		software_id=1
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#Remove Information file
			rm /mnt/samba/readme.txt &> /dev/null

			G_AGI smbclient cifs-utils

		fi

		software_id=110
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#Remove information file
			rm /mnt/nfs_client/readme.txt &> /dev/null

			# "netbase" is needed for mounting NFSv3: https://github.com/Fourdee/DietPi/issues/1898#issuecomment-406247814
			G_AGI nfs-common netbase

		fi

		software_id=104
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI dropbear

			#set to start on next boot
			G_CONFIG_INJECT 'NO_START=' 'NO_START=0' /etc/default/dropbear

		fi

		software_id=105
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI openssh-server


			# - Remove all references before adding the entry: https://github.com/Fourdee/DietPi/issues/604
			sed -i '/PermitRootLogin[[:space:]]/d' /etc/ssh/sshd_config
			echo -e '\n\n#Allow root login over SSH\nPermitRootLogin yes' >> /etc/ssh/sshd_config

			#Generate host keys
			# - remove all previous
			rm /etc/ssh/ssh_host_key
			rm /etc/ssh/ssh_host_rsa_key
			rm /etc/ssh/ssh_host_dsa_key

			# - Generate
			ssh-keygen -f /etc/ssh/ssh_host_key -N '' -t rsa1
			ssh-keygen -f /etc/ssh/ssh_host_rsa_key -N '' -t rsa
			ssh-keygen -f /etc/ssh/ssh_host_dsa_key -N '' -t dsa

			# - Set permissions
			chmod -R 700 /etc/ssh/

			#Restart ssh server now so root users can login during setup.
			systemctl restart ssh

			#SSH server package also installs client.
			aSOFTWARE_INSTALL_STATE[0]=2

		fi

		software_id=103
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			l_message='Copy /var/log skeletons to temporary storage' G_RUN_CMD /DietPi/dietpi/func/dietpi-ramlog 1
			# Install (add tmpfs mount to fstab)
			local tmpfs_max_size=$(grep -m1 '^[[:blank:]]*AUTO_SETUP_RAMLOG_MAXSIZE=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')
			sed -i '/[[:space:]]\/var\/log[[:space:]]/d' /etc/fstab
			echo "tmpfs /var/log tmpfs defaults,size=${tmpfs_max_size}m,noatime,nodev,nosuid,mode=1777 0 0" >> /etc/fstab
			systemctl enable dietpi-ramlog

		fi

		software_id=101
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing
			G_AGI logrotate

		fi

		software_id=102
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#Workaround for dpkg failure on 1st install if service is already running but APT not installed: https://github.com/Fourdee/DietPi/pull/2277/#issuecomment-441460925
			systemctl stop rsyslog &> /dev/null
			G_AGI rsyslog
			systemctl start rsyslog &> /dev/null

		fi

		software_id=7
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#RPi + OpenMAX HW Encoding: https://github.com/Fourdee/DietPi/issues/869
			if (( $G_HW_MODEL < 10 )); then

				Download_Install 'https://dietpi.com/downloads/binaries/rpi/ffmpeg_rpi.7z' ffmpeg_rpi

				dpkg -i ffmpeg_rpi/*.deb
				rm -R ffmpeg_rpi

			#Everything else
			else

				G_AGI ffmpeg

			fi

		fi

		software_id=8
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			# On Jessie use backports repo:
			if (( $G_DISTRO == 3 )); then

				cat << _EOF_ > /etc/apt/preferences.d/99-dietpi-openjdk-8-jdk
Package: openjdk-8-jdk
Pin: release a=jessie-backports
Pin-Priority: 990
_EOF_

				G_AGI openjdk-8-jdk -t jessie-backports

			else

				# - Workaround to allow install: https://github.com/Fourdee/DietPi/issues/1340#issuecomment-389902031
				local packages='ca-certificates-java openjdk-8-jre-headless openjdk-8-jdk-headless'
				apt-get install -y -qq $packages
				G_AGI $packages

			fi

		fi

		software_id=9
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://raw.githubusercontent.com/taaem/nodejs-linux-installer/master/node-install.sh'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			wget "$INSTALL_URL_ADDRESS" -O node_install.sh
			chmod +x node_install.sh
			mkdir -p /usr/local # failsafe
			./node_install.sh
			rm node_install.sh

		fi

		software_id=130
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://bootstrap.pypa.io/get-pip.py'
			G_CHECK_URL "$INSTALL_URL_ADDRESS"

			# - Preqs
			G_AGI python python-dev

			wget "$INSTALL_URL_ADDRESS" -O install.py
			python ./install.py
			rm install.py

			G_AGI python-pip python3-pip

		fi

		#SDL2
		software_id=140
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			#X86_64
			if (( $G_HW_ARCH == 10 )); then

				# G_AGI libsdl2-2.0-0 libsdl2-image-2.0-0 libsdl2-ttf-2.0-0 libsdl2-net-2.0-0 libsdl2-mixer-2.0-0
				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/sdl2-x86_64_stretch.7z'

			#ARMv6
			elif (( $G_HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/sdl2-armv6_stretch.7z'

			#ARMv7 FKMS:
			#	./configure --disable-video-rpi --enable-video-kmsdrm
			elif (( $G_HW_ARCH == 2 )); then

				INSTALL_URL_ADDRESS='https://dietpi.com/downloads/binaries/all/sdl2-armv7_stretch.7z'

				# - RPi 2/3 Enable fkms OpenGL
				if (( $G_HW_MODEL < 10 )); then

					/DietPi/dietpi/func/dietpi-set_hardware rpi-opengl vc4-fkms-v3d

				fi

			fi

			Download_Install "$INSTALL_URL_ADDRESS" sdl2

			dpkg -i sdl2/*.deb

			rm -R sdl2

		fi

		#Mono repo
		software_id=150
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF

			#RPi's + ARMv6 only available in raspbian repo: https://github.com/Fourdee/DietPi/issues/1023
			if (( $G_HW_MODEL < 10 || $G_HW_ARCH == 1 )); then

				echo "deb https://download.mono-project.com/repo/debian raspbian$G_DISTRO_NAME main" > /etc/apt/sources.list.d/mono-xamarin.list

			else

				echo "deb https://download.mono-project.com/repo/debian $G_DISTRO_NAME main" > /etc/apt/sources.list.d/mono-xamarin.list

			fi
			# - Buster: Revert to Stretch, since Buster is not yet available
			sed -i 's/buster/stretch/g' /etc/apt/sources.list.d/mono-xamarin.list

			G_AGUP

			G_AGI mono-runtime mono-complete
			rm /tmp/mono* &> /dev/null #https://github.com/Fourdee/DietPi/issues/1877#issuecomment-403856446

		fi

		#------------------ Home Automation: Home Assistant ------------------
		software_id=157
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Installing

			local ha_user="homeassistant"
			local ha_userroot="/home/$ha_user"
			local ha_srvroot="/srv/homeassistant"
			local ha_pyenv_activation="export PATH=\"$ha_userroot/.pyenv/bin:\$PATH\"; eval \"\$(pyenv init -)\"; eval \"\$(pyenv virtualenv-init -)\""
			local ha_python_version="3.6.3"

			G_DIETPI-NOTIFY 2 "ha_user: $ha_user"
			G_DIETPI-NOTIFY 2 "ha_userroot: $ha_userroot"
			G_DIETPI-NOTIFY 2 "ha_srvroot: $ha_srvroot"
			G_DIETPI-NOTIFY 2 "ha_pyenv_activation: $ha_pyenv_activation"
			G_DIETPI-NOTIFY 2 "ha_python_version: $ha_python_version"

			# Install needed libraries
			G_AGI libssl-dev git cmake libc-ares-dev uuid-dev daemon curl libgnutls28-dev libgnutlsxx28 nmap net-tools sudo libglib2.0-dev libudev-dev swig libssl-dev libusb-1.0-0 gcc libssl-dev libffi-dev libbz2-dev zlib1g-dev libreadline-dev libsqlite3-dev libncurses5-dev libncursesw5-dev
			if (( $G_DISTRO < 4 )); then

				G_AGI libmysqlclient-dev

			else

				G_AGI libmariadbclient-dev

			fi

			# Setup the user account information
			adduser --system $ha_user
			addgroup $ha_user
			usermod -G dialout -a $ha_user
			# this allows the dietpi user to edit the files along with HA.
			usermod -G dietpi -a $ha_user
			mkdir $ha_srvroot
			chown $ha_user:$ha_user $ha_srvroot

			# Install pyenv
			su --shell /bin/bash --command "cd $ha_userroot; curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash" $ha_user

			# Install Python which is needed for HA.
			su --shell /bin/bash --command "cd $ha_userroot; $ha_pyenv_activation; pyenv install $ha_python_version" $ha_user

			# Make the virtual environment.
			su --shell /bin/bash --command "cd $ha_srvroot; $ha_pyenv_activation; pyenv virtualenv $ha_python_version homeassistant-$ha_python_version" $ha_user
			su --shell /bin/bash --command "cd $ha_srvroot; $ha_pyenv_activation; pyenv local homeassistant-$ha_python_version" $ha_user
			su --shell /bin/bash --command "cd $ha_srvroot; $ha_pyenv_activation; pyenv local" $ha_user

			# Install Home Assistant and extra modules.
			su --shell /bin/bash --command "cd $ha_srvroot; $ha_pyenv_activation; pyenv activate homeassistant-$ha_python_version; pip3 install colorlog PyMySQL mysqlclient" $ha_user
			su --shell /bin/bash --command "cd $ha_srvroot; $ha_pyenv_activation; pyenv activate homeassistant-$ha_python_version; pip3 install --upgrade homeassistant" $ha_user

			# Generate the scripts to launch HA using pyenv.
			echo '#!/bin/bash' > $ha_srvroot/homeassistant-start.sh
			echo "cd $ha_srvroot" >> $ha_srvroot/homeassistant-start.sh
			echo "$ha_pyenv_activation" >> $ha_srvroot/homeassistant-start.sh
			echo "pyenv activate homeassistant-$ha_python_version" >> $ha_srvroot/homeassistant-start.sh
			echo "hass -c \"$ha_userroot/.homeassistant\"" >> $ha_srvroot/homeassistant-start.sh
			#su --shell /bin/bash --command "/srv/homeassistant/homeassistant-start.sh" homeassistant
			chmod +x /srv/homeassistant/homeassistant-start.sh

		fi

		#-------------------------------------------------------------------
		#Reset error handler (eg: for usermsg clear set in Banner_Installing)
		G_ERROR_HANDLER_RESET
		#-------------------------------------------------------------------

	}

	Apply_SSHServer_Choices(){

		#Work out which SSH Server needs installing from IDs (if any)
		#Work out which SSH server needs removing (if any)
		if (( $INDEX_SSHSERVER_TARGET != $INDEX_SSHSERVER_CURRENT )); then

			# Run uninstall of old SSH servers, after install loop
			UNINSTALL_REQUIRED=1

			# - No SSH server
			if (( $INDEX_SSHSERVER_TARGET == 0 )); then

				(( aSOFTWARE_INSTALL_STATE[104] == 2 )) && aSOFTWARE_INSTALL_STATE[104]=-1
				(( aSOFTWARE_INSTALL_STATE[105] == 2 )) && aSOFTWARE_INSTALL_STATE[105]=-1

			# - Dropbear
			elif (( $INDEX_SSHSERVER_TARGET == -1 )); then

				aSOFTWARE_INSTALL_STATE[104]=1
				(( aSOFTWARE_INSTALL_STATE[105] == 2 )) && aSOFTWARE_INSTALL_STATE[105]=-1

			# - Openssh
			elif (( $INDEX_SSHSERVER_TARGET == -2 )); then

				aSOFTWARE_INSTALL_STATE[105]=1
				(( aSOFTWARE_INSTALL_STATE[104] == 2 )) && aSOFTWARE_INSTALL_STATE[104]=-1

			fi

			#Inform user (From testing, stopping SSH server services does not disconnect user, however, just incase it does in the future)
			G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" 'Stopping SSH servers'

			#stop all SSH server services
			systemctl stop ssh &> /dev/null
			systemctl stop dropbear &> /dev/null

			#Update Current SSHSERVER index
			INDEX_SSHSERVER_CURRENT=$INDEX_SSHSERVER_TARGET

		fi

	}

	Apply_FileServer_Choices(){

		#Work out which File Server needs installing from IDs (if any)
		#Work out which File server needs removing (if any)
		if (( $INDEX_FILESERVER_TARGET != $INDEX_FILESERVER_CURRENT )); then

			# Run uninstall of old file servers, after install loop
			UNINSTALL_REQUIRED=1

			#No File server
			if (( $INDEX_FILESERVER_TARGET == 0 )); then

				(( aSOFTWARE_INSTALL_STATE[94] == 2 )) && aSOFTWARE_INSTALL_STATE[94]=-1
				(( aSOFTWARE_INSTALL_STATE[96] == 2 )) && aSOFTWARE_INSTALL_STATE[96]=-1

			#ProFTP
			elif (( $INDEX_FILESERVER_TARGET == -1 )); then

				aSOFTWARE_INSTALL_STATE[94]=1
				(( aSOFTWARE_INSTALL_STATE[96] == 2 )) && aSOFTWARE_INSTALL_STATE[96]=-1

			#Samba
			elif (( $INDEX_FILESERVER_TARGET == -2 )); then

				aSOFTWARE_INSTALL_STATE[96]=1
				(( aSOFTWARE_INSTALL_STATE[94] == 2 )) && aSOFTWARE_INSTALL_STATE[94]=-1

			fi

			#Update Current SSHSERVER index
			INDEX_FILESERVER_CURRENT=$INDEX_FILESERVER_TARGET

		fi

	}

	Apply_Logging_Choices(){

		#Work out which Logging system needs installing from IDs (if any)
		#Work out which Logging system needs removing (if any)
		if (( $INDEX_LOGGING_TARGET != $INDEX_LOGGING_CURRENT )); then

			# Run uninstall of old logging systems, after install loop
			UNINSTALL_REQUIRED=1

			#None
			if (( $INDEX_LOGGING_TARGET == 0 )); then

				(( aSOFTWARE_INSTALL_STATE[101] == 2 )) && aSOFTWARE_INSTALL_STATE[101]=-1
				(( aSOFTWARE_INSTALL_STATE[102] == 2 )) && aSOFTWARE_INSTALL_STATE[102]=-1
				(( aSOFTWARE_INSTALL_STATE[103] == 2 )) && aSOFTWARE_INSTALL_STATE[103]=-1

			#Ramlog - clear every hour
			elif (( $INDEX_LOGGING_TARGET == -1 )); then

				aSOFTWARE_INSTALL_STATE[103]=1
				(( aSOFTWARE_INSTALL_STATE[101] == 2 )) && aSOFTWARE_INSTALL_STATE[101]=-1
				(( aSOFTWARE_INSTALL_STATE[102] == 2 )) && aSOFTWARE_INSTALL_STATE[102]=-1

			#Ramlog - backup every 1H to $HOME/logfile_storage, then clear.
			elif (( $INDEX_LOGGING_TARGET == -2 )); then

				aSOFTWARE_INSTALL_STATE[103]=1
				(( aSOFTWARE_INSTALL_STATE[101] == 2 )) && aSOFTWARE_INSTALL_STATE[101]=-1
				(( aSOFTWARE_INSTALL_STATE[102] == 2 )) && aSOFTWARE_INSTALL_STATE[102]=-1

			#Logrotate + rsyslog - logs to disk
			elif (( $INDEX_LOGGING_TARGET == -3 )); then

				aSOFTWARE_INSTALL_STATE[101]=1
				aSOFTWARE_INSTALL_STATE[102]=1
				(( aSOFTWARE_INSTALL_STATE[103] == 2 )) && aSOFTWARE_INSTALL_STATE[103]=-1

			fi

			#Update Current Logging index
			INDEX_LOGGING_CURRENT=$INDEX_LOGGING_TARGET

		fi

	}

	Apply_Webserver_Preference(){

		if (( $INDEX_WEBSERVER_TARGET != $INDEX_WEBSERVER_CURRENT )); then

			#Update Current to Target
			INDEX_WEBSERVER_CURRENT=$INDEX_WEBSERVER_TARGET

		fi

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Configuration post installation goes here.
	#
	# Reference:
	# - Adding new software to DietPi-Software
	#   https://github.com/Fourdee/DietPi/issues/490#issuecomment-244416570
	#
	# Adding post installation steps.
	# ------------------------------------
	# - software_id:
	#   This has to be the same number as software_id for the software list above.
	#
	# Here you can add any configuration changes or addtions to systemd. After this
	# has run it will reload the systemd environment and start any services installed
	# and referenced in 'dietpi-services'
	#
	# Example:
	#	#------------------ Desktop: MATE ------------------
	#	software_id=24
	#	if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then
	#
	#		# - file manager desktop icon
	#		ln -sf /usr/share/applications/caja.desktop $HOME/Desktop/caja.desktop
	#
	#		Create_Desktop_Shared_Items
	#
	#		#Odroid C2, define default pulseaudio sink: https://github.com/Fourdee/DietPi/issues/415
	#		if (( $G_HW_MODEL == 12 )) &&
	#			! grep -qi '^set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo' /etc/pulse/default.pa; then
	#
	#			echo 'set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo' >> /etc/pulse/default.pa
	#
	#		fi
	#
	#	fi
	#
	#/////////////////////////////////////////////////////////////////////////////////////
	Install_Apply_Configs(){

		# Copy/Set optimised Software settings.
		# Set install states to 2 (installed).

		local software_id=0

		#DESKTOP_LXDE
		software_id=23
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Pre-create dirs
			mkdir -p $HOME/.config/openbox
			mkdir -p $HOME/.config/lxpanel/LXDE/panels
			mkdir -p $HOME/.config/pcmanfm/LXDE

			# - PCmanFM configs
			G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/lxde/pcmanfm.conf -O $HOME/.config/pcmanfm/LXDE/pcmanfm.conf
			G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/lxde/pcmanfm-desktopitems.conf -O $HOME/.config/pcmanfm/LXDE/desktop-items-0.conf

			# - Panel config
			G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/lxde/panel -O $HOME/.config/lxpanel/LXDE/panels/panel

			# - Openbox config
			G_THREAD_START wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/lxde/lxde-rc.xml -O $HOME/.config/openbox/lxde-rc.xml

			# - Remove Lxrandr Menu item (monitor configuration tool as we set res in dietpi-config)
			rm /usr/share/applications/lxrandr.desktop &> /dev/null

			# - Disable Trash
			G_CONFIG_INJECT 'use_trash=' 'use_trash=0' /etc/xdg/libfm/libfm.conf

			# - file manager desktop icon
			ln -sf /usr/share/applications/pcmanfm.desktop $HOME/Desktop/pcmanfm.desktop

			# - Firefox optimizations
			#	??? These keep adding new entries, ignore existing entry???
			# G_CONFIG_INJECT 'extensions.update.enabled' 'pref("extensions.update.enabled", false);' /etc/firefox-esr/firefox-esr.js
			# G_CONFIG_INJECT 'datareporting.healthreport.uploadEnabled' 'pref("datareporting.healthreport.uploadEnabled", false);' /etc/firefox-esr/firefox-esr.js
			# G_CONFIG_INJECT 'browser.cache.disk.parent_directory' 'pref("browser.cache.disk.parent_directory", "/tmp/firefox_cache");' /etc/firefox-esr/firefox-esr.js
			# G_CONFIG_INJECT 'general.smoothScroll' 'pref("general.smoothScroll", false);' /etc/firefox-esr/firefox-esr.js

			G_THREAD_WAIT

			Create_Desktop_Shared_Items

		fi

		#Desktop MATE
		software_id=24
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - file manager desktop icon
			ln -sf /usr/share/applications/caja.desktop $HOME/Desktop/caja.desktop

			Create_Desktop_Shared_Items

			#Odroid C2, define default pulseaudio sink: https://github.com/Fourdee/DietPi/issues/415
			if (( $G_HW_MODEL == 12 )) &&
				! grep -qi '^set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo' /etc/pulse/default.pa; then

				echo 'set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo' >> /etc/pulse/default.pa

			fi

		fi

		#Desktop GNUStep
		software_id=26
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			Create_Desktop_Shared_Items

		fi

		#DESKTOP_XFCE
		software_id=25
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			Create_Desktop_Shared_Items

		fi

		#WEBSERVER_APACHE
		software_id=83
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Apache2 confs
			G_BACKUP_FP /etc/apache2/apache2.conf
			dps_index=$software_id Download_Install 'apache2.conf' /etc/apache2/apache2.conf
			cat << _EOF_ > /etc/apache2/sites-available/000-default.conf
<VirtualHost *:80>
	ServerAdmin webmaster@localhost
	DocumentRoot /var/www

	ErrorLog \${APACHE_LOG_DIR}/error.log
	#CustomLog \${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
_EOF_

			cat << _EOF_ > /etc/apache2/mods-available/mpm_event.conf
<IfModule mpm_event_module>
	StartServers		$G_HW_CPU_CORES
	MinSpareThreads		1
	MaxSpareThreads		8
	ThreadLimit		16
	ThreadsPerChild		4
	MaxRequestWorkers	50
	MaxConnectionsPerChild	0
</IfModule>
_EOF_

			cat << _EOF_ > /etc/apache2/mods-available/mpm_prefork.conf
<IfModule mpm_prefork_module>
	StartServers		$G_HW_CPU_CORES
	MinSpareServers		1
	MaxSpareServers		$G_HW_CPU_CORES
	MaxRequestWorkers	50
	MaxConnectionsPerChild	0
</IfModule>
_EOF_

			cat << _EOF_ > /etc/apache2/mods-available/mpm_worker.conf
<IfModule mpm_worker_module>
	StartServers		$G_HW_CPU_CORES
	MinSpareThreads		1
	MaxSpareThreads		8
	ThreadLimit		16
	ThreadsPerChild		4
	MaxRequestWorkers	50
	MaxConnectionsPerChild	0
</IfModule>
_EOF_

			#Use /var/www as default webfolder
			mv /var/www/html/index.html /var/www/index.html &> /dev/null
			[[ $(ls -A /var/www/html 2>&1) ]] || rm -R /var/www/html

			# Change error log level
			sed -i '/LogLevel[[:blank:]]/c\	LogLevel error' /etc/apache2/sites-available/*

		fi

		#WEBSERVER_NGINX
		software_id=85
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# Custom confs, included by sites-enabled/default within server directive, while nginx/(conf.d|sites-enabled) is included by nginx.conf outside server directive
			mkdir /etc/nginx/sites-dietpi

			G_BACKUP_FP /etc/nginx/nginx.conf
			dps_index=$software_id Download_Install 'nginx.conf' /etc/nginx/nginx.conf
			# Adjust socket name to PHP version
			if (( $G_DISTRO < 4 )); then

				sed -i 's#/run/php/php7.0-fpm.sock#/run/php5-fpm.sock#g' /etc/nginx/nginx.conf

			elif (( $G_DISTRO > 4 )); then

				sed -i 's#php7.0-fpm.sock#php7.3-fpm.sock#g' /etc/nginx/nginx.conf

			fi

			# - CPU core count
			sed -i "/worker_processes/c\worker_processes $G_HW_CPU_CORES;" /etc/nginx/nginx.conf

			#Default site
			dps_index=$software_id Download_Install 'nginx.default' /etc/nginx/sites-available/default

			# - Nginx index page
			cp /usr/share/nginx/html/index.html /var/www/index.html
			[[ $(ls -A /var/www/html 2>&1) ]] || rm -R /var/www/html

		fi

		#WEBSERVER_LIGHTTPD
		software_id=84
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#www path
			G_BACKUP_FP /etc/lighttpd/lighttpd.conf
			sed -i '/^server.document-root/c\server.document-root        = "/var/www"' /etc/lighttpd/lighttpd.conf

			#Configure fastcgi for PHP-FPM
			local fp_php_fpm_sock='/var/run/php/php7.0-fpm.sock'
			if (( $G_DISTRO < 4 )); then

				fp_php_fpm_sock='/var/run/php5-fpm.sock'

			elif (( $G_DISTRO > 4 )); then

				fp_php_fpm_sock='/var/run/php/php7.3-fpm.sock'

			fi

			cat << _EOF_ > /etc/lighttpd/conf-available/15-fastcgi-php.conf
# -*- depends: fastcgi -*-
# /usr/share/doc/lighttpd/fastcgi.txt.gz
# http://redmine.lighttpd.net/projects/lighttpd/wiki/Docs:ConfigurationOptions#mod_fastcgi-fastcgi

## Start an FastCGI server using php-fpm
fastcgi.server += ( ".php" =>
        ((
                "socket" => "$fp_php_fpm_sock",
                "broken-scriptfilename" => "enable"
        ))
)
_EOF_

			#enable cgi/php
			lighttpd-enable-mod fastcgi
			lighttpd-enable-mod fastcgi-php

			#Move default page
			mv /var/www/html/index.lighttpd.html /var/www/
			[[ $(ls -A /var/www/html 2>&1) ]] || rm -R /var/www/html

		fi

		#WEBSERVER_PHP
		software_id=89
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Apache2 has its own PHP module
			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

				# https://github.com/Fourdee/DietPi/issues/1144
				local php_service='/lib/systemd/system/apache2.service'

			# - Nginx and Lighttpd use PHP-FPM
			elif (( ${aSOFTWARE_INSTALL_STATE[84]} >= 1 || ${aSOFTWARE_INSTALL_STATE[85]} >= 1 )); then

				local php_service='/lib/systemd/system/php*-fpm.service'

				# - PHP-FPM confs
				sed -i '/cgi.fix_pathinfo=/c\cgi.fix_pathinfo=1' "$FP_PHP_BASE_DIR"/fpm/php.ini

				# - PHP-FPM optimizations based on total cores
				sed -i "/pm.max_children = /c\pm.max_children = $(( $G_HW_CPU_CORES * 3 ))" "$FP_PHP_BASE_DIR"/fpm/pool.d/www.conf
				sed -i "/pm.start_servers = /c\pm.start_servers = $G_HW_CPU_CORES" "$FP_PHP_BASE_DIR"/fpm/pool.d/www.conf
				sed -i "/pm.min_spare_servers = /c\pm.min_spare_servers = $G_HW_CPU_CORES" "$FP_PHP_BASE_DIR"/fpm/pool.d/www.conf
				sed -i "/pm.max_spare_servers = /c\pm.max_spare_servers = $G_HW_CPU_CORES" "$FP_PHP_BASE_DIR"/fpm/pool.d/www.conf

				# - Enviroment PHP settings:
				sed -i "/env\[HOSTNAME\]/c\env\[HOSTNAME\] = \$HOSTNAME" "$FP_PHP_BASE_DIR"/fpm/pool.d/www.conf
				sed -i "/env\[PATH\]/c\env\[PATH\] = /usr/local/bin:/usr/bin:/bin" "$FP_PHP_BASE_DIR"/fpm/pool.d/www.conf

				#	/tmp is mounted to RAM, so use DISK (/var/tmp) instead
				sed -i "/env\[TMP\]/c\env\[TMP\] = /var/tmp" "$FP_PHP_BASE_DIR"/fpm/pool.d/www.conf
				sed -i "/env\[TMPDIR\]/c\env\[TMPDIR\] = /var/tmp" "$FP_PHP_BASE_DIR"/fpm/pool.d/www.conf
				sed -i "/env\[TEMP\]/c\env\[TEMP\] = /var/tmp" "$FP_PHP_BASE_DIR"/fpm/pool.d/www.conf

			fi

			# PHP cache settings
			local target_php_cachesize=$(( $RAM_TOTAL / 30 ))
			(( $target_php_cachesize < 10 )) && target_php_cachesize=10

			# - OPcache
			local target_php_ini="$FP_PHP_BASE_DIR/mods-available/opcache.ini"

			G_CONFIG_INJECT 'opcache.enable[[:blank:]]*=' 'opcache.enable=1' $target_php_ini
			G_CONFIG_INJECT 'opcache.memory_consumption[[:blank:]]*=' "opcache.memory_consumption=$target_php_cachesize" $target_php_ini
			G_CONFIG_INJECT 'opcache.revalidate_freq[[:blank:]]*=' 'opcache.revalidate_freq=60' $target_php_ini

			# - APCu
			target_php_ini="$FP_PHP_BASE_DIR/mods-available/apcu.ini"
			#	- apc.shm_size= requires M at end to prevent warning: https://github.com/Fourdee/DietPi/issues/218
			target_php_cachesize+='M'
			#	- 3days TTL
			local target_apc_ttl='259200'

			G_CONFIG_INJECT 'apc.shm_size[[:blank:]]*=' "apc.shm_size=$target_php_cachesize" $target_php_ini
			G_CONFIG_INJECT 'apc.ttl[[:blank:]]*=' "apc.ttl=$target_apc_ttl" $target_php_ini

			# We create our own PHP mod to add DietPi specific configs.
			target_php_ini="$FP_PHP_BASE_DIR/mods-available/dietpi.ini"
			echo -e '; DietPi PHP settngs\n; priority=99' > $target_php_ini

			# - Set tmp_upload_dir to sd. Can't be /tmp as its ramdisk and limited size. Also used by ownCloud/Nextcloud uploads
			#	- If PHP uses PrivateTmp, we must not use own subfolder: https://github.com/Fourdee/DietPi/issues/1144
			if [[ -f $php_service ]] && grep -q '^[[:blank:]]*PrivateTmp=true' $php_service; then

				local tmp_upload_dir='/var/tmp'

			else

				local tmp_upload_dir='/var/tmp/php_upload_tmp'
				mkdir -p $tmp_upload_dir
				chown -R www-data:www-data $tmp_upload_dir

			fi
			G_CONFIG_INJECT 'upload_tmp_dir[[:blank:]]*=' "upload_tmp_dir=$tmp_upload_dir" $target_php_ini

			# - max upload size
			local php_max_upload_size="$(( $(php -r 'print(PHP_INT_MAX);') / 1024 / 1024))M"
			#	- upload_max_filesize
			G_CONFIG_INJECT 'upload_max_filesize[[:blank:]]*=' "upload_max_filesize=$php_max_upload_size" $target_php_ini
			#	- post_max_size
			G_CONFIG_INJECT 'post_max_size[[:blank:]]*=' "post_max_size=$php_max_upload_size" $target_php_ini
			#	- Nginx - Set client_max_body_size to avoid 2MB upload error: https://github.com/Fourdee/DietPi/issues/546
			if (( ${aSOFTWARE_INSTALL_STATE[85]} >= 1 )); then

				sed -i "/client_max_body_size/c\    client_max_body_size $php_max_upload_size;" /etc/nginx/nginx.conf

			fi

			# - Set UTF-8
			G_CONFIG_INJECT 'default_charset[[:blank:]]*=' 'default_charset="UTF-8"' $target_php_ini

			# Enable all installed and available PHP modules.
			local modules_to_enable=$(ls "$FP_PHP_BASE_DIR"/mods-available | grep '.ini' | sed 's/.ini//')
			${PHP_BINARY}enmod "$modules_to_enable"

			# Create PHP info pages within webroot, if webserver is installed.
			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 ||
				${aSOFTWARE_INSTALL_STATE[84]} >= 1 ||
				${aSOFTWARE_INSTALL_STATE[85]} >= 1 )); then

				# PHP info page
				echo '<?php phpinfo(); ?>' > /var/www/phpinfo.php

				#	OPcache info page
				G_THREAD_START wget https://raw.githubusercontent.com/rlerdorf/opcache-status/master/opcache.php -O /var/www/opcache.php
				#	APC info page
				G_THREAD_START wget https://github.com/krakjoe/apcu/raw/master/apc.php -O /var/www/apc.php

				G_THREAD_WAIT

			fi

		fi

		#WEBSERVER_MARIADB
		software_id=88
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# On Jessie assure unix_socket authentication:
			if (( $G_DISTRO < 4 )); then

				G_RUN_CMD systemctl start $MARIADB_SERVICE
				mysql -e "install plugin unix_socket soname 'auth_socket';" &> /dev/null
				mysql -e "grant all privileges on *.* to 'root'@'localhost' identified via unix_socket with grant option;flush privileges"
				# Drop unnecessary root user children.
				mysql -e "drop user 'root'@'dietpi';drop user 'root'@'127.0.0.1';drop user 'root'@'::1'" &> /dev/null

			fi

			### Also for MariaDB?
			# Optimize for reduced memory use: https://github.com/Fourdee/DietPi/issues/605#issue-188930987
			#cat << _EOF_ > /etc/mysql/conf.d/reduce_resources.cnf
#[mysqld]
#key_buffer_size=8M
#max_connections=30
#query_cache_size=8M
#query_cache_limit=512K
#thread_stack=128K
#_EOF_

		fi

		#WEBSERVER_MYADMINPHP
		software_id=90
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#NGINX LIGHTTPD symlink to var www
			if (( ${aSOFTWARE_INSTALL_STATE[84]} > 0 ||
				${aSOFTWARE_INSTALL_STATE[85]} > 0 )); then

				ln -sf /usr/share/phpmyadmin /var/www

			fi

			# Due to MariaDB unix_socket authentication, "root" cannot be used to login the web ui.
			# Thus default "phpmyadmin" user need to be used, who on Jessie does not have all privileges:
			# https://dietpi.com/phpbb/viewtopic.php?f=8&t=5&p=54#p54
			systemctl start $MARIADB_SERVICE
			mysql -e 'grant all privileges on *.* to phpmyadmin@localhost with grant option'

		fi

		#WEBSERVER_REDIS
		software_id=91
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# Enable redis php module, if installed:
			${PHP_BINARY}enmod redis 2> /dev/null

		fi

		#OPENBAZAAR
		software_id=58
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Data dir
			mkdir -p $G_FP_DIETPI_USERDATA/openbazaar

			# - Init OB to have config file available, if not yet the case, and edit to allow remote client access
			if [[ ! -f $G_FP_DIETPI_USERDATA/openbazaar/config ]]; then

				openbazaar-go init -d $G_FP_DIETPI_USERDATA/openbazaar

				# - Add current IP as gateway to allow external client connection
				G_CONFIG_INJECT '"Gateway": "' "    \"Gateway\": \"/ip4/$(sed -n 4p /DietPi/dietpi/.network)/tcp/4002\"," $G_FP_DIETPI_USERDATA/openbazaar/config

				# - Client connection user/password
				G_DIETPI-NOTIFY 2 "Please enter username and password for your ${aSOFTWARE_WHIP_NAME[$software_id]} client connection:"
				openbazaar-go setapicreds -d $G_FP_DIETPI_USERDATA/openbazaar

				# - Client IP needs to be added to allowed IP list
				local ob_client_ip=''
				local invalid_entry=''
				while :
				do

					G_WHIP_INPUTBOX "${invalid_entry}Please enter the IP address of your ${aSOFTWARE_WHIP_NAME[$software_id]} client machine
This is required, since the ${aSOFTWARE_WHIP_NAME[$software_id]} server node by default does not allow any remote connection."
					if (( ! $? )) && [[ $G_WHIP_RETURNED_VALUE =~ ^[0-9.]+$ ]]; then

						ob_client_ip=$G_WHIP_RETURNED_VALUE
						break

					else

						invalid_entry='[FAILED] Please enter a valid IP address\n\n'

					fi

				done
				GCI_NEWLINE=1 G_CONFIG_INJECT '"AllowedIPs":' "    \"AllowedIPs\": [\n      \"$ob_client_ip\"\n    ]," $G_FP_DIETPI_USERDATA/openbazaar/config

			else

				G_DIETPI-NOTIFY 2 "Existing ${aSOFTWARE_WHIP_NAME[$software_id]} config found. Skipping pre-configuration..."

			fi

			# - service
			cat << _EOF_ > /etc/systemd/system/openbazaar.service
[Unit]
Description=OpenBazaar (DietPi)

[Service]
Type=simple
Environment=GOPATH=$G_FP_DIETPI_USERDATA/go
WorkingDirectory=$G_FP_DIETPI_USERDATA/go
ExecStart=$(which openbazaar-go) start -d $G_FP_DIETPI_USERDATA/openbazaar

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#YaCy
		software_id=133
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			chmod +x -R /etc/yacy

			cat << _EOF_ > /etc/systemd/system/yacy.service
[Unit]
Description=YaCy (DietPi)

[Service]
Type=simple
RemainAfterExit=yes
ExecStart=/bin/bash -c '/etc/yacy/startYACY.sh'
ExecStop=/bin/bash -c '/etc/yacy/stopYACY.sh'

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl daemon-reload

			#	Create admin login account:
			/etc/yacy/bin/passwd.sh "$GLOBAL_PW"

		fi

		#Folding@Home
		software_id=2
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# Remove old data + config directories and init.d service
			rm -R /var/lib/fahclient
			rm -R /etc/fahclient
			rm /etc/init.d/FAHClient

			# Create new working (data + config) directory and log file
			mkdir -p $G_FP_DIETPI_USERDATA/fahclient
			> /var/log/fahclient.log

			# Create new systemd service
			cat << _EOF_ > /lib/systemd/system/fahclient.service
[Unit]
Description=Folding@Home (DietPi)

[Service]
Type=simple
User=fahclient
Group=dietpi
WorkingDirectory=$G_FP_DIETPI_USERDATA/fahclient
ExecStart=$(which FAHClient) --allow='0/0' --web-allow='0/0' --daemon=false --user=DietPi --team=234437 --passkey=06c869246e88c00cb05cc4d1758a97f9 --gpu=true --log-rotate=false --log=/var/log/fahclient.log --power=light --data-directory=$G_FP_DIETPI_USERDATA/fahclient

[Install]
WantedBy=multi-user.target

_EOF_

		fi

		#ownCloud
		software_id=47
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			G_DIETPI-NOTIFY 2 'Enabling needed PHP modules.' # https://doc.owncloud.org/server/latest/admin_manual/installation/source_installation.html#php-extensions
			${PHP_BINARY}enmod curl gd intl json pdo_mysql opcache apcu redis
			# Following modules are switchable since Stretch:
			if (( $G_DISTRO > 3 )); then

				phpenmod ctype dom fileinfo iconv mbstring posix simplexml xmlwriter xmlreader zip exif

			fi

			G_DIETPI-NOTIFY 2 'Enabling APCu memory cache for PHP command line usage (CLI) as well, including ownCloud occ command and cron jobs.'
			G_CONFIG_INJECT 'apc.enable_cli[[:blank:]=]' 'apc.enable_cli=1' "$FP_PHP_BASE_DIR/mods-available/apcu.ini"

			if (( ${aSOFTWARE_INSTALL_STATE[83]} > 0 )); then

				G_DIETPI-NOTIFY 2 'Apache webserver found, enabling ownCloud specific configuration.' # https://doc.owncloud.org/server/latest/admin_manual/installation/source_installation.html#configure-apache-web-server
				a2enmod rewrite headers env dir mime 1> /dev/null
				local owncloud_conf='/etc/apache2/sites-available/dietpi-owncloud.conf'
				if [[ -f $owncloud_conf ]]; then

					owncloud_conf+='.dietpi-new'
					G_WHIP_MSG "Existing ownCloud Apache configuration found, will preserve the old one and save the new one for review and comparison to: $owncloud_conf"

				fi
				dps_index=$software_id Download_Install 'apache.owncloud.conf' $owncloud_conf
				a2ensite owncloud 1> /dev/null
				# Cal/CardDAV redirects to ownCloud DAV endpoint
				if [[ ! -f /etc/apache2/conf-available/dietpi-dav_redirect.conf ]]; then

					echo '# Redirect Cal/CardDAV requests to ownCloud endpoint:
Redirect permanent /.well-known/carddav /owncloud/remote.php/dav
Redirect permanent /.well-known/caldav /owncloud/remote.php/dav' > /etc/apache2/conf-available/dietpi-dav_redirect.conf
					a2enconf dietpi-dav_redirect

				fi

			elif (( ${aSOFTWARE_INSTALL_STATE[84]} > 0 )); then

				G_DIETPI-NOTIFY 2 'Lighttpd webserver found, enabling ownCloud specific configuration.'
				# Cal/CardDAV redirects to ownCloud DAV endpoint
				if [[ ! -f /etc/lighttpd/conf-enabled/99-dietpi-dav_redirect.conf ]]; then

					echo '# Redirect Cal/CardDAV requests to ownCloud endpoint:
url.redirect = (
	"^/.well-known/caldav"  => "/owncloud/remote.php/dav",
	"^/.well-known/carddav" => "/owncloud/remote.php/dav"
)' > /etc/lighttpd/conf-available/99-dietpi-dav_redirect.conf
					lighttpd-enable-mod dietpi-dav_redirect

				fi

			elif (( ${aSOFTWARE_INSTALL_STATE[85]} > 0 )); then

				G_DIETPI-NOTIFY 2 'Nginx webserver found, enabling ownCloud specific configuration.' # https://doc.owncloud.org/server/latest/admin_manual/installation/nginx_configuration.html#owncloud-in-a-subdir-of-nginx
				local owncloud_conf='/etc/nginx/sites-dietpi/dietpi-owncloud.conf'
				if [[ -f $owncloud_conf ]]; then

					owncloud_conf+='.dietpi-new'
					G_WHIP_MSG "Existing ownCloud Nginx configuration found, will preserve the old one and save the new one for review and comparison to: $owncloud_conf"

				fi

				dps_index=$software_id Download_Install 'nginx.owncloud.conf' $owncloud_conf

				# Stretch: Set 'fastcgi_request_buffering off';
				if (( $G_DISTRO > 3 )); then

					sed -i 's/#fastcgi_request_buffering off;/fastcgi_request_buffering off;/g' $owncloud_conf

				fi

				# Set HTTPS on, if SSL connection is available, even with self-signed/untrusted certificate.
				wget -q --spider --timeout=10 --tries=2 https://localhost &> /dev/null
				if (( $? == 0 || $? == 5)); then

					sed -i 's/#fastcgi_param HTTPS on;/fastcgi_param HTTPS on;/g' $owncloud_conf

				fi

				# Disable pretty URLs (front controller), if ownCloud version is lower than 10:
				if (( $(grep '$OC_VersionString' /var/www/owncloud/version.php | sed "s/^.*= '//" | sed "s/\..*$//") < 10 )); then

					sed -i 's/^[[:blank:]]*fastcgi_param front_controller_active true;/\t#fastcgi_param front_controller_active true;/g' $owncloud_conf

				fi

				# Cal/CardDAV redirects to ownCloud DAV endpoint
				if [[ ! -f /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf ]]; then

					echo '# Redirect Cal/CardDAV requests to ownCloud endpoint:
location = /.well-known/carddav {
	return 301 $scheme://$host/owncloud/remote.php/dav;
}
location = /.well-known/caldav {
	return 301 $scheme://$host/owncloud/remote.php/dav;
}' > /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf

				fi

			fi

			G_DIETPI-NOTIFY 2 'Enable 4-byte support for MariaDB.' # https://doc.owncloud.org/server/latest/admin_manual/configuration/database/linux_database_configuration.html#configure-mysql-for-4-byte-unicode-support
			local fp_mariadb_conf='/etc/mysql/mariadb.conf.d'
			# On Jessie (MariaDB 10.0), /etc/mysql/mariadb.conf.d does not yet exist
			(( G_DISTRO < 4 )) && fp_mariadb_conf='/etc/mysql/conf.d'
			cat << _EOF_ > $fp_mariadb_conf/99-dietpi-4byte.cnf
[mysqld]
innodb_large_prefix=1
innodb_file_format=barracuda
innodb_file_per_table=1
character-set-server=utf8mb4
collation-server=utf8mb4_general_ci
_EOF_
			G_RUN_CMD systemctl restart $MARIADB_SERVICE

			# Start redis-server, which is required for ncc command:
			G_RUN_CMD systemctl start redis-server

			# Initially add occ command shortcut, will be done by Dietpi-Globals automatically, if occ file exist:
			occ(){ sudo -u www-data php /var/www/owncloud/occ "$@"; }

			# Adjusting config file:
			local config_php='/var/www/owncloud/config/config.php'

			local datadir="$(grep -m1 '^[[:blank:]]*SOFTWARE_OWNCLOUD_DATADIR=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')"
			[[ $datadir ]] || datadir="$G_FP_DIETPI_USERDATA/owncloud_data"
			mkdir -p $datadir
			chown -R www-data:www-data $datadir

			if [[ -d $G_FP_DIETPI_USERDATA/mysql/owncloud ]]; then

				G_DIETPI-NOTIFY 2 'ownCloud database found, will NOT overwrite.'

			else

				if [[ -f $datadir/dietpi-owncloud-database-backup.sql ]]; then

					G_DIETPI-NOTIFY 2 'ownCloud database backup found, starting recovery...'
					local dbuser=$(grep -m1 "^[[:blank:]]*'dbuser'" $config_php | awk '{print $3}' | sed "s/[',]//g")
					local dbpass=$(grep -m1 "^[[:blank:]]*'dbpassword'" $config_php | awk '{print $3}' | sed "s/[',]//g")
					/DietPi/dietpi/func/create_mysql_db owncloud "$dbuser" "$dbpass"
					mysql owncloud < "$datadir"/dietpi-owncloud-database-backup.sql
					### Seems to be not needed anymore and can cause double entries: https://help.nextcloud.com/t/howto-change-move-data-directory-after-installation/17170/3?u=michaing
					# Adjust database data directory entry, in case it changed due to server migration:
					#mysql -e "update owncloud.oc_storages set id='local::$datadir/' where id rlike 'local::'"

				else

					local username="$(grep -m1 '^[[:blank:]]*SOFTWARE_OWNCLOUD_NEXTCLOUD_USERNAME=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')"
					[[ $username ]] || username='admin'

					# For MariaDB, temporary database admin user needs to be created, as 'root' uses unix_socket login, which cannot be accessed by sudo -u www-data.
					mysql -e "grant all privileges on *.* to 'tmp_root'@'localhost' identified by '$GLOBAL_PW' with grant option"
					if ! grep -q "'installed' => true," $config_php 2>/dev/null; then

						G_ERROR_HANDLER_COMMAND='occ maintenance:install'
						G_ERROR_HANDLER_ONERROR_FPLOGFILE='G_ERROR_HANDLER_OCC'
						occ maintenance:install --no-interaction --database 'mysql' --database-name 'owncloud' --database-user 'tmp_root' --database-pass "$GLOBAL_PW" --admin-user "$username" --admin-pass "$GLOBAL_PW" --data-dir "$datadir" &> G_ERROR_HANDLER_OCC
						G_ERROR_HANDLER_EXITCODE=$?
						if (( ! $G_ERROR_HANDLER_EXITCODE )) && grep -qi 'Stack trace' G_ERROR_HANDLER_OCC; then

							G_ERROR_HANDLER_EXITCODE=999 # Our individual error code for unhandled exceptions

						fi
						G_ERROR_HANDLER
						rm G_ERROR_HANDLER_OCC
						# Remove obsolete default data dir
						[[ $(readlink -f $datadir) != $(readlink -f /var/www/owncloud/data) ]] && rm -R /var/www/owncloud/data

					fi
					mysql -e "drop user 'tmp_root'@'localhost'"

				fi

			fi

			# Enable ownCloud to use 4-byte database
			G_CONFIG_INJECT "'mysql.utf8mb4'" "'mysql.utf8mb4' => true," $config_php "'dbpassword'"

			# Add local IP and hostname to trusted domains.
			# If "1 => '" does not exist, the config.php is not copied e.g. from older instance, so we add entries.
			if ! grep -q "1 => '" $config_php; then

				sed -i "/0 => 'localhost'/a     1 => '$(sed -n 4p /DietPi/dietpi/.network)'," $config_php
				sed -i "/1 => '/a     2 => '$(cat /etc/hostname)'," $config_php

			fi

			# Set CLI URL to ownCloud sub directory:
			sed -i "s|'http://localhost'|'http://localhost/owncloud'|g" $config_php

			# Set pretty URLs (without /index.php/) on Apache:
			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

				GCI_PRESERVE=1 G_CONFIG_INJECT "'htaccess.RewriteBase'" "'htaccess.RewriteBase' => '/owncloud'," $config_php "'overwrite.cli.url'"
				occ maintenance:update:htaccess

			fi

			# APCu Memcache
			GCI_PRESERVE=1 G_CONFIG_INJECT "'memcache.local'" "'memcache.local' => '\\\\OC\\\\Memcache\\\\APCu'," $config_php "'version'"

			# Redis for transactional file locking:
			G_DIETPI-NOTIFY 2 'Enabling Redis for transactional file locking.' # https://doc.owncloud.org/server/latest/admin_manual/configuration/server/caching_configuration.html#configuring-transactional-file-locking
			local redis_conf="/etc/redis/redis*.conf"
			# - Enable Redis socket and grant www-data access to it:
			#	- NB: To allow wildcard expansion, do not use quotes around $redis_conf!
			GCI_PRESERVE=1 G_CONFIG_INJECT 'unixsocket[[:blank:]]' 'unixsocket /var/run/redis/redis-server.sock' $redis_conf
			G_CONFIG_INJECT 'unixsocketperm[[:blank:]]' 'unixsocketperm 770' $redis_conf
			local redis_sock=$(grep -m1 '^[[:blank:]]*unixsocket[[:blank:]]' $redis_conf | awk '{print $2}')
			usermod -a -G redis www-data
			G_RUN_CMD systemctl restart redis-server
			# - Enable ownCloud to use Redis socket for transactional file locking:
			G_CONFIG_INJECT "'filelocking.enabled'" "'filelocking.enabled' => true," $config_php "'memcache.local'"
			GCI_PRESERVE=1 GCI_NEWLINE=1 G_CONFIG_INJECT "'memcache.locking'" "'memcache.locking' => '\\\\OC\\\\Memcache\\\\Redis',\n'redis' => array ('host' => '$redis_sock', 'port' => 0,)," $config_php "'filelocking.enabled'"

			# Enable ownCloud background cron job:
			crontab -u www-data -l 2>/dev/null | grep -q '/var/www/owncloud/cron.php' || ( crontab -u www-data -l 2>/dev/null ; echo "*/15 * * * * php /var/www/owncloud/cron.php" ) | crontab -u www-data -
			occ background:cron

			# Enable maintenance mode to allow handling by dietpi-services:
			grep -q "^[[:blank:]]*'maintenance' => true," $config_php || occ maintenance:mode --on

		fi

		#Nextcloud
		software_id=114
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			G_DIETPI-NOTIFY 2 'Enabling needed PHP modules.' # https://docs.nextcloud.com/server/14/admin_manual/installation/source_installation.html#prerequisites-label
			${PHP_BINARY}enmod curl gd intl json pdo_mysql opcache apcu redis
			# Following modules are switchable since Stretch:
			if (( $G_DISTRO > 3 )); then

				phpenmod ctype dom fileinfo iconv mbstring posix simplexml xmlwriter xmlreader zip exif

			fi

			G_DIETPI-NOTIFY 2 'Enabling APCu memory cache for PHP command line usage (CLI) as well, including Nextcloud ncc command and cron jobs.'
			G_CONFIG_INJECT 'apc.enable_cli[[:blank:]=]' 'apc.enable_cli=1' "$FP_PHP_BASE_DIR/mods-available/apcu.ini"

			G_DIETPI-NOTIFY 2 'Enabling and configuring OPcache for Nextcloud.' # https://docs.nextcloud.com/server/14/admin_manual/configuration_server/server_tuning.html#enable-php-opcache
			G_CONFIG_INJECT 'opcache.enable[[:blank:]=]' 'opcache.enable=1' "$FP_PHP_BASE_DIR/mods-available/opcache.ini"
			G_CONFIG_INJECT 'opcache.enable_cli[[:blank:]=]' 'opcache.enable_cli=1' "$FP_PHP_BASE_DIR/mods-available/opcache.ini"
			G_CONFIG_INJECT 'opcache.interned_strings_buffer[[:blank:]=]' 'opcache.interned_strings_buffer=8' "$FP_PHP_BASE_DIR/mods-available/opcache.ini"
			G_CONFIG_INJECT 'opcache.max_accelerated_files[[:blank:]=]' 'opcache.max_accelerated_files=10000' "$FP_PHP_BASE_DIR/mods-available/opcache.ini"
			G_CONFIG_INJECT 'opcache.save_comments[[:blank:]=]' 'opcache.save_comments=1' "$FP_PHP_BASE_DIR/mods-available/opcache.ini"
			G_CONFIG_INJECT 'opcache.revalidate_freq[[:blank:]=]' 'opcache.revalidate_freq=1' "$FP_PHP_BASE_DIR/mods-available/opcache.ini"

			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

				G_DIETPI-NOTIFY 2 'Apache webserver found, enabling Nextcloud specific configuration.' # https://docs.nextcloud.com/server/14/admin_manual/installation/source_installation.html#apache-web-server-configuration
				a2enmod rewrite headers env dir mime 1> /dev/null
				local nextcloud_conf='/etc/apache2/sites-available/dietpi-nextcloud.conf'
				if [[ -f $nextcloud_conf ]]; then

					nextcloud_conf+='.dietpi-new'
					G_WHIP_MSG "Existing Nextcloud Apache configuration found, will preserve the old one and save the new one for review and comparison to: $nextcloud_conf"

				fi
				G_RUN_CMD cp -f /DietPi/dietpi/conf/apache.nextcloud.conf $nextcloud_conf
				a2ensite nextcloud 1> /dev/null
				# Cal/CardDAV redirects to Nextcloud DAV endpoint
				if [[ ! -f /etc/apache2/conf-available/dietpi-dav_redirect.conf ]]; then

					echo '# Redirect Cal/CardDAV requests to Nextcloud endpoint:
Redirect permanent /.well-known/carddav /nextcloud/remote.php/dav
Redirect permanent /.well-known/caldav /nextcloud/remote.php/dav' > /etc/apache2/conf-available/dietpi-dav_redirect.conf
					a2enconf dietpi-dav_redirect

				fi

			elif (( ${aSOFTWARE_INSTALL_STATE[84]} >= 1 )); then

				G_DIETPI-NOTIFY 2 'Lighttpd webserver found, enabling Nextcloud specific configuration.'

				# Enable mod_setenv
				G_CONFIG_INJECT '"mod_setenv",' '	"mod_setenv",' /etc/lighttpd/lighttpd.conf '"mod_.+",'

				# Move Nextcloud configuration file in place and activate it
				nextcloud_conf='/etc/lighttpd/conf-available/99-dietpi-nextcloud.conf'
				if [[ -f $nextcloud_conf ]]; then

					nextcloud_conf+='.dietpi-new'
					G_WHIP_MSG "Existing Nextcloud Lighttpd configuration found, will preserve the old one and save the new one for review and comparison to: $nextcloud_conf"

				fi
				dps_index=$software_id Download_Install 'lighttpd.nextcloud.conf' $nextcloud_conf
				lighttpd-enable-mod dietpi-nextcloud

				# Cal/CardDAV redirects to Nextcloud DAV endpoint
				if [[ ! -f /etc/lighttpd/conf-enabled/99-dietpi-dav_redirect.conf ]]; then

					echo '# Redirect Cal/CardDAV requests to Nextcloud endpoint:
url.redirect = (
	"^/.well-known/caldav"  => "/nextcloud/remote.php/dav",
	"^/.well-known/carddav" => "/nextcloud/remote.php/dav"
)' > /etc/lighttpd/conf-available/99-dietpi-dav_redirect.conf
					lighttpd-enable-mod dietpi-dav_redirect

				fi

			elif (( ${aSOFTWARE_INSTALL_STATE[85]} > 0 )); then

				G_DIETPI-NOTIFY 2 'Nginx webserver found, enabling Nextcloud specific configuration.' # https://docs.nextcloud.com/server/14/admin_manual/installation/nginx.html#nextcloud-in-a-subdir-of-nginx
				local nextcloud_conf='/etc/nginx/sites-dietpi/dietpi-nextcloud.conf'
				if [[ -f $nextcloud_conf ]]; then

					nextcloud_conf+='.dietpi-new'
					G_WHIP_MSG "Existing Nextcloud Nginx configuration found, will preserve the old one and save the new one for review and comparison to: $nextcloud_conf"

				fi
				dps_index=$software_id Download_Install 'nginx.nextcloud.conf' $nextcloud_conf

				# Stretch: Set 'fastcgi_request_buffering off';
				if (( $G_DISTRO > 3 )); then

					sed -i 's/#fastcgi_request_buffering off;/fastcgi_request_buffering off;/g' $nextcloud_conf

				fi

				# Set HTTPS on, if SSL connection is available, even with self-signed/untrusted certificate.
				wget -q --spider --timeout=10 --tries=2 https://localhost &> /dev/null
				if (( $? == 0 || $? == 5)); then

					sed -i 's/#fastcgi_param HTTPS on;/fastcgi_param HTTPS on;/g' $nextcloud_conf

				fi

				# Disable pretty URLs (front controller), if Nextcloud version is lower than 13:
				if (( $(grep '$OC_VersionString' /var/www/nextcloud/version.php | sed "s/^.*= '//" | sed "s/\..*$//") < 13 )); then

					sed -i 's/^[[:blank:]]*fastcgi_param front_controller_active true;/\t#fastcgi_param front_controller_active true;/g' $nextcloud_conf

				fi

				# Cal/CardDAV redirects to Nextcloud DAV endpoint
				if [[ ! -f /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf ]]; then

					echo '# Redirect Cal/CardDAV requests to Nextcloud endpoint:
location = /.well-known/carddav {
	return 301 $scheme://$host/nextcloud/remote.php/dav;
}
location = /.well-known/caldav {
	return 301 $scheme://$host/nextcloud/remote.php/dav;
}' > /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf

				fi

			fi

			G_DIETPI-NOTIFY 2 'Enable 4-byte support for MariaDB' # https://docs.nextcloud.com/server/14/admin_manual/configuration_database/mysql_4byte_support.html
			local fp_mariadb_conf='/etc/mysql/mariadb.conf.d'
			# On Jessie (MariaDB 10.0), /etc/mysql/mariadb.conf.d does not yet exist
			(( G_DISTRO < 4 )) && fp_mariadb_conf='/etc/mysql/conf.d'
			cat << _EOF_ > $fp_mariadb_conf/99-dietpi-4byte.cnf
[mysqld]
innodb_large_prefix=1
innodb_file_format=barracuda
innodb_file_per_table=1
character-set-server=utf8mb4
collation-server=utf8mb4_general_ci
_EOF_
			G_RUN_CMD systemctl restart $MARIADB_SERVICE

			# Start redis-server, which is required for ncc command:
			G_RUN_CMD systemctl start redis-server

			# Initially add occ command shortcut, will be done by Dietpi-Globals automatically, if occ file exist:
			ncc(){ sudo -u www-data php /var/www/nextcloud/occ "$@"; }

			# Adjusting config file:
			local config_php='/var/www/nextcloud/config/config.php'

			local datadir="$(grep -m1 '^[[:blank:]]*SOFTWARE_NEXTCLOUD_DATADIR=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')"
			[[ $datadir ]] || datadir="$G_FP_DIETPI_USERDATA/nextcloud_data"
			mkdir -p $datadir
			chown www-data:www-data $datadir

			if [[ -d $G_FP_DIETPI_USERDATA/mysql/nextcloud ]]; then

				G_DIETPI-NOTIFY 2 'Nextcloud database found, will NOT overwrite.'
				if [[ ! -f $config_php ]]; then

					G_WHIP_MSG '[WARNING] Existing Nextcloud database was found, but no related install directory\n
A remaining MariaDB "nextcloud" database from an earlier installed instance was found. But the related install directory "/var/www/nextcloud/config/config.php" does not exist.
Since running a fresh install with an existing database can produce data corruption, if the versions do not exactly match, you either need to remove the database or find and place the related install directory.\n
We cannot predict your aim and do not want to mess or break your data, so please do this manually.\n
To remove the existing database (including e.g. contacts, calendar, file tags etc.):
	# mysqladmin drop nextcloud
Otherwise to copy an existing instance in place:
	# rm -R /var/www/nextcloud
	# cp -a /path/to/existing/nextcloud/. /var/www/nextcloud
	# chown -R www-data:www-data /var/www/nextcloud\n
The install script will now exit. After applying one of the the above, rerun dietpi-software, e.g.:
	# dietpi-software install 114'

					[[ -f /var/www/nextcloud/occ ]] && rm /var/www/nextcloud/occ
					/DietPi/dietpi/dietpi-services start
					exit 1

				fi

			else

				if [[ -f $datadir/dietpi-nextcloud-database-backup.sql ]]; then

					G_DIETPI-NOTIFY 2 'Nextcloud database backup found, starting recovery...'
					local dbuser=$(grep -m1 "^[[:blank:]]*'dbuser'" $config_php | awk '{print $3}' | sed "s/[',]//g")
					local dbpass=$(grep -m1 "^[[:blank:]]*'dbpassword'" $config_php | awk '{print $3}' | sed "s/[',]//g")
					/DietPi/dietpi/func/create_mysql_db nextcloud "$dbuser" "$dbpass"
					mysql nextcloud < $datadir/dietpi-nextcloud-database-backup.sql
					### Seems to be not needed anymore and can cause double entries: https://help.nextcloud.com/t/howto-change-move-data-directory-after-installation/17170/3?u=michaing
					# Adjust database data directory entry, in case it changed due to server migration:
					#mysql -e "update nextcloud.oc_storages set id='local::$datadir/' where id rlike 'local::'"

				else

					local username="$(grep -m1 '^[[:blank:]]*SOFTWARE_OWNCLOUD_NEXTCLOUD_USERNAME=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')"
					[[ $username ]] || username='admin'

					# For MariaDB, temporary database admin user needs to be created, as 'root' uses unix_socket login, which cannot be accessed by sudo -u www-data.
					mysql -e "grant all privileges on *.* to 'tmp_root'@'localhost' identified by '$GLOBAL_PW' with grant option"
					if ! grep -q "'installed' => true," $config_php 2>/dev/null; then

						G_ERROR_HANDLER_COMMAND='ncc maintenance:install'
						G_ERROR_HANDLER_ONERROR_FPLOGFILE='G_ERROR_HANDLER_NCC'
						ncc maintenance:install --no-interaction --database 'mysql' --database-name 'nextcloud' --database-user 'tmp_root' --database-pass "$GLOBAL_PW" --admin-user "$username" --admin-pass "$GLOBAL_PW" --data-dir "$datadir" &> G_ERROR_HANDLER_NCC
						G_ERROR_HANDLER_EXITCODE=$?
						if (( ! G_ERROR_HANDLER_EXITCODE )) && grep -qi 'Stack trace' G_ERROR_HANDLER_NCC; then

							G_ERROR_HANDLER_EXITCODE=999 # Our individual error code for unhandled exceptions

						fi
						# Workaround Nextcloud 14.0.3 throwing an error, when data dir path contains a symlink: https://github.com/nextcloud/server/issues/12247
						if (( $G_DISTRO > 3 )) && [[ $(readlink -f $datadir) != $datadir ]]; then

							G_ERROR_HANDLER_RESET
							# Install with this error does not copy over skeleton
							cp -a /var/www/nextcloud/core/skeleton/. "$datadir/$username/files"

						else

							G_ERROR_HANDLER

						fi
						rm G_ERROR_HANDLER_NCC
						# Remove obsolete default data dir
						[[ $(readlink -f $datadir) != $(readlink -f /var/www/nextcloud/data) ]] && rm -R /var/www/nextcloud/data

					fi
					mysql -e "drop user 'tmp_root'@'localhost'"

				fi

			fi

			# Enable Nextcloud to use 4-byte database
			G_CONFIG_INJECT "'mysql.utf8mb4'" "'mysql.utf8mb4' => true," $config_php "'dbpassword'"

			# Disable trusted_domains.
			if ! grep -q "1 => '*'" $config_php; then

				sed -i "/0 => 'localhost'/a     1 => '*'," $config_php

			fi

			# Set CLI URL to Nextcloud sub directory:
			sed -i "s|'http://localhost'|'http://localhost/nextcloud'|g" $config_php

			# Set pretty URLs (without /index.php/) on Apache:
			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

				GCI_PRESERVE=1 G_CONFIG_INJECT "'htaccess.RewriteBase'" "'htaccess.RewriteBase' => '/nextcloud'," $config_php "'overwrite.cli.url'"
				ncc maintenance:update:htaccess

			fi

			# APCu Memcache
			GCI_PRESERVE=1 G_CONFIG_INJECT "'memcache.local'" "'memcache.local' => '\\\\OC\\\\Memcache\\\\APCu'," $config_php "'version'"

			# Redis for transactional file locking:
			G_DIETPI-NOTIFY 2 'Enabling Redis for transactional file locking.' # https://docs.nextcloud.com/server/14/admin_manual/configuration_files/files_locking_transactional.html
			local redis_conf="/etc/redis/redis*.conf"
			# - Enable Redis socket and grant www-data access to it:
			#	- NB: To allow wildcard expansion, do not use quotes around $redis_conf!
			GCI_PRESERVE=1 G_CONFIG_INJECT 'unixsocket[[:blank:]]' 'unixsocket /var/run/redis/redis-server.sock' $redis_conf
			G_CONFIG_INJECT 'unixsocketperm[[:blank:]]' 'unixsocketperm 770' $redis_conf
			local redis_sock=$(grep -m1 '^[[:blank:]]*unixsocket[[:blank:]]' $redis_conf | awk '{print $2}')
			usermod -a -G redis www-data
			G_RUN_CMD systemctl restart redis-server
			# - Enable Nextloud to use Redis socket:
			G_CONFIG_INJECT "'filelocking.enabled'" "'filelocking.enabled' => true," $config_php "'memcache.local'"
			GCI_PRESERVE=1 GCI_NEWLINE=1 G_CONFIG_INJECT "'memcache.locking'" "'memcache.locking' => '\\\\OC\\\\Memcache\\\\Redis',\n'redis' => array ('host' => '$redis_sock', 'port' => 0,)," $config_php "'filelocking.enabled'"

			# Enable Nextcloud background cron job:
			crontab -u www-data -l 2>/dev/null | grep -q '/var/www/nextcloud/cron.php' || ( crontab -u www-data -l 2>/dev/null ; echo "*/15 * * * * php /var/www/nextcloud/cron.php" ) | crontab -u www-data -
			ncc background:cron

			# Enable maintenance mode to allow handling by dietpi-services:
			grep -q "^[[:blank:]]*'maintenance' => true," $config_php || ncc maintenance:mode --on

		fi

		#Nextcloud Talk
		software_id=168
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			G_DIETPI-NOTIFY 2 'Configuring TURN server:'
			# - Enable init.d service
			G_CONFIG_INJECT 'TURNSERVER_ENABLED=' 'TURNSERVER_ENABLED=1' /etc/default/coturn
			# - Disable coturn logging by default, this can be overridden via /etc/turnserver.conf
			G_CONFIG_INJECT 'DAEMON_ARGS=' "DAEMON_ARGS='-c /etc/turnserver.conf -o -l stdout --no-stdout-log --simple-log'" /etc/default/coturn

			# - Ask user for server domain and desired TURN server port
			local invalid_text=''
			local domain='my.domain.org'
			while :
			do

				G_WHIP_DEFAULT_ITEM="$domain"
				G_WHIP_INPUTBOX "${invalid_text}Please enter your servers external domain to allow Nextcloud Talk access your TURN server:"
				if (( $? == 0 )) && [[ $G_WHIP_RETURNED_VALUE ]]; then

					domain="${G_WHIP_RETURNED_VALUE#http*://}"
					break

				else

					invalid_text='[ERROR] No valid entry found. Please retry...\n\n'

				fi

			done
			local invalid_text=''
			local port=5349
			while :
			do

				G_WHIP_DEFAULT_ITEM=$port
				G_WHIP_INPUTBOX "${invalid_text}Please enter the network port, that should be used for your TURN server:\n
NB: This port needs to be forwarded by your router and/or opened in your firewall settings. Default value is: 5349"
				if (( $? == 0 )) && disable_error=1 G_CHECK_VALIDINT "$G_WHIP_RETURNED_VALUE"; then

					port=$G_WHIP_RETURNED_VALUE
					break

				else

					invalid_text='[ERROR] No valid entry found, value needs to be a sequence of integers. Please retry...\n\n'

				fi

			done

			# - Adjust coturn settings
			G_CONFIG_INJECT 'fingerprint' 'fingerprint' /etc/turnserver.conf
			G_CONFIG_INJECT 'lt-cred-mech' 'lt-cred-mech' /etc/turnserver.conf
			G_CONFIG_INJECT 'use-auth-secret' 'use-auth-secret' /etc/turnserver.conf
			G_CONFIG_INJECT 'realm=' "realm=$domain" /etc/turnserver.conf
			GCI_PRESERVE=1 G_CONFIG_INJECT 'total-quota=' 'total-quota=100' /etc/turnserver.conf
			GCI_PRESERVE=1 G_CONFIG_INJECT 'bps-capacity=' 'bps-capacity=0' /etc/turnserver.conf
			G_CONFIG_INJECT 'stale-nonce' 'stale-nonce' /etc/turnserver.conf
			G_CONFIG_INJECT 'no-loopback-peers' 'no-loopback-peers' /etc/turnserver.conf
			G_CONFIG_INJECT 'no-multicast-peers' 'no-multicast-peers' /etc/turnserver.conf

			# - Add TLS settings, if LetsEncrypt certificates are available:
			if [[ -f /DietPi/dietpi/.dietpi-letsencrypt &&
				-f /etc/letsencrypt/live/$(sed -n 1p /DietPi/dietpi/.dietpi-letsencrypt)/cert.pem ]]; then

				G_DIETPI-NOTIFY 2 'LetsEncrypt certificate found, will configure coturn TURN server to accept TLS connections'
				# - Disable non-TLS listening port, enable TLS listening port:
				G_CONFIG_INJECT 'listening-port=' "#listening-port=$port" /etc/turnserver.conf
				G_CONFIG_INJECT 'tls-listening-port=' "tls-listening-port=$port" /etc/turnserver.conf
				local fp_cert_dir="/etc/letsencrypt/live/$(sed -n 1p /DietPi/dietpi/.dietpi-letsencrypt)"
				G_CONFIG_INJECT 'cert=' "cert=$fp_cert_dir/cert.pem" /etc/turnserver.conf
				G_CONFIG_INJECT 'pkey=' "pkey=$fp_cert_dir/privkey.pem" /etc/turnserver.conf
				# - Proven working default cipher, but thus should be properly reworked, e.g. to match webserver settings?
				G_CONFIG_INJECT 'cipher-list=' 'cipher-list="ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AES:RSA+3DES:!ADH:!AECDH:!MD5"' /etc/turnserver.conf

			else

				G_CONFIG_INJECT 'listening-port=' "listening-port=$port" /etc/turnserver.conf

			fi

			# - Install Nextcloud Talk app
			G_RUN_CMD systemctl start $MARIADB_SERVICE
			G_RUN_CMD systemctl start redis-server
			G_RUN_CMD ncc maintenance:mode --off
			G_RUN_CMD ncc app:install spreed
			ncc app:enable spreed

			# - Adjust Nextcloud Talk settings to use coturn
			ncc config:app:set spreed stun_servers --value="[\"$domain:$port\"]"
			#	Generate random secret to secure TURN server access
			local secret=$(openssl rand -hex 32)
			GCI_PRESERVE=1 G_CONFIG_INJECT 'static-auth-secret=' "static-auth-secret=$secret" /etc/turnserver.conf
			#	Scrape existing secret, in case user manually chose/edited it
			secret="$(grep -m1 '^[[:blank:]]*static-auth-secret=' /etc/turnserver.conf)"
			secret="${secret#*static-auth-secret=}"
			ncc config:app:set spreed turn_servers --value="[{\"server\":\"$domain:$port\",\"secret\":\"$secret\",\"protocols\":\"udp,tcp\"}]"
			unset secret

		fi

		# Transmission
		software_id=44
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# Remove obsolete init.d service
			rm /etc/init.d/transmission-daemon &> /dev/null

			# Run service as "dietpi" group: https://github.com/Fourdee/DietPi/issues/350#issuecomment-423763518
			mkdir -p /etc/systemd/system/transmission-daemon.service.d
			echo -e '[Service]\nGroup=dietpi' > /etc/systemd/system/transmission-daemon.service.d/dietpi-group.conf

			# Apply optimized settings
			sed -i '/^}/d' /etc/transmission-daemon/settings.json

			G_CONFIG_INJECT '"cache-size-mb"' '"cache-size-mb": '$(Optimize_BitTorrent 0)',' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"download-queue-size"' '"download-queue-size": '$(Optimize_BitTorrent 1)',' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"peer-limit-global"' '"peer-limit-global": '$(Optimize_BitTorrent 2)',' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"max-peers-global"' '"max-peers-global": '$(Optimize_BitTorrent 2)',' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"upload-slots-per-torrent"' '"upload-slots-per-torrent": '$(Optimize_BitTorrent 3)',' /etc/transmission-daemon/settings.json

			G_CONFIG_INJECT '"port-forwarding-enabled"' '"port-forwarding-enabled": true,' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"encryption"' '"encryption": 2,' /etc/transmission-daemon/settings.json

			G_CONFIG_INJECT '"idle-seeding-limit"' '"idle-seeding-limit": 1,' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"idle-seeding-limit-enabled"' '"idle-seeding-limit-enabled": true,' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"ratio-limit"' '"ratio-limit": 1.1,' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"ratio-limit-enabled"' '"ratio-limit-enabled": true,' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"trash-original-torrent-files"' '"trash-original-torrent-files": true,' /etc/transmission-daemon/settings.json

			G_CONFIG_INJECT '"download-dir"' '"download-dir": "'$G_FP_DIETPI_USERDATA'/downloads",' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"rpc-password"' '"rpc-password": "'"$GLOBAL_PW"'",' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"rpc-username"' '"rpc-username": "root",' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"rpc-whitelist-enabled"' '"rpc-whitelist-enabled": false,' /etc/transmission-daemon/settings.json
			G_CONFIG_INJECT '"message-level"' '"message-level": 0,' /etc/transmission-daemon/settings.json

			# To allow access for download managers and media software, files need to be created with 77X permissions.
			G_CONFIG_INJECT '\"umask\":' '    "umask": 7,' /etc/transmission-daemon/settings.json

			echo '}' >> /etc/transmission-daemon/settings.json

		fi

		#PHPBB
		software_id=54
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration
			/DietPi/dietpi/func/create_mysql_db phpbb3 phpbb3 "$GLOBAL_PW"

		fi

		#MPD
		software_id=128
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# Create MPD user
			#useradd -rM mpd -G dietpi,audio -s /usr/sbin/nologin

			# - Runtime folders/files
			#	log
			mkdir -p /var/log/mpd
			> /var/log/mpd/mpd.log

			#	cache
			mkdir -p $G_FP_DIETPI_USERDATA/.mpd_cache
			> $G_FP_DIETPI_USERDATA/.mpd_cache/db_file
			> $G_FP_DIETPI_USERDATA/.mpd_cache/state
			> $G_FP_DIETPI_USERDATA/.mpd_cache/sticker.sql

			#	Symlink from MPD defaults that applications may still expect/use.
			rm -R /var/lib/mpd &> /dev/null
			mkdir -p /var/lib/mpd
			ln -sf $G_FP_DIETPI_USERDATA/Music /var/lib/mpd/music
			ln -sf $G_FP_DIETPI_USERDATA/Music /var/lib/mpd/playlists
			ln -sf $G_FP_DIETPI_USERDATA/.mpd_cache/db_file /var/lib/mpd/mpd.db
			ln -sf $G_FP_DIETPI_USERDATA/.mpd_cache/state /var/lib/mpd/state
			ln -sf $G_FP_DIETPI_USERDATA/.mpd_cache/sticker.sql /var/lib/mpd/sticker.sql

			# - default config
			G_BACKUP_FP /etc/mpd.conf
			cp /DietPi/dietpi/conf/mpd.conf /etc/mpd.conf

			# - MPD service/confs
			cat << _EOF_ > /etc/default/mpd
#Even though we declare the conf location in our service, MPD will fail to start if this file does not exist.
## The configuration file location for mpd:
MPDCONF=/etc/mpd.conf
_EOF_

			cat << _EOF_ > /lib/systemd/system/mpd.service
[Unit]
Description=Music Player Daemon (DietPi)
After=network.target sound.target

[Service]
#User=root #forks its own process under user set in /etc/mpd.conf (mpd)
Type=simple
LimitRTPRIO=infinity
RuntimeDirectory=/var/run/mpd
EnvironmentFile=/etc/default/mpd
ExecStartPre=$(which mkdir) -p /var/run/mpd
ExecStartPre=$(which chown) -R root:dietpi /var/run/mpd
ExecStart=$(which mpd) --no-daemon /etc/mpd.conf

[Install]
WantedBy=multi-user.target

_EOF_

			#JustBoom specials
			if grep -qi '^[[:blank:]]*CONFIG_SOUNDCARD=justboom' /DietPi/dietpi.txt; then

				# - Name displayed in YMPD sound button
				local justboom_soundcard_desc='JustBoom DietPi'
				G_CONFIG_INJECT 'name "' "name \"$justboom_soundcard_desc\"" /etc/mpd.conf
				G_CONFIG_INJECT 'zeroconf_name "' "zeroconf_name \"$justboom_soundcard_desc\"" /etc/mpd.conf

				# - Output (192khz 32bit)
				local target_bitdepth=32
				local target_rate=192000
				G_CONFIG_INJECT 'format "' "format \"$target_rate:$target_bitdepth:2\"" /etc/mpd.conf
				G_CONFIG_INJECT 'audio_output_format "' "audio_output_format \"$target_rate:$target_bitdepth:2\"" /etc/mpd.conf

				# - Set SOXR quality
				#	All RPi's can handle SOXR VH @ 192khz 32bit: https://github.com/Fourdee/DietPi/issues/581#issuecomment-256643079
				G_CONFIG_INJECT 'samplerate_converter "' 'samplerate_converter "soxr very high"' /etc/mpd.conf #highest

			fi

			#Grab our test music for the user.
			Download_Test_Media

		fi

		# Proftpd
		software_id=94
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			G_CONFIG_INJECT 'root' '#root' /etc/ftpusers

			G_BACKUP_FP /etc/proftpd/proftpd.conf
			dps_index=$software_id Download_Install 'conf' /etc/proftpd/proftpd.conf

		fi

		#Samba Server
		software_id=96
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			echo -e "$GLOBAL_PW\n$GLOBAL_PW" | smbpasswd -s -a dietpi

			local fp_conf='/etc/samba/smb.conf'
			G_BACKUP_FP $fp_conf
			dps_index=$software_id Download_Install 'conf' $fp_conf

			G_CONFIG_INJECT 'max connections =' "max connections = $(( $G_HW_CPU_CORES * 2 ))" $fp_conf

		fi

		#vsFTPD
		software_id=95
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			G_CONFIG_INJECT 'root' '#root' /etc/ftpusers

			local fp_conf='/etc/vsftpd.conf'
			G_BACKUP_FP $fp_conf
			dps_index=$software_id Download_Install 'conf' $fp_conf

			G_CONFIG_INJECT 'local_root=' "local_root=$G_FP_DIETPI_USERDATA" $fp_conf

		fi

		#NFS_SERVER
		software_id=109
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			cat << _EOF_ > /etc/exports
$G_FP_DIETPI_USERDATA *(rw,async,no_root_squash,fsid=0,crossmnt,no_subtree_check)
_EOF_

		fi

		#YMPD
		software_id=32
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM ympd -G dietpi -s /usr/sbin/nologin

			#YMPD service
			cat << _EOF_ > /etc/systemd/system/ympd.service
[Unit]
Description=YMPD (DietPi)
After=mpd.service

[Service]
Type=simple
User=root # Changes to ympd during run
Group=dietpi
ExecStart=/usr/bin/ympd --user ympd --webport 1337

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#myMPD
		software_id=148
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM mympd -G dietpi,audio -s /usr/sbin/nologin

			cat << _EOF_ > /lib/systemd/system/mympd.service
[Unit]
Description=myMPD (DietPi)
After=mpd.service

[Service]
Type=simple
User=root # Changes at runlevel
Group=dietpi
ExecStart=$(which mympd) /etc/mympd/mympd.conf

[Install]
WantedBy=multi-user.target
_EOF_

			G_CONFIG_INJECT 'webport =' 'webport = 1333' /etc/mympd/mympd.conf
			G_CONFIG_INJECT 'ssl =' 'ssl = false' /etc/mympd/mympd.conf
			G_CONFIG_INJECT 'user =' 'user = mympd' /etc/mympd/mympd.conf
			G_CONFIG_INJECT 'group =' 'group = dietpi' /etc/mympd/mympd.conf

			mkdir -p /var/lib/mympd/smartpls /var/lib/mympd/tmp

			#symlink music/libary folders used by mympd
			if [[ $(readlink /usr/share/mympd/htdocs/library) != $G_FP_DIETPI_USERDATA/Music ]]; then

				[[ -d /usr/share/mympd/htdocs/library ]] && rm -R /usr/share/mympd/htdocs/library
				ln -sf $G_FP_DIETPI_USERDATA/Music /usr/share/mympd/htdocs/library

			fi

		fi

		#Roon Bridge
		software_id=121
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#useradd -rM roon -G dietpi,audio -s /usr/sbin/nologin
			#root required for remote updates

			mkdir -p $G_FP_DIETPI_USERDATA/roon

			dps_index=$software_id Download_Install 'roonbridge.service' /etc/systemd/system/roonbridge.service

			# - Move logfiles to /var/log/ (dietpi-ramlog)
			#	Remove any previous folders to clear for symlink
			rm -R $G_FP_DIETPI_USERDATA/roon/RoonBridge/Logs &> /dev/null
			rm -R $G_FP_DIETPI_USERDATA/roon/RAATServer/Logs &> /dev/null

			mkdir -p $G_FP_DIETPI_USERDATA/roon/RoonBridge
			mkdir -p $G_FP_DIETPI_USERDATA/roon/RAATServer
			mkdir -p /var/log/roon

			ln -sf /var/log/roon $G_FP_DIETPI_USERDATA/roon/RoonBridge/Logs
			ln -sf /var/log/roon $G_FP_DIETPI_USERDATA/roon/RAATServer/Logs

		fi

		#NodeRed
		software_id=122
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			mkdir -p $G_FP_DIETPI_USERDATA/node-red

			adduser nodered --system --group --shell=/bin/nologin
			usermod -a -G gpio nodered

			cat << _EOF_ > /etc/systemd/system/node-red.service
[Unit]
Description=Node-Red (DietPi)

[Service]
Type=simple
User=nodered
ExecStart=/usr/local/bin/node-red -u $G_FP_DIETPI_USERDATA/node-red

[Install]
WantedBy=multi-user.target
_EOF_

			#Symlink to home dir: https://github.com/Fourdee/DietPi/issues/1256
			ln -sf $G_FP_DIETPI_USERDATA/node-red $HOME/.node-red

		fi

		#Tomcat8
		software_id=125
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration
			sed -i "/JAVA_HOME=/c\JAVA_HOME=$(find \/usr\/lib\/jvm\/ -name java-8-openjdk*)" /etc/default/tomcat8

		fi

		#CAVA
		software_id=119
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Cava conf
			mkdir -p $HOME/.config/cava

			G_BACKUP_FP $HOME/.config/cava/config
			cp /DietPi/dietpi/conf/cava.conf $HOME/.config/cava/config

			# - lower MPD buffer size to reduce latency of spectrum:
			sed -i '/audio_buffer_size /c\audio_buffer_size "384"' /etc/mpd.conf

			# - fifo stream for mpd
			if (( ! $(grep -ci -m1 '/tmp/mpd.fifo' /etc/mpd.conf) )); then

				cat << _EOF_ >> /etc/mpd.conf

#Cava fifo stream
audio_output {

    type "fifo"
    enabled "yes"
    name "CAVA"
    path "/tmp/mpd.fifo"
    format "44100:16:2"

}
_EOF_

			fi

		fi

		#Mopidy
		software_id=118
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM mopidy -G dietpi,audio -s /usr/sbin/nologin
			sed -i "/User=/c\User=mopidy" /lib/systemd/system/mopidy.service

			# - conf
			mkdir -p $G_FP_DIETPI_USERDATA/mopidy/cache
			mkdir -p $G_FP_DIETPI_USERDATA/mopidy/data

			mkdir -p ~/.config/mopidy

			G_BACKUP_FP ~/.config/mopidy/mopidy.conf
			cat << _EOF_ > ~/.config/mopidy/mopidy.conf
[core]
cache_dir = $G_FP_DIETPI_USERDATA/mopidy/cache
config_dir = /etc/mopidy
data_dir = $G_FP_DIETPI_USERDATA/mopidy/data

[logging]
config_file = /etc/mopidy/logging.conf
debug_file = /var/log/mopidy.log

[local]
library = images
media_dir = /mnt
enabled = true
scan_timeout = 1000
scan_flush_threshold = 100
scan_follow_symlinks = false
excluded_file_extensions =
  .directory
  .html
  .jpeg
  .jpg
  .log
  .nfo
  .png
  .txt

[file]
enabled = true
media_dirs = /mnt

[m3u]
playlists_dir = /mnt

[http]
enabled = true
hostname = ::
port = 6680
static_dir =
zeroconf = Mopidy HTTP server on $hostname

_EOF_

			#	NB: mopidy uses both config locations, so lets make sure we match them
			cp ~/.config/mopidy/mopidy.conf /etc/mopidy/mopidy.conf

			Download_Test_Media

		fi

		#Kodi
		software_id=31
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Remove Kodi user (Whilst waving)
			userdel -r kodi &> /dev/null

			#Run Kodi as root
			sed -i '/USER=/c\USER=root' /etc/default/kodi &> /dev/null

			#Copy udev rules, probably not needed for root, but we'll do it anyway
			dps_index=$software_id Download_Install '99-dietpi-kodi.rules' /etc/udev/rules.d/99-dietpi-kodi.rules
			chmod +x /etc/udev/rules.d/99-dietpi-kodi.rules

			#Create .desktop SymLinks
			mkdir -p $HOME/Desktop
			rm /usr/share/applications/kodi.desktop &> /dev/null
			G_RUN_CMD wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/apps/kodi.desktop -O /usr/share/applications/kodi.desktop
			ln -sf /usr/share/applications/kodi.desktop $HOME/Desktop/kodi.desktop

		fi

		#MINIDLNA
		software_id=39
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			userdel -rf minidlna &> /dev/null
			useradd -rM minidlna -G dietpi -s /usr/sbin/nologin

			rm /etc/init.d/minidlna &> /dev/null
			rm /etc/systemd/system/minidlna.service &> /dev/null
			rm /lib/systemd/system/minidlna.service &> /dev/null

			cat << _EOF_ > /etc/systemd/system/minidlna.service
[Unit]
Description=MiniDLNA (DietPi)
After=network.target

[Service]
Type=simple
User=minidlna
Group=dietpi
RuntimeDirectory=minidlna
ExecStart=$(which minidlnad) -SR -f /etc/minidlna.conf

[Install]
WantedBy=multi-user.target

_EOF_

			#Copy Config
			G_BACKUP_FP /etc/minidlna.conf
			dps_index=$software_id Download_Install 'minidlna.conf' /etc/minidlna.conf

			#Setup data directories
			mkdir -p $G_FP_DIETPI_USERDATA/.MiniDLNA_Cache

			Download_Test_Media

		fi


		#NoIp
		software_id=67
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#noip2 service file
			cat << _EOF_ > /etc/systemd/system/noip2.service
[Unit]
Description=noip2 (DietPi)
After=network.target network-online.target rsyslog.service

[Service]
Type=forking
RemainAfterExit=yes

ExecStart=/usr/local/bin/noip2
ExecStop=/usr/bin/killall -w noip2

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#amiberry
		software_id=108
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Allow binary execution
			chmod -R +x $G_FP_DIETPI_USERDATA/amiberry

			local amiberry_filename=0
			local capsimg_filename='capsimg-rpi.so'

			# - ASUS TB
			if (( $G_HW_MODEL == 52 )); then

				amiberry_filename='amiberry-tinker'
				capsimg_filename='capsimg-tinker.so'

			# - XU4
			elif (( $G_HW_MODEL == 11 )); then

				amiberry_filename='amiberry-xu4'
				capsimg_filename='capsimg-xu4.so'

			# - RPi 3
			elif (( $G_HW_MODEL == 3 )); then

				amiberry_filename='amiberry-rpi3-sdl2-dispmanx'

			# - RPi 2
			elif (( $G_HW_MODEL == 2 )); then

				amiberry_filename='amiberry-rpi2-sdl2-dispmanx'

			# - Assume RPi 1 (ARMv6)
			else

				amiberry_filename='amiberry-rpi1-sdl2-dispmanx'

			fi

			# - Update capsimg.so
			rm $G_FP_DIETPI_USERDATA/amiberry/capsimg.so &> /dev/null
			mv $G_FP_DIETPI_USERDATA/amiberry/"$capsimg_filename" $G_FP_DIETPI_USERDATA/amiberry/capsimg.so

			# - Create additional user media directories
			mkdir -p $G_FP_DIETPI_USERDATA/amiberry/floppy_images
			mkdir -p $G_FP_DIETPI_USERDATA/amiberry/hdf
			mkdir -p $G_FP_DIETPI_USERDATA/amiberry/cd

			#Uae4arm does not support browsing symlinks (https://github.com/Fourdee/DietPi/issues/474#issuecomment-242973839)
			#	So we need to change config file default paths to actual userdata location:
			local fp_userdata_actual=$(readlink $G_FP_DIETPI_USERDATA) # Only returns a value if symlink exists (eg: off SDcard)
			if [[ -n $fp_userdata_actual ]]; then

				sed -i "s:$G_FP_DIETPI_USERDATA:$fp_userdata_actual:g" $G_FP_DIETPI_USERDATA/amiberry/conf/adfdir.conf
				sed -i "s:$G_FP_DIETPI_USERDATA:$fp_userdata_actual:g" $G_FP_DIETPI_USERDATA/amiberry/conf/autostart.uae

			fi

			# - Service
			local exec_start="$G_FP_DIETPI_USERDATA/amiberry/$amiberry_filename -f $G_FP_DIETPI_USERDATA/amiberry/conf/autostart.uae"
			if (( $G_HW_MODEL == 52 )); then

				exec_start="$(which xinit) $G_FP_DIETPI_USERDATA/amiberry/$amiberry_filename -f $G_FP_DIETPI_USERDATA/amiberry/conf/autostart.uae"

			fi

			cat << _EOF_ > /etc/systemd/system/amiberry.service
[Unit]
Description=AmiBerry Amiga Emulator (DietPi)

[Service]
Type=simple
User=root
#StandardOutput=tty
#StandardInput=tty
#TTYPath=/dev/tty1
#TTYReset=yes
#TTYVHangup=yes
WorkingDirectory=$G_FP_DIETPI_USERDATA/amiberry
ExecStart=$exec_start

[Install]
WantedBy=local-fs.target
_EOF_

			cat << _EOF_ > $G_FP_DIETPI_USERDATA/amiberry/run.sh
#!/bin/bash
cd $G_FP_DIETPI_USERDATA/amiberry
./$amiberry_filename -f conf/autostart.uae
_EOF_

			chmod +x $G_FP_DIETPI_USERDATA/amiberry/run.sh

		fi

		#dxx-rebirth
		software_id=112
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Symlink savegames to root
			# - Remove existing syslinks
			rm -R $HOME/.d1x-rebirth &> /dev/null
			rm -R $HOME/.d2x-rebirth &> /dev/null

			ln -sf $G_FP_DIETPI_USERDATA/dxx-rebirth/descent_1_profiles $HOME/.d1x-rebirth
			ln -sf $G_FP_DIETPI_USERDATA/dxx-rebirth/descent_2_profiles $HOME/.d2x-rebirth

			#+exe
			chmod +x -R $G_FP_DIETPI_USERDATA/dxx-rebirth/*

			#Create .Desktop SymLinks
			mkdir -p $HOME/Desktop
			mkdir -p /usr/share/applications

			ln -s $G_FP_DIETPI_USERDATA/dxx-rebirth/dxx-rebirth.desktop $HOME/Desktop/dxx-rebirth.desktop
			ln -s $G_FP_DIETPI_USERDATA/dxx-rebirth/dxx-rebirth.desktop  /usr/share/applications/dxx-rebirth.desktop

		fi

		#OpenTyrian
		software_id=51
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Copy the DietPi run file for OpenTyrian
			dps_index=$software_id Download_Install 'run' /usr/local/games/opentyrian/run
			chmod +x /usr/local/games/opentyrian/run

			#Create .Desktop SymLinks
			mkdir -p $HOME/Desktop
			rm /usr/share/applications/opentyrian.desktop &> /dev/null
			G_RUN_CMD wget https://raw.githubusercontent.com/Fourdee/DietPi/$G_GITBRANCH/.conf/desktop/apps/opentyrian.desktop -O /usr/share/applications/opentyrian.desktop
			ln -s /usr/share/applications/opentyrian.desktop $HOME/Desktop/opentyrian.desktop

		fi

		#DIETPICAM
		software_id=59
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - raspimjpeg conf
			chmod +x /etc/raspimjpeg
			ln -s /etc/raspimjpeg /var/www/rpicam/raspimjpeg

			# - Motion conf
			chgrp www-data /etc/motion/motion.conf
			chmod 777 /etc/motion/motion.conf
			usermod -a -G video www-data

			# - raspimjpeg/php schedule startup and control script
			dps_index=$software_id Download_Install 'raspimjpeg.sh' /var/lib/dietpi/dietpi-software/installed/raspimjpeg.sh
			chmod +x /var/lib/dietpi/dietpi-software/installed/raspimjpeg.sh
			cat << _EOF_ > /etc/systemd/system/raspimjpeg.service
[Unit]
Description=Raspimjpeg (DietPi)

[Service]
Type=simple
RemainAfterExit=yes
ExecStart=$(which bash) -c '/var/lib/dietpi/dietpi-software/installed/raspimjpeg.sh start'
ExecStop=$(which bash) -c '/var/lib/dietpi/dietpi-software/installed/raspimjpeg.sh stop'

[Install]
WantedBy=multi-user.target
_EOF_

			# - Replace confs with /var/www to /var/www/rpicam, once
			if (( ! $(grep -ci -m1 '/rpicam' /etc/raspimjpeg) )); then

				sed -i 's#/var/www#/var/www/rpicam#g' /etc/raspimjpeg
				sed -i 's#/var/www#/var/www/rpicam#g' /etc/motion/motion.conf

			fi

			# - Setup Data directory
			mkdir -p $G_FP_DIETPI_USERDATA/rpicam
			rm -R /var/www/rpicam/media
			ln -s $G_FP_DIETPI_USERDATA/rpicam /var/www/rpicam/media

			# - Enable RPi camera
			/DietPi/dietpi/func/dietpi-set_hardware rpi-camera enable

		fi

		#Deluge
		software_id=45
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM deluge -G dietpi -s /usr/sbin/nologin

			mkdir -p $G_FP_DIETPI_USERDATA/deluge/.config/deluge

			> /var/log/deluged.log
			> /var/log/deluge-web.log

			cat << _EOF_ > /etc/systemd/system/deluged.service
[Unit]
Description=Deluged (DietPi)

[Service]
Type=simple
User=deluge
Group=dietpi
UMask=002
Environment=USER=deluge HOME=$G_FP_DIETPI_USERDATA/deluge
ExecStart=$(which deluged) -d -l /var/log/deluged.log -L warning

[Install]
WantedBy=multi-user.target
_EOF_

			cat << _EOF_ > /etc/systemd/system/deluge-web.service
[Unit]
Description=Deluge-web (DietPi)

[Service]
Type=simple #forking causes systemd-tty-ask-password-agent hang
User=deluge
Group=dietpi
Environment=USER=deluge HOME=$G_FP_DIETPI_USERDATA/deluge
ExecStart=$(which deluge-web) -l /var/log/deluge-web.log -L warning

[Install]
WantedBy=multi-user.target
_EOF_

			#Generate deluge default config
			deluged
			killall -w deluged

			#Copy DietPi configs
			G_BACKUP_FP $G_FP_DIETPI_USERDATA/deluge/.config/deluge/core.conf $G_FP_DIETPI_USERDATA/deluge/.config/deluge/web.conf
			dps_index=$software_id Download_Install 'deluge.conf' $G_FP_DIETPI_USERDATA/deluge/.config/deluge/core.conf
			dps_index=$software_id Download_Install 'deluge_web.conf' $G_FP_DIETPI_USERDATA/deluge/.config/deluge/web.conf

			# - Enable service run:
			G_CONFIG_INJECT 'ENABLE_DELUGED=' 'ENABLE_DELUGED=1' /etc/default/deluged

			#Set remote access login details
			cat << _EOF_ > $G_FP_DIETPI_USERDATA/deluge/.config/deluge/auth
root:$GLOBAL_PW:10
_EOF_

			#Apply Optimized settings
			# - Cache size is in steps of 16 KiB. (Cachesize * 16 = total KiB)
			local deluge_cache_size=$(( $(echo -e "scale=0; $(Optimize_BitTorrent 0) * 1024 / 16" | bc -l ) ))
			sed -i '/"cache_size": /c\ "cache_size": '"$deluge_cache_size"',' $G_FP_DIETPI_USERDATA/deluge/.config/deluge/core.conf

			sed -i '/"max_active_limit": /c\ "max_active_limit": '"$(Optimize_BitTorrent 1)"',' $G_FP_DIETPI_USERDATA/deluge/.config/deluge/core.conf
			sed -i '/"max_active_downloading": /c\ "max_active_downloading": '"$(Optimize_BitTorrent 1)"',' $G_FP_DIETPI_USERDATA/deluge/.config/deluge/core.conf
			sed -i '/"max_connections_global": /c\ "max_connections_global": '"$(Optimize_BitTorrent 2)"',' $G_FP_DIETPI_USERDATA/deluge/.config/deluge/core.conf
			sed -i '/"max_upload_slots_global": /c\ "max_upload_slots_global": '"$(Optimize_BitTorrent 3)"',' $G_FP_DIETPI_USERDATA/deluge/.config/deluge/core.conf

		fi

		#Webmin
		software_id=115
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			update-rc.d webmin remove &> /dev/null
			rm /etc/init.d/webmin &> /dev/null
			cat << _EOF_ > /etc/systemd/system/webmin.service
[Unit]
Description=Webmin (DietPi)

[Service]
Type=forking
ExecStart=$(which bash) -c  '/etc/webmin/start'
ExecStop=$(which bash) -c  '/etc/webmin/stop'

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#PIHOLE
		software_id=93
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Create symlinks to align Pi-hole admin and blocking page relative to webroot
			cd /var/www
			#	Move existing files/dirs out of the way
			[[ -L admin ]] || { [[ -e admin ]] && mv -v admin admin.bak; }
			ln -vsf html/admin admin
			[[ -L pihole ]] || { [[ -e pihole ]] && mv -v pihole pihole.bak; }
			ln -vsf html/pihole pihole

			# - Ask user whether to show blocking page
			G_WHIP_BUTTON_OK_TEXT='YES'
			G_WHIP_BUTTON_CANCEL_TEXT='NO'
			if G_WHIP_YESNO 'Pi-hole can show a blocking page, when clients access a blocked website. This allows you to whitelist domains directly from the blocking page and prevents the need to access the admin page or use the Pi-hole CLI for this.\n
The downside is additional traffic and less performance compared to a silent request block. Additional info can be found at: https://docs.pi-hole.net/ftldns/blockingmode/\n
Do you want to enable the Pi-hole blocking page?'; then

				G_CONFIG_INJECT 'BLOCKINGMODE=' 'BLOCKINGMODE=IP-NODATA-AAAA' /etc/pihole/pihole-FTL.conf
				#	Link blocking page to webroot, where it is required
				[[ -L index.php ]] || { [[ -e index.php ]] && mv -v index.php index.php.bak; }
				ln -vsf pihole/index.php index.php

			else

				G_CONFIG_INJECT 'BLOCKINGMODE=' 'BLOCKINGMODE=NULL' /etc/pihole/pihole-FTL.conf

			fi
			cd /tmp/$G_PROGRAM_NAME

			# - Fix service to disable syslog pre-req preventing start
			G_CONFIG_INJECT '# Required-Stop:' '# Required-Stop: $network $remote_fs' /etc/init.d/pihole-FTL
			G_CONFIG_INJECT '# Required-Start:' '# Required-Start: $network $remote_fs' /etc/init.d/pihole-FTL
			systemctl enable pihole-FTL

			# - Run Gravity
			pihole -g

			# - Generate web interface PW: https://github.com/Fourdee/DietPi/issues/662
			pihole -a -p "$GLOBAL_PW"
			G_WHIP_MSG "DietPi has changed the Pi-hole web interface password to:\n - $GLOBAL_PW\n\nPlease use this password when logging into the web interface:\n - http://$(sed -n 4p /DietPi/dietpi/.network)/admin\n\nThis password can be changed, please see pihole binary for info:\n - pihole --help"

		fi

		#AirSonic
		software_id=33
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM airsonic -G dietpi,audio -s /usr/sbin/nologin

			#Optimize memory limit
			local airsonic_memory_max=$(( $RAM_TOTAL / 5 ))
			if (( $airsonic_memory_max < 200 )); then

				airsonic_memory_max='200'

			fi
			airsonic_memory_max+='m'

			cat << _EOF_ > /etc/systemd/system/airsonic.service
[Unit]
Description=Airsonic Media Server (DietPi)
After=remote-fs.target network.target

[Service]
Type=simple
User=airsonic
WorkingDirectory=$G_FP_DIETPI_USERDATA/airsonic
ExecStart=$(which java) -Xmx$airsonic_memory_max -Dairsonic.home=$G_FP_DIETPI_USERDATA/airsonic -Dserver.context-path=/airsonic -Dserver.port=8080 -jar $G_FP_DIETPI_USERDATA/airsonic/airsonic.war

[Install]
WantedBy=multi-user.target
_EOF_

			#Symlink ffmpeg to subsonic transcoder
			ln -fs $(which ffmpeg) $G_FP_DIETPI_USERDATA/airsonic/transcode

			#Grab our test media for user
			Download_Test_Media

		fi

		#SUBSONIC 6
		software_id=34
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Optimize memory limit
			local subsonic_memory_max=$(( $RAM_TOTAL / 5 ))
			if (( $subsonic_memory_max < 200 )); then

				subsonic_memory_max=200

			fi

			cat << _EOF_ > /etc/default/subsonic
SUBSONIC_USER=root
SUBSONIC_ARGS="--quiet --pidfile=/run/subsonic.pid --max-memory=$subsonic_memory_max --default-music-folder=$G_FP_DIETPI_USERDATA/$FOLDER_MUSIC --default-podcast-folder=$G_FP_DIETPI_USERDATA/$FOLDER_MUSIC --default-playlist-folder=$G_FP_DIETPI_USERDATA/$FOLDER_MUSIC"
_EOF_

			#Grab our test media for user
			Download_Test_Media

			#Symlink ffmpeg to subsonic transcoder
			ln -fs $(which ffmpeg) /var/subsonic/transcode

		fi

		#WEBIOPI
		software_id=71
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#auto start
			update-rc.d webiopi defaults

		fi

		#DIETPICLOUDSHELL
		software_id=62
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Enable DietPi-Cloudshell autostart
			/DietPi/dietpi/dietpi-autostart 5

			#Service
			cat << _EOF_ > /etc/systemd/system/dietpi-cloudshell.service
[Unit]
Description=dietpi-cloudshell on main screen (DietPi)

[Service]
Type=simple
StandardOutput=tty
TTYPath=/dev/tty1

ExecStartPre=$(which setterm) --term linux --blank 0 --powersave off --cursor off
ExecStart=/bin/bash -c '/DietPi/dietpi/dietpi-cloudshell 1'
ExecStop=$(which setterm) --reset
ExecStop=$(which echo) 'DietPi-Cloudshell terminated, have a nice day!'

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#HAPROXY
		software_id=98
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Create jail directory
			mkdir -p /var/lib/haproxy

			cat << _EOF_ > /etc/haproxy/haproxy.cfg
global

	#rsyslog is required for logging
	#log /var/log    local0
	#log /var/log    local1 notice
	maxconn 64
	#Jail directory
	chroot /var/lib/haproxy
	stats socket /run/haproxy.sock mode 660 level admin
	stats timeout 30s
	user root
	group root
	daemon

	# Default SSL material locations
	ca-base /etc/ssl/certs
	crt-base /etc/ssl/private

	# Default ciphers to use on SSL-enabled listening sockets.
	# For more information, see ciphers(1SSL).
	ssl-default-bind-ciphers kEECDH+aRSA+AES:kRSA+AES:+AES256:RC4-SHA:!kEDH:!LOW:!EXP:!MD5:!aNULL:!eNULL

defaults

	log     global
	mode    http
	option  httplog
	option  dontlognull
	timeout connect 5000
	timeout client  50000
	timeout server  50000
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http

frontend localnodes

	bind *:80
	mode http
	default_backend nodes

backend nodes

	mode http
	balance roundrobin
	option forwardfor
	http-request set-header X-Forwarded-Port %[dst_port]
	http-request add-header X-Forwarded-Proto https if { ssl_fc }
	option httpchk HEAD / HTTP/1.1\r\nHost:localhost
	server web01 127.0.0.1:9000 check
	server web02 127.0.0.1:9001 check
	server web03 127.0.0.1:9002 check

#Admin web page

	listen stats
	bind *:1338
	stats enable
	stats uri /
	stats hide-version
	stats auth admin:dietpi
_EOF_

			#Add html error pages
			mkdir -p /etc/haproxy/errors
			local errorcode=0

			errorcode=400; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=403; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=408; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=500; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=502; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=503; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=504; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http

		fi

		#SQUEEZEBOXSERVER
		software_id=35
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Remove bundled service
			systemctl stop logitechmediaserver &> /dev/null
			killall -w squeezeboxserver &> /dev/null #provided service may not wait for exit, kill: https://github.com/Fourdee/DietPi/issues/1613#issuecomment-372787574

			update-rc.d logitechmediaserver remove &> /dev/null
			rm /etc/init.d/logitechmediaserver &> /dev/null

			#Service
			cat << _EOF_ > /etc/systemd/system/squeezeboxserver.service
[Unit]
Description=Squeezebox Server/LMS (DietPi)

[Service]
Type=simple
ExecStart=$(which squeezeboxserver) --prefsdir /var/lib/squeezeboxserver/prefs --logfile /var/log/squeezeboxserver/error.log --logdir /var/log/squeezeboxserver/ --cachedir /var/lib/squeezeboxserver/cache --user root

[Install]
WantedBy=multi-user.target
_EOF_

			#Grab our test media for user
			Download_Test_Media

		fi

		#WORDPRESS
		software_id=55
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Create mysql DB
			/DietPi/dietpi/func/create_mysql_db wordpress wordpress "$GLOBAL_PW"

		fi

		#FRESHRSS
		software_id=38
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# Enable required PHP modules: https://github.com/FreshRSS/FreshRSS#requirements
			${PHP_BINARY}enmod curl gmp intl json pdo_mysql
			(( $G_DISTRO > 3 )) && phpenmod ctype dom mbstring xml zip

			# Apache configuration
			if (( ${aSOFTWARE_INSTALL_STATE[83]} > 0 )); then

				# - Required modules
				a2enmod headers expires rewrite

				# - Better compatibility with mobile clients
				echo 'AllowEncodedSlashes On' > /etc/apache2/conf-available/dietpi-freshrss.conf
				a2enconf dietpi-freshrss

			fi

			# Create MariaDB database and user
			if [[ -d $G_FP_DIETPI_USERDATA/mysql/freshrss ]]; then

				G_DIETPI-NOTIFY 2 'FreshRSS MariaDB database found, will NOT overwrite.'

			else

				/DietPi/dietpi/func/create_mysql_db freshrss freshrss "$GLOBAL_PW"

			fi

			# Set permissions for webserver access
			chown -R :www-data /opt/FreshRSS
			chmod -R g+r+w /opt/FreshRSS

			# CLI install: https://github.com/FreshRSS/FreshRSS/blob/master/cli/README.md#commands
			cd /opt/FreshRSS
			sudo -u www-data php ./cli/prepare.php
			sudo -u www-data php ./cli/do-install.php --default_user dietpi --auth_type form --environment production --title FreshRSS --db-type mysql --db-host localhost --db-user freshrss --db-password "$GLOBAL_PW" --db-base freshrss --db-prefix freshrss
			sudo -u www-data php ./cli/create-user.php --user dietpi --password "$GLOBAL_PW" --api_password "$GLOBAL_PW"
			cd /tmp/$G_PROGRAM_NAME

			# Link web interface to webroot
			ln -sf /opt/FreshRSS/p /var/www/freshrss

			# Create cron job for feed update every 30 minutes, if it does not yet exist
			crontab -u www-data -l 2>/dev/null | grep -q '/opt/FreshRSS/app/actualize_script.php' || ( crontab -u www-data -l 2>/dev/null ; echo '*/30 * * * * php /opt/FreshRSS/app/actualize_script.php' ) | crontab -u www-data -

		fi

		#TIGHTVNCSERVER / VNC4SERVER / RealVNC - Shared setup
		#software_id=27/28/120
		if (( ${aSOFTWARE_INSTALL_STATE[27]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[28]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[120]} == 1 )); then

			#Banner_Configuration

			#User, enter PW
			if (( $G_USER_INPUTS )); then

				local entering_pw=1
				local loop_count=0

				# - RealVNC uses Unix account
				if (( ${aSOFTWARE_INSTALL_STATE[120]} == 1 )); then

					entering_pw=0

				else

					G_WHIP_MSG 'A password is required for your VNC Server.\n\nThe next screen will allow you to set your password, this password will be used when connecting from a VNC client/viewer.\n\nPress Ok/Enter when ready.'

				fi

				while (( $entering_pw == 1 )); do

					vncpasswd
					((loop_count++))

					# - Password file created
					if [ -f $HOME/.vnc/passwd ]; then

						entering_pw=0

					# - Endless loop
					elif (( $loop_count >= 30 )); then

						entering_pw=0

					fi

				done

			fi

			cat << _EOF_ > /etc/systemd/system/vncserver.service
[Unit]
Description=Manage VNC Server (DietPi)
Before=xrdp.service xrdp-sesman.service
After=dietpi-boot.service dietpi-ramdisk.service dietpi-ramlog.service

[Service]
Type=simple
User=root
RemainAfterExit=yes
PAMName=login
ExecStart=/bin/bash /usr/local/bin/vncserver start
ExecStop=/bin/bash /usr/local/bin/vncserver stop

[Install]
WantedBy=multi-user.target
_EOF_

			systemctl daemon-reload
			systemctl enable vncserver.service

			cat << _EOF_ > /usr/local/bin/vncserver
#!/bin/bash

#Globals
VNC_INSTALLED=0
BINARY_FP=0
SHARED_MODE=0

WIDTH=\$(grep -m1 '^[[:blank:]]*SOFTWARE_VNCSERVER_WIDTH=' /DietPi/dietpi.txt | sed 's/^.*=//')
HEIGHT=\$(grep -m1 '^[[:blank:]]*SOFTWARE_VNCSERVER_HEIGHT=' /DietPi/dietpi.txt | sed 's/^.*=//')
DEPTH=\$(grep -m1 '^[[:blank:]]*SOFTWARE_VNCSERVER_DEPTH=' /DietPi/dietpi.txt | sed 's/^.*=//')
DISPLAY=\$(grep -m1 '^[[:blank:]]*SOFTWARE_VNCSERVER_DISPLAY_INDEX=' /DietPi/dietpi.txt | sed 's/^.*=//')
SHARED_MODE=\$(grep -m1 '^[[:blank:]]*SOFTWARE_VNCSERVER_SHARE_DESKTOP=' /DietPi/dietpi.txt | sed 's/^.*=//')

#RealVNC | Slightly different launch method to VNC4server
REALVNC=0
if (( \$(dpkg --get-selections | grep -ci -m1 '^realvnc-vnc-server') )); then

	REALVNC=1

	#Set shared desktop mode if autostart is enabled for desktops. This prevents another VNC server being launched on :1.
	if (( \$(</DietPi/dietpi/.dietpi-autostart_index) == 2 )); then

		SHARED_MODE=1

	fi

fi

#Find binary FP to use
if [ -f /usr/bin/tigervncserver ]; then
    BINARY_FP='/usr/bin/tigervncserver'
    VNC_INSTALLED=1
elif [ -f /usr/bin/vnc4server ]; then
    BINARY_FP='/usr/bin/vnc4server'
    VNC_INSTALLED=1
elif [ -f /usr/bin/vncserver ]; then
    BINARY_FP='/usr/bin/vncserver'
    VNC_INSTALLED=1
fi

#Exit if no VNC binary found
if (( ! \$VNC_INSTALLED )); then
    exit 1
fi

case "\$1" in
    start)
        if (( \$SHARED_MODE )); then

			# - excluding RealVNC as it has its own services
			if (( ! \$REALVNC )); then

				#wait for X to start
				while ! pgrep Xorg
				do

					echo 'Waiting for X11 to start'
					sleep 2

				done

				sleep 5 #Give system some time to finish setting up X11 + desktop
				xset dpms force on #disable screen blanking
				x11vnc -display :0 -usepw -forever

			fi

        else

            \$BINARY_FP :\$DISPLAY -geometry \$WIDTH'x'\$HEIGHT -depth \$DEPTH

        fi
    ;;

    stop)
        \$BINARY_FP -kill :\$DISPLAY &> /dev/null
        killall -w x11vnc &> /dev/null
		killall -w Xtigervnc &> /dev/null
    ;;

esac

exit 0
_EOF_
			chmod +x /usr/local/bin/vncserver

			# + RealVNC | enable services
			if (( ${aSOFTWARE_INSTALL_STATE[120]} == 1 )); then

				systemctl enable vncserver-x11-serviced.service
				systemctl enable vncserver-virtuald.service

			fi

			# - Stretch + TigerVNC: Disable Localhost only by default
			if (( $G_DISTRO >= 4 )); then

				echo -e '$localhost = "no";' >> /etc/vnc.conf

			fi

		fi

		#VNC4SERVER / RealVNC
		software_id=28
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} >= 1 ||
			${aSOFTWARE_INSTALL_STATE[120]} >= 1 )); then

			Banner_Configuration

			local cmd_launch_desktop=''
			#DESKTOP_LXDE
			if (( ${aSOFTWARE_INSTALL_STATE[23]} >= 1 )); then

				cmd_launch_desktop='/usr/bin/lxsession -s LXDE &'

			#DESKTOP_MATE
			elif (( ${aSOFTWARE_INSTALL_STATE[24]} >= 1 )); then

				cmd_launch_desktop='/usr/bin/mate-session &'

			#DESKTOP_GNUSTEP
			elif (( ${aSOFTWARE_INSTALL_STATE[26]} >= 1 )); then

				cmd_launch_desktop='x-window-manager &'

			#DESKTOP_XFCE
			elif (( ${aSOFTWARE_INSTALL_STATE[25]} >= 1 )); then

				cmd_launch_desktop='/usr/bin/xfce4-session &'

			fi

			mkdir -p $HOME/.vnc
			cat << _EOF_ > $HOME/.vnc/xstartup
#!/bin/bash
export SHELL='/bin/bash'
[ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
[ -r /root/.Xresources ] && xrdb /root/.Xresources
xsetroot -solid grey
vncconfig -iconic &
$cmd_launch_desktop
_EOF_

			chmod +x $HOME/.vnc/xstartup

		fi

		#FAIL2BAN
		software_id=73
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			G_BACKUP_FP /etc/fail2ban/fail2ban.conf /etc/fail2ban/jail.conf
			cat << _EOF_ > /etc/fail2ban/fail2ban.conf
[Definition]
# loglevel #1=error #2=warn #3=info
loglevel = 3
logtarget = /var/log/fail2ban.log
socket = /var/run/fail2ban/fail2ban.sock
pidfile = /var/run/fail2ban/fail2ban.pid
_EOF_

			cat << _EOF_ > /etc/fail2ban/jail.conf
[DEFAULT]

enabled = true
ignoreip = 127.0.0.1/8
ignorecommand =
backend = systemd
bantime = 600
findtime = 600
maxretry = 3
banaction = route
action_ = %(banaction)s[name=%(__name__)s, bantime="%(bantime)s", port="%(port)s"]
action = %(action_)s

[sshd]

enabled  = true
port     = ssh
filter   = sshd
logpath  = /var/log/auth.log
maxretry = 3

[dropbear]

enabled  = true
port     = ssh
filter   = dropbear
logpath  = /var/log/auth.log
maxretry = 3
_EOF_

		fi

		#InfluxDB
		software_id=74
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Move DB/datadir to userdata location
			mv /var/lib/influxdb $G_FP_DIETPI_USERDATA/
			ln -sf $G_FP_DIETPI_USERDATA/influxdb /var/lib/influxdb

		fi

		#grafana
		software_id=77
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Move DB/plugins to userdata location, if not already existent
			if [[ -d $G_FP_DIETPI_USERDATA/grafana ]]; then

				G_DIETPI-NOTIFY 2 "Existing database/plugin directory $G_FP_DIETPI_USERDATA/grafana found. Will not overwrite..."
				[[ -e /var/lib/grafana ]] && rm -R /var/lib/grafana

			else

				mv /var/lib/grafana $G_FP_DIETPI_USERDATA/

			fi
			ln -sf $G_FP_DIETPI_USERDATA/grafana /var/lib/grafana

			# - Set password, wrap into trippled double quotes in case of ; or # being contained, according to docs: http://docs.grafana.org/installation/configuration/#password
			GCI_PRESERVE=1 G_CONFIG_INJECT 'admin_password[[:blank:]]*=' "admin_password = \"\"\"$GLOBAL_PW\"\"\"" /etc/grafana/grafana.ini

		fi

		#Ubooquity
		software_id=80
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM ubooquity -G dietpi -s /usr/sbin/nologin

			mkdir -p $G_FP_DIETPI_USERDATA/ebooks $G_FP_DIETPI_USERDATA/comics

			chmod +x $G_FP_DIETPI_USERDATA/ubooquity/Ubooquity.jar
			cat << _EOF_ > /etc/systemd/system/ubooquity.service
[Unit]
Description=Ubooquity (DietPi)
After=dietpi-boot.service network.target

[Service]
Type=simple
User=ubooquity
WorkingDirectory=$G_FP_DIETPI_USERDATA/ubooquity
ExecStart=$(which java) -jar $G_FP_DIETPI_USERDATA/ubooquity/Ubooquity.jar --headless --remoteadmin --adminport 2038 --libraryport 2039

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#PHPSYSINFO
		software_id=64
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			G_BACKUP_FP /var/www/phpsysinfo/phpsysinfo.ini
			dps_index=$software_id Download_Install 'phpsysinfo.ini' /var/www/phpsysinfo/phpsysinfo.ini

		fi

		#PHPIMAGEGALLERY
		software_id=56
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Get test images
			mkdir -p /var/www/gallery/DietPi
			wget https://dietpi.com/images/dietpi-logo_256.png -O /var/www/gallery/DietPi/logo_256.png

			mkdir -p /var/www/gallery/Tr-Zero
			wget http://media.indiedb.com/images/games/1/25/24673/SS_0.jpg -O /var/www/gallery/Tr-Zero/SS_0.jpg
			wget http://media.indiedb.com/images/games/1/25/24673/SS_44.jpg -O /var/www/gallery/Tr-Zero/SS_1.jpg
			wget http://media.indiedb.com/images/games/1/25/24673/3.png -O /var/www/gallery/Tr-Zero/SS_2.jpg

			#permissions for cache/thumbnail/database
			mkdir -p /var/www/gallery/_sfpg_data

			#enable (Some type of security trigger)
			sed -i "/define('SECURITY_PHRASE'/c\define('SECURITY_PHRASE', 'true');" /var/www/gallery/index.php

		fi

		#AMPACHE
		software_id=40
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			Download_Test_Media

			#create/insert our pre-made ampache sql db
			Download_Install 'https://dietpi.com/downloads/mysql_databases/ampache_mysql_3.8.2-v6.0.zip'

			/DietPi/dietpi/func/create_mysql_db ampache ampache "$GLOBAL_PW"
			mysql ampache < ampache.sql
			rm ampache.sql

			#Grab config
			G_RUN_CMD wget https://dietpi.com/downloads/conf/ampache.cfg.php_3.8.2-v6.0 -O /var/www/ampache/config/ampache.cfg.php

		fi

		#OPENVPNSERVER
		software_id=97
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			local key_size=1024

			#Start Cert/Key generation.
			cp -R /usr/share/easy-rsa/ /etc/openvpn
			mkdir -p /etc/openvpn/easy-rsa/keys
			cat << _EOF_ >> /etc/openvpn/easy-rsa/vars
export KEY_SIZE=$key_size
export KEY_COUNTRY="UK"
export KEY_PROVINCE="DietPi"
export KEY_CITY="DietPi"
export KEY_ORG="DietPi"
export KEY_EMAIL="noreply@DietPi.com"
export KEY_OU="DietPi"
export KEY_NAME="DietPi_OpenVPN_Server"
_EOF_

			#Create Server Cert Auth
			G_DIETPI-NOTIFY 2 'Generating unique OpenVPN certificates and keys. Please wait...\n'
			openssl dhparam -out /etc/openvpn/dh"$key_size".pem "$key_size"

			#Build Server certs/keys
			chmod -R +x /etc/openvpn/easy-rsa
			cd /etc/openvpn/easy-rsa
			# - https://github.com/Fourdee/DietPi/issues/1450#issuecomment-362608574
			if (( $G_DISTRO >= 4 )); then

				cp openssl-1.0.0.cnf openssl.cnf

			fi
			. ./vars
			./clean-all
			./build-ca --batch DietPi_OpenVPN_Server
			./build-key-server --batch DietPi_OpenVPN_Server

			#Copy Server cert/keys
			cp /etc/openvpn/easy-rsa/keys/{DietPi_OpenVPN_Server.crt,DietPi_OpenVPN_Server.key,ca.crt} /etc/openvpn/

			#Build client cert/keys
			./build-key --batch DietPi_OpenVPN_Client

			cd ..
			#End Cert/Key generation.

			#Server config
			cat << _EOF_ > /etc/openvpn/server.conf
port 1194
proto udp
dev tun

ca ca.crt
cert DietPi_OpenVPN_Server.crt
key DietPi_OpenVPN_Server.key
dh dh$key_size.pem

server 10.8.0.0 255.255.255.0

client-to-client
keepalive 10 60
comp-lzo
max-clients 10

user nobody
group nogroup

persist-key
persist-tun
verb 3

#Web Forwarding (uncomment to enable)
#push "redirect-gateway"
#push "dhcp-option DNS 10.8.0.1"

_EOF_

			#Client config
			cat << _EOF_ > /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
client
proto udp
dev tun

#Ip/Domain name of DietPi system, running OpenVPN server.
remote mywebsite.com 1194

resolv-retry infinite
nobind

user nobody
group nogroup

persist-key
persist-tun

ns-cert-type server
comp-lzo
verb 3

_EOF_

			#Unified client file. Add DietPi generated certs/keys.
			# - Add Server Cert auth
			echo '<ca>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			cat /etc/openvpn/ca.crt >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			echo '</ca>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			# - Add Client Cert
			echo '<cert>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			cat /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.crt >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			echo '</cert>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			# - Add Client Key
			echo '<key>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			cat /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.key >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			echo '</key>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn

			#Copy client file to userdata location
			cp /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn $G_FP_DIETPI_USERDATA/
			# - and /boot partition
			cp /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn /boot/

			#enable ipv4 forwarding
			sed -i '/net.ipv4.ip_forward=/c\net.ipv4.ip_forward=1' /etc/sysctl.conf

			#Web Fowarding (Setup IPtables, must also be run during boot)
			#iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o "$(sed -n 3p /DietPi/dietpi/.network)" -j MASQUERADE

		fi

		#WIFIHOTSPOT
		software_id=60
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			local eth_index=$(sed -n 1p /DietPi/dietpi/.network)
			local wifi_index=$(sed -n 2p /DietPi/dietpi/.network)

			# - DHCPD Config
			G_BACKUP_FP /etc/dhcp/dhcpd.conf
			cat << _EOF_ > /etc/dhcp/dhcpd.conf
ddns-update-style none;
default-lease-time 600;
max-lease-time 7200;
authoritative;
log-facility local7;

subnet 192.168.42.0 netmask 255.255.255.0 {
        range 192.168.42.10 192.168.42.50;
        option broadcast-address 192.168.42.255;
        option routers 192.168.42.1;
        option domain-name "local";
        option domain-name-servers 8.8.8.8, 8.8.4.4;
}
_EOF_

			# - Assign wlan as interface for dhcp server.
			cat << _EOF_ > /etc/default/isc-dhcp-server
INTERFACES="wlan$wifi_index"
_EOF_

			# - Remove all entries below wlan, so we can recreate them.
			sed -i '/allow-hotplug wlan/q0' /etc/network/interfaces

			# - enable up wlan
			sed -i "/allow-hotplug wlan/c\allow-hotplug wlan$wifi_index" /etc/network/interfaces

			# - Add wifi settings to network interfaces config
			cat << _EOF_ >> /etc/network/interfaces
iface wlan$wifi_index inet static
address 192.168.42.1
netmask 255.255.255.0
#gateway 192.168.0.1
wireless-power off
#dns-nameservers 8.8.8.8 8.8.4.4

# IP tables
up iptables-restore < /etc/iptables.ipv4.nat
_EOF_

			# - Assign static IP for wlan now
			#ifconfig wlan$wifi_index 192.168.42.1
			ip addr add 192.168.42.1 dev wlan$wifi_index

			# - Create access point config
			G_BACKUP_FP /etc/hostapd/hostapd.conf
			cat << _EOF_ > /etc/hostapd/hostapd.conf
interface=wlan$wifi_index
driver=nl80211
ssid=$(grep -m1 '^[[:blank:]]*SOFTWARE_WIFI_HOTSPOT_SSID=' /DietPi/dietpi.txt | sed 's/^.*=//')
hw_mode=g
channel=$(grep -m1 '^[[:blank:]]*SOFTWARE_WIFI_HOTSPOT_CHANNEL=' /DietPi/dietpi.txt | sed 's/^.*=//')
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=$(grep -m1 '^[[:blank:]]*SOFTWARE_WIFI_HOTSPOT_KEY=' /DietPi/dietpi.txt | sed 's/^.*=//')
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
_EOF_

			# - Check for RTL8188C* device, use the patched driver with compiled binary: https://github.com/pritambaral/hostapd-rtl871xdrv#why
			if (( $WIFIHOTSPOT_RTL8188C_DEVICE )); then

				sed -i "/^driver=/c\driver=rtl871xdrv" /etc/hostapd/hostapd.conf

			fi

			# - Enable access point config
			cat << _EOF_ > /etc/default/hostapd
DAEMON_CONF="/etc/hostapd/hostapd.conf"
_EOF_

			# - Enable IPv4 forwarding
			sed -i "/net.ipv4.ip_forward=/c\net.ipv4.ip_forward=1" /etc/sysctl.conf
			echo 1 > /proc/sys/net/ipv4/ip_forward

			# - Apply iptables
			iptables -t nat -A POSTROUTING -o eth$eth_index -j MASQUERADE
			iptables -A FORWARD -i eth$eth_index -o wlan$wifi_index -m state --state RELATED,ESTABLISHED -j ACCEPT
			iptables -A FORWARD -i wlan$wifi_index -o eth$eth_index -j ACCEPT

			# - Save IP tables, applied during ifup in /etc/network/interfaces.
			iptables-save > /etc/iptables.ipv4.nat

			# - RPi 3 - onboard wifi, enable N
			if (( $G_HW_MODEL == 3 && ! $WIFIHOTSPOT_RTL8188C_DEVICE )); then

				# - Add Wireless N support
				echo -e "ieee80211n=1" >> /etc/hostapd/hostapd.conf

			fi

		fi

		#TORHOTSPOT
		software_id=61
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Tor config
			cat << _EOF_ > /etc/tor/torrc
Log notice file /var/log/tor/notices.log
VirtualAddrNetwork 10.192.0.0/10
AutomapHostsSuffixes .onion,.exit
AutomapHostsOnResolve 1
TransPort 9040
TransListenAddress 192.168.42.1
DNSPort 53
DNSListenAddress 192.168.42.1
_EOF_

			# - Flush IP tables
			iptables -F
			iptables -t nat -F

			# - Generate tor prerouting tables
			local wifi_index=$(sed -n 2p /DietPi/dietpi/.network)
			iptables -t nat -A PREROUTING -i wlan$wifi_index -p tcp --dport 22 -j REDIRECT --to-ports 22
			iptables -t nat -A PREROUTING -i wlan$wifi_index -p udp --dport 53 -j REDIRECT --to-ports 53
			iptables -t nat -A PREROUTING -i wlan$wifi_index -p tcp --syn -j REDIRECT --to-ports 9040

			# - Save
			iptables-save > /etc/iptables.ipv4.nat

			# - Generate Logfile
			mkdir -p /var/log/tor
			> /var/log/tor/notices.log
			chown -R debian-tor:nogroup /var/log/tor/notices.log

			# - User: Test tor is functional.
			#https://check.torproject.org

		fi

		#SHAIRPORTSYNC
		software_id=37
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Enable SOXR by default:
			G_BACKUP_FP /usr/local/etc/shairport-sync.conf
			cat << _EOF_ >  /usr/local/etc/shairport-sync.conf
general =
{
  name = "%H";
  interpolation = "soxr";
};

metadata =
{
	enabled = "yes";
	include_cover_art = "no";
	pipe_name = "/tmp/shairport-sync-metadata";
	pipe_timeout = 5000;
	socket_address = "226.0.0.1";
	socket_port = 5555;
	socket_msglength = 65000;
};


alsa =
{
//  mixer_control_name = "PCM";
//  output_rate = 44100; // can be 44100, 88200, 176400 or 352800
//  output_format = "S16"; // can be "U8", "S8", "S16", "S24", "S24_3LE", "S24_3BE" or "S32"
};
_EOF_

			#Create shairport user
			useradd -rM shairport-sync -G audio -s /usr/sbin/nologin

			chmod +x /usr/local/bin/shairport-sync

		fi

		#PYDIO
		software_id=48
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# PHP configuration
			${PHP_BINARY}enmod apcu gd intl pdo_mysql
			(( $G_DISTRO > 3 )) && phpenmod dom mbstring xml

			# Webserver config
			# - Apache2
			if (( ${aSOFTWARE_INSTALL_STATE[83]} > 0 )); then

				# - Enable Apache2 rewrite engine
				a2enmod rewrite

				# - Move Pydio Apache2 config in place
				dps_index=$software_id Download_Install 'apache.pydio.conf' /etc/apache2/sites-available/dietpi-pydio.conf
				a2ensite dietpi-pydio

			# - Lighttpd
			elif (( ${aSOFTWARE_INSTALL_STATE[84]} > 0 )); then

				# - Enable Lighttpd setenv, access and rewrite modules
				G_CONFIG_INJECT '"mod_access",' '	"mod_access",' /etc/lighttpd/lighttpd.conf '"mod_.+",'
				G_CONFIG_INJECT '"mod_setenv",' '	"mod_setenv",' /etc/lighttpd/lighttpd.conf '"mod_.+",'
				#	- On Jessie rewrite.ini is not available, thus "lighttpd-enable-mod rewrite" does not work.
				if (( $G_DISTRO < 4 )); then

					G_CONFIG_INJECT '"mod_rewrite",' '	"mod_rewrite",' /etc/lighttpd/lighttpd.conf '"mod_.+",'

				else

					lighttpd-enable-mod rewrite

				fi

				# - Move Pydio Lighttpd config in place
				dps_index=$software_id Download_Install 'lighttpd.pydio.conf' /etc/lighttpd/conf-available/99-dietpi-pydio.conf
				lighttpd-enable-mod dietpi-pydio

			# - Nginx
			elif (( ${aSOFTWARE_INSTALL_STATE[85]} > 0 )); then

				# - Move Pydio Nginx config in place
				dps_index=$software_id Download_Install 'nginx.pydio.conf' /etc/nginx/sites-dietpi/dietpi-pydio.conf

			fi

			# Create MySQL DB
			/DietPi/dietpi/func/create_mysql_db pydio pydio "$GLOBAL_PW"

			# Setup Data directory
			# - Skip if already existent
			local target_data_dir=$G_FP_DIETPI_USERDATA/pydio_data
			if [[ -d $target_data_dir ]]; then

				G_DIETPI-NOTIFY 2 "Existing $target_data_dir found, will migrate..."
				[[ -e /var/www/pydio/data ]] && rm -R /var/www/pydio/data

			else

				# - Move data structure
				[[ -e $target_data_dir ]] && rm -R $target_data_dir
				mv /var/www/pydio/data $target_data_dir

			fi

			# Create symlink
			ln -sf $target_data_dir /var/www/pydio/data

		fi


		#SQUEEZELITE
		software_id=36
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Replace Sysinit service with systemd
			echo -e '#This file is no longer used as service has been upgraded to systemd.\n#Please see /etc/systemd/system/squeezelite.service to set start options' > /etc/default/squeezelite
			rm /etc/init.d/squeezelite
			dps_index=$software_id Download_Install 'squeezelite.service' /etc/systemd/system/squeezelite.service

			Download_Test_Media

		fi

		#EMONHUB
		software_id=99
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Copy configs
			cp /etc/emonhub/conf/default/emonhub /etc/default/emonhub

			# - Setup service
			cp /etc/emonhub/service/emonhub /etc/init.d/emonhub
			chmod +x /etc/init.d/emonhub
			update-rc.d emonhub defaults

			chmod +x -R /etc/emonhub

			#RPI 3 - Must disable BCM BT to recover UART 0
			if (( $G_HW_MODEL == 3 )); then

				# - Add DToverlay to disable bluetooth
				if ! grep -qi '=pi3-disable-bt' /DietPi/config.txt; then

					echo -e '\ndtoverlay=pi3-disable-bt' >> /DietPi/config.txt

				# - Enable
				else

					sed -i '/pi3-disable-bt/c\dtoverlay=pi3-disable-bt' /DietPi/config.txt

				fi

				# - Disable bluetooth service
				systemctl stop hciuart
				systemctl disable hciuart

			fi

			#RPi - Disable serial tty that emonPi uses.
			/DietPi/dietpi/func/dietpi-set_hardware serialconsole disable

			# - Apply user API KEY
			USER_EMONHUB_APIKEY_CURRENT="$(grep -m1 '^[[:blank:]]*SOFTWARE_EMONHUB_APIKEY=' /DietPi/dietpi.txt | sed 's/^.*=//')"
			sed -i "/apikey/c\        apikey = $USER_EMONHUB_APIKEY_CURRENT" /etc/emonhub/conf/emonhub.conf

		fi

		#RPIMONITOR
		software_id=66
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Update apt package stats
			/usr/share/rpimonitor/scripts/updatePackagesStatus.pl

			# - USBdrive stats implimentation by Rich
			if (( $USBDRIVE )); then

				sed -i '\/include=\/etc\/rpimonitor\/template\/sdcard.conf/a include=\/etc\/rpimonitor\/template\/usb_hdd.conf' /etc/rpimonitor/data.conf

				cat << _EOF_ > /etc/rpimonitor/template/usb_hdd.conf
########################################################################
# Extract USB HDD (sda1) information
#  Page: 1
#  Information               Status     Statistics
#  - USBHDD1 total          - yes      - yes
#  - USBHDD1 used           - yes      - yes
########################################################################
static.10.name=usbhdd_total
static.10.source=df -t ext4
static.10.regexp=sda1\s+(\d+)
static.10.postprocess=\$1/1024

dynamic.14.name=usbhdd_used
dynamic.14.source=df -t ext4
dynamic.14.regexp=sda1\s+\d+\s+(\d+)
dynamic.14.postprocess=\$1/1024
dynamic.14.rrd=GAUGE

web.status.1.content.9.name=USB HDD
web.status.1.content.9.icon=usb_hdd.png
web.status.1.content.9.line.1="<b>/sda1</b> Used: <b>"+KMG(data.usbhdd_used,'M')+"</b> (<b>"+Percent(data.udbhdd_used,data.usbhdd_total,'M')+"</b>) Free: <b>"+KMG(data.usbhdd_total-data.usbhdd_used,'M')+ "</b> Total: <b>"+ KMG(data.usbhdd_total,'M') +"</b>"
web.status.1.content.9.line.2=ProgressBar(data.usbhdd_used,data.usbhdd_total)

web.statistics.1.content.9.name=USB HDD
web.statistics.1.content.9.graph.1=usbhdd_total
web.statistics.1.content.9.graph.2=usbhdd_used
web.statistics.1.content.9.ds_graph_options.usbhdd_total.label=USB HDD total space (MB)
web.statistics.1.content.9.ds_graph_options.usbhdd_total.color="#FF7777"
web.statistics.1.content.9.ds_graph_options.usbhdd_used.label=USB HDD used space (MB)
web.statistics.1.content.9.ds_graph_options.usbhdd_used.lines={ fill: true }
web.statistics.1.content.9.ds_graph_options.usbhdd_used.color="#7777FF"
_EOF_

			fi

		fi

		#NETDATA
		software_id=65
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - service
			dps_index=$software_id Download_Install 'netdata.service' /etc/systemd/system/netdata.service

			# - Create netdata user/group
			getent passwd netdata > /dev/null || useradd -r netdata -c netdata -s /usr/sbin/nologin -d /

			for i in /var/cache/netdata /usr/share/netdata/web /etc/netdata /var/log/netdata /var/lib/netdata; do

				chown -R netdata.netdata $i
				chmod 0775 -R $i

			done

		fi

		#BAIKAL
		software_id=57
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			/DietPi/dietpi/func/dietpi-set_software setpermissions &> /dev/null

			# - install/run composer | Also run for ampache. Move this to a global function....
			php -r "readfile('https://getcomposer.org/installer');" > composer-setup.php
			php composer-setup.php
			php -r "unlink('composer-setup.php');"

			mv composer.phar /usr/local/bin/composer

			cd /var/www/baikal
			composer install --no-interaction
			cd /tmp/$G_PROGRAM_NAME

			# - Mysql DB
			/DietPi/dietpi/func/create_mysql_db baikal baikal "$GLOBAL_PW"

			# - Cal/CardDAV request redirection: http://sabre.io/baikal/install/, https://github.com/bambocher/docker-baikal/blob/master/lighttpd.conf
			#	- Apache
			if (( ${aSOFTWARE_INSTALL_STATE[83]} > 0 )); then

				echo '# Redirect Cal/CardDAV requests to Baikal endpoint:
Redirect permanent /.well-known/carddav /baikal/html/dav.php
Redirect permanent /.well-known/caldav /baikal/html/dav.php' > /etc/apache2/conf-available/dietpi-dav_redirect.conf
				a2enconf dietpi-dav_redirect

			#	- Lighttpd
			elif (( ${aSOFTWARE_INSTALL_STATE[84]} > 0 )); then

				echo '# Redirect Cal/CardDAV requests to Baikal endpoint:
url.redirect = (
	"^/.well-known/caldav"  => "/baikal/html/dav.php",
	"^/.well-known/carddav" => "/baikal/html/dav.php"
)' > /etc/lighttpd/conf-available/99-dietpi-dav_redirect.conf
				lighttpd-enable-mod dietpi-dav_redirect

			#	- Nginx
			elif (( ${aSOFTWARE_INSTALL_STATE[85]} > 0 )); then

				echo '# Redirect Cal/CardDAV requests to Baikal endpoint:
location = /.well-known/carddav {
	return 301 $scheme://$host/baikal/html/dav.php;
}
location = /.well-known/caldav {
	return 301 $scheme://$host/baikal/html/dav.php;
}' > /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf

			fi

		fi

		#MUMBLESERVER
		software_id=43
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Cap total connections
			local max_users=$(( $G_HW_CPU_CORES * 8 ))
			sed -i "/users=/c\users=$max_users" /etc/mumble-server.ini

			#Name the root channel
			sed -i '/registerName=/c\registerName=DietPi Mumble Server' /etc/mumble-server.ini

			#Disable DB logging
			sed -i '/logdays=/c\logdays=-1' /etc/mumble-server.ini

			#Set Superuser passwd: https://dietpi.com/phpbb/viewtopic.php?f=11&t=2024#p8084
			murmurd -ini /etc/mumble-server.ini -supw "$GLOBAL_PW"

		fi

		#EMBYSERVER
		software_id=41
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration
			Download_Test_Media

		fi

		#PLEXMEDIASERVER
		software_id=42
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration
			Download_Test_Media

			# For all ARM devices:
			# - en_US.UTF-8 must be installed and the default locale on system. This is for SBC installs using dev2day repo: https://github.com/Fourdee/DietPi/issues/116#issuecomment-222195911
			if (( $G_HW_ARCH < 10 )) && ! locale | grep -q 'en_US.UTF-8'; then

				G_WHIP_MSG 'Plex Media Server requires en_US.UTF-8 locale to be installed and set to default, else, Plex will not start.\n\nThe installer will now change your locale to: en_US.UTF-8'
				/DietPi/dietpi/func/dietpi-set_software locale 'en_US.UTF-8'

			fi

			# Run service as "dietpi" group: https://github.com/Fourdee/DietPi/issues/350#issuecomment-423763518
			mkdir -p /etc/systemd/system/plexmediaserver.service.d
			echo -e '[Service]\nGroup=dietpi' > /etc/systemd/system/plexmediaserver.service.d/dietpi-group.conf

		fi

		#CUBERITE
		software_id=52
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM cuberite -G dietpi -s /usr/sbin/nologin

			cat << _EOF_ > /etc/systemd/system/cuberite.service
[Unit]
Description=Cuberite Server (DietPi)

[Service]
Type=forking
User=cuberite
Group=dietpi
WorkingDirectory=$G_FP_DIETPI_USERDATA/cubrite
ExecStart=$G_FP_DIETPI_USERDATA/cubrite/Cuberite --service

[Install]
WantedBy=multi-user.target
_EOF_

			#WebUI settings
			cat << _EOF_ > $G_FP_DIETPI_USERDATA/cubrite/webadmin.ini
[User:admin]
Password=$GLOBAL_PW

[WebAdmin]
Ports=1339
Enabled=1
_EOF_

		fi

		#MINEOS
		software_id=53
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Add underprivilged user for web access | no longer works, could be a nodejs v8 issue?
			useradd mineos
			echo -e "$GLOBAL_PW\n$GLOBAL_PW\n" | passwd mineos

			#Stop mineos from running while we config it. When we didnt do this, the program would constantly overwrite our symlink from (/var/games/minecraft).
			/DietPi/dietpi/dietpi-services stop
			killall -w supervisord &> /dev/null
			killall -w node &> /dev/null
			killall -w nodejs &> /dev/null

			# - Create symlinks to userdata dir
			mkdir -p $G_FP_DIETPI_USERDATA/mineos/minecraft
			ln -sf $G_FP_DIETPI_USERDATA/mineos/minecraft/mineos_console.js /usr/local/bin/mineos

			G_BACKUP_FP /etc/mineos.conf
			cp $G_FP_DIETPI_USERDATA/mineos/minecraft/mineos.conf /etc/mineos.conf

			rm -R /var/games/minecraft &> /dev/null
			mkdir -p /var/games
			mkdir -p $G_FP_DIETPI_USERDATA/mineos/serverdata
			ln -sf $G_FP_DIETPI_USERDATA/mineos/serverdata /var/games/minecraft

			# - setup SSL cert
			cd $G_FP_DIETPI_USERDATA/mineos/minecraft
			./generate-sslcert.sh
			cd /tmp/$G_PROGRAM_NAME

			# - Supervisor service
			cat << _EOF_ > /etc/supervisor/conf.d/mineos.conf
[program:mineos]
command=/usr/local/bin/node webui.js
directory=$G_FP_DIETPI_USERDATA/mineos/minecraft
environment=HOME=$G_FP_DIETPI_USERDATA/mineos
user=root
autostart=true
autorestart=true
redirect_stderr=true
_EOF_

			supervisorctl reload

		fi

		#GOGS
		software_id=49
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			adduser gogs --system --no-create-home --group --shell=/bin/nologin

			# - Data storage / user data
			mkdir -p $G_FP_DIETPI_USERDATA/gogs-repo
			mkdir -p /var/log/gogs
			> /var/log/gogs/gogs_daemon.log
			chown -R gogs:gogs /var/log/gogs

			# - sqldb
			/DietPi/dietpi/func/create_mysql_db gogs gogs "$GLOBAL_PW"

			cat << _EOF_ > /etc/systemd/system/gogs.service
[Unit]
Description=Gogs (DietPi)
DefaultDependencies=no
After=mysqld.service mysql.service mariadb.service

[Service]
Type=simple
User=gogs
Group=gogs
WorkingDirectory=/etc/gogs
Environment=USER=gogs HOME=/etc/gogs
ExecStart=/etc/gogs/gogs web &> /var/log/gogs/gogs_daemon.log
StandardOutput=tty

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#QBITTORRENT
		software_id=46
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rm qbittorrent -p "$GLOBAL_PW" -G dietpi -s /usr/sbin/nologin

			# - conf.
			mkdir -p /home/qbittorrent/.config/qBittorrent
			G_BACKUP_FP /home/qbittorrent/.config/qBittorrent/qBittorrent.conf
			cat << _EOF_ > /home/qbittorrent/.config/qBittorrent/qBittorrent.conf
[General]
ported_to_new_savepath_system=true

[Preferences]
Downloads\DiskWriteCacheSize=$(Optimize_BitTorrent 0)
Downloads\DiskWriteCacheTTL=60
Queueing\MaxActiveDownloads=$(Optimize_BitTorrent 1)
Queueing\MaxActiveTorrents=$(Optimize_BitTorrent 1)
Queueing\MaxActiveUploads=1
Queueing\IgnoreSlowTorrents=false
Bittorrent\MaxConnecs=$(Optimize_BitTorrent 2)
Bittorrent\MaxConnecsPerTorrent=$(Optimize_BitTorrent 2)
Bittorrent\MaxUploads=$(Optimize_BitTorrent 3)
Bittorrent\MaxUploadsPerTorrent=$(Optimize_BitTorrent 3)
WebUI\Port=1340
WebUI\Enabled=true
General\Locale=en_GB
Downloads\SavePath=$G_FP_DIETPI_USERDATA/downloads
Downloads\TempPathEnabled=false
Downloads\TempPath=$G_FP_DIETPI_USERDATA/downloads
Downloads\ScanDirs=@Invalid()
Downloads\DownloadInScanDirs=@Invalid()
Downloads\TorrentExportDir=
MailNotification\enabled=false
MailNotification\email=
MailNotification\smtp_server=smtp.changeme.com
MailNotification\req_ssl=false
MailNotification\req_auth=false
MailNotification\username=
MailNotification\password=
Downloads\PreAllocation=false
Queueing\QueueingEnabled=false
Downloads\UseIncompleteExtension=false
Connection\PortRangeMin=6881
Connection\UPnP=true
Connection\GlobalDLLimit=-1
Connection\GlobalUPLimit=-1
Bittorrent\uTP=true
Bittorrent\uTP_rate_limited=false
Advanced\IncludeOverhead=false
Connection\GlobalDLLimitAlt=10
Connection\GlobalUPLimitAlt=10
Scheduler\Enabled=false
Bittorrent\DHT=true
Bittorrent\sameDHTPortAsBT=true
Bittorrent\DHTPort=6881
Bittorrent\PeX=true
Bittorrent\LSD=true
Bittorrent\Encryption=1
Advanced\AnonymousMode=false
Connection\ProxyType=-1
Connection\Proxy\IP=0.0.0.0
Connection\Proxy\Port=8080
Connection\ProxyPeerConnections=false
Connection\Proxy\Authentication=false
Connection\Proxy\Username=
Connection\Proxy\Password=
IPFilter\Enabled=false
IPFilter\File=
WebUI\Username=qbittorrent
WebUI\LocalHostAuth=true
WebUI\HTTPS\Enabled=false
DynDNS\Enabled=false
DynDNS\Service=0
DynDNS\Username=
DynDNS\Password=
DynDNS\DomainName=changeme.dyndns.org
WebUI\Password_ha1=@ByteArray($(echo -ne "$GLOBAL_PW" | md5sum | awk '{print $1}'))

[LegalNotice]
Accepted=true

[AutoRun]
enabled=false
program=
_EOF_

			#Jessie WebUI\Password_ha1 breaks login with m5dsum generated pw, revert to default 'adminadmin': https://github.com/Fourdee/DietPi/issues/1499#issuecomment-364769146
			if (( $G_DISTRO == 3 )); then

				sed -i '/Password_ha1=/d' $HOME/.config/qBittorrent/qBittorrent.conf

			fi

			# - service
			cat << _EOF_ > /etc/systemd/system/qbittorrent.service
[Unit]
Description=qBittorrent (DietPi)
After=network.target

[Service]
Type=simple
User=qbittorrent
Group=dietpi
RemainAfterExit=yes
ExecStart=/usr/bin/qbittorrent-nox --webui-port=1340

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#RTORRENT
		software_id=107
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Create username/password for rutorrent based on webserver type.
			# - Apache2
			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

				# - Allow overrides redirects and .htaccess
				sed -i "/AllowOverride /c\    AllowOverride All" /etc/apache2/sites-enabled/000-default*
				sed -i "/AllowOverride /c\    AllowOverride All" /etc/apache2/apache2.conf

				a2enmod rewrite

				#install scgi module
				G_AGI libapache2-mod-scgi

				htpasswd -cb /etc/.rutorrent-htaccess root "$GLOBAL_PW"
				cat << _EOF_ > /var/www/rutorrent/.htaccess
AuthUserFile /etc/.rutorrent-htaccess
AuthName "ruTorrent_login"
AuthType Basic
require user root
_EOF_

				cat << _EOF_ > /etc/apache2/sites-available/dietpi-rutorrent.conf
SCGIMount /RPC2 127.0.0.1:5000
<location /RPC2>
AuthName "rTorrent secure access"
AuthType Basic
AuthBasicProvider file
AuthUserFile /etc/.rutorrent-htaccess
Require user root
</location>
_EOF_
				a2ensite dietpi-rutorrent

			# - Lighttpd
			elif (( ${aSOFTWARE_INSTALL_STATE[84]} >= 1 )); then

				echo "root:rtorrent:$(echo -n 'root:rtorrent:dietpi' | md5sum | cut -b -32)" > /etc/.rutorrent-htaccess

				# - add to /etc/lighttpd/lighttpd.conf
				if ! grep -qi '^#RUTORRENT_DIETPI' /etc/lighttpd/lighttpd.conf; then

					cat << _EOF_ >> /etc/lighttpd/lighttpd.conf
#RUTORRENT_DIETPI
server.modules += ( "mod_fastcgi" )
server.modules += ( "mod_scgi" )
server.modules += ( "mod_auth" )
auth.debug = 0
auth.backend = "htdigest"
auth.backend.htdigest.userfile = "/etc/.rutorrent-htaccess"

auth.require = ( "/rutorrent/" => (
                    "method"  => "digest",
                    "realm"   => "rtorrent",
                    "require" => "valid-user"
               ))

scgi.server = ( "/RPC2" =>
    ( "127.0.0.1" =>
        (
            "host" => "127.0.0.1",
            "port" => 5000,
            "check-local" => "disable"
        )
    )
)
#RUTORRENT_DIETPI
_EOF_

				fi

			# - Nginx
			elif (( ${aSOFTWARE_INSTALL_STATE[85]} >= 1 )); then

				echo "root:$(openssl passwd -crypt dietpi)" > /etc/.rutorrent-htaccess

				cat << _EOF_ > /etc/nginx/sites-dietpi/dietpi-rutorrent.conf
location /rutorrent {
    auth_basic "Restricted Content";
    auth_basic_user_file /etc/.rutorrent-htaccess;
}

location /RPC2 {
    include scgi_params;
    scgi_pass 127.0.0.1:5000;
}
_EOF_

			fi

			# - Define curl location in config.php (for lighttpd and nginx)
			sed -i '/"curl"[[:space:]]/c\        "curl" => "/usr/bin/curl",' /var/www/rutorrent/conf/config.php

			chown www-data:www-data /etc/.rutorrent-htaccess
			chmod 400 /etc/.rutorrent-htaccess

			# - Session folder
			mkdir -p $G_FP_DIETPI_USERDATA/downloads/.session

			# - Service using screen | '/usr/bin/rtorrent &> /var/log/rtorrent.log &' doesnt work, hangs program after 5 seconds
			cat << _EOF_ > /etc/systemd/system/rtorrent.service
[Unit]
Description=rTorrent (DietPi)
After=network.target

[Service]
User=root
Type=forking
KillMode=none
ExecStart=/usr/bin/screen -d -m -fa -S rtorrent /usr/bin/rtorrent
ExecStop=/usr/bin/killall -w -s 2 /usr/bin/rtorrent
WorkingDirectory=%h

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl daemon-reload

			#Default conf
			cat << _EOF_ > $HOME/.rtorrent.rc
#Attempt to reduce disk throttling/abuse | 0.9.2 command does not exist
#max_open_files = 50

#Max queue
scheduler.max_active.set = 3

#byte value
max_memory_usage = $(( $(Optimize_BitTorrent 0) * 1024 * 1024 ))

# Maximum and minimum number of peers to connect to per torrent.
min_peers = 1
max_peers = $(( $(Optimize_BitTorrent 2) / 2 + 1 ))

# Same as above but for seeding completed torrents (-1 = same as downloading)
min_peers_seed = -1
max_peers_seed = -1

# Maximum number of simultaneous downloads
max_downloads_global = $(Optimize_BitTorrent 2)
# Maximum number of simultaneous uploads
max_uploads_global = $(Optimize_BitTorrent 3)

# Global upload and download rate in KiB. "0" for unlimited.
download_rate = 0
upload_rate = 0

# Default directory to save the downloaded torrents.
directory = $G_FP_DIETPI_USERDATA/downloads

# Default session directory. Make sure you don't run multiple instance
# of rtorrent using the same session directory. Perhaps using a
# relative path?
session = $G_FP_DIETPI_USERDATA/downloads/.session

# Close torrents when diskspace is low.
schedule = low_diskspace,5,60,close_low_diskspace=1000M

# Periodically save session data
schedule = session_save,240,300,session_save=

# Enable the default ratio group.
ratio.enable=yes
# Change the limits, the defaults should be sufficient.
# Upload to a minimum ratio of 1.01
ratio.min.set=101
# Upload to a maximum ratio of 1.25
ratio.max.set=125
# Upload a minimum of x MB
ratio.upload.set=1M

# When seeding ratio is reached close the torrent
system.method.set = group.seeding.ratio.command, d.close=

# Move files to ./unsorted when download completes
system.method.set_key = event.download.finished,move_complete,"execute=mv,-n,$d.get_base_path=,./unsorted/;d.set_directory=./unsorted/"

# Port range to use for listening.
port_range = 33101-33199

# Start opening ports at a random position within the port range.
port_random = yes

# Encryption options, set to none (default) or any combination of the following:
# allow_incoming, try_outgoing, require, require_RC4, enable_retry, prefer_plaintext
#
# The example value allows incoming encrypted connections, starts unencrypted
# outgoing connections but retries with encryption if they fail, preferring
# plaintext to RC4 encryption after the encrypted handshake
#
encryption = require

# Sort the main view by ratio
view.sort_current = main,greater=d.get_ratio=
view.sort_new = main,less=d.get_ratio=
view.sort = main

# Sort the seeding view by the upload rate and only show torrents with peers
view.sort_current = seeding,greater=d.get_up_rate=
view.filter = seeding,"and=d.get_complete=,d.get_peers_connected="
view.sort_new = seeding,less=d.get_up_rate=
view.sort = seeding

# Sort the leeching view by name
view.sort_current = leeching,greater=d.get_name=
view.sort_new = leeching,greater=d.get_name=
view.sort = leeching

# Filter the active view by connected peers
view.sort_current = active,less=d.get_name=
view.sort_new = leeching,less=d.get_name=
view.filter = active,d.get_peers_connected=
view.sort = active

schedule = sort_main,11,5,view.sort=main
schedule = sort_seeding,12,5,view.sort=seeding
schedule = sort_leeching,13,5,view.sort=leeching
schedule = sort_active,14,5,view.sort=active

# Enable DHT support for trackerless torrents or when all trackers are down.
# May be set to "disable" (completely disable DHT), "off" (do not start DHT),
# "auto" (start and stop DHT as needed), or "on" (start DHT immediately).
# The default is "off". For DHT to work, a session directory must be defined.
#
dht = auto

# UDP port to use for DHT.
#
#dht_port = 6881

# Enable peer exchange (for torrents not marked private)
#
peer_exchange = yes

#Enable remote access (eg: webui)
scgi_port = localhost:5000

_EOF_


		fi

		#Aria2
		software_id=132
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			G_BACKUP_FP /var/lib/dietpi/dietpi-software/installed/aria2.conf
			cat << _EOF_ > /var/lib/dietpi/dietpi-software/installed/aria2.conf
# host is where aria2c is running on
host=localhost
dir=$G_FP_DIETPI_USERDATA/$FOLDER_DOWNLOADS

# cleanup_policy
cleanup-policy=clean_got
cleanup-percent=90%

# The fallowing options are aria2c options as usual aria2.conf file
# https://aria2.github.io/manual/en/html/aria2c.html

# RPC Options
enable-rpc=true
rpc-listen-all=true
rpc-listen-port=6800
rpc-secret=$GLOBAL_PW
pause=false

# General Options
log=/var/log/aria2.log
log-level=warn

split=$(Optimize_BitTorrent 1)
continue=true
check-integrity=true
max-concurrent-downloads=$(Optimize_BitTorrent 1)
max-connection-per-server=$(Optimize_BitTorrent 1)
max-file-not-found=3
max-tries=5
retry-wait=60
ftp-pasv=true
bt-max-peers=$(Optimize_BitTorrent 2)
listen-port=6881-6999
check-certificate=false

max-overall-upload-limit=0
max-upload-limit=0
max-overall-download-limit=0
max-download-limit=0
seed-ratio=0.1
seed-time=0

metalink-servers=$(Optimize_BitTorrent 2)
allow-overwrite=false
always-resume=true
auto-file-renaming=false
file-allocation=none

[limit-options]
max-concurrent-downloads=$(Optimize_BitTorrent 1)
max-overall-download-limit=1000K
max-overall-upload-limit=100K

[unlimit-options]
max-concurrent-downloads=$(Optimize_BitTorrent 1)
max-overall-download-limit=0
max-overall-upload-limit=0
_EOF_

			cat << _EOF_ > /etc/systemd/system/aria2.service
[Unit]
Description=Aria2 (DietPi)

[Service]
Type=simple
ExecStart=$(which aria2c) --conf-path=/var/lib/dietpi/dietpi-software/installed/aria2.conf

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#SYNCTHING
		software_id=50
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Generate dir's
			mkdir -p $G_FP_DIETPI_USERDATA/syncthing
			mkdir -p $G_FP_DIETPI_USERDATA/syncthing_data

			#	Logs/Binary
			mkdir -p /var/log/syncthing
   			>> /var/log/syncthing/syncthing.log
   			chown -R dietpi:dietpi /var/log/syncthing
   			chown -R dietpi:dietpi /etc/syncthing

			# - Run Syncthing to create cert/config and exit
			/etc/syncthing/syncthing -generate=$G_FP_DIETPI_USERDATA/syncthing

			# - Disable automatic upgrades
			sed -i '/<\/autoUpgradeIntervalH>/c\        <autoUpgradeIntervalH>0<\/autoUpgradeIntervalH>' $G_FP_DIETPI_USERDATA/syncthing/config.xml

			# - Allow external access (LAN).
			sed -i '/:8384<\/address>/c\        <address>0.0.0.0:8384<\/address>' $G_FP_DIETPI_USERDATA/syncthing/config.xml

			# - Set default folder
			sed -i '/label=\"Default Folder/c\    <folder id=\"0000-0000\" label=\"Syncthing Data\" path=\"'"$G_FP_DIETPI_USERDATA/syncthing_data"'\" type=\"readwrite\" rescanIntervalS=\"60\" ignorePerms=\"false\" autoNormalize=\"true\">' $G_FP_DIETPI_USERDATA/syncthing/config.xml

			# - Disable browser starting
			sed -i '/<\/startBrowser>/c\        <startBrowser>false<\/startBrowser>' $G_FP_DIETPI_USERDATA/syncthing/config.xml

			# - Enable filesystem watcher (previously inotify)
			sed -i 's/fsWatcherEnabled=\"false\"/fsWatcherEnabled=\"true\"/g' $G_FP_DIETPI_USERDATA/syncthing/config.xml

			#services
			cat << _EOF_ > /etc/systemd/system/syncthing.service
[Unit]
Description=Syncthing (DietPi)
After=network.target

[Service]
Type=simple
ExecStart=/etc/syncthing/syncthing -logfile=/var/log/syncthing/syncthing.log -logflags=3 -home=$G_FP_DIETPI_USERDATA/syncthing
User=dietpi

[Install]
WantedBy=multi-user.target
_EOF_

			# - Increase open file limit:
			echo 'fs.inotify.max_user_watches=204800' > /etc/sysctl.d/dietpi-syncthing.conf

		fi

		#Urbackup server
		software_id=111
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			mkdir -p $G_FP_DIETPI_USERDATA/urbackup/urbackup_tmp_files

			#As we have /tmp mounted to RAM, change tmp locations
			sed -i '/DAEMON_TMPDIR=/c\DAEMON_TMPDIR="/var/tmp"' /etc/default/urbackupsrv

			#https://github.com/Fourdee/DietPi/issues/545#issuecomment-252419739
			#sqlite3 /usr/local/var/urbackup/backup_server_settings.db "UPDATE settings SET value = '/mnt/dietpi_userdata/urbackup/' WHERE key = 'backupfolder'"

		fi

		#SICKRAGE
		software_id=116
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM sickrage -G dietpi -s /usr/sbin/nologin

			cat << _EOF_ > /etc/systemd/system/sickrage.service
[Unit]
Description=SickRage (DietPi)

[Service]
User=sickrage
Group=dietpi
Type=forking
GuessMainPID=no
WorkingDirectory=$G_FP_DIETPI_USERDATA/sickrage
TimeoutSec=infinity
TimeoutStopSec=20
Restart=always
ExecStart=$(which python) $G_FP_DIETPI_USERDATA/sickrage/SiCKRAGE.py -d --nolaunch --datadir=$G_FP_DIETPI_USERDATA/sickrage

[Install]
WantedBy=multi-user.target
_EOF_

			chown -R sickrage:dietpi $G_FP_DIETPI_USERDATA/sickrage # also applied in /DietPi/dietpi/func/dietpi-set_software setpermissions
			> /var/log/sickrage.log
			chown sickrage:dietpi /var/log/sickrage.log # also applied in /DietPi/dietpi/func/dietpi-set_software setpermissions

		fi

		#TONIDO
		software_id=134
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rm tonido -G dietpi -s /usr/sbin/nologin

			#service
			cat << _EOF_ > /etc/systemd/system/tonido.service
[Unit]
Description=Tonido (DietPi)

[Service]
Type=simple
User=tonido
Group=dietpi
WorkingDirectory=$G_FP_DIETPI_USERDATA/tonido
ExecStart=/bin/bash -c 'export LD_LIBRARY_PATH=$G_FP_DIETPI_USERDATA/tonido; export TONIDODIR=$G_FP_DIETPI_USERDATA/tonido; ./tonidoconsole'

[Install]
WantedBy=multi-user.target
_EOF_

			# - userdirs
			mkdir -p $G_FP_DIETPI_USERDATA/tonido/sync
			mkdir -p $G_FP_DIETPI_USERDATA/tonido/syncdata

			#	symlink
			cp -R /home/tonido/tonido $G_FP_DIETPI_USERDATA/ &> /dev/null
			rm -R /home/tonido/tonido &> /dev/null
			ln -sf $G_FP_DIETPI_USERDATA/tonido /home/tonido/tonido
			ln -sf $G_FP_DIETPI_USERDATA/tonido/sync /home/tonido/TonidoSync
			ln -sf $G_FP_DIETPI_USERDATA/tonido/syncdata /home/tonido/TonidoSyncData

			# - armv7 switch
			if (( $G_HW_ARCH == 2 )); then

				sed -i 's/armv6l/armv7l/' $G_FP_DIETPI_USERDATA/tonido/manifest.xml
				sed -i 's/armv6l/armv7l/' $G_FP_DIETPI_USERDATA/tonido/plugins/*/manifest.xml

			fi

		fi

		#Chromium
		software_id=113
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Allow root, start maximized and disable sandbox under root (blank screen without)
			local export_options="export CHROMIUM_FLAGS=\"\$CHROMIUM_FLAGS \
--test-type \
--no-sandbox \
--temp-profile \
--user-data-dir \
--disable-smooth-scrolling \
--disable-low-res-tiling \
--enable-low-end-device-mode \
--num-raster-threads=$G_HW_CPU_CORES \
--profiler-timing=0 \
--disable-composited-antialiasing "

			#RPi
			if (( $G_HW_MODEL < 10 )); then

				#	OpenGL
				#if (( $G_HW_MODEL >= 2 )); then

					# Hangs xinit: https://github.com/Fourdee/DietPi/issues/834
					#/DietPi/dietpi/func/dietpi-set_hardware rpi-opengl vc4-kms-v3d

				#fi
				:

			#OpenGL
			elif (( $G_HW_MODEL == 21 )); then

				:

			#GLES
			else

				export_options+='--use-gl=egl'

			fi

			export_options+="\""

			mkdir -p /etc/chromium.d
			cat << _EOF_ > /etc/chromium.d/custom_flags
$export_options
_EOF_

			#	Chromium 60+
			cp /etc/chromium.d/custom_flags $HOME/.chromium-browser.init

			#Symlink to desktop
			#	* for RPi Stretch due to chromium-browser.desktop
			ln -sf /usr/share/applications/chromium*.desktop $HOME/Desktop/chromium.desktop &> /dev/null

			# - Autostart run script for Kiosk mode, based on @AYapejian https://github.com/Fourdee/DietPi/issues/1737#issue-318697621

			cat << _EOF_ > /var/lib/dietpi/dietpi-software/installed/chromium-autostart.sh
#!/bin/bash
#Autostart run script for Kiosk mode, based on @AYapejian https://github.com/Fourdee/DietPi/issues/1737#issue-318697621
# - Please see $HOME/.chromium-browser.init (and /etc/chromium.d/custom_flags) for additional egl/gl init options

# Command line switches https://peter.sh/experiments/chromium-command-line-switches/
# 	--test-type gets rid of some of the chromium warnings that you may or may not care about in kiosk on a LAN
#   --pull-to-refresh=1
#   --ash-host-window-bounds="400,300"

# - Resolution to use for kiosk mode, should ideally match current system resolution
RES_X=\$(grep -m1 '^[[:blank:]]*SOFTWARE_CHROMIUM_RES_X=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')
RES_Y=\$(grep -m1 '^[[:blank:]]*SOFTWARE_CHROMIUM_RES_Y=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')

CHROMIUM_OPTS="--kiosk --test-type --window-size=\$RES_X,\$RES_Y --start-fullscreen --start-maximized --window-position=0,0"
# - If you want tablet mode, uncomment the next line.
#CHROMIUM_OPTS+=' --force-tablet-mode --tablet-ui'

# - Add URL for first run:
URL=\$(grep -m1 '^[[:blank:]]*SOFTWARE_CHROMIUM_AUTOSTART_URL=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')
CHROMIUM_OPTS+=" --homepage \$URL"

#Find absolute filepath location of Chromium binary.
FP_CHROMIUM=\$(which chromium)
if [[ ! \$FP_CHROMIUM ]]; then

	# - Assume RPi
	FP_CHROMIUM="\$(which chromium-browser)"

fi

xinit \$FP_CHROMIUM \$CHROMIUM_OPTS
_EOF_
			chmod +x /var/lib/dietpi/dietpi-software/installed/chromium-autostart.sh

		fi

		#O!MPD
		software_id=129
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Always install fresh import of SQL for current version
			G_RUN_CMD systemctl start $MARIADB_SERVICE
			mysqladmin drop ompd -f &> /dev/null
			mysql -e "drop user 'ompd'@'localhost'" &> /dev/null

			sed -i "/'mysqli_user'/c \$cfg[\'mysqli_user\']                 = \'ompd\';" /var/www/ompd/include/config.inc.php
			sed -i "/'mysqli_password'/c \$cfg[\'mysqli_password\']                 = \'$GLOBAL_PW\';" /var/www/ompd/include/config.inc.php
			sed -i "/'media_dir'/c \$cfg[\'media_dir\']                 = \'$G_FP_DIETPI_USERDATA/$FOLDER_MUSIC/\';" /var/www/ompd/include/config.inc.php
			sed -i "/'ignore_media_dir_access_error'/c \$cfg[\'ignore_media_dir_access_error\']                 = \'true';" /var/www/ompd/include/config.inc.php

			/DietPi/dietpi/func/create_mysql_db ompd ompd "$GLOBAL_PW"
			mysql ompd < /var/www/ompd/sql/ompd*.sql

			systemctl stop $MARIADB_SERVICE

		fi

		#IceCast + DarkIce
		software_id=135
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#icecast set passwords:
			sed -i '/\<source-password\>/c\\<source-password\>'"$GLOBAL_PW"'\<\/source-password\>' /etc/icecast2/icecast.xml
			sed -i '/\<relay-password\>/c\\<relay-password\>'"$GLOBAL_PW"'\<\/relay-password\>' /etc/icecast2/icecast.xml

			#	Create random password
			local admin_password=$(tr -cd '[:alnum:]' < /dev/urandom | fold -w10 | head -n1)
			sed -i "/\<admin-password\>/c\\<admin-password\>$admin_password\<\/admin-password\>" /etc/icecast2/icecast.xml

			sed -i '/ENABLE=/c\ENABLE=true' /etc/default/icecast2

			#Darkice
			local input_device_index=$(arecord -l | grep -m1 'card' | awk '{print $2}' | sed 's/://')

			cat << _EOF_ > /etc/darkice.cfg
[general]
duration      = 0
bufferSecs    = 3
reconnect     = yes

[input]
device        = hw:$input_device_index,0
sampleRate    = 44100
bitsPerSample = 16
channel       = 1

[icecast2-0]
bitrateMode   = vbr
format        = vorbis
quality       = 0.8
server        = dietpi
port          = 8000
password      = $GLOBAL_PW
mountPoint    = DietPi
name          = DietPi
description   = DarkIce on DietPi
url           = http://localhost
genre         = none
public        = no
#localDumpFile = $G_FP_DIETPI_USERDATA/darkice_recording.ogg
_EOF_

			#Systemd service for Darkice
			rm /etc/init.d/darkice
			cat << _EOF_ > /etc/systemd/system/darkice.service
[Unit]
Description=DarkIce (DietPi)
After=icecast2.service
Requires=icecast2.service

[Service]
Type=simple
ExecStart=$(which darkice)

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#mosquitto
		software_id=123
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			rm /etc/init.d/mosquitto
			cat << _EOF_ > /etc/systemd/system/mosquitto.service
[Unit]
Description=Mosquitto (DietPi)
After=network.target

[Service]
Type=simple
ExecStart=$(which mosquitto) -c /etc/mosquitto/mosquitto.conf

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#Blynk
		software_id=131
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Preserve existing config
			if [[ ! -f $G_FP_DIETPI_USERDATA/blynk/server.properties ]]; then

				local config_file_url_address='https://raw.githubusercontent.com/blynkkk/blynk-server/master/server/core/src/main/resources/server.properties'
				G_RUN_CMD wget "$config_file_url_address" -O $G_FP_DIETPI_USERDATA/blynk/server.properties
				G_CONFIG_INJECT 'data.folder=' "data.folder=$G_FP_DIETPI_USERDATA/blynk/data" $G_FP_DIETPI_USERDATA/blynk/server.properties

			fi

			# - User
			useradd -rM blynk -G dietpi -s /usr/sbin/nologin

			# - Service
			cat << _EOF_ > /etc/systemd/system/blynkserver.service
[Unit]
Description=Blynk Server (DietPi)
After=network.target

[Service]
Type=simple
User=blynk
Group=dietpi
ExecStart=$(which java) -jar $G_FP_DIETPI_USERDATA/blynk/blynkserver.jar -serverConfig $G_FP_DIETPI_USERDATA/blynk/server.properties

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#MotionEye
		software_id=136
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Enable RPi cam
			if (( $G_HW_MODEL < 10 )); then

				/DietPi/dietpi/func/dietpi-set_hardware rpi-camera enable

			fi

			mkdir -p /etc/motioneye
			G_BACKUP_FP /etc/motioneye/motioneye.conf
			cp /usr/local/share/motioneye/extra/motioneye.conf.sample /etc/motioneye/motioneye.conf

			mkdir -p $G_FP_DIETPI_USERDATA/motioneye
			sed -i "/^media_path/c\media_path $G_FP_DIETPI_USERDATA/motioneye" /etc/motioneye/motioneye.conf

			#	service
			cp /usr/local/share/motioneye/extra/motioneye.systemd-unit-local /etc/systemd/system/motioneye.service

		fi

		#CloudPrint
		software_id=137
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Enable web admin
			G_RUN_CMD systemctl start cups
			cupsctl --remote-admin
			usermod -a -G lpadmin root
			systemctl stop cups

		fi

		#VirtualHere
		software_id=138
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			cat << _EOF_ > /etc/systemd/system/virtualhere.service
[Unit]
Description=VirtualHere (DietPi)
After=local-fs.target

[Service]
Type=simple

ExecStart=/etc/vhusbd/vhusbd -r /var/log/virtualhere.log

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl daemon-reload

			echo -e "ServerName='DietPi'" > /etc/vhusbd/config.ini

		fi

		#SABnzbd
		software_id=139
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM sabnzbd -G dietpi -s /usr/sbin/nologin
			cat << _EOF_ > /etc/systemd/system/sabnzbd.service
[Unit]
Description=sabnzbd (DietPi)

[Service]
User=sabnzbd
Group=dietpi
Type=simple
ExecStart=$(which python) /etc/sabnzbd/SABnzbd.py -f /etc/sabnzbd/sabnzbd.ini

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl daemon-reload

			mkdir -p /var/log/sabnzbd
			chown -R sabnzbd:dietpi /etc/sabnzbd
			chown -R sabnzbd:dietpi /var/log/sabnzbd

			#Create config:
			#	API keys and intial config are only generated during 1st run of sabnzbd
			#	We need to launch program, then apply our config tweaks, else, wizard setup in web interface simply loops without API keys.
			rm /etc/sabnzbd/sabnzbd.ini &> /dev/null

			systemctl start sabnzbd
			G_DIETPI-NOTIFY 2 "Generating initial config, please wait..."
			while [[ ! -f '/etc/sabnzbd/sabnzbd.ini' ]]
			do

				sleep 1

			done

			sleep 2

			systemctl stop sabnzbd

			sleep 2 #additional wait, config being overwritten after below changes: https://dietpi.com/phpbb/viewtopic.php?f=11&t=1848&p=7085#p7082

			sed -i "/^download_dir =/c\download_dir = $G_FP_DIETPI_USERDATA/downloads/incomplete" /etc/sabnzbd/sabnzbd.ini
			sed -i "/^complete_dir =/c\complete_dir = $G_FP_DIETPI_USERDATA/downloads/complete" /etc/sabnzbd/sabnzbd.ini
			sed -i "/^nzb_backup_dir =/c\nzb_backup_dir = $G_FP_DIETPI_USERDATA/downloads/sabnzbd_nzb_backup" /etc/sabnzbd/sabnzbd.ini
			sed -i "/^admin_dir =/c\admin_dir = $G_FP_DIETPI_USERDATA/downloads/sabnzbd_admin" /etc/sabnzbd/sabnzbd.ini
			sed -i "/^log_dir =/c\log_dir = /var/log/sabnzbd" /etc/sabnzbd/sabnzbd.ini
			sed -i "/^log_level =/c\log_level = 0" /etc/sabnzbd/sabnzbd.ini #err only
			sed -i "/^refresh_rate =/c\refresh_rate = 2" /etc/sabnzbd/sabnzbd.ini
			sed -i "/^host =/c\host = 0.0.0.0" /etc/sabnzbd/sabnzbd.ini

			G_CONFIG_INJECT 'permissions =' 'permissions = "0775"' /etc/sabnzbd/sabnzbd.ini

			# - Install language packs: https://github.com/Fourdee/DietPi/issues/1917#issue-340631943
			cd /etc/sabnzbd
			G_RUN_CMD python tools/make_mo.py
			cd $HOME

		fi

		#spotifyconnectweb
		software_id=141
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			cat << _EOF_ > /etc/systemd/system/spotify-connect-web.service
[Unit]
Description=spotify-connect-web (DietPi)
After=sound.target

[Service]
Type=simple
WorkingDirectory=$G_FP_DIETPI_USERDATA/spotify-connect-web
ExecStart=$G_FP_DIETPI_USERDATA/spotify-connect-web/spotify-connect-web

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#couchpotato
		software_id=142
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			cp /etc/couchpotato/init/ubuntu.default /etc/default/couchpotato
			sed -i "/CP_USER=/c\CP_USER=root" /etc/default/couchpotato
			sed -i "/CP_HOME=/c\CP_HOME=/etc/couchpotato" /etc/default/couchpotato
			sed -i "/CP_DATA=/c\CP_DATA=$G_FP_DIETPI_USERDATA/couchpotato" /etc/default/couchpotato

			mkdir -p $G_FP_DIETPI_USERDATA/couchpotato
			#useradd -d $G_FP_DIETPI_USERDATA/couchpotato couchpotato

			cp /etc/couchpotato/init/ubuntu /etc/init.d/couchpotato

		fi

		#Koel
		software_id=143
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM koel -G dietpi -s /usr/sbin/nologin

			Download_Test_Media

			/DietPi/dietpi/func/create_mysql_db koel koel "$GLOBAL_PW"

			cd $G_FP_DIETPI_USERDATA/koel

			G_CONFIG_INJECT 'DB_CONNECTION=' 'DB_CONNECTION=mysql' .env
			G_CONFIG_INJECT 'DB_HOST=' 'DB_HOST=127.0.0.1' .env
			G_CONFIG_INJECT 'DB_DATABASE=' 'DB_DATABASE=koel' .env
			G_CONFIG_INJECT 'DB_USERNAME=' 'DB_USERNAME=koel' .env
			G_CONFIG_INJECT 'DB_PASSWORD=' "DB_PASSWORD=$GLOBAL_PW" .env
			# ADMIN env vars are not used any more, user prompt will ask for info.
			#G_CONFIG_INJECT 'ADMIN_EMAIL=' 'ADMIN_EMAIL=dietpi@dietpi.com' .env
			#G_CONFIG_INJECT 'ADMIN_NAME=' 'ADMIN_NAME=admin' .env
			#G_CONFIG_INJECT 'ADMIN_PASSWORD=' "ADMIN_PASSWORD=$GLOBAL_PW" .env
			G_CONFIG_INJECT 'FFMPEG_PATH=' "FFMPEG_PATH=$(which ffmpeg)" .env

			php artisan koel:init
			#php artisan db:seed --force

			cd /tmp/$G_PROGRAM_NAME

			cat << _EOF_ > /etc/systemd/system/koel.service
[Unit]
Description=Koel (DietPi)

[Service]
Type=simple
User=koel
Group=dietpi
WorkingDirectory=$G_FP_DIETPI_USERDATA/koel
ExecStart=$(which php) $G_FP_DIETPI_USERDATA/koel/artisan serve --host 0.0.0.0

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#Sonarr
		software_id=144
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM sonarr -G dietpi -s /usr/sbin/nologin

			mkdir -p $G_FP_DIETPI_USERDATA/sonarr

			cat << _EOF_ > /etc/systemd/system/sonarr.service
[Unit]
Description=Sonarr (NzbDrone) Daemon (DietPi)
After=network.target

[Service]
User=sonarr
Group=dietpi
Type=simple
ExecStart=/usr/bin/mono -O=-aot /opt/NzbDrone/NzbDrone.exe -nobrowser -data=$G_FP_DIETPI_USERDATA/sonarr

[Install]
WantedBy=multi-user.target
_EOF_

			# - logs to RAM
			rm -R $G_FP_DIETPI_USERDATA/sonarr/logs* &> /dev/null
			mkdir -p /var/log/sonarr
			ln -sf /var/log/sonarr $G_FP_DIETPI_USERDATA/sonarr/logs
			ln -sf /var/log/sonarr/logs.db $G_FP_DIETPI_USERDATA/sonarr/logs.db
			ln -sf /var/log/sonarr/logs.db-shm $G_FP_DIETPI_USERDATA/sonarr/logs.db-shm
			ln -sf /var/log/sonarr/logs.db-wal $G_FP_DIETPI_USERDATA/sonarr/logs.db-wal

		fi

		#Radarr
		software_id=145
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM radarr -G dietpi -s /usr/sbin/nologin

			mkdir -p $G_FP_DIETPI_USERDATA/radarr

			cat << _EOF_ > /etc/systemd/system/radarr.service
[Unit]
Description=Radarr Daemon (DietPi)
After=network.target

[Service]
User=radarr
Group=dietpi
Type=simple
ExecStart=/usr/bin/mono -O=-aot /opt/Radarr/Radarr.exe -nobrowser -data=$G_FP_DIETPI_USERDATA/radarr

[Install]
WantedBy=multi-user.target
_EOF_

			# - logs to RAM
			rm -R $G_FP_DIETPI_USERDATA/radarr/logs* &> /dev/null
			mkdir -p /var/log/radarr
			ln -sf /var/log/radarr $G_FP_DIETPI_USERDATA/radarr/logs
			ln -sf /var/log/radarr/logs.db $G_FP_DIETPI_USERDATA/radarr/logs.db
			ln -sf /var/log/radarr/logs.db-shm $G_FP_DIETPI_USERDATA/radarr/logs.db-shm
			ln -sf /var/log/radarr/logs.db-wal $G_FP_DIETPI_USERDATA/radarr/logs.db-wal

		fi

		#Lidarr
		software_id=106
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM lidarr -G dietpi -s /usr/sbin/nologin

			mkdir -p $G_FP_DIETPI_USERDATA/lidarr

			cat << _EOF_ > /etc/systemd/system/lidarr.service
[Unit]
Description=lidarr (NzbDrone) Daemon (DietPi)
After=network.target

[Service]
User=lidarr
Group=dietpi
Type=simple
ExecStart=/usr/bin/mono -O=-aot /opt/Lidarr/Lidarr.exe -nobrowser -data=$G_FP_DIETPI_USERDATA/lidarr

[Install]
WantedBy=multi-user.target
_EOF_

			# - logs to RAM
			rm -R $G_FP_DIETPI_USERDATA/lidarr/logs* &> /dev/null
			mkdir -p /var/log/lidarr
			ln -sf /var/log/lidarr $G_FP_DIETPI_USERDATA/lidarr/logs
			ln -sf /var/log/lidarr/logs.db $G_FP_DIETPI_USERDATA/lidarr/logs.db
			ln -sf /var/log/lidarr/logs.db-shm $G_FP_DIETPI_USERDATA/lidarr/logs.db-shm
			ln -sf /var/log/lidarr/logs.db-wal $G_FP_DIETPI_USERDATA/lidarr/logs.db-wal

		fi

		#PlexPy
		software_id=146
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			mkdir -p $G_FP_DIETPI_USERDATA/plexpy

			useradd -rM plexpy -G dietpi -s /usr/sbin/nologin

			cat << _EOF_ > /etc/systemd/system/plexpy.service
[Unit]
Description=Tautulli - Stats for Plex Media Server usage (DietPi)

[Service]
Type=forking
User=plexpy
Group=dietpi
GuessMainPID=no
ExecStart=/opt/plexpy/PlexPy.py --quiet --daemon --nolaunch --config /opt/plexpy/config.ini --datadir $G_FP_DIETPI_USERDATA/plexpy

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#Jackett
		software_id=147
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			adduser jackett --system --no-create-home --group --shell=/usr/sbin/nologin

			cat << _EOF_ > /etc/systemd/system/jackett.service
[Unit]
Description=Jackett Daemon (DietPi)
After=network.target

[Service]
User=jackett
Group=jackett
WorkingDirectory=/opt/jackett
Environment=USER=jackett HOME=/opt/jackett
Restart=always
RestartSec=5
Type=simple
ExecStart=/usr/bin/mono -O=-aot /opt/jackett/JackettConsole.exe
TimeoutStopSec=20

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#NZBget
		software_id=149
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rM nzbget -G dietpi -s /usr/sbin/nologin

			G_BACKUP_FP $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/MainDir=/c\MainDir=$G_FP_DIETPI_USERDATA/downloads" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/DestDir=/c\DestDir=$G_FP_DIETPI_USERDATA/downloads/complete" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf

			sed -i "/LogFile=/c\LogFile=/var/log/nzbget.log" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf

			sed -i "/ControlUsername=/c\ControlUsername=admin" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/ControlPassword=/c\ControlPassword=$GLOBAL_PW" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf

			# - Umask: https://github.com/Fourdee/DietPi/issues/1999
			sed -i "/UMask=/c\UMask=0002" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf

			#	Optimizations
			sed -i "/Server1.Cipher=/c\Server1.Cipher=RC4-MD5" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/CrcCheck=/c\CrcCheck=no" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/ParScan=/c\ParScan=limited" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/ParThreads=/c\ParThreads=$G_HW_CPU_CORES" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf

			sed -i "/DebugTarget=/c\DebugTarget=none" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/CrashTrace=/c\CrashTrace=no" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/DetailTarget=/c\DetailTarget=none" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf

			sed -i "/ParBuffer=/c\ParBuffer=$(Optimize_BitTorrent 0)" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/ArticleCache=/c\ArticleCache=$(Optimize_BitTorrent 0)" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf
			sed -i "/WriteBuffer=/c\WriteBuffer=$(Optimize_BitTorrent 0)" $G_FP_DIETPI_USERDATA/nzbget/nzbget.conf

			cat << _EOF_ > /etc/systemd/system/nzbget.service
[Unit]
Description=NZBget (DietPi)

[Service]
Type=forking
User=nzbget
Group=dietpi
WorkingDirectory=$G_FP_DIETPI_USERDATA/nzbget
ExecStart=$G_FP_DIETPI_USERDATA/nzbget/nzbget -D

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#HTPC Manager
		software_id=155
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			cat << _EOF_ > /etc/systemd/system/htpc-manager.service
[Unit]
Description=HTPC Manager (DietPi)
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/python $G_FP_DIETPI_USERDATA/htpc-manager/Htpc.py

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#OctoPrint
		software_id=153
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			cat << _EOF_ > /etc/systemd/system/octoprint.service
[Unit]
Description=OctoPrint (DietPi)

[Service]
Type=simple
User=root
ExecStart=$(which octoprint) serve --iknowwhatimdoing

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#RoonServer
		software_id=154
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			cat << _EOF_ > /etc/systemd/system/roonserver.service
[Unit]
Description=Roon Server (DietPi)
After=network.target

[Service]
Type=simple
User=root
Environment=ROON_DATAROOT=$G_FP_DIETPI_USERDATA/roonserver
ExecStart=$G_FP_DIETPI_USERDATA/roonserver/start.sh

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#Steam
		software_id=156
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			mkdir -p $G_FP_DIETPI_USERDATA/steam
			mv $HOME/.steam/* $G_FP_DIETPI_USERDATA/steam/
			rm -R $HOME/.steam

			ln -sf $G_FP_DIETPI_USERDATA/steam $HOME/.steam

		fi

		#------------------ Home Automation: Home Assistant ------------------
		software_id=157
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

            cat << _EOF_ > /etc/systemd/system/home-assistant.service
[Unit]
Description=Home Assistant (DietPi)
After=network.target

[Service]
Type=simple
User=homeassistant
ExecStart=/srv/homeassistant/homeassistant-start.sh

[Install]
WantedBy=multi-user.target

_EOF_

			# Link to the default ha location for the homeassistant user, this makes
			# the configuration avaliable for the user to edit. Configuration generated
			# when service is started at /home/homeassistant/.homeassistant
			mkdir $G_FP_DIETPI_USERDATA/homeassistant
			ln -sf $G_FP_DIETPI_USERDATA/homeassistant /home/homeassistant/.homeassistant

		fi
		#-------------------------------------------------------------------

		#Minio Config
		software_id=158
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# Create simple mandatory default configuration file, if not already existent:
			[ -f /etc/default/minio ] || cat << _EOF_ > /etc/default/minio
# Default file path
MINIO_VOLUMES="$G_FP_DIETPI_USERDATA/minio-data"
# Use if you want to run Minio on a custom port.
# MINIO_OPTS="--address :9199"
# Access Key of the server.
# MINIO_ACCESS_KEY=Server-Access-Key
# Secret key of the server.
# MINIO_SECRET_KEY=Server-Secret-Key
_EOF_

			# Enable startup on boot by default
			systemctl enable minio.service

		fi

		#Docker Config
		software_id=162
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#Set docker service to 'simple': https://github.com/Fourdee/DietPi/issues/2238#issuecomment-439474766
			mkdir -p /lib/systemd/system/docker.service.d
			echo -e '[Service]\nType=simple' > /lib/systemd/system/docker.service.d/dietpi-simple.conf

			# Move docker containers to dietpi_userdata
			mkdir -p $G_FP_DIETPI_USERDATA/docker-data
			if [[ -f /etc/docker/daemon.json ]]; then

				GCI_PRESERVE=1 G_CONFIG_INJECT '"data-root":' "    \"data-root\": \"$G_FP_DIETPI_USERDATA/docker-data\"," /etc/docker/daemon.json '^\{([[:space:]]\|$)'

			else

				mkdir -p /etc/docker
				echo -e "{\n    \"data-root\": \"$G_FP_DIETPI_USERDATA/docker-data\"\n}" > /etc/docker/daemon.json

			fi

		fi

		#-------------------------------------------------------------------
		#FuguHub Config
		software_id=161
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# Setup Filestore DietPi appropriate
			# IF already present just create symlink
			if [[ ! -f $G_FP_DIETPI_USERDATA/fuguhub-data/ ]]; then
				# Move installed filestore to dietpi folder
				mkdir $G_FP_DIETPI_USERDATA/fuguhub-data/
				mv /home/bd/disk/*  $G_FP_DIETPI_USERDATA/fuguhub-data/
				# Removed 'actual' folder to make way for symlink
				rm -r /home/bd/disk
				# Create symlink
				ln -s $G_FP_DIETPI_USERDATA/fuguhub-data /home/bd/disk
				# Set permissions
				# setfacl -R -m u:bd:rwx $G_FP_DIETPI_USERDATA/fuguhub-data/
			else
				# Removed 'actual' folder to make way for symlink
				rm -r /home/bd/disk
				# Create symlink
				ln -s $G_FP_DIETPI_USERDATA/fuguhub-data /home/bd/disk
			fi

		fi

		#-------------------------------------------------------------------
		#Nukkit Config
		software_id=164
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# Conig file to autostart -- english default
			wget -O /usr/local/bin/nukkit/nukkit.yml https://github.com/Nukkit/Languages/raw/master/eng/nukkit.yml
			# create systemd file
			cat << _EOF_ > /etc/systemd/system/nukkit.service
[Unit]
Description=nukkit (DietPi)

[Service]
WorkingDirectory=/usr/local/bin/nukkit
ExecStart=/bin/bash -c 'java -jar /usr/local/bin/nukkit/nukkit.jar'

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#GITEA Config
		software_id=165
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - service
			cat << _EOF_ > /etc/systemd/system/gitea.service

[Unit]
Description=Gitea (DietPi)

[Service]
Type=simple
User=dietpi
WorkingDirectory=$G_FP_DIETPI_USERDATA/gitea/gitea-repositories
ExecStart=$G_FP_DIETPI_USERDATA/gitea/gitea web
Environment=USER=dietpi HOME=$G_FP_DIETPI_USERDATA/gitea

[Install]
WantedBy=multi-user.target
_EOF_

			# - Logs
			mkdir -p /var/log/gitea
			chown -R dietpi:dietpi /var/log/gitea

			# - sqldb
			/DietPi/dietpi/func/create_mysql_db gitea gitea "$GLOBAL_PW"

		fi


		#Allo Config
		software_id=159 #160 for quick reinstall/update
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[160]} == 1 )); then

			Banner_Configuration

			#Create allo user for GUI
			useradd -m allo -s /bin/bash -G www-data
			chpasswd <<< "allo:allo"
			echo -e "allo ALL=NOPASSWD: ALL" > /etc/sudoers.d/allo

			#Always Drop DB, and, recreate it, due to error issue with reinstall over the top.
			mysqladmin drop allo_db -f &> /dev/null
			mysql -e "drop user allo_db@localhost" &> /dev/null

			/DietPi/dietpi/func/create_mysql_db allo_db allo_db "$GLOBAL_PW"
			mysql allo_db < /var/www/allo_db.sql
			rm /var/www/allo_db.sql

			# - Redirect to web interface by default:
			rm /var/www/index.htm*
			cat << _EOF_ > /var/www/index.php
<?php
/* Redirect to allo web interface */
\$host  = \$_SERVER['HTTP_HOST'];
\$uri   = rtrim(dirname(\$_SERVER['PHP_SELF']), '/\\\\');
\$extra = 'index.php';
header("Location: http://\$host\$uri/allo/public/\$extra");
exit;
?>
_EOF_

			#HW specific changes
			# - SPARKY ONLY - Auto detect eth adapter
			if (( $G_HW_MODEL == 70 )); then

				# - Disable onboard ETH if adapter found
				cat << _EOF_ > /etc/systemd/system/sparky_eth_controller.service
[Unit]
Description=Sparky auto detect and set onboard ETH/USB ETH (DietPi)
After=network.target networking.service

[Service]
Type=simple
RemainAfterExit=yes
ExecStart=/bin/bash -c '/usr/local/bin/sparky_eth_controller.sh'

[Install]
WantedBy=multi-user.target
_EOF_
				systemctl daemon-reload
				systemctl enable sparky_eth_controller.service

				cat << _EOF_ > /usr/local/bin/sparky_eth_controller.sh
#!/bin/bash
#We need to wait until USB eth is established on USB bus. This takes much longer than onboard init and network.target network-pre.target
sleep 20
# - Set USB ETH if found
if ip a | grep -qi 'eth1'; then

	echo -e "blacklist ethernet" > /etc/modprobe.d/disable_sparkysbc_ethernet.conf
	rm /etc/udev/rules.d/70-persistent-net.rules &> /dev/null
	rm /etc/udev/rules.d/70-persistant-net.rules &> /dev/null
	reboot

# - Enable onboard ETH if no adapter found
elif ! ip a | grep -qi 'eth0'; then

	rm /etc/modprobe.d/disable_sparkysbc_ethernet.conf &> /dev/null
	rm /etc/udev/rules.d/70-persistent-net.rules &> /dev/null
	rm /etc/udev/rules.d/70-persistant-net.rules &> /dev/null
	reboot

fi
_EOF_

				chmod +x /usr/local/bin/sparky_eth_controller.sh

			fi

			# - Allow for quick updates with 160 reinstall
			aSOFTWARE_INSTALL_STATE[160]=2

		fi

		#Gmediarender
		software_id=163
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			useradd -rm gmrender -G dietpi,audio -s /usr/sbin/nologin

			cat << _EOF_ > /etc/systemd/system/gmrender.service
[Unit]
Description=GMrender (DietPi)
After=network.target

[Service]
Type=simple
User=gmrender
Group=dietpi
ExecStart=$(which gmediarender) -u "$(sed -n 5p /DietPi/dietpi/.hw_model)" -f "$(cat /etc/hostname)" --gstout-audiodevice=sysdefault --gstout-initial-volume-db=-1 --logfile=/var/log/gmrender.log

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#AudioPhonics Pi-SPC
		software_id=166
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			mkdir -p /var/lib/dietpi/dietpi-software/installed/pi-spc

			cat << _EOF_ > /var/lib/dietpi/dietpi-software/installed/pi-spc/sds.sh
#!/bin/bash
#DietPi version
PATH+=':$HOME/wiringPi/gpio'

TICKRATE=0.25

echo -e "Audiophonics Shutdown script starting..."
echo -e "Asserting pins : "
echo -e "ShutDown : GPIO17=in, Low"
echo -e "BootOK   : GPIO22=out, High"
echo -e "SoftSD   : GPIO04=out, Low"

gpio -g mode 04 out
gpio -g write 04 0
gpio -g mode 17 in
gpio -g write 17 0
gpio -g mode 22 out
gpio -g write 22 1

while :
do

	if (( \$(gpio -g read 17) == 1 )); then

		G_DIETPI-NOTIFY 0 "AudioPhonics Pi-SPC: Power off requested. Shutting down system."
		sudo poweroff
		#sudo shutdown -h -P now
		break

	fi

	sleep \$TICKRATE

done

exit 0
_EOF_

			chmod +x /var/lib/dietpi/dietpi-software/installed/pi-spc/sds.sh

			cat << _EOF_ > /etc/systemd/system/pi-spc.service
[Unit]
Description=AudioPhonics Pi-SPC (DietPi)

[Service]
Type=simple
StandardOutput=tty
User=root

ExecStart=/bin/bash -c '/var/lib/dietpi/dietpi-software/installed/pi-spc/sds.sh'

[Install]
WantedBy=multi-user.target
_EOF_

			# G_CONFIG_INJECT	'dtoverlay=gpio-shutdown' 'dtoverlay=gpio-shutdown,gpio_pin=22,active_low=0' /DietPi/config.txt
			# G_CONFIG_INJECT	'dtoverlay=gpio-poweroff' 'dtoverlay=gpio-poweroff,gpio_pin=17' /DietPi/config.txt

		fi

		#Google AIY
		software_id=169
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			# - Symlink userdata location for assistant.json
			ln -sf $G_FP_DIETPI_USERDATA/voice-recognizer-raspi/assistant.json /home/dietpi/assistant.json

			# - Generate cache dir
			mkdir -p /home/dietpi/.cache/voice-recognizer

			#Setup soundcard
			/DietPi/dietpi/func/dietpi-set_hardware soundcard googlevoicehat-soundcard

		fi

		#PiJuice
		software_id=100
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

			#RPi enable i2c required for GUI
			(( $G_HW_MODEL < 10 )) && /DietPi/dietpi/func/dietpi-set_hardware i2c enable

			mkdir -p /var/lib/dietpi/dietpi-software/installed/pijuice
			cat << _EOF_ > /var/lib/dietpi/dietpi-software/installed/pijuice/pijuice_func1.sh
#!/bin/bash
poweroff
_EOF_
			chmod +x /var/lib/dietpi/dietpi-software/installed/pijuice/pijuice_func1.sh

			cat << _EOF_ > /var/lib/pijuice/pijuice_config.JSON
{
  "system_events": {
    "low_battery_voltage": {
      "function": "SYS_FUNC_HALT",
      "enabled": true
    },
    "low_charge": {
      "function": "NO_FUNC",
      "enabled": true
    },
    "button_power_off": {
      "function": "USER_FUNC1",
      "enabled": true
    },
    "forced_power_off": {
      "function": "USER_FUNC2",
      "enabled": false
    },
    "no_power": {
      "function": "SYS_FUNC_HALT_POW_OFF",
      "enabled": true
    },
    "forced_sys_power_off": {
      "function": "USER_FUNC3",
      "enabled": false
    },
    "watchdog_reset": {
      "function": "USER_EVENT",
      "enabled": true
    }
  },
  "user_functions": {
    "USER_FUNC1": "/var/lib/dietpi/dietpi-software/installed/pijuice/pijuice_func1.sh",
    "USER_FUNC2": "/var/lib/dietpi/dietpi-software/installed/pijuice/pijuice_func2.sh",
    "USER_FUNC3": "/var/lib/dietpi/dietpi-software/installed/pijuice/pijuice_func3.sh",
    "USER_FUNC4": "",
    "USER_FUNC5": "",
    "USER_FUNC6": "",
    "USER_FUNC7": "",
    "USER_FUNC8": ""
  },
  "system_task": {
    "watchdog": {
      "enabled": true,
      "period": "60"
    },
    "min_bat_voltage": {
      "threshold": "1",
      "enabled": true
    },
    "min_charge": {
      "threshold": "1",
      "enabled": true
    },
    "enabled": true,
    "wakeup_on_charge": {
      "enabled": true,
      "trigger_level": "1"
    }
  }
}
_EOF_

		fi

		#Roon Extension Manager
		software_id=86
		if (( ${aSOFTWARE_INSTALL_STATE[$software_id]} == 1 )); then

			Banner_Configuration

		fi

		#------------------------------------------------------------------

	}

	Install_Apply_GPU_Settings(){

		local gpu_enabled=0
		local gpu_memory=0

		#Define Memory Split Modes with installed software
		#Mode 4 RPI ONLY (Descent HIGH GPU RAM / 192MB)
		if (( ${aSOFTWARE_INSTALL_STATE[112]} == 2 )); then

			gpu_enabled=1
			gpu_memory=192

		#Define Memory Split Modes with installed software
		#Mode 3 (KODI / DIETPICAM / UAE4ARM / Chromium / MED GPU RAM / 128MB)
		elif (( ${aSOFTWARE_INSTALL_STATE[31]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[59]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[108]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[113]} == 2 )); then

			gpu_enabled=1
			gpu_memory=128

		#Mode 2 (Desktop / LOW GPU RAM)
		#All DESKTOP_* and OPENTYRIAN
		elif (( ${aSOFTWARE_INSTALL_STATE[23]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[24]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[25]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[26]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[51]} == 2 )); then

			gpu_enabled=1
			gpu_memory=64

		#Mode 1 - DIETPICLOUDSHELL (forces display output)
		elif (( ${aSOFTWARE_INSTALL_STATE[62]} == 2 )); then

			gpu_enabled=1

		fi

		#Apply
		if (( $gpu_memory > 0 )); then

			#RPi
			if (( $G_HW_MODEL < 10 )); then

				# - Never override a higher existing value
				local current_gpu_mem=$(grep -m1 '^[[:blank:]]*gpu_mem' /DietPi/config.txt | sed 's/^[^=]*=//g')
				(( $current_gpu_mem <= $gpu_memory )) && /DietPi/dietpi/func/dietpi-set_hardware gpumemsplit $gpu_memory

			fi

		fi

		if (( $gpu_enabled )); then

			#RPi
			if (( $G_HW_MODEL < 10 )); then

				sed -i '/CONFIG_HDMI_OUTPUT=/c\CONFIG_HDMI_OUTPUT=1' /DietPi/dietpi.txt

			#odroid C1
			elif (( $G_HW_MODEL == 10 )); then

				sed -i '/setenv hdmioutput /c\setenv hdmioutput "1"' /DietPi/boot.ini
				sed -i '/setenv vpu /c\setenv vpu "1"' /DietPi/boot.ini
				sed -i '/setenv m_bpp /c\setenv m_bpp "32"' /DietPi/boot.ini

			#Odroid C2
			elif (( $G_HW_MODEL == 12 )); then

				sed -i '/setenv nographics /c\setenv nographics "0"' /DietPi/boot.ini

			fi

		fi

	}

	Check_USB_Drive_Installed(){

		USBDRIVE=0

		FP_DIETPI_DEDICATED_USBDRIVE="$(df -P | grep -m1 '^/dev/sda1' | awk '{print $6}')"

		#Only enable if mounted
		if [[ $FP_DIETPI_DEDICATED_USBDRIVE ]] &&
			df -P | grep -qi "$FP_DIETPI_DEDICATED_USBDRIVE"; then

			USBDRIVE=1

		fi

	}

	Uninstall_Software(){

		#NB: systemctl daemon-reload is executed at the end of this function

		local software_id=0

		software_id=23
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			apt-mark unhold pcmanfm #RPi

			Banner_Uninstalling
			G_AGP lxde $(dpkg --get-selections lxde-* | awk '{print $1}') upower policykit-1 firefox-esr

		fi

		software_id=24
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP mate-desktop-environment-extras upower policykit-1 firefox-esr

		fi

		software_id=26
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP x-window-system-core wmaker gnustep gnustep-devel gnustep-games upower policykit-1 firefox-esr

		fi

		software_id=25
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP xfce4 gnome-icon-theme tango-icon-theme firefox-esr

		fi

		software_id=22
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP quiterss

		fi

		software_id=30
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP nomachine

		fi

		software_id=29
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP xrdp

		fi

		software_id=44
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP transmission-daemon
			[[ -f /etc/systemd/system/transmission-daemon.service ]] && rm /etc/systemd/system/transmission-daemon.service # pre v6.17
			[[ -d /etc/systemd/system/transmission-daemon.service.d ]] && rm /etc/systemd/system/transmission-daemon.service.d # post v6.17

		fi

		#ownCloud
		software_id=47
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			# Remove background cron job
			crontab -u www-data -l | grep -v '/var/www/owncloud/cron.php'  | crontab -u www-data -
			# Disable and remove webserver configs
			a2dissite dietpi-owncloud 2> /dev/null
			rm /etc/apache2/sites-available/dietpi-owncloud.conf 2> /dev/null
			rm /etc/nginx/sites-dietpi/dietpi-owncloud.conf 2> /dev/null
			G_WHIP_MSG "DietPi will perform an automated backup of your ownCloud database and installation directory, which will be stored inside your ownCloud data directory.\n\nThe data directory won't be removed. So you can recover your whole ownCloud instance any time later.\n\nRemove the data directory manually, if you don't need it anymore."
			# Drop MariaDB users and database
			local dbuser=$(grep -m1 "^[[:blank:]]*'dbuser'" /var/www/owncloud/config/config.php | awk '{print $3}' | sed 's/,//')
			local dbhost=$(grep -m1 "^[[:blank:]]*'dbhost'" /var/www/owncloud/config/config.php | awk '{print $3}' | sed 's/,//')
			# - Find datadir for backups
			local datadir=$(grep -m1 "^[[:blank:]]*'datadirectory'" /var/www/owncloud/config/config.php | awk '{print $3}' | sed "s/[',]//g")
			[[ $datadir ]] || datadir=$G_FP_DIETPI_USERDATA/owncloud_data
			systemctl start $MARIADB_SERVICE
			mysql -e "drop user $dbuser@$dbhost"
			mysql -e "drop user $dbuser" 2> /dev/null
			# - Perform database backup if existent, otherwise skip to not overwrite existing one
			[[ -d $G_FP_DIETPI_USERDATA/mysql/owncloud ]] && mysqldump owncloud > $datadir/dietpi-owncloud-database-backup.sql
			mysqladmin drop owncloud -f
			# Backup ownCloud installation folder
			cp -a /var/www/owncloud/. $datadir/dietpi-owncloud-installation-backup
			# Remove ownCloud installation folder
			rm -R /var/www/owncloud
			# Remove redirect configs
			if grep -q 'owncloud' /etc/lighttpd/conf-available/99-dietpi-dav_redirect.conf &> /dev/null; then

				lighttpd-disable-mod dietpi-dav_redirect
				rm /etc/lighttpd/conf-available/99-dietpi-dav_redirect.conf

			fi
			if grep -q 'owncloud' /etc/apache2/conf-available/dietpi-dav_redirect.conf &> /dev/null; then

				a2disconf dietpi-dav_redirect
				rm /etc/apache2/conf-available/dietpi-dav_redirect.conf

			fi
			grep -q 'owncloud' /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf &> /dev/null && rm /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf

		fi

		#Nextcloud Talk + TURN server "coturn"
		software_id=168
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP coturn
			systemctl start $MARIADB_SERVICE
			ncc maintenance:mode --off
			ncc app:disable spreed
			G_DIETPI-NOTIFY 2 'Disabled Nextcloud Talk app, but you need to remove it manually from Nextcloud web UI, if desired.'

		fi

		#Nextcloud
		software_id=114
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			crontab -u www-data -l | grep -v '/var/www/nextcloud/cron.php'  | crontab -u www-data -
			# Disable and remove webserver configs
			a2dissite dietpi-nextcloud 2> /dev/null
			rm /etc/apache2/sites-available/dietpi-nextcloud.conf 2> /dev/null
			rm /etc/nginx/sites-dietpi/dietpi-nextcloud.conf 2> /dev/null
			lighttpd-disable-mod dietpi-nextcloud 2> /dev/null
			rm /etc/lighttpd/conf-available/99-dietpi-nextcloud.conf 2> /dev/null
			G_WHIP_MSG "DietPi will perform an automated backup of your Nextcloud database and installation directory, which will be stored inside your Nextcloud data directory.\n\nThe data directory won't be removed. So you can recover your whole Nextcloud instance any time later.\n\nRemove the data directory manually, if you don't need it anymore."
			# Drop MariaDB users and database
			local dbuser=$(grep -m1 "^[[:blank:]]*'dbuser'" /var/www/nextcloud/config/config.php | awk '{print $3}' | sed 's/,//')
			local dbhost=$(grep -m1 "^[[:blank:]]*'dbhost'" /var/www/nextcloud/config/config.php | awk '{print $3}' | sed 's/,//')
			# - Find datadir for backups
			local datadir=$(grep -m1 "^[[:blank:]]*'datadirectory'" /var/www/nextcloud/config/config.php | awk '{print $3}' | sed "s/[',]//g")
			[[ $datadir ]] || datadir=$G_FP_DIETPI_USERDATA/nextcloud_data
			systemctl start $MARIADB_SERVICE
			mysql -e "drop user $dbuser@$dbhost"
			mysql -e "drop user $dbuser" 2> /dev/null
			# - Perform database backup if existent, otherwise skip to not overwrite existing one
			[[ -d $G_FP_DIETPI_USERDATA/mysql/nextcloud ]] && mysqldump nextcloud > $datadir/dietpi-nextcloud-database-backup.sql
			mysqladmin drop nextcloud -f
			# Backup Nextcloud installation folder
			cp -a /var/www/nextcloud/. $datadir/dietpi-nextcloud-installation-backup
			# Remove Nextcloud installation folder
			rm -R /var/www/nextcloud
			# Remove redirect configs
			if grep -q 'nextcloud' /etc/lighttpd/conf-available/99-dietpi-dav_redirect.conf &> /dev/null; then

				lighttpd-disable-mod dietpi-dav_redirect
				rm /etc/lighttpd/conf-available/99-dietpi-dav_redirect.conf

			fi
			if grep -q 'nextcloud' /etc/apache2/conf-available/dietpi-dav_redirect.conf &> /dev/null; then

				a2disconf dietpi-dav_redirect
				rm /etc/apache2/conf-available/dietpi-dav_redirect.conf

			fi
			grep -q 'nextcloud' /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf  &> /dev/null && rm /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf

		fi

		software_id=83
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP apache2

		fi

		software_id=85
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP nginx $(dpkg --get-selections nginx-* | awk '{print $1}')

		fi

		software_id=84
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP lighttpd

			# Remove certbot renewal hook:
			rm /etc/systemd/system/certbot.service.d/dietpi-lighttpd.conf &> /dev/null
			# Remove hook directory only, if empty:
			rmdir /etc/systemd/system/certbot.service.d &> /dev/null

		fi

		software_id=87
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP sqlite3

		fi

		software_id=91
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP "$PHP_BINARY"-redis redis-server redis-tools

		fi

		software_id=89
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm $FP_PHP_BASE_DIR/fpm/pool.d/www.conf 2> /dev/null
			rm $FP_PHP_BASE_DIR/mods-available/dietpi.ini 2> /dev/null
			G_AGP $(dpkg --get-selections | grep -E '(php[0-9]?\.?[0-9]?-*|libapache2-mod-php*)' | awk '{print $1}')
			rm /var/www/phpinfo.php
			rm /var/www/apc.php
			rm /var/www/opcache.php
			# temp php uploads, if it was created
			rm -R /var/tmp/php_upload_tmp 2> /dev/null

		fi

		software_id=90
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			systemctl start $MARIADB_SERVICE
			mysqladmin drop phpmyadmin -f
			mysql -e "drop user 'phpmyadmin'@'localhost'"
			G_AGP phpmyadmin

		fi

		software_id=54
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			systemctl start $MARIADB_SERVICE
			mysqladmin drop phpbb3 -f
			mysql -e "drop user 'phpbb3'@'localhost'"
			rm -R /var/www/phpBB3

		fi

		software_id=115
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP webmin
			rm /etc/systemd/system/webmin.service

		fi

		software_id=32
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			userdel -rf ympd
			rm /usr/bin/ympd
			rm /etc/systemd/system/ympd.service

		fi

		software_id=148
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			userdel -rf mympd
			rm -R /etc/mympd
			rm -R /usr/share/mympd
			rm $(which mympd)
			rm /lib/systemd/system/mympd.service

		fi

		software_id=128
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto libavformat57 libupnp6 libao-common libao4 libasound2 libasound2-data libasyncns0 libaudiofile1 libavahi-client3 libavahi-common-data libavahi-common3 libavcodec56 libavformat56 libavresample2 libavutil54 libbinio1ldbl libcaca0 libcdio-cdda1 libcdio-paranoia1 libcdio13 libcups2 libcurl3-gnutls libdirectfb-1.2-9 libdnet libfaad2 libflac8 libfluidsynth1 libgme0 libgomp1 libgsm1 libice6 libid3tag0 libiso9660-8 libjack-jackd2-0 libjson-c2 libldb1 libmad0 libmikmod3 libmms0 libmodplug1 libmp3lame0 libmpcdec6 libmpg123-0 libnfs4 libntdb1 libogg0 libopenal-data libopenal1 libopenjpeg5 libopus0 liborc-0.4-0 libpulse0 libresid-builder0c2a libroar2 libsamplerate0 libschroedinger-1.0-0 libsdl1.2debian libshout3 libsidplay2 libsidutils0 libslp1 libsm6 libsmbclient libsndfile1 libsoxr0 libspeex1 libspeexdsp1 libsqlite3-0 libtalloc2 libtdb1 libtevent0 libtheora0 libupnp6 libva1 libvorbis0a libvorbisenc2 libvorbisfile3 libvpx1 libwavpack1 libwbclient0 libwildmidi-config libwildmidi1 libx11-6 libx11-data libx11-xcb1 libx264-142 libxau6 libxcb1 libxdmcp6 libxext6 libxi6 libxtst6 libxvidcore4 libyajl2 libzzip-0-13 mime-support python python-talloc python2.7 samba-libs x11-common file &> /dev/null
			apt-mark unhold mpd 1> /dev/null
			G_AGP mpd libmpdclient2
			userdel -rf mpd
			rm /lib/systemd/system/mpd.service
			rm -R $G_FP_DIETPI_USERDATA/.mpd_cache

		fi

		software_id=122
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			npm r -g node-red
			rm /etc/systemd/system/node-red.service
			rm $HOME/.node-red
			rm -R $G_FP_DIETPI_USERDATA/node-red
			[[ -f /usr/local/bin/node-red ]] && rm /usr/local/bin/node-red
			[[ -f /usr/local/bin/node-red-pi ]] && rm /usr/local/bin/node-red-pi
			userdel -rf nodered

		fi

		software_id=123
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP mosquitto

			rm /etc/systemd/system/mosquitto.service

		fi

		software_id=124
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto gcc-6-base libstdc++6 &> /dev/null
			G_AGP networkaudiod

		fi

		software_id=125
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP tomcat8

		fi

		software_id=126
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			apt-mark auto libssl1.0.0

		fi

		software_id=129
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /var/www/ompd
			systemctl start $MARIADB_SERVICE
			mysqladmin drop ompd -f
			mysql -e "drop user 'ompd'@'localhost'"

		fi

		software_id=130
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP python-pip python3-pip

		fi

		software_id=131
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			[[ -f /etc/systemd/system/blynkserver.service ]] && rm /etc/systemd/system/blynkserver.service
			[[ -d $G_FP_DIETPI_USERDATA/blynk ]] && rm -R $G_FP_DIETPI_USERDATA/blynk
			[[ -d /etc/blynkserver ]] && rm -R /etc/blynkserver #pre v6.19

			userdel -rf blynk

		fi

		software_id=132
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm /etc/systemd/system/aria2.service
			rm /usr/local/bin/aria2c
			rm /var/lib/dietpi/dietpi-software/installed/aria2.conf
			rm -R /var/www/aria2

			G_AGP aria2

		fi

		software_id=133
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm /etc/systemd/system/yacy.service
			rm -R /etc/yacy

		fi

		software_id=2
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP fahclient

			rm -R $G_FP_DIETPI_USERDATA/fahclient
			rm /lib/systemd/system/fahclient.service
			rm /var/log/fahclient.log

		fi

		software_id=134
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto libjpeg8 libpng12-0 libfontconfig1 libssl1.0.0 &> /dev/null

			rm /etc/systemd/system/tonido.service
			rm -R $G_FP_DIETPI_USERDATA/tonido

			userdel -rf tonido
			rm -R /home/tonido

		fi

		software_id=135
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP darkice icecast2
			rm /etc/systemd/system/darkice.service

		fi

		software_id=136
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto v4l-utils python python-dev libssl-dev libcurl4-openssl-dev libjpeg-dev zlib1g-dev libx264-142 libavcodec56 libavformat56 libmysqlclient18 libswscale3 libpq5 &> /dev/null
			G_AGP motion
			rm -R /etc/motioneye
			rm /etc/systemd/system/motioneye.service
			pip uninstall -y motioneye

		fi

		software_id=137
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP cloudprint-service
			if (( $G_DISTRO == 3 )); then

				rm /etc/apt/sources.list.d/cloudprint.list
				G_AGUP

			fi

		fi

		software_id=138
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /etc/vhusbd
			rm /etc/systemd/system/virtualhere.service

		fi

		software_id=139
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			userdel -rf sabnzbd
			rm -R /etc/sabnzbd
			rm /etc/systemd/system/sabnzbd.service

		fi

		software_id=140
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP libsdl2 libsdl2-image libsdl2-mixer libsdl2-net libsdl2-ttf libsmpeg2

		fi

		software_id=141
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R $G_FP_DIETPI_USERDATA/spotify-connect-web
			rm /etc/systemd/system/spotify-connect-web.service

		fi

		software_id=142
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /etc/couchpotato
			rm -R $G_FP_DIETPI_USERDATA/couchpotato
			rm /etc/init.d/couchpotato
			#userdel -rf couchpotato

		fi

		software_id=143
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			userdel -rf koel

			systemctl start $MARIADB_SERVICE
			mysqladmin drop koel -f
			mysql -e "drop user 'koel'@'localhost'"

			rm -R $G_FP_DIETPI_USERDATA/koel

			systemctl disable koel
			rm /etc/systemd/system/koel.service

		fi

		software_id=144
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			G_AGP nzbdrone

			rm /etc/systemd/system/sonarr.service
			rm -R /opt/NzbDrone 2>/dev/null

			rm -R $G_FP_DIETPI_USERDATA/sonarr
			rm -R /var/log/sonarr

			userdel -rf sonarr

			rm /etc/apt/sources.list.d/sonarr.list 2>/dev/null
			G_AGUP

		fi

		software_id=145
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			rm -R /opt/radarr
			rm /etc/systemd/system/radarr.service

			rm -R $G_FP_DIETPI_USERDATA/radarr
			rm -R /var/log/radarr

			userdel -rf radarr

		fi

		software_id=106
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			rm -R /opt/Lidarr
			rm /etc/systemd/system/lidarr.service

			rm -R $G_FP_DIETPI_USERDATA/lidarr
			rm -R /var/log/lidarr

			userdel -rf lidarr

		fi

		software_id=146
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /opt/plexpy
			rm -R $G_FP_DIETPI_USERDATA/plexpy
			rm /etc/systemd/system/plexpy.service

			userdel -rf plexpy

		fi

		software_id=147
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			userdel -rf jackett
			rm -R /opt/jackett
			rm /etc/systemd/system/jackett.service

		fi

		software_id=149
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R $G_FP_DIETPI_USERDATA/nzbget
			rm /etc/systemd/system/nzbget.service

			userdel -rf nzbget

		fi

		software_id=155
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R $G_FP_DIETPI_USERDATA/htpc-manager
			rm /etc/systemd/system/htpc-manager.service

		fi

		software_id=150
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			apt-mark auto mono-complete mono-devel mono-runtime libmono-cil-dev 2>/dev/null
			rm /etc/apt/sources.list.d/mono-xamarin.list
			G_AGUP

		fi

		software_id=151
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP nvidia-driver nvidia-xconfig libgl1-nvidia-glx:i386

		fi

		software_id=152
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP avahi-daemon

		fi

		software_id=153
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R $G_FP_DIETPI_USERDATA/octoprint
			rm $(which octoprint)
			rm -R $HOME/.octoprint
			rm /etc/systemd/system/octoprint.service

		fi


		software_id=121
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm /etc/systemd/system/roonbridge.service
			rm -R /etc/roonbridge
			userdel -rf roon

		fi

		software_id=154
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			[[ -d $G_FP_DIETPI_USERDATA/roonserver ]] && rm -R $G_FP_DIETPI_USERDATA/roonserver
			[[ -f /etc/systemd/system/roonserver.service ]] && rm /etc/systemd/system/roonserver.service

		fi

		software_id=156
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP steam
			rm -R $HOME/.steam
			rm -R $G_FP_DIETPI_USERDATA/steam

		fi

		software_id=119
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP cava
			rm "$HOME/.config/cava/config"
			rm "$HOME/cava.psf"

		fi

		software_id=118
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP mopidy
			rm /etc/apt/sources.list.d/mopidy.list
			rm -R $G_FP_DIETPI_USERDATA/mopidy

			userdel -rf mopidy

			pip uninstall -y Mopidy-MusicBox-Webclient Mopidy-Local-Images

		fi

		software_id=31
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP kodi kodi-odroid
			[[ -f /usr/share/applications/kodi.desktop ]] && rm /usr/share/applications/kodi.desktop
			[[ -f /root/Desktop/kodi.desktop ]] && rm /root/Desktop/kodi.desktop
			rm /home/*/Desktop/kodi.desktop &> /dev/null
			[[ -f /etc/udev/rules.d/99-dietpi-kodi.rules ]] && rm /etc/udev/rules.d/99-dietpi-kodi.rules

		fi

		software_id=39
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP minidlna

			rm -R $G_FP_DIETPI_USERDATA/.MiniDLNA_Cache

			rm /etc/systemd/system/minidlna.service
			userdel -rf minidlna

		fi

		software_id=51
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP ibsdl1.2debian libsdl-net1.2
			rm -R /usr/local/games/opentyrian
			rm /usr/share/applications/opentyrian.desktop
			rm ~/Desktop/opentyrian.desktop

		fi

		software_id=59
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP gpac
			rm -R /var/www/rpicam
			rm /opt/vc/bin/raspimjpeg
			rm /usr/bin/raspimjpeg
			rm /var/lib/dietpi/dietpi-software/installed/raspimjpeg.sh
			rm /etc/systemd/system/raspimjpeg.service
			rm /etc/raspimjpeg

		fi

		software_id=45
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP deluged deluge-web deluge-webui deluge-console
			rm /etc/systemd/system/deluged.service
			rm /etc/systemd/system/deluge-web.service
			rm -R $G_FP_DIETPI_USERDATA/deluge

			userdel -rf deluge

		fi

		software_id=94
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP proftpd-basic

		fi

		software_id=96
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP samba samba-common-bin

		fi

		software_id=95
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP vsftpd

		fi

		software_id=109
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP nfs-kernel-server

		fi

		software_id=67
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm /usr/local/bin/noip2
			rm /etc/systemd/system/noip2.service

		fi

		software_id=63
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /var/www/linuxdash

		fi

		software_id=93
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			pihole uninstall

			# - pihole-FTL service+binary
			systemctl disable pihole-FTL &> /dev/null
			systemctl stop pihole-FTL &> /dev/null
			rm /etc/init.d/pihole-FTL &> /dev/null
			rm /usr/bin/pihole-FTL &> /dev/null

			rm -R /etc/pihole &> /dev/null
			rm -R /etc/.pihole &> /dev/null
			rm -R /opt/pihole &> /dev/null
			rm -R /var/www/html/admin &> /dev/null
			rm -R /var/www/html/pihole &> /dev/null

			# - symlinks
			rm /var/www/pihole &> /dev/null
			rm /var/www/admin &> /dev/null
			[[ $(readlink /var/www/index.php) == 'pihole/index.php' ]] && rm /var/www/index.php

			# - pre Pi-hole v4
			G_AGP dnsmasq
			rm -R /etc/dnsmasq* &> /dev/null

		fi

		software_id=33
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R $G_FP_DIETPI_USERDATA/airsonic
			rm /etc/systemd/system/airsonic.service

			userdel -rf airsonic

		fi

		software_id=34
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP subsonic
			rm -R /var/subsonic

		fi

		software_id=71
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			update-rc.d webiopi remove
			rm -R /etc/webiopi
			rm -R /usr/share/webiopi
			rm /usr/bin/webiopi
			rm /etc/init.d/webiopi

		fi

		software_id=68
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			# <= v150 (weaved)
			rm -R /etc/weaved
			rm -R $HOME/weaved_software
			rm $HOME/weaved_setup.bin

			# Remot3.it
			G_AGP weavedconnectd

		fi

		software_id=62
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#Kill
			systemctl stop dietpi-cloudshell
			rm /etc/systemd/system/dietpi-cloudshell.service

			# - For old version of dietpi-cloudshell, without service.
			killall -w dietpi-cloudshell

			#Disable auto login, revert boot index to console
			/DietPi/dietpi/dietpi-autostart 0

		fi

		software_id=98
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			update-rc.d haproxy remove
			rm /etc/init.d/haproxy

			rm -r /etc/haproxy

			# Shared dev libraries. Leave these installed
			#apt-mark auto libpcre3-dev libssl-dev &> /dev/null

		fi

		software_id=35
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto libxml-parser-perl zlib1g-dev libjpeg-dev libpng-dev libjpeg62-turbo-dev &> /dev/null
			G_AGP logitechmediaserver
			rm /etc/systemd/system/squeezeboxserver.service
			rm -R /var/lib/squeezeboxserver
			rm -R /usr/share/squeezeboxserver

		fi

		software_id=55
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			systemctl start $MARIADB_SERVICE
			mysqladmin drop wordpress -f
			mysql -e "drop user 'wordpress'@'localhost'"

			rm -R /var/www/wordpress

		fi

		software_id=38
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			crontab -u www-data -l | grep -v '/opt/FreshRSS/app/actualize_script.php'  | crontab -u www-data -

			a2disconf dietpi-freshrss &> /dev/null
			rm /etc/apache2/conf-available/dietpi-freshrss.conf &> /dev/null

			systemctl start $MARIADB_SERVICE
			mysqladmin drop freshrss -f
			mysql -e "drop user 'freshrss'@'localhost'"

			rm -R /var/www/freshrss
			rm -R /opt/FreshRSS
			rm /var/log/freshrss.log

		fi

		software_id=27
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )) ||
			(( aSOFTWARE_INSTALL_STATE[28] == -1 )) ||
			(( aSOFTWARE_INSTALL_STATE[120] == -1 )); then

			Banner_Uninstalling
			G_AGP tightvncserver $(dpkg --get-selections tigervnc-* | awk '{print $1}') vnc4server x11vnc realvnc-vnc-server

			rm /etc/systemd/system/vncserver.service
			rm /etc/init.d/vncserver
			rm /usr/local/bin/vncserver
			rm -R $HOME/.vnc

			# + RealVNC services
			systemctl disable vncserver-x11-serviced.service
			systemctl disable vncserver-virtuald.service

		fi

		software_id=73
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP fail2ban

		fi

		software_id=64
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /var/www/phpsysinfo

		fi

		software_id=56
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm /var/www/gallery/index.php
			rm -R /var/www/gallery/_sfpg_data

		fi

		software_id=40
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /var/www/ampache

			#drop database
			systemctl start $MARIADB_SERVICE
			mysqladmin drop ampache -f
			mysql -e "drop user 'ampache'@'localhost'"

		fi

		software_id=117
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm /etc/apt/sources.list.d/swupdate.openvpn.net.list
			pivpn -u
			userdel -rf pivpn

		fi

		software_id=97
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP openvpn
			rm -R /etc/openvpn &> /dev/null

		fi

		software_id=92
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			if (( $G_DISTRO >= 4 )); then

				G_AGP python-certbot-apache python-certbot-nginx certbot
				[ -f /etc/systemd/system/certbot.service ] && rm /etc/systemd/system/certbot.service
				[ -d /etc/systemd/system/certbot.service.d ] && rm -R /etc/systemd/system/certbot.service.d

			else

				# Pre-reqs: https://github.com/certbot/certbot/blob/master/certbot-auto#L390-L399
				#apt-mark auto python python-dev virtualenv python-virtualenv gcc libaugeas0 augeas-lenses libssl-dev openssl libffi-dev ca-certificates
				[ -d /etc/certbot_scripts ] && rm -R /etc/certbot_scripts
				[ -f /etc/cron.weekly/dietpi-letsencrypt ] && rm /etc/cron.weekly/dietpi-letsencrypt
				[ -f /home/minio-user/.minio/dietpi-cert-renewl.sh ] && rm /home/minio-user/.minio/dietpi-cert-renewl.sh

			fi

		fi

		software_id=69
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP python-rpi.gpio python3-rpi.gpio

		fi

		software_id=72
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP i2c-tools
			#Disable
			/DietPi/dietpi/func/dietpi-set_hardware i2c disable

		fi

		software_id=70
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /root/wiringPi* &> /dev/null

		fi

		software_id=61
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP tor

			# - uninstall WIFIHOTSPOT ALSO. Due to IPtables needing reset.
			aSOFTWARE_INSTALL_STATE[60]=-1

		fi

		software_id=60
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto libssl1.0.0 &> /dev/null
			G_AGP hostapd isc-dhcp-server

			rm /etc/dhcp/dhcpd.conf &> /dev/null
			rm /etc/hostapd/hostapd.conf &> /dev/null
			rm /etc/default/isc-dhcp-server &> /dev/null
			rm /etc/default/hostapd &> /dev/null
			rm /etc/iptables.ipv4.nat &> /dev/null
			# - remove binary (used a -f trigger to detect wifi hotspot mode in dietpi-config).
			rm /usr/sbin/hostapd &> /dev/null
			rm /usr/sbin/hostapd_cli &> /dev/null

			#Set Wlan back to inactive and ready for use with dietpi-config.
			local wifi_index=$(sed -n 2p /DietPi/dietpi/.network)

			# - Remove all entries below wlan, so we can recreate them.
			sed -i '/allow-hotplug wlan/q0' /etc/network/interfaces

			# - Disable wlan
			sed -i "/allow-hotplug wlan/c\#allow-hotplug wlan$wifi_index" /etc/network/interfaces

			# - Add default wifi settings to network interfaces config
			cat << _EOF_ >> /etc/network/interfaces
iface wlan$wifi_index inet dhcp
address 192.168.0.101
netmask 255.255.255.0
gateway 192.168.0.1
wireless-power off
wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf
#dns-nameservers 8.8.8.8 8.8.4.4
_EOF_

			# - Flush IP tables
			iptables -F
			iptables -t nat -F
			iptables-save > /etc/iptables.ipv4.nat

		fi

		software_id=37
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto libssl1.0.0 openssl libsoxr0 libavahi-client3 libtool libconfig9 libpopt0 libdaemon0 &> /dev/null
			# No package is installed anymore, files are directly extracted into places, need to remove them manually?
			# https://github.com/Fourdee/DietPi/blob/testing/dietpi/dietpi-software#L5968
			#G_AGP shairport-sync
			rm /lib/systemd/system/shairport-sync.service /usr/local/bin/shairport-sync /usr/local/etc/shairport-sync.conf* /usr/local/share/man/man7/shairport-sync.7.gz &> /dev/null
			userdel -rf shairport-sync

		fi

		software_id=48
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /var/www/pydio

			# Remove webserver configs
			[[ $(which a2dissite) ]] && a2dissite dietpi-pydio
			[[ -f /etc/apache2/conf-available/dietpi-pydio.conf ]] && rm /etc/apache2/conf-available/dietpi-pydio.conf
			[[ -f /etc/nginx/sites-dietpi/dietpi-pydio.conf ]] && rm /etc/nginx/sites-dietpi/dietpi-pydio.conf
			[[ $(which lighttpd-disable-mod) ]] && lighttpd-disable-mod dietpi-pydio
			[[ -f /etc/lighttpd/conf-available/99-dietpi-pydio.conf ]] && rm /etc/lighttpd/conf-available/99-dietpi-pydio.conf

			# Drop database
			systemctl start $MARIADB_SERVICE
			mysqladmin drop pydio -f
			mysql -e "drop user pydio@localhost"

		fi

		software_id=36
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP squeezelite

			rm -R /usr/bin/squeezelite*
			rm /etc/systemd/system/squeezelite.service

		fi

		software_id=99
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /etc/emonhub
			rm /etc/init.d/emonhub
			rm /etc/default/emonhub

		fi

		software_id=66
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP rpimonitor

		fi

		software_id=57
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /var/www/baikal

			#drop database
			systemctl start $MARIADB_SERVICE
			mysqladmin drop baikal -f
			mysql -e "drop user 'baikal'@'localhost'"

			# Remove redirect configs
			lighttpd-disable-mod dietpi-dav_redirect &> /dev/null
			rm /etc/lighttpd/conf-available/99-dietpi-dav_redirect.conf &> /dev/null

			a2disconf dietpi-dav_redirect &> /dev/null
			rm /etc/apache2/conf-available/dietpi-dav_redirect.conf &> /dev/null

			rm /etc/nginx/sites-dietpi/dietpi-dav_redirect.conf &> /dev/null

		fi

		software_id=65
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto zlib1g-dev &> /dev/null

			#all
			rm /etc/systemd/system/netdata.service

			userdel -rf netdata
			groupdel netdata

			#1.2.0+
			G_AGP netdata

			#1.0.0
			rm /usr/sbin/netdata

			rm -R /etc/netdata
			rm -R /usr/share/netdata
			rm -R /usr/libexec/netdata
			rm -R /var/cache/netdata
			rm -R /var/log/netdata

		fi

		software_id=43
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP mumble-server

		fi

		software_id=41
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP emby-server embymagick

			# - Pre v6.15
			if [[ -f /etc/apt/sources.list.d/emby-server.list ]]; then

				rm /etc/apt/sources.list.d/emby-server.list
				G_AGUP

			fi

		fi

		software_id=58
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			rm /etc/systemd/system/openbazaar.service
			rm -R $G_FP_DIETPI_USERDATA/go/src/github.com/OpenBazaar
			rm -R /etc/openbazaar-server &> /dev/null # Pre v6.15 OB1.0

		fi

		software_id=42
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP $(dpkg --get-selections plexmediaserver* | awk '{print $1}')
			[[ -d /var/lib/plexmediaserver ]] && rm -R /var/lib/plexmediaserver
			[[ -f etc/apt/sources.list.d/plex.list ]] && rm /etc/apt/sources.list.d/plex.list && G_AGUP
			[[ -d /etc/systemd/system/plexmediaserver.service.d ]] && rm -R /etc/systemd/system/plexmediaserver.service.d # post v6.17

		fi

		software_id=52
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R /etc/cuberite &> /dev/null #v6.11<
			rm -R $G_FP_DIETPI_USERDATA/cubrite
			rm /etc/systemd/system/cuberite.service

			userdel -rf cuberite

		fi

		software_id=53
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R $G_FP_DIETPI_USERDATA/mineos
			rm -R /var/games/minecraft

			rm /etc/supervisor/conf.d/mineos.conf
			supervisorctl reload

			rm /usr/local/bin/mineos

			userdel -rf mineos

		fi

		software_id=49
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			userdel -rf gogs

			rm -R /etc/gogs
			rm /etc/systemd/system/gogs.service
			rm -R /var/log/gogs

			systemctl start $MARIADB_SERVICE
			mysqladmin drop gogs -f
			mysql -e "drop user 'gogs'@'localhost'"

		fi

		software_id=46
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP qbittorrent-nox

			userdel -rf qbittorrent

			rm /etc/systemd/system/qbittorrent.service
			rm -R /home/qbittorrent

		fi

		software_id=50
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			[[ -f /etc/systemd/system/syncthing.service ]] && rm /etc/systemd/system/syncthing.service
			[[ -f dietpi-syncthing.conf ]] && rm /etc/sysctl.d/dietpi-syncthing.conf # DietPi post-v6.18

			[[ -f /usr/bin/syncthing ]] && rm /usr/bin/syncthing # DietPi pre-v158
			[[ -d /etc/syncthing ]] && rm -R /etc/syncthing

			[[ -d $G_FP_DIETPI_USERDATA/syncthing ]] && rm -R $G_FP_DIETPI_USERDATA/syncthing

		fi

		software_id=116
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			rm /etc/systemd/system/sickrage.service

			rm -R  /etc/sickrage &> /dev/null # v6.11<
			rm -R $G_FP_DIETPI_USERDATA/sickrage

			userdel -rf sickrage

		fi

		software_id=107
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP rtorrent
			rm -R /var/www/rutorrent
			rm $HOME/.rtorrent.rc
			rm /etc/systemd/system/rtorrent.service

			# - webserver rutorrent user/pw settings
			rm /etc/.rutorrent-htaccess

			#	lighttpd
			#Remove from
			#RUTORRENT_DIETPI to #RUTORRENT_DIETPI in /etc/lighttpd/lighttpd.conf

			#	nginx
			rm /etc/nginx/sites-dietpi/dietpi-rutorrent.conf

			#	apache2
			which a2dissite &> /dev/null && a2dissite dietpi-rutorrent
			rm /etc/apache2/sites-available/dietpi-rutorrent.conf

		fi

		software_id=108
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R $G_FP_DIETPI_USERDATA/amiberry
			rm /etc/systemd/system/amiberry.service

			#Disable autostart, revert boot index to console
			/DietPi/dietpi/dietpi-autostart 0

		fi

		software_id=112
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm $G_FP_DIETPI_USERDATA/dxx-rebirth/*
			rm -R $G_FP_DIETPI_USERDATA/dxx-rebirth/descent_1_game
			rm -R $G_FP_DIETPI_USERDATA/dxx-rebirth/descent_2_game

			#Remove symlinks
			rm $HOME/.d1x-rebirth
			rm $HOME/.d2x-rebirth
			rm $HOME/Desktop/dxx-rebirth.desktop
			rm /usr/share/applications/dxx-rebirth.desktop

		fi

		software_id=113
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto libgnome-keyring0 libnspr4 libnss3 libnss3-1d libspeechd2 libxslt1.1 libxss1 xdg-utils libgnome-keyring-common libltdl7 &> /dev/null
			apt-mark unhold chromium chromedriver

			rm /etc/chromium.d/custom_flags
			rm /var/lib/dietpi/dietpi-software/installed/chromium-autostart.sh
			rm $HOME/.chromium-browser.init

			G_AGP $(dpkg --get-selections chromium* | awk '{print $1}') chromedriver # chromedriver: Jessie only

		fi

		software_id=157
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			# Remove installationof HA.
			rm -R /srv/homeassistant

			# Remove the user and all files. This removed pyenv for this user as well.
			userdel -rf homeassistant
			groupdel homeassistant

			# Remove the service.
			rm /etc/systemd/system/home-assistant.service

		fi

		software_id=165
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			# Delete systemd files
			rm /etc/systemd/system/gitea.service

			# Delete data
			rm -R $G_FP_DIETPI_USERDATA/gitea
			rm -R /var/log/gitea

			# drop/delete database
			systemctl start $MARIADB_SERVICE
			mysqladmin drop gitea -f
			mysql -e "drop user 'gitea'@'localhost'"

		fi

		software_id=166
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm /etc/systemd/system/pi-spc.service
			rm -R /var/lib/dietpi/dietpi-software/installed/pi-spc

			sed -i '/^dtoverlay=gpio-shutdown/d' /DietPi/config.txt
			sed -i '/^dtoverlay=gpio-poweroff/d' /DietPi/config.txt

		fi

		software_id=167
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP raspotify
			rm /etc/apt/sources.list.d/raspotify.list
			G_AGUP

		fi

		software_id=169
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			rm -R $G_FP_DIETPI_USERDATA/voice-recognizer-raspi
			rm /etc/systemd/system/voice-recognizer.service
			rm /etc/systemd/system/alsa-init.service
			rm -R /home/dietpi/assistant.json

		fi

		software_id=100
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP pijuice-base
			rm -R /var/lib/dietpi/dietpi-software/installed/pijuice

		fi

		software_id=158
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			# Remove service
			systemctl stop minio.service
			systemctl disable minio.service

			# Remove files
			rm /usr/local/bin/minio
			rm /etc/systemd/system/minio.service
			rm /etc/default/minio

			# Remove userdel
			userdel -rf minio-user

			# Remove certbot renewal hook:
			rm /etc/systemd/system/certbot.service.d/dietpi-minio.conf &> /dev/null
			# Remove hook directory only, if empty:
			rmdir /etc/systemd/system/certbot.service.d &> /dev/null

		fi

		software_id=161
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			/etc/init.d/bdd stop
			sleep 2
			killall --user bd
			sleep 2
			rm /etc/rc3.d/S99bdd
			rm /etc/rc4.d/S99bdd
			rm /etc/rc2.d/S99bdd
			rm /etc/rc5.d/S99bdd
			rm /etc/init.d/bdd

			userdel -rf bd

		fi

		software_id=162
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			# Remove docker, all its unused dependencies and custom repository
			G_AGP docker-ce docker-ce-cli docker-engine
			[[ -f /etc/apt/sources.list.d/docker.list ]] && rm /etc/apt/sources.list.d/docker.list

			# Remove service adjustments
			[[ -d /lib/systemd/system/docker.service.d ]] && rm -R /lib/systemd/system/docker.service.d
			# Delete data files - dietpi
			[[ -d $G_FP_DIETPI_USERDATA/docker-data ]] && rm -R $G_FP_DIETPI_USERDATA/docker-data
			# Remove default unused folder
			[[ -d /var/lib/docker ]] && rm -R /var/lib/docker

			# Faulty "docker-ce" package version fix; This can be removed after repo got an update: https://github.com/Fourdee/DietPi/issues/2282
			[[ -f /etc/apt/preferences.d/dietpi-docker_fix ]] && rm /etc/apt/preferences.d/dietpi-docker_fix

		fi

		software_id=164
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			# Remove Service file
			rm /etc/systemd/system/nukkit.service

			# remove nukkit java file/folder
			rm -r /usr/local/bin/nukkit

		fi

		software_id=163
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto libupnp6 gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-alsa &> /dev/null
			G_AGP gmrender
			rm /etc/systemd/system/gmrender.service

			userdel -rf gmrender

		fi

		software_id=159
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )) ||
			(( aSOFTWARE_INSTALL_STATE[160] == -1 )); then

			Banner_Uninstalling
			rm -R /var/www/allo
			userdel -rf allo
			rm /etc/sudoers.d/allo
			systemctl start $MARIADB_SERVICE
			mysqladmin drop allo_db -f
			mysql -e "drop user 'allo_db'@'localhost'"

		fi

		software_id=88
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_WHIP_MSG "Creating MariaDB database backup before uninstallation:\n\nIn case of accident, we create a database backup for you. You can remove it manually, if you are sure, that you don't need it any more.\n\n$G_FP_DIETPI_USERDATA/mariadb-database-backup.sql"
			G_RUN_CMD systemctl start $MARIADB_SERVICE
			mysqldump --all-databases > $G_FP_DIETPI_USERDATA/mariadb-database-backup.sql
			# On Jessie, purging MariaDB server with unix_socket authentication fails, thus revert to password:
			(( $G_DISTRO < 4 )) && mysql -e "grant all privileges on *.* to 'root'@'localhost' identified by '$GLOBAL_PW' with grant option;flush privileges"
			systemctl stop $MARIADB_SERVICE
			G_AGP mariadb-server

			# - config folder
			rm -R /etc/mysql 2> /dev/null
			rm -R ~/.mysql_history 2> /dev/null

			# - SQL store
			rm -R /var/lib/mysql 2> /dev/null
			rm -R $G_FP_DIETPI_USERDATA/mysql 2> /dev/null

		fi

		software_id=74
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			G_AGP influxdb
			rm /etc/apt/sources.list.d/influxdb.list && G_AGUP

			rm -R /var/lib/influxdb
			rm -R $G_FP_DIETPI_USERDATA/influxdb

			rm /lib/systemd/system/influxdb.service &> /dev/null # still exists after G_AGP

		fi

		software_id=77
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			G_AGP grafana
			rm /etc/apt/sources.list.d/grafana*.list &> /dev/null && G_AGUP

			rm -R /var/lib/grafana
			rm -R $G_FP_DIETPI_USERDATA/grafana

		fi

		software_id=80
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			rm /etc/systemd/system/ubooquity.service
			rm -R $G_FP_DIETPI_USERDATA/ubooquity

			userdel -rf ubooquity

		fi

		software_id=86
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			UNINSTALL_URL_ADDRESS='https://github.com/TheAppgineer/roon-extension-manager-packaging/raw/master/linux/setup.sh'
			G_CHECK_URL "$UNINSTALL_URL_ADDRESS"

			wget -O setup.sh "$UNINSTALL_URL_ADDRESS"
			chmod +x setup.sh
			./setup.sh --uninstall
			rm setup.sh

		fi


		#----------------------------------------------------------------------
		#LINUX SOFTWARE

		software_id=15
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP tcpdump

		fi

		software_id=14
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP nload

		fi

		software_id=13
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP mtr-tiny

		fi

		software_id=11
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP iptraf

		fi

		software_id=10
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP iftop

		fi

		software_id=19
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP jed

		fi

		software_id=3
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP mc

		fi

		software_id=18
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP emacs

		fi

		software_id=20
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )) ||
			(( aSOFTWARE_INSTALL_STATE[21] == -1 )); then

			Banner_Uninstalling
			G_AGP vim vim-tiny

		fi

		software_id=127
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP neovim

		fi

		software_id=0
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			# This also removes OpenSSH server. So lets check OpenSSH server isn't installed before hand.
			if dpkg --get-selections | grep -qi 'openssh-server'; then

				G_AGP openssh-client

			fi

		fi

		software_id=1
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			umount -f /mnt/samba
			G_AGP smbclient
			#Disable in fstab
			sed -i '/\/mnt\/samba/c\#\/mnt\/samba . Please use dietpi-drive_manager to setup this mount' /etc/fstab
			#Add info file for installation method.
			echo -e 'Samba client can be installed and setup by DietPi-Drive_Manager.\nSimply run: dietpi-drive_manager and select the "Add network drive" option.' > /mnt/samba/readme.txt

		fi

		software_id=111
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP urbackup-server

			#+sourcebuild
			rm /etc/systemd/system/urbackupsrv.service
			rm /etc/default/urbackupsrv
			rm /etc/logrotate.d/urbackupsrv
			rm /usr/sbin/urbackupsrv
			rm /usr/bin/urbackup_snapshot_helper
			rm /usr/bin/urbackupsrv
			rm -R /usr/share/urbackup

		fi

		software_id=110
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			umount -f /mnt/nfs_client

			#nfs-kernel-server depends on nfs-common
			if (( ${aSOFTWARE_INSTALL_STATE[109]} == 0 )); then

				G_AGP nfs-common
				#apt-mark auto netbase

			fi

			#Disable in fstab
			sed -i '/\/mnt\/nfs_client/c\#\/mnt\/nfs_client . Please use DietPi-Drive_Manager to setup this mount' /etc/fstab

			#Add info file for installation method.
			echo -e 'NFS client can be installed and setup by DietPi-Drive_Manager.\nSimply run: dietpi-drive_manager and select the "Add network drive" option.' > /mnt/nfs_client/readme.txt

		fi

		software_id=16
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP build-essential

		fi

		software_id=17
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP git

		fi

		software_id=5
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP alsa-utils

		fi

		software_id=6
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			#apt-mark auto xserver-xorg-video-armsoc libdrm-rockchip1 libmali-rk-utgard-450-r7p0 aml-libs-odroid mali450-odroid xf86-video-mali-odroid libump* xf86-video-fbturbo* firmware-samsung xf86-video-armsoc-odroid malit628-odroid &> /dev/null
			G_AGP xserver-xorg xinit xcompmgr xterm dbus-x11 xfonts-base x11-xserver-utils x11-utils
			rm /etc/xdg/autostart/xcompmgr.desktop /etc/X11/xorg.conf /etc/X11/xorg.conf.d/99-dietpi-dpms_off.conf &> /dev/null

		fi

		software_id=7
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP ffmpeg
			(( $G_HW_MODEL < 10 )) && apt-mark auto libx264 libmp3lame libfdk-aac

		fi

		software_id=8
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			apt-mark auto $(dpkg --get-selections default-jre* default-jdk* openjdk-8-jre* openjdk-8-jdk* | awk '{print $1}') ca-certificates-java
			rm /etc/apt/preferences.d/99-dietpi-openjdk-8-jdk &> /dev/null

		fi

		software_id=104
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP $(dpkg --get-selections dropbear* | awk '{print $1}') #stretch | dropbear-initramfs dropbear-run

		fi

		software_id=105
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP $(dpkg --get-selections openssh-* | awk '{print $1}')

			# This also clears Openssh-client
			aSOFTWARE_INSTALL_STATE[0]=0

		fi

		software_id=103
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling

			sed -i '/\/var\/log/c\#\/var\/log DietPi-RAMlog disabled' /etc/fstab

			# - Boot service to allow dietpi-ramlog to start and copy skeletons back to /var/log, then finally disable ramlog
			cat << _EOF_ > /etc/systemd/system/dietpi-ramlog_disable.service
[Unit]
Description=DietPi - Boot service to allow dietpi-ramlog to start and copy skeletons back to /var/log, then finally disable ramlog
After=dietpi-ramlog.service dietpi-ramdisk.service
Requires=dietpi-ramdisk.service
Before=dietpi-boot.service rsyslog.service syslog.service

[Service]
Type=oneshot
RemainAfterExit=yes
StandardOutput=tty
ExecStart=/bin/bash -c '/var/lib/dietpi/dietpi-ramlog/disable.sh &> /var/tmp/dietpi/logs/dietpi-ramlog_disable_debug.log'

[Install]
WantedBy=local-fs.target
_EOF_

			systemctl daemon-reload
			systemctl enable dietpi-ramlog_disable

			cat << _EOF_ > /var/lib/dietpi/dietpi-ramlog/disable.sh
#!/bin/bash
{
	systemctl stop dietpi-ramlog
	systemctl disable dietpi-ramlog
	rm -R /var/tmp/dietpi/logs/dietpi-ramlog_store/*
	systemctl disable dietpi-ramlog_disable
	rm /etc/systemd/system/dietpi-ramlog_disable.service
	systemctl daemon-reload
	rm /var/lib/dietpi/dietpi-ramlog/disable.sh
}
_EOF_

			chmod +x /var/lib/dietpi/dietpi-ramlog/disable.sh

		fi

		software_id=101
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP logrotate

		fi

		software_id=102
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP rsyslog

		fi

		software_id=9
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			npm r -g n yarn npm
			G_AGP nodejs

			# - old install via repo
			if [[ -f /etc/apt/sources.list.d/nodesource_nodejs.list ]]; then

				rm /etc/apt/sources.list.d/nodesource_nodejs.list
				G_AGUP

			fi

			[[ -f /usr/local/bin/node ]] && rm /usr/local/bin/node
			[[ -d /usr/local/n ]] && rm -R /usr/local/n
			[[ -d /usr/local/yarn ]] && rm -R /usr/local/yarn
			[[ -d /usr/local/include/node ]] && rm -R /usr/local/include/node
			[[ -d /usr/local/lib/node_modules ]] && rm -R /usr/local/lib/node_modules
			[[ -d /usr/local/share/doc/node ]] && rm -R /usr/local/share/doc/node
			[[ -f /usr/local/man/man1/node.1 ]] && rm /usr/local/man/man1/node.1
			[[ -f /usr/local/share/man/man1/node.1 ]] && rm /usr/local/share/man/man1/node.1
			[[ -f /usr/local/README.md ]] && /usr/local/README.md
			[[ -f /usr/local/CHANGELOG.md ]] && /usr/local/CHANGELOG.md
			[[ -f /usr/local/LICENSE ]] && /usr/local/LICENSE
			[[ -f /usr/local/share/systemtap/tapset/node.stp ]] && rm /usr/local/share/systemtap/tapset/node.stp
			[[ -d $HOME/.npm ]] && rm -R $HOME/.npm
			[[ -f $HOME/.config/configstore/update-notifier-npm.json ]] && rm $HOME/.config/configstore/update-notifier-npm.json

		fi

		software_id=4
		if (( aSOFTWARE_INSTALL_STATE[$software_id] == -1 )); then

			Banner_Uninstalling
			G_AGP vifm

		fi

		G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" 'Finalize uninstall'

		#Uninstall finished, set all uninstalled software to state 0 (not installed)
		for i in ${!aSOFTWARE_INSTALL_STATE[@]}
		do

			(( ${aSOFTWARE_INSTALL_STATE[$i]} == -1 )) && aSOFTWARE_INSTALL_STATE[$i]=0

		done

		#apt-get autoremove
		G_AGA

		#Check if we need to clear DietPi choices
		local fp_temp='.dietpi-uninstall_dpkg'
		dpkg --get-selections | awk '{print $1}' > $fp_temp
		if ! grep -q '^openssh-server' $fp_temp &&
			! grep -q '^dropbear' $fp_temp; then

			INDEX_SSHSERVER_CURRENT=0
			INDEX_SSHSERVER_TARGET=0

		fi

		if ! grep -q '^samba$' $fp_temp &&
			! grep -q '^proftpd-basic' $fp_temp; then

			INDEX_FILESERVER_CURRENT=0
			INDEX_FILESERVER_TARGET=0

		fi

		if grep -q '#/var/log' /etc/fstab &&
			! grep -q '^rsyslog' $fp_temp &&
			! grep -q '^logrotate' $fp_temp; then

			INDEX_LOGGING_CURRENT=0
			INDEX_LOGGING_TARGET=0

		fi

		rm $fp_temp

		systemctl daemon-reload

		#----------------------------------------------------------------------
		#Done, reset uninstall flag
		UNINSTALL_REQUIRED=0
		#----------------------------------------------------------------------
		#Reset error handler (eg: for usermsg clear)
		G_ERROR_HANDLER_RESET
		#----------------------------------------------------------------------

	}

	Run_Installations(){

		#------------------------------------------------------------
		#Prevent continue if Network or NTPD is not completed: https://github.com/Fourdee/DietPi/issues/786
		Check_Internet_and_NTPD
		#------------------------------------------------------------
		#Disable powersaving on main screen during installation
		setterm -blank 0 -powersave off 2> /dev/null
		#------------------------------------------------------------
		# Unmask all services: https://github.com/Fourdee/DietPi/issues/1320
		DISABLE_SERVICES_START=1 /DietPi/dietpi/dietpi-services unmask all
		# Stop services
		/DietPi/dietpi/dietpi-services stop
		#------------------------------------------------------------
		#Generate userdata folders:
		Create_UserContent_Folders
		#------------------------------------------------------------
		# Set current path to home folder
		cd /tmp/$G_PROGRAM_NAME

		# Update & upgrade APT
		Banner_Apt_Update

		# - Update APT list
		G_AGUP

		# - Simulated APT installation to check for failures related to apt-cache.
		G_DIETPI-NOTIFY 2 'Running apt simulation to check for errors, please wait...'
		local package_to_test='bash-doc'
		G_AGI $package_to_test -s

		# - Upgrade APT packages
		G_AGUG

		# - Automation Set NTPD mode
		#	Due to possible packages required, must be done here after APT cache updated
		if (( $G_DIETPI_INSTALL_STAGE == 0 )); then

			/DietPi/dietpi/func/dietpi-set_software ntpd-mode $(grep -m1 '^[[:blank:]]*CONFIG_NTP_MODE=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')

		fi

		# Generate dir for dietpi-software installed "non-service" based control scripts
		mkdir -p /var/lib/dietpi/dietpi-software/services
		chmod -R +x /var/lib/dietpi/dietpi-software/services

		# Disable software installation, if user input is required for automated installs
		Install_Disable_Requires_UserInput

		# Apply DietPi choice systems
		Apply_FileServer_Choices
		Apply_SSHServer_Choices
		Apply_Logging_Choices

		# Apply DietPi preference systems
		Apply_Webserver_Preference

		# Update required software that needs to be installed
		Install_Flag_Prereq_Software

		# Install Linux Software
		/DietPi/dietpi/dietpi-services stop
		Install_Linux_Software

		# Install DietPi Optimized Software
		/DietPi/dietpi/dietpi-services stop
		Install_Dietpi_Software

		# Apply Uninstall script, if required by e.g. DietPi choice system
		(( $UNINSTALL_REQUIRED )) && Uninstall_Software

		# Apply DietPi configurations and optimizations
		/DietPi/dietpi/dietpi-services stop
		Banner_Configs
		Install_Apply_Configs

		/DietPi/dietpi/func/dietpi-set_software setpermissions &> /dev/null

		# Apply autostart index
		local autostart_current=0
		[[ -f /DietPi/dietpi/.dietpi-autostart_index ]] && autostart_current="$(</DietPi/dietpi/.dietpi-autostart_index)"
		/DietPi/dietpi/dietpi-autostart $autostart_current

		# Disable services so DietPi-services can take control (DietPi will start all services from dietpi-postboot.service)
		/DietPi/dietpi/dietpi-services dietpi_controlled

		# Install finished, set all installed software to state 2 (installed)
		for i in ${!aSOFTWARE_INSTALL_STATE[@]}
		do

			(( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 )) && aSOFTWARE_INSTALL_STATE[$i]=2

		done

		# Apply GPU Memory Splits: NB, this only checks for installed state '=2'
		Install_Apply_GPU_Settings

		# Write to .install File
		Write_InstallFileList

		# DietPi-Automation
		if (( $G_DIETPI_INSTALL_STAGE == 0 )); then

			# - Remove fake-hwclock, if real hwclock is available
			#REMOVED: Needs further work as SBC's without RTC's (XU4/Sparky SBC) are being flagged for this removal
			#hwclock &> /dev/null && G_AGP fake-hwclock

			# - x86_64 microcode installation
			if (( $G_HW_ARCH == 10 )); then

				grep -qi 'vendor_id.*intel' /proc/cpuinfo && G_AGI intel-microcode
				grep -qi 'vendor_id.*amd' /proc/cpuinfo && G_AGI amd64-microcode

			fi

			# - Custom 1st run Script (Local file)
			local run_custom_script=0
			if [[ -f /boot/Automation_Custom_Script.sh ]]; then

				cp /boot/Automation_Custom_Script.sh /root/AUTO_CustomScript.sh
				run_custom_script=1

			# - Custom 1st run Script (Online file)
			elif [[ $AUTOINSTALL_CUSTOMSCRIPTURL != '0' ]]; then

				INSTALL_URL_ADDRESS="$AUTOINSTALL_CUSTOMSCRIPTURL"
				G_CHECK_URL "$INSTALL_URL_ADDRESS"

				#Get script and execute
				wget "$INSTALL_URL_ADDRESS" -O /root/AUTO_CustomScript.sh
				run_custom_script=1

			fi

			if (( $run_custom_script )); then

				local fp_dietpiautomation_custom_script_log='/var/tmp/dietpi/logs/dietpi-automation_custom_script.log'

				G_DIETPI-NOTIFY 2 'Running custom script, please wait...'
				chmod +x /root/AUTO_CustomScript.sh
				if /root/AUTO_CustomScript.sh | tee $fp_dietpiautomation_custom_script_log; then

					G_DIETPI-NOTIFY 0 'Custom script'

				else

					G_DIETPI-NOTIFY 1 "Custom script: Please see the log file for more information $fp_dietpiautomation_custom_script_log"

				fi

				rm /root/AUTO_CustomScript.sh

			fi

			# Apply AutoStart
			/DietPi/dietpi/dietpi-autostart "$AUTOINSTALL_AUTOSTARTTARGET"

		fi

		# Set Install Stage to Finished
		echo 1 > /DietPi/dietpi/.install_stage

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# First Run / Automation functions Vars (eg: on a fresh install)
	#/////////////////////////////////////////////////////////////////////////////////////
	AUTOINSTALL_ENABLED=0

	AUTOINSTALL_SSHINDEX=0
	AUTOINSTALL_FILESERVERINDEX=0
	AUTOINSTALL_LOGGINGINDEX=0
	AUTOINSTALL_WEBSERVERINDEX=0

	AUTOINSTALL_AUTOSTARTTARGET=0

	AUTOINSTALL_CUSTOMSCRIPTURL=0

	FirstRun_Automation_Init(){

		#Get settings
		AUTOINSTALL_ENABLED="$(grep -m1 '^[[:blank:]]*AUTO_SETUP_AUTOMATED=' /DietPi/dietpi.txt | sed 's/^.*=//')"

		AUTOINSTALL_AUTOSTARTTARGET="$(grep -m1 '^[[:blank:]]*AUTO_SETUP_AUTOSTART_TARGET_INDEX=' /DietPi/dietpi.txt | sed 's/^.*=//' )"

		AUTOINSTALL_SSHINDEX="$(grep -m1 '^[[:blank:]]*AUTO_SETUP_SSH_SERVER_INDEX=' /DietPi/dietpi.txt | sed 's/^.*=//')"
		AUTOINSTALL_FILESERVERINDEX="$(grep -m1 '^[[:blank:]]*AUTO_SETUP_FILE_SERVER_INDEX=' /DietPi/dietpi.txt | sed 's/^.*=//')"
		AUTOINSTALL_LOGGINGINDEX="$(grep -m1 '^[[:blank:]]*AUTO_SETUP_LOGGING_INDEX=' /DietPi/dietpi.txt | sed 's/^.*=//')"
		AUTOINSTALL_WEBSERVERINDEX="$(grep -m1 '^[[:blank:]]*AUTO_SETUP_WEB_SERVER_INDEX=' /DietPi/dietpi.txt | sed 's/^.*=//')"

		AUTOINSTALL_CUSTOMSCRIPTURL="$(grep -m1 '^[[:blank:]]*AUTO_SETUP_CUSTOM_SCRIPT_EXEC=' /DietPi/dietpi.txt | sed 's/^[^=]*=//')"

	}

	FirstRun_Automation_Set(){

		#Automated install
		if (( $AUTOINSTALL_ENABLED > 0 )); then

			G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" 'Running automated installation'

			#Skip dietpi-software menu
			TARGETMENUID=-1

			#Set start install
			GOSTARTINSTALL=1

			#Find all software entries of AUTO_SETUP_INSTALL_SOFTWARE_ID= in dietpi.txt. Then set to state 1 for installation.
			while read -r software_id
			do

				# - Flag for installation
				if disable_error=1 G_CHECK_VALIDINT "${aSOFTWARE_INSTALL_STATE[$software_id]}"; then

					aSOFTWARE_INSTALL_STATE[$software_id]=1

					G_DIETPI-NOTIFY 2 "Automation: ${aSOFTWARE_WHIP_NAME[$software_id]}. Flagged for installation."

				fi

			done <<< "$(grep '^[[:blank:]]*AUTO_SETUP_INSTALL_SOFTWARE_ID=' /DietPi/dietpi.txt | awk '{print $1}' | sed 's/[^0-9]*//g')"

		fi

		#Further Automated options. (Applied regardless of AUTOINSTALL_ENABLED)
		INDEX_SSHSERVER_TARGET=$AUTOINSTALL_SSHINDEX
		INDEX_FILESERVER_TARGET=$AUTOINSTALL_FILESERVERINDEX
		INDEX_LOGGING_TARGET=$AUTOINSTALL_LOGGINGINDEX
		INDEX_WEBSERVER_TARGET=$AUTOINSTALL_WEBSERVERINDEX

		#Re-flag RAMlog for install, if enabled, ensures AUTO_SETUP_RAMLOG_MAXSIZE gets applied
		if (( $INDEX_LOGGING_TARGET == -1 || $INDEX_LOGGING_TARGET == -2 )); then

			aSOFTWARE_INSTALL_STATE[103]=1

		fi

	}

	FirstRun_DietPi_Update(){

		#Disable powersaving on main screen
		setterm -blank 0 -powersave off 2> /dev/null

		#-1 = 1st run | 0 = Reboot, updates applied | 1 = Idle, No updates
		#Update .update_stage file to completed
		echo 1 > /DietPi/dietpi/.update_stage

		#Check for updates and apply if needed (1=force apply updates).
		/DietPi/dietpi/dietpi-update 1

		#Check update stage file again (dietpi-update will set to 0 if an update was applied and requires a reboot)
		if (( $(</DietPi/dietpi/.update_stage) == 0 )); then

			#Update .update_stage file to completed
			echo 1 > /DietPi/dietpi/.update_stage

			#Prompt user for reboot
			if (( $G_USER_INPUTS )); then

				G_WHIP_MSG 'DietPi has been updated to the latest version.\n\nThe system will now reboot. Once completed, simply login to resume DietPi Setup. \n\nPress Enter to Continue.'

			fi

			#Reboot required NOW
			reboot
			exit

		fi

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Globals
	#/////////////////////////////////////////////////////////////////////////////////////
	Input_Modes(){

		# - Skip menu
		TARGETMENUID=-1

		DISABLE_REBOOT=1

		local input="$@"
		input="${input#*[[:blank:]]}"

		#Install software and exit.
		if [[ $1 == 'install' || $1 == 'reinstall' || $1 == 'uninstall' ]]; then

			G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" "Automated $1"

			# - Make sure we have at least one entry
			if [[ -z $2 ]]; then

				G_DIETPI-NOTIFY 1 'Please enter at least one software index ID or choice system INDEX_*_TARGET=-?'

			else

				# - Uninstall | Stop services prior
				[[ $1 == 'uninstall' ]] && /DietPi/dietpi/dietpi-services stop

				# - Process inputs
				for i in $input
				do

					# - Check if input software ID exists, install state was defined
					if disable_error=1 G_CHECK_VALIDINT $i 0
						disable_error=1 G_CHECK_VALIDINT ${aSOFTWARE_INSTALL_STATE[$i]}; then

						if [[ $1 == 'uninstall' ]]; then

							if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 2 )); then

								aSOFTWARE_INSTALL_STATE[$i]=-1
								G_DIETPI-NOTIFY 0 "Uninstalling ${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}"

							else

								G_DIETPI-NOTIFY 2 "$i: ${aSOFTWARE_WHIP_NAME[$i]} is not currently installed"
								G_DIETPI-NOTIFY 0 "No changes applied for: ${aSOFTWARE_WHIP_NAME[$i]}"

							fi

						elif [[ $1 == 'reinstall' ]]; then

							if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 2 )); then

								# - Flag to be installed
								aSOFTWARE_INSTALL_STATE[$i]=1
								GOSTARTINSTALL=1

								G_DIETPI-NOTIFY 0 "Reinstalling ${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}"
								sleep 1

							else

								G_DIETPI-NOTIFY 2 "$i: ${aSOFTWARE_WHIP_NAME[$i]} is not currently installed"
								G_DIETPI-NOTIFY 2 'The program must be installed, before reinstall can be used'
								G_DIETPI-NOTIFY 0 "No changes applied for: ${aSOFTWARE_WHIP_NAME[$i]}"

							fi

						elif [[ $1 == 'install' ]]; then

							if (( ! ${aSOFTWARE_AVAIL_G_HW_ARCH[$i,$G_HW_ARCH]:=1} )); then

								G_DIETPI-NOTIFY 1 "Software title (${aSOFTWARE_WHIP_NAME[$i]}) is not supported for $G_HW_ARCH_DESCRIPTION."

							elif (( ! ${aSOFTWARE_AVAIL_G_HW_MODEL[$i,$G_HW_MODEL]:=1} )); then

								G_DIETPI-NOTIFY 1 "Software title (${aSOFTWARE_WHIP_NAME[$i]}) is not supported for $G_HW_MODEL_DESCRIPTION."

							elif (( ! ${aSOFTWARE_AVAIL_G_DISTRO[$i,$G_DISTRO]:=1} )); then

								G_DIETPI-NOTIFY 1 "Software title (${aSOFTWARE_WHIP_NAME[$i]}) is not supported for Debian $G_DISTRO_NAME."

							elif (( ${aSOFTWARE_INSTALL_STATE[$i]} != 2 )); then

								aSOFTWARE_INSTALL_STATE[$i]=1
								GOSTARTINSTALL=1

								G_DIETPI-NOTIFY 0 "Installing ${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}"
								sleep 0.5

							else

								G_DIETPI-NOTIFY 2 "$i: ${aSOFTWARE_WHIP_NAME[$i]} is already installed"
								G_DIETPI-NOTIFY 2 "Use \"dietpi-software reinstall $i\", to force rerun of installation and configuration scripts for ${aSOFTWARE_WHIP_NAME[$i]}."
								G_DIETPI-NOTIFY 0 "No changes applied for: ${aSOFTWARE_WHIP_NAME[$i]}"

							fi

						fi

					fi

				done

				# - Reinstall, prompt for backup
				if [[ $1 == 'reinstall' ]]; then

					if (( $GOSTARTINSTALL )); then

						G_PROMPT_BACKUP

					fi

				# - Uninstall | Finish up and clear non-required packages
				elif [[ $1 == 'uninstall' ]]; then

					Uninstall_Software

					#Save
					Write_InstallFileList

					# - Start services
					/DietPi/dietpi/dietpi-services start

				fi

			fi

		#List unique software names and ID's
		elif [[ $1 == 'list' ]]; then

			for i in ${!aSOFTWARE_INSTALL_STATE[@]}
			do

				local string=''

				if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 2 )); then

					string="\e[32mID $i | "

				else

					string="\e[0mID $i | "

				fi

				string+="=${aSOFTWARE_INSTALL_STATE[$i]} | ${aSOFTWARE_WHIP_NAME[$i]}: \e[0m\e[90m${aSOFTWARE_WHIP_DESC[$i]}\e[0m |"

				if (( ${aSOFTWARE_REQUIRES_ALSA[$i]:=0} == 1 )); then

					string+=' +ALSA'

				fi

				if (( ${aSOFTWARE_REQUIRES_XSERVERXORG[$i]:=0} == 1 )); then

					string+=' +XSERVER'

				fi

				if (( ${aSOFTWARE_REQUIRES_DESKTOP[$i]:=0} == 1 )); then

					string+=' +DESKTOP'

				fi

				if (( ${aSOFTWARE_REQUIRES_RSYSLOG[$i]:=0} == 1 )); then

					string+=' +RSYSLOG'

				fi

				if (( ${aSOFTWARE_REQUIRES_FFMPEG[$i]:=0} == 1 )); then

					string+=' +FFMPEG'

				fi

				if (( ${aSOFTWARE_REQUIRES_JAVA_JRE_JDK[$i]:=0} == 1 )); then

					string+=' +ORACLEJAVA'

				fi

				if (( ${aSOFTWARE_REQUIRES_NODEJS[$i]:=0} == 1 )); then

					string+=' +NODEJS'

				fi

				if (( ${aSOFTWARE_REQUIRES_BUILDESSENTIAL[$i]:=0} == 1 )); then

					string+=' +BUILDESSENTIAL'

				fi

				if (( ${aSOFTWARE_REQUIRES_GIT[$i]:=0} == 1 )); then

					string+=' +GIT'

				fi

				if (( ${aSOFTWARE_REQUIRES_WEBSERVER[$i]:=0} == 1 )); then

					string+=' +WEBSERVER'

				fi

				if (( ${aSOFTWARE_REQUIRES_PHP[$i]:=0} == 1 )); then

					string+=' +PHP'

				fi

				if (( ${aSOFTWARE_REQUIRES_MYSQL[$i]:=0} == 1 )); then

					string+=' +MARIADB'

				fi

				if (( ${aSOFTWARE_REQUIRES_SQLITE[$i]:=0} == 1 )); then

					string+=' +SQLITE'

				fi

				# - Available for G_HW_ARCH?
				if (( ! ${aSOFTWARE_AVAIL_G_HW_ARCH[$i,$G_HW_ARCH]:=1} )); then

					string+=" \e[31mDISABLED for $G_HW_ARCH_DESCRIPTION\e[0m"

				# - Available for G_HW_MODEL?
				elif (( ! ${aSOFTWARE_AVAIL_G_HW_MODEL[$i,$G_HW_MODEL]:=1} )); then

					string+=" \e[31mDISABLED for $G_HW_MODEL_DESCRIPTION\e[0m"

				# - Available for G_DISTRO?
				elif (( ! ${aSOFTWARE_AVAIL_G_DISTRO[$i,$G_DISTRO]:=1} )); then

					string+=" \e[31mDISABLED for Debian $G_DISTRO_NAME\e[0m"

				fi

				# - Online docs
				if [[ ${aSOFTWARE_ONLINEDOC_URL[$i]} ]]; then

					string+=" | \e[90m$FP_ONLINEDOC_URL${aSOFTWARE_ONLINEDOC_URL[$i]}\e[0m"

				fi

				#Convert string to lowercase
				echo -e "${string,,}"

			done

		else

			G_DIETPI-NOTIFY 2 "Unknown command $1"

		fi

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Whip menus
	#/////////////////////////////////////////////////////////////////////////////////////
	MENU_MAIN_LASTITEM='Help!'
	TARGETMENUID=0

	Menu_CreateSoftwareList(){

		#software type for this menu
		local input_mode=$1 #-1=search all mode #0=dietpi 1=linux
		local display_software_menu=1 #only used to disable display of CHECKLIST when search finds no results

		#Search Mode
		if (( $input_mode == -1 )); then

			local search_string='' #show all
			display_software_menu=0 #prevent display of CHECKLIST if no results found
			G_WHIP_INPUTBOX 'Please enter a software title/index to search (eg: desktop/cloud/media/torrent)'
			if (( $? == 0 )); then

				G_WHIP_CHECKLIST_ARRAY=()
				local item_found=0
				search_string="$G_WHIP_RETURNED_VALUE"
				for i in ${!aSOFTWARE_INSTALL_STATE[@]}
				do

					if (( ${aSOFTWARE_AVAIL_G_HW_MODEL[$i,$G_HW_MODEL]:=1} && ${aSOFTWARE_AVAIL_G_HW_ARCH[$i,$G_HW_ARCH]:=1} && ${aSOFTWARE_AVAIL_G_DISTRO[$i,$G_DISTRO]:=1} )) &&
						[[ $search_string == $i || ${aSOFTWARE_WHIP_NAME[$i],,} == *${search_string,,}* || ${aSOFTWARE_WHIP_DESC[$i],,} == *${search_string,,}* ]]; then

						local selected='off'
						if (( ${aSOFTWARE_INSTALL_STATE[$i]} > 0 )); then

							selected='on'

							if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

								#Reset to 0. Menu checklists will apply back to 1
								aSOFTWARE_INSTALL_STATE[$i]=0

							fi

						fi

						G_WHIP_CHECKLIST_ARRAY+=($i "${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}" "$selected")
						display_software_menu=1

					fi

				done

				if (( ! $display_software_menu )); then

					G_WHIP_MSG "Search was unable to find any items for '$search_string'"

				fi

			fi

		#Generate Whiptail menu list, of all items in specific software type, based on category
		else

			# - Prewarnings - Linux
			if (( $input_mode == 1 )); then

				#	Inform User that DietPi software will automatically install additional linux software when required.
				if (( ! $USER_LINUX_AUTOINSTALL_PROMPT_DISPLAYED )); then

					G_WHIP_MSG 'DietPi will automatically install additional Linux software on the next screen, when required (eg: Desktop LXDE will install ALSA + Xserver).\n\nThis means you only need to select the software you actually require.'
					USER_LINUX_AUTOINSTALL_PROMPT_DISPLAYED=1

				fi

			fi

			G_WHIP_CHECKLIST_ARRAY=()

			local max_categories=${#aSOFTWARE_CATEGORIES_DIETPI[@]}
			if (( $input_mode == 1 )); then

				max_categories=${#aSOFTWARE_CATEGORIES_LINUX[@]}

			fi

			for ((i=0; i<$max_categories; i++))
			do

				#Only add the category if we have software for it.
				local category_enabled=0

				#Now run through all available software
				for j in ${!aSOFTWARE_CATEGORY_INDEX[@]}
				do

					#Check if this software matches the current category and software type for this menu.
					if (( ${aSOFTWARE_CATEGORY_INDEX[$j]} == $i && ${aSOFTWARE_TYPE[$j]} == $input_mode )); then

						# + is available for hardware?
						# + is available for distro?
						if (( ${aSOFTWARE_AVAIL_G_HW_MODEL[$j,$G_HW_MODEL]:=1} &&
							${aSOFTWARE_AVAIL_G_HW_ARCH[$j,$G_HW_ARCH]:=1} &&
							${aSOFTWARE_AVAIL_G_DISTRO[$j,$G_DISTRO]:=1} )); then

							local selected='off'

							if (( ${aSOFTWARE_INSTALL_STATE[$j]} > 0 )); then

								selected='on'

								if (( ${aSOFTWARE_INSTALL_STATE[$j]} == 1 )); then

									#Reset to 0. Menu checklists will apply back to 1
									aSOFTWARE_INSTALL_STATE[$j]=0

								fi

							fi

							# - Add category
							if (( $category_enabled == 0 )); then

								# - dietpi
								if (( $input_mode == 0 )); then

									G_WHIP_CHECKLIST_ARRAY+=('' "${aSOFTWARE_CATEGORIES_DIETPI[$i]}" 'off')

								# - linux
								elif (( $input_mode == 1 )); then

									G_WHIP_CHECKLIST_ARRAY+=('' "${aSOFTWARE_CATEGORIES_LINUX[$i]}" 'off')

								fi

								category_enabled=1

							fi

							#Add this option to whiptail list
							G_WHIP_CHECKLIST_ARRAY+=($j "${aSOFTWARE_WHIP_NAME[$j]}: ${aSOFTWARE_WHIP_DESC[$j]}" $selected)

						fi

					fi

				done

			done

		fi

		if (( $display_software_menu )); then

			G_WHIP_SIZE_X_MAX=83
			G_WHIP_BUTTON_CANCEL_TEXT='Back'
			G_WHIP_CHECKLIST "Please use the spacebar to select the software you wish to install.\n - Software and usage details: https://dietpi.com/software
 - NB: Pressing 'ESC' or selecting 'Back' will clear all changed selections"

			#Reset Choices made flag
			INSTALL_SOFTWARE_CHOICESMADE=0

			#Check for matching results (selected items)
			for i in ${G_WHIP_RETURNED_VALUE[@]}
			do

				#enable
				if disable_error=1 G_CHECK_VALIDINT $i && (( ${aSOFTWARE_INSTALL_STATE[$i]} == 0 )); then

					INSTALL_SOFTWARE_CHOICESMADE=1
					aSOFTWARE_INSTALL_STATE[$i]=1

				fi

			done

			#-----------------------------------------------------------------------------
			#Install Info/Warnings

			#DietPi-Drive_Manager can be used to setup Samba/NFS shares with ease!
			if (( ${aSOFTWARE_INSTALL_STATE[1]} == 1 || ${aSOFTWARE_INSTALL_STATE[110]} == 1 )); then

				G_WHIP_MSG "NFS/Samba client info:\n\nDietPi-Drive_Manager is a powerful tool which vastly simplifies the mounting of NFS and Samba shares.\n
Once $G_PROGRAM_NAME has finished installation, simply run 'dietpi-drive_manager' to setup required network mounts."

			fi

			#Gogs: Requires OpenSSH for ssh-keygen binary: https://github.com/Fourdee/DietPi/issues/442
			if (( ${aSOFTWARE_INSTALL_STATE[49]} == 1 && $INDEX_SSHSERVER_TARGET != -2 )); then

				G_WHIP_YESNO "Gogs requires OpenSSH server to function.\n\nIf you continue, OpenSSH will be selected for install on your system. OpenSSH will also replace Dropbear (if currently installed).\n
Would you like to continue with the Gogs installation?"
				if (( $? == 0 )); then

					# - Use SSH target index to ensure Dropbear gets removed if installed.
					INDEX_SSHSERVER_TARGET=-2

				else

					aSOFTWARE_INSTALL_STATE[49]=0

				fi

			fi

			#Webserver stacks
			for i in 75 76 78 79 81 82
			do

				#Please let DietPi install them for you...
				if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

					G_WHIP_MSG 'DietPi will automatically install a webserver stack (based on your Webserver Preference) when any software that requires a webserver is selected for installation (eg: ownCloud, Pi-hole etc).\n
It is highly recommended that you allow DietPi to do this for you, ensuring compatibility and stability across DietPi installed programs.\n\nPlease only select a webserver stack if you specifically require it, and, no other webserver stack is installed.\n
TLDR: You do NOT need to select a webserver stack for installation with DietPi. Its all automatic.'
					break

				fi

			done

			#RPiCamInterface - warn user of locking out camera: https://github.com/Fourdee/DietPi/issues/249
			if (( ${aSOFTWARE_INSTALL_STATE[59]} == 1 )); then

				G_WHIP_MSG 'RPi Cam Control Interface will automatically start and activate the camera during boot. This will prevent other programs (eg: raspistill) from using the camera.\n
You can free up the camera by selecting "Stop Camera" from the web interface:\n - http://myip/rpicam'

			fi

			#EmonHUB/EmonPi
			if (( ${aSOFTWARE_INSTALL_STATE[99]} == 1 )); then

				# - Enter API KEY
				# - Grab key from dietpi.txt
				USER_EMONHUB_APIKEY_CURRENT=$(grep -m1 '^[[:blank:]]*SOFTWARE_EMONHUB_APIKEY=' /DietPi/dietpi.txt | sed 's/^.*=//')

				while (( $USER_EMONHUB_APIKEY_COMPLETED == 0 )); do

					G_WHIP_INPUTBOX "EmonHUB/EmonPi:\n\nPlease enter the \"Write API KEY\":\n - Visit http://emoncms.org to register an account and login.
 - Select \"Setup\" from the top right of screen, then select \"My Account\"\n - Enter the \"Write API Key\" into the box below."
					if (( $? == 0 )); then

						USER_EMONHUB_APIKEY_CURRENT=$G_WHIP_RETURNED_VALUE

						G_WHIP_YESNO "The following \"Write API KEY\" will be applied during installation:\n$USER_EMONHUB_APIKEY_CURRENT\n\nIs this key correct?"
						if (( $? == 0 )); then

							# - update dietpi.txt so the value will be applied during installation.
							sed -i "/^[[:blank:]]*SOFTWARE_EMONHUB_APIKEY=/c\SOFTWARE_EMONHUB_APIKEY=$USER_EMONHUB_APIKEY_CURRENT" /DietPi/dietpi.txt

							USER_EMONHUB_APIKEY_COMPLETED=1

						fi

					fi

				done

			fi

			#Pi-hole.
			if (( ${aSOFTWARE_INSTALL_STATE[93]} == 1 )); then

				# - prompt for static ip.
				G_WHIP_YESNO 'A static IP address is essential for Pi-hole installations. DietPi-Config can be used to quickly setup your static IP address.\n
If you have already setup your static IP, please ignore this message.\n\nWould you like to setup your static IP address now?'
				if (( $? == 0 )); then

					G_WHIP_MSG 'DietPi-Config will now be launched. Simply select your Ethernet or Wifi connection from the menu to access the IP address settings.\n
The "copy current address to STATIC" menu option can be used to quickly setup your static IP. Please ensure you change the mode "DHCP" to "STATIC".\n
Once completed, select "Apply Save Changes", then exit DietPi-Config to resume setup.'
					/DietPi/dietpi/dietpi-config 8 1

				fi

			fi

			#Wifi Hotspot Criteria
			if (( ${aSOFTWARE_INSTALL_STATE[60]} == 1 || ${aSOFTWARE_INSTALL_STATE[61]} == 1 )); then

				#Enable wifi modules
				/DietPi/dietpi/func/dietpi-set_hardware wifimodules enable

				while :; do

					local criteria_passed=1
					local output_string='The following criteria must be met, for the installation of WiFi Hotspot to succeed:'

					if ip r | grep -qi "eth$(sed -n 1p /DietPi/dietpi/.network)"; then

						output_string+='\n\n - Ethernet online: PASSED'

					else

						criteria_passed=0
						output_string+='\n\n - Ethernet online: FAILED.\nUse dietpi-config to connect and configure ethernet.'

					fi

					if [[ -d /sys/class/net/wlan$(sed -n 2p /DietPi/dietpi/.network) ]]; then

						output_string+='\n\n - Wifi adapter detected: PASSED'

					else

						criteria_passed=0
						output_string+='\n\n - Wifi adapter detected: FAILED.\nPlease connect a WiFi adapter and try again.'

					fi

					#Passed
					if (( $criteria_passed )); then

						output_string+='\n\nPASSED: Criteria met. Good to go.'
						G_WHIP_MSG "$output_string"
						break

					#Failed, retry?
					else

						output_string+='\n\nFAILED: Criteria not met. Would you like to check again?'
						if ! G_WHIP_YESNO "$output_string"; then

							aSOFTWARE_INSTALL_STATE[60]=0
							aSOFTWARE_INSTALL_STATE[61]=0
							G_WHIP_MSG 'WiFi Hotspot criteria was not met. The software will not be installed.'
							break

						fi

					fi

				done

			fi

			#Weaved
			if (( ${aSOFTWARE_INSTALL_STATE[68]} == 1 )); then

				G_WHIP_MSG 'Remot3.it requires you to create an online account, and, link it this device.\n
Once DietPi has completed your software installations, and rebooted, please follow the First Run tutorial link below:\nhttps://dietpi.com/phpbb/viewtopic.php?f=8&t=5&p=188#p188'

			fi

			#LetsEncrypt
			if (( ${aSOFTWARE_INSTALL_STATE[92]} == 1 )); then

				G_WHIP_MSG 'The DietPi installation of CertBot supports all offered web servers.\n\nOnce the installation has finished, you can setup your free SSL cert with:
 - DietPi-LetsEncrypt\n\nThis is a easy to use frontend for CertBot and allows integration into DietPi systems.\n\nMore information:\n - https://dietpi.com/phpbb/viewtopic.php?f=8&t=5&p=1061#p1062'

			fi

			#dietpi-config can be used to install/configure the following software. Ask user.
			#	NoIp
			if (( ${aSOFTWARE_INSTALL_STATE[67]} == 1 )); then

				G_WHIP_YESNO 'NoIp can be setup and configured by using DietPi-Config. Would you like to complete this now? \n\n- Once finished, exit DietPi-Config to resume setup.\n
 - More information:\nhttps://dietpi.com/phpbb/viewtopic.php?f=8&t=5&start=10#p58'
				if (( $? == 0 )); then

					#Write installed states to temp
					Write_InstallFileList temp

					#Launch DietPi-config
					/DietPi/dietpi/dietpi-config 16 1

					#Read installed states from temp
					Read_InstallFileList temp

				fi

			fi

			#Boot Choices
			if (( ${aSOFTWARE_INSTALL_STATE[23]} == 1 ||
				${aSOFTWARE_INSTALL_STATE[24]} == 1 ||
				${aSOFTWARE_INSTALL_STATE[25]} == 1 ||
				${aSOFTWARE_INSTALL_STATE[26]} == 1 ||
				${aSOFTWARE_INSTALL_STATE[31]} == 1 ||
				${aSOFTWARE_INSTALL_STATE[51]} == 1 ||
				${aSOFTWARE_INSTALL_STATE[108]} == 1 ||
				${aSOFTWARE_INSTALL_STATE[112]} == 1 ||
				${aSOFTWARE_INSTALL_STATE[119]} == 1 ||
				${aSOFTWARE_INSTALL_STATE[155]} == 1 )); then

				# Set Boot Order
				G_WHIP_YESNO 'Would you like to configure the auto boot options for DietPi?\n
This will allow you to choose which program loads automatically, after the system has booted up, eg:\n - Console\n - Desktop\n - Kodi'
				(( $? )) || /DietPi/dietpi/dietpi-autostart

			fi

		fi

	}

	Menu_Main(){

		#Data for storing SSH server index info
		local index_sshserver_text='None'
		if (( $INDEX_SSHSERVER_TARGET == -1 )); then

			index_sshserver_text='Dropbear'

		elif (( $INDEX_SSHSERVER_TARGET == -2 )); then

			index_sshserver_text='OpenSSH'

		fi

		#Data for storing Fileserver index info
		local index_fileserver_text='None'
		if (( $INDEX_FILESERVER_TARGET == -1 )); then

			index_fileserver_text='ProFTP'

		elif (( $INDEX_FILESERVER_TARGET == -2 )); then

			index_fileserver_text='Samba'

		fi

		#Data for storing Logging index info
		local index_logging_text='None'
		if (( $INDEX_LOGGING_TARGET == -1 )); then

			index_logging_text='DietPi-Ramlog #1'

		elif (( $INDEX_LOGGING_TARGET == -2 )); then

			index_logging_text='DietPi-Ramlog #2'

		elif (( $INDEX_LOGGING_TARGET == -3 )); then

			index_logging_text='Full'

		fi

		#Hold our string that tells the user what software will be removed when using Index based choice systems
		local toberemoved_text=''

		#Check status of USB drive
		Check_USB_Drive_Installed

		#Where is userdata stored?
		local user_data_location_current="$(readlink -f $G_FP_DIETPI_USERDATA)"

		local user_data_location_description=''
		if [[ $user_data_location_current == $FP_DIETPI_DEDICATED_USBDRIVE ]]; then

			user_data_location_description="USB Drive | $user_data_location_current"

		elif [[ $user_data_location_current == $G_FP_DIETPI_USERDATA ]]; then

			user_data_location_description="SD/EMMC | $user_data_location_current"

		else

			user_data_location_description="Custom | $user_data_location_current"

		fi

		# - Webserver preference system
		local index_webserver_text='Apache2'
		if (( $INDEX_WEBSERVER_TARGET == -1 )); then

			index_webserver_text='Nginx'

		elif (( $INDEX_WEBSERVER_TARGET == -2 )); then

			index_webserver_text='Lighttpd'

		fi

		G_WHIP_MENU_ARRAY=(

			'Help!' ': Links to online guides, docs and information'
			'DietPi-Config' ': Feature-rich configuration tool for your device'
			'' '●─ Select Software '
			'Search' ': Find a software title for installation'
			'Software Optimized' ': Select DietPi optimized software for installation'
			'Software Additional' ': Select additional Linux software for installation'
			'SSH Server' ": [$index_sshserver_text]"
			'File Server' ": [$index_fileserver_text]"
			'Log System' ": [$index_logging_text]"
			'Webserver Preference' ": [$index_webserver_text]"
			'User Data Location' ": [$user_data_location_description]"
			'' '●─ Install or Remove Software '
			'Uninstall' ': Select installed software for removal'
			'Install' ': Go >> Start installation for selected software'

		)

		G_WHIP_DEFAULT_ITEM="$MENU_MAIN_LASTITEM"
		G_WHIP_BUTTON_CANCEL_TEXT='Exit'
		G_WHIP_SIZE_X_MAX=80

		if G_WHIP_MENU; then

			MENU_MAIN_LASTITEM="$G_WHIP_RETURNED_VALUE"

			case "$G_WHIP_RETURNED_VALUE" in

				'Uninstall')

					TARGETMENUID=3

				;;

				'Search')

					Menu_CreateSoftwareList -1

				;;

				'Software Optimized')

					TARGETMENUID=1

				;;

				'Software Additional'*)

					TARGETMENUID=2

				;;

				'SSH Server')

					G_WHIP_MENU_ARRAY=(

						'None' ': Not required / manual setup.'
						'Dropbear' ': Lightweight SSH Server (Recommended).'
						'OpenSSH' ': Feature Rich SSH Server with SFTP/SCP support.'

					)

					G_WHIP_DEFAULT_ITEM="$index_sshserver_text"
					G_WHIP_BUTTON_CANCEL_TEXT='Back'
					G_WHIP_MENU 'Please select desired SSH server:\n
- None: Selecting this option will uninstall all SSH servers. This reduces system resources and improves performance. Useful for users who do NOT require networked/remote terminal access.\n
- Dropbear (Recommended): Lightweight SSH server, installed by default on DietPi systems.\n
- OpenSSH: A feature rich SSH server with SFTP/SCP support, at the cost of increased resource usage.'
					if (( $? == 0 )); then

						# - Assign target index
						if [[ $G_WHIP_RETURNED_VALUE == 'None' ]]; then

							INDEX_SSHSERVER_TARGET=0
							toberemoved_text='Dropbear and OpenSSH Server'

						elif [[ $G_WHIP_RETURNED_VALUE == 'Dropbear' ]]; then

							INDEX_SSHSERVER_TARGET=-1
							toberemoved_text='OpenSSH Server'

						elif [[ $G_WHIP_RETURNED_VALUE == 'OpenSSH' ]]; then

							INDEX_SSHSERVER_TARGET=-2
							toberemoved_text='Dropbear'

						# - Reset to current
						else

							INDEX_SSHSERVER_TARGET=$INDEX_SSHSERVER_CURRENT

						fi

					fi

					#Check for changes
					INSTALL_SSHSERVER_CHOICESMADE=0
					if (( $INDEX_SSHSERVER_TARGET != $INDEX_SSHSERVER_CURRENT )); then

						INSTALL_SSHSERVER_CHOICESMADE=1

						G_WHIP_MSG "$G_WHIP_RETURNED_VALUE has been selected:\n- Your choice will be applied when 'Install Go >> Start installation' is selected.\n- $toberemoved_text installations will be automatically uninstalled."

					fi

				;;

				'File Server')

					G_WHIP_MENU_ARRAY=(

						'None' ': Not required / manual setup.'
						'ProFTP' ': Efficient, lightweight fileserver (recommended).'
						'Samba' ': Feature-rich fileserver.'

					)

					G_WHIP_DEFAULT_ITEM="$index_fileserver_text"
					G_WHIP_BUTTON_CANCEL_TEXT='Back'
					G_WHIP_MENU 'Please select desired fileserver:\n
- None: Select this option if you do NOT require a method of accessing files and folders on this device, over a network.\n
- ProFTP (Recommended for RPi v1): Allows you to access/share files on this device efficiently with minimal cpu usage. Uses FTP protocol.\n
- Samba (Recommended for RPi v2): Allows you to easily access/share files on this device, at the cost of higher cpu usage.\n\nMore info: https://dietpi.com/phpbb/viewtopic.php?f=8&t=15#p19'
					if (( $? == 0 )); then

						# - Assign target index
						if [[ $G_WHIP_RETURNED_VALUE == 'None' ]]; then

							INDEX_FILESERVER_TARGET=0
							toberemoved_text='ProFTP and Samba Server'

						elif [[ $G_WHIP_RETURNED_VALUE == 'ProFTP' ]]; then

							INDEX_FILESERVER_TARGET=-1
							toberemoved_text='Samba Server'

						elif [[ $G_WHIP_RETURNED_VALUE == 'Samba' ]]; then

							INDEX_FILESERVER_TARGET=-2
							toberemoved_text='ProFTP'

						# - Reset to current
						else

							INDEX_FILESERVER_TARGET=$INDEX_FILESERVER_CURRENT

						fi

					fi

					#Check for changes
					INSTALL_FILESERVER_CHOICESMADE=0
					if (( $INDEX_FILESERVER_TARGET != $INDEX_FILESERVER_CURRENT )); then

						INSTALL_FILESERVER_CHOICESMADE=1

						G_WHIP_MSG "$G_WHIP_RETURNED_VALUE has been selected:\n- Your choice will be applied when 'Install Go >> Start installation' is selected.\n- $toberemoved_text installations will be automatically uninstalled."

					fi

				;;

				'Log System')

					G_WHIP_MENU_ARRAY=(

						'None' ': Not required / manual setup.'
						'DietPi-Ramlog #1' ': Hourly clear (recommended).'
						'DietPi-Ramlog #2' ': Hourly save, then clear.'
						'Full' ': Logrotate and Rsyslog.'

					)

					G_WHIP_DEFAULT_ITEM="$index_logging_text"
					G_WHIP_BUTTON_CANCEL_TEXT='Back'
					G_WHIP_MENU 'Please select desired logging system:\n
- None: Selecting this option will uninstall DietPi-Ramlog, Logrotate, Rsyslog.\n
- DietPi-Ramlog #1 (Max performance): Mounts /var/log to RAM, reducing filesystem IO. Logfiles are cleared every hour. Does NOT save logfiles to disk.\n
- DietPi-Ramlog #2: Same as #1, with the added feature of saving logfile contents to disk (/root/logfile_storage/*), before being cleared.\n
- Full (Reduces performance): Mounts /var/log to DISK, reduces SDcard lifespan. Full logging system with Logrotate and Rsyslog.'
					if (( $? == 0 )); then

						# - Assign target index
						if [[ $G_WHIP_RETURNED_VALUE == 'None' ]]; then

							INDEX_LOGGING_TARGET=0
							toberemoved_text='DietPi-Ramlog, Logrotate, Rsyslog'

						elif [[ $G_WHIP_RETURNED_VALUE == 'DietPi-Ramlog #1' ]]; then

							INDEX_LOGGING_TARGET=-1
							toberemoved_text='Logrotate, Rsyslog'

						elif [[ $G_WHIP_RETURNED_VALUE == 'DietPi-Ramlog #2' ]]; then

							INDEX_LOGGING_TARGET=-2
							toberemoved_text='Logrotate, Rsyslog'

						elif [[ $G_WHIP_RETURNED_VALUE == 'Full' ]]; then

							INDEX_LOGGING_TARGET=-3
							toberemoved_text='DietPi-Ramlog'

						# - Reset to current
						else

							INDEX_LOGGING_TARGET=$INDEX_LOGGING_CURRENT

						fi

					fi

					#Check for changes
					INSTALL_LOGGING_CHOICESMADE=0
					if (( $INDEX_LOGGING_TARGET != $INDEX_LOGGING_CURRENT )); then

						INSTALL_LOGGING_CHOICESMADE=1

						G_WHIP_MSG "$G_WHIP_RETURNED_VALUE has been selected:\n - Your choice will be applied when 'Install Go >> Start installation' is selected.\n - $toberemoved_text installations will be automatically uninstalled."

					fi

				;;

				'User Data Location')

					# - Vars if we need to move data.
					local move_data_target=$user_data_location_current

					G_WHIP_MENU_ARRAY=(

						'List' ': Select from a list of available drive mounts, to move user data.'
						'Custom' ': Input a manual location to move user data.'
						'Drive' ': Launches DietPi Drive Manager.'

					)

					G_WHIP_BUTTON_CANCEL_TEXT='Back'
					G_WHIP_MENU 'Choose where to store your user data. User data includes software such as Owncloud data store, BitTorrent downloads etc.\n
More information on user data in DietPi:\n- https://dietpi.com/phpbb/viewtopic.php?f=8&t=478&p=2087\n\n- DietPi-Drive Manager: Launch DietPi-Drive Manager to setup external drives, and, move user data to different locations.'
					if (( $? == 0 )); then

						# - DriveMan
						if [[ $G_WHIP_RETURNED_VALUE == 'Drive' ]]; then

							/DietPi/dietpi/dietpi-drive_manager

						# - List
						elif [[ $G_WHIP_RETURNED_VALUE == 'List' ]]; then

							/DietPi/dietpi/dietpi-drive_manager 1

							local return_value="$(</tmp/dietpi-drive_manager_selmnt)"
							if [[ $return_value ]]; then

								if [[ $return_value == '/' ]]; then

									return_value='/mnt'

								fi

								move_data_target="$return_value"
								move_data_target+='/dietpi_userdata'

							fi

						# - Manual filepath entry
						elif [[ $G_WHIP_RETURNED_VALUE == 'Custom' ]]; then

							if G_WHIP_INPUTBOX 'Please input a location. Your user data will be stored inside this location.\n - eg: /mnt/MyDrive/MyData'; then

								move_data_target="$G_WHIP_RETURNED_VALUE"

							fi

						fi

						# - Move data if the new entry has changed
						if [[ $user_data_location_current != $move_data_target ]]; then

							# - Ask before we begin
							G_WHIP_YESNO "DietPi will now attempt to transfer your existing user data to the new location:\n\n- From: $user_data_location_current\n- To: $move_data_target\n\nWould you like to begin?"
							if (( $? == 0 )); then

								# - Move data, setup symlinks
								if /DietPi/dietpi/func/dietpi-set_userdata "$user_data_location_current" "$move_data_target"; then

									G_WHIP_MSG "User data transfer: Completed\n\nYour user data has been successfully moved:\n\n- From: $user_data_location_current\n- To: $move_data_target"

								else

									G_WHIP_MSG "User data transfer: Failed\n\n$(cat /var/log/dietpi-move_userdata.log)\n\nNo changes have been applied."

								fi

							fi

						fi

					fi

				;;

				'Webserver Preference')

					G_WHIP_MENU_ARRAY=(

						'Apache2' ': Popular webserver.'
						'Nginx' ': Lightweight webserver.'
						'Lighttpd' ': Extremely lightweight webserver.'

					)

					G_WHIP_DEFAULT_ITEM="$index_webserver_text"
					G_WHIP_BUTTON_CANCEL_TEXT='Back'
					G_WHIP_MENU 'Please select a Webserver preference, more info https://dietpi.com/phpbb/viewtopic.php?f=8&t=5&p=1549#p1549:\n
- Apache2: Feature-rich and popular. Recommended for beginners and users who are looking to follow Apache2 based guides.\n
- Nginx: Lightweight alternative to Apache2. Nginx claims faster webserver performance compared to Apache2.\n
- Lighttpd: Extremely lightweight and is generally considered to offer the \"best\" webserver performance for SBCs. Recommended for users who expect low webserver traffic.'
					if (( $? == 0 )); then

						#Assign target index
						if [[ $G_WHIP_RETURNED_VALUE == 'Apache2' ]]; then

							INDEX_WEBSERVER_TARGET=0

						elif [[ $G_WHIP_RETURNED_VALUE == 'Nginx' ]]; then

							INDEX_WEBSERVER_TARGET=-1

						elif [[ $G_WHIP_RETURNED_VALUE == 'Lighttpd' ]]; then

							INDEX_WEBSERVER_TARGET=-2

						#Reset to current
						else

							INDEX_WEBSERVER_TARGET=$INDEX_WEBSERVER_CURRENT

						fi

						#Check for changes
						if (( $INDEX_WEBSERVER_TARGET != $INDEX_WEBSERVER_CURRENT )); then

							# - Check for existing and compatible installed stacks before allowing the change
							local incompatible_webserver_preference=0
							local info_currently_installed_webserver='None'

							if dpkg-query -s 'apache2' &> /dev/null; then

								INDEX_WEBSERVER_CURRENT=0
								info_currently_installed_webserver='Apache2'
								(( $INDEX_WEBSERVER_TARGET != 0 )) && incompatible_webserver_preference=1

							elif dpkg-query -s 'nginx' &> /dev/null; then

								INDEX_WEBSERVER_CURRENT=-1
								info_currently_installed_webserver='Nginx'
								(( $INDEX_WEBSERVER_TARGET != -1 )) && incompatible_webserver_preference=1

							elif dpkg-query -s 'lighttpd' &> /dev/null; then

								INDEX_WEBSERVER_CURRENT=-2
								info_currently_installed_webserver='Lighttpd'
								(( $INDEX_WEBSERVER_TARGET != -2 )) && incompatible_webserver_preference=1

							fi

							# - Reset preference selection
							if (( $incompatible_webserver_preference == 1 )); then

								INDEX_WEBSERVER_TARGET=$INDEX_WEBSERVER_CURRENT

								# - inform user
								G_WHIP_MSG "Error: Incompatible Webserver Preference:\n\nUnable to change your webserver preference to $G_WHIP_RETURNED_VALUE.\n
This is due to an existing and incompatible webserver installation on your system ($info_currently_installed_webserver). Please remove all webserver based software (using dietpi-software > uninstall), before trying again."


							# - Apply preference selection
							else

								# - Inform user
								G_WHIP_MSG "Webserver Preference Changed:\n\n$G_WHIP_RETURNED_VALUE has been selected as your webserver preference.\n
When you select any software for install that requires a webserver, DietPi will automatically install your prefered choice ($G_WHIP_RETURNED_VALUE)."
								# - NB: INDEX_WEBSERVER_CURRENT=$INDEX_WEBSERVER_TARGET | is applied during installation with func Apply_Webserver_Preference().

							fi

						fi

					fi

				;;

				'DietPi-Config')

					/DietPi/dietpi/dietpi-config

				;;

				'Help!')

					#Populate help to text file so we can read it back to whiptail, as a scrollbox.
					local string=''
					string+='───────────────────────────────────────────────────────────────\n'
					string+='Welcome to DietPi:\n'
					string+='───────────────────────────────────────────────────────────────\n'
					string+='Use PageUp/Down or Arrow Up/Down to scroll this help screen.\n'
					string+='Press ESC, or TAB then enter to exit this help screen.\n'
					string+='\n'
					string+='Easy to follow, step by step guides for installing DietPi:\n'
					string+='https://dietpi.com/phpbb/viewtopic.php?f=8&t=9\n'
					string+='\n'
					string+='For a list of all installation options and their details:\n'
					string+='https://dietpi.com/software\n'
					string+='\n'
					string+='───────────────────────────────────────────────────────────────\n'
					string+='List of installed software and their URL links for online docs:\n'
					string+='───────────────────────────────────────────────────────────────\n'

					# - Installed software
					for i in ${!aSOFTWARE_INSTALL_STATE[@]}
					do

						if (( ${aSOFTWARE_INSTALL_STATE[i]} > 0 )) && [[ ${aSOFTWARE_ONLINEDOC_URL[$i]} ]]; then

							string+="\n${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_NAME[$i]}"
							string+="\n$FP_ONLINEDOC_URL${aSOFTWARE_ONLINEDOC_URL[$i]}\n"

						fi

					done

					G_WHIP_SIZE_X_MAX=70
					G_WHIP_SCROLLBOX "$string"
					unset string

				;;

				'Install')

					Menu_StartInstall

				;;

			esac

		#Exit/Abort Setup
		else

			Menu_Exit

		fi

	}

	Menu_Exit(){

		#1st run install
		if (( $G_DIETPI_INSTALL_STAGE == 0 )); then

			G_WHIP_YESNO 'DietPi has not fully been installed.\nThis must be completed prior to using DietPi by selecting:\n - Go Start Install.\n\nWould you like to exit and abort the installation?'
			if (( $? == 0 )); then

				Banner_Aborted
				#Exit script NOW
				exit

			else

				#Return to Main Menu
				TARGETMENUID=0

			fi

		#Standard exit
		elif (( $G_DIETPI_INSTALL_STAGE == 1 )); then

			if G_WHIP_YESNO 'Do you wish to exit DietPi-Software?\n\nAll changes to software selections will be cleared.'; then

				Banner_Aborted
				#Exit script NOW
				exit

			else

				#Return to Main Menu
				TARGETMENUID=0

			fi

		fi

	}

	Menu_ConfirmInstall(){

		#Obtain list of pending software installation:
		local string_output=''
		for i in ${!aSOFTWARE_INSTALL_STATE[@]}
		do

			if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				string_output+="\n - ${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}"

			fi

		done

		#Confirm Software install
		G_WHIP_YESNO "DietPi is now ready to install your software choices: $string_output\n
Software details, usernames, passwords etc:\n - https://dietpi.com/software\n
NB: Software services will be temporarily controlled (stopped) by DietPi during this process. Please inform connected users, before continuing. SSH is not affected.\n
Would you like to begin?"
		if (( $? == 0 )); then

			#exit menu system
			TARGETMENUID=-1

			#Enable installation start flag
			GOSTARTINSTALL=1

		else

			#Return to Main Menu
			TARGETMENUID=0

		fi

	}

	Menu_StartInstall(){

		#Check if the user has made changes to their software selections.
		if (( $INSTALL_SOFTWARE_CHOICESMADE ||
			$INSTALL_SSHSERVER_CHOICESMADE ||
			$INSTALL_FILESERVER_CHOICESMADE ||
			$INSTALL_LOGGING_CHOICESMADE )); then

			# Confirm install with user
			Menu_ConfirmInstall

		else

			#1st run install
			if (( $G_DIETPI_INSTALL_STAGE == 0 )); then

				G_WHIP_YESNO 'DietPi was unable to detect any additional software selections for install.\n
NB: You can use dietpi-software at a later date, to install optimized software from our catalogue as required.\n\nDo you wish to continue with DietPi as a pure minimal image?'
				if (( $? == 0 )); then

					#exit menu system
					TARGETMENUID=-1

					#Enable installation start flag
					GOSTARTINSTALL=1

				else

					#Return to Main Menu
					TARGETMENUID=0

				fi

			#Not 1st run
			elif (( $G_DIETPI_INSTALL_STAGE == 1 )); then

				G_WHIP_MSG 'No changes have been detected. Unable to start installation.'

			fi

		fi

	}

	#TARGETMENUID=1
	Menu_Dietpi_Software(){

		#Generate Whiptail menu and store results into our software arrays
		Menu_CreateSoftwareList 0

		#Return to Main Menu
		TARGETMENUID=0

	}

	#TARGETMENUID=2
	Menu_Linux_Software(){

		#Generate Whiptail menu and store results into our software arrays
		Menu_CreateSoftwareList 1

		#Return to Main Menu
		TARGETMENUID=0

	}

	#TARGETMENUID=3
	Menu_Uninstall_Software(){

		#Return to main menu
		TARGETMENUID=0

		#Array which will hold all software IDs to be removed.
		G_WHIP_CHECKLIST_ARRAY=()

		#Obtain list of installed software
		local software_available_for_uninstall=0
		for i in ${!aSOFTWARE_INSTALL_STATE[@]}
		do

			if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 2 &&
				${aSOFTWARE_TYPE[$i]:=-2} >= -1 )); then

				G_WHIP_CHECKLIST_ARRAY+=($i "${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}" 'off')
				software_available_for_uninstall=1

			fi

		done

		#No software installed
		if (( ! $software_available_for_uninstall )); then

			G_WHIP_MSG 'No software is currently installed, or, available for removal.'

		#Run menu
		else

			G_WHIP_BUTTON_CANCEL_TEXT='Back'
			if G_WHIP_CHECKLIST 'Use the spacebar to select the software you would like to remove.'; then

				# - Create list for user to review before removal
				local output_string='The following software will be REMOVED from your system:\n'
				for i in ${G_WHIP_RETURNED_VALUE[@]}
				do

					output_string+=" - ${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}\n"
					UNINSTALL_REQUIRED=1

				done

				if (( $UNINSTALL_REQUIRED )); then

					G_WHIP_YESNO "$output_string \n\nNB: Software services will be temporarily controlled (stopped) by DietPi during this process. Please inform connected users, before continuing. SSH is not affected.\n\nDo you wish to continue?"
					if (( $? == 0 )); then

						# - stop services
						/DietPi/dietpi/dietpi-services stop

						# - Run uninstall
						for i in ${G_WHIP_RETURNED_VALUE[@]}
						do

							aSOFTWARE_INSTALL_STATE[$i]=-1

						done
						Uninstall_Software

						#Save
						Write_InstallFileList

						# - start services
						/DietPi/dietpi/dietpi-services start

						G_WHIP_MSG 'Uninstall completed.'

					else

						UNINSTALL_REQUIRED=0

					fi

				fi

			fi

		fi

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Banner Print
	#/////////////////////////////////////////////////////////////////////////////////////

	Banner_Installing(){

		G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" "Installing ${aSOFTWARE_WHIP_NAME[$software_id]}: ${aSOFTWARE_WHIP_DESC[$software_id]}"

	}

	Banner_Configuration(){

		G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" "Configuring ${aSOFTWARE_WHIP_NAME[$software_id]}: ${aSOFTWARE_WHIP_DESC[$software_id]}"

	}

	Banner_Uninstalling(){

		G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" "Uninstalling ${aSOFTWARE_WHIP_NAME[$software_id]}: ${aSOFTWARE_WHIP_DESC[$software_id]}"

	}

	Banner_Apt_Update(){

		G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" 'Update & upgrade APT'

	}

	Banner_Reboot(){

		local delay=3
		G_WHIP_MSG 'DietPi-Software installation is completed, however a reboot is required to finalise the installation.\n\nPlease select "Ok" to continue and reboot the system.'
		G_DIETPI-NOTIFY 0 "System rebooting in $delay seconds to finalise the DietPi-Software installations. Please wait..."
		sleep $delay

	}

	Banner_Configs(){

		G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" 'Optimize and configure software'
		G_DIETPI-NOTIFY 2 "Applying DietPi optimizations and configurations for $G_HW_MODEL_DESCRIPTION, please wait...\n"

	}

	Banner_Aborted(){

		#1st run abort
		if (( $G_DIETPI_INSTALL_STAGE == 0 )); then

			/DietPi/dietpi/func/dietpi-banner 0
			G_DIETPI-NOTIFY 1 '\n Installation aborted by user.\n Installation must be completed prior to using DietPi.\n Please run dietpi-software to restart the installation.\n'

		#Standard abort
		else

			/DietPi/dietpi/func/dietpi-banner 1

		fi

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#--------------------------------------------------------------------------------------
	#Init software arrays
	Software_Arrays_Init
	#--------------------------------------------------------------------------------------
	#load .installed file, update vars, if it exists
	Read_InstallFileList
	#--------------------------------------------------------------------------------------
	#Update GLOBAL_PW
	Update_Global_Pw
	#--------------------------------------------------------------------------------------
	# - CLi input mode
	if [[ $1 ]]; then

		# - Run input mode
		Input_Modes "$@"

	#--------------------------------------------------------------------------------------
	#Standard launch
	else

		#Pre-first run (no network)
		if (( $G_DIETPI_INSTALL_STAGE == 0 )); then

			# - Load all automation vars
			FirstRun_Automation_Init

			# - GPL compliance prompt
			G_WHIP_MSG 'DietPi - GPLv2 License:\n
This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 2 of the License, or any later version.\n
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.\n
You should have received a copy of the GNU General Public License along with this program.  If not, see http://www.gnu.org/licenses/'

			#	NB: This should be after 1st run update, however, to prevent dupe run of this without requiring an image update, we can do it here.
			if (( $(</DietPi/dietpi/.update_stage) == -1 )); then

				# - Global PW
				#	Automation, apply as per dietpi.txt
				if (( $AUTOINSTALL_ENABLED )); then

					/DietPi/dietpi/func/dietpi-set_software passwords "$GLOBAL_PW"

				#	Prompt change global password and login passwords for root and dietpi users
				else

					/DietPi/dietpi/func/dietpi-set_software passwords
					Update_Global_Pw

				fi

				# - Disable serial?
				#	must be enabled for the following:
				#	XU4: https://github.com/Fourdee/DietPi/issues/2038#issuecomment-416089875
				#	RockPro64: Fails to boot into kernel without serial enabled
				#	NanoPi Neo Air: Required for end users/debugging/setting up WiFi without automation
				if (( $(grep -m1 '^[[:blank:]]*CONFIG_SERIAL_CONSOLE_ENABLE=' /DietPi/dietpi.txt | sed 's/^.*=//') == 1 &&
					$G_HW_MODEL != 11 && $G_HW_MODEL != 42 && $G_HW_MODEL != 64 )); then

					if G_WHIP_YESNO 'Serial console is currently enabled, would you like to disable it?\n - Disabling serial console will reduce memory consumption slightly\n - If you are unsure on what serial console is, it is safe to disable it'; then

						/DietPi/dietpi/func/dietpi-set_hardware serialconsole disable

					fi

				fi

			fi

		fi

		# Prevent continue if no Network or NTPD is not completed: https://github.com/Fourdee/DietPi/issues/786
		Check_Internet_and_NTPD

		# - 1st run DietPi updates
		if (( $(</DietPi/dietpi/.update_stage) == -1 )); then

			FirstRun_DietPi_Update

		fi

		# - Apply 1st run automation
		if (( $G_DIETPI_INSTALL_STAGE == 0 )); then

			# - Activate automation settings from dietpi.txt, if set.
			FirstRun_Automation_Set

		fi

		# Start DietPi Menu
		while (( $TARGETMENUID > -1 )); do

			printf '\ec' # clear current terminal screen

			if (( $TARGETMENUID == 0 )); then

				Menu_Main

			elif (( $TARGETMENUID == 1 )); then

				Menu_Dietpi_Software

			elif (( $TARGETMENUID == 2 )); then

				Menu_Linux_Software

			elif (( $TARGETMENUID == 3 )); then

				Menu_Uninstall_Software

			fi

		done

	fi

	#--------------------------------------------------------------------------------------
	# Start DietPi-Software installs
	# - Check for at least 500M free space available
	if (( $GOSTARTINSTALL )) && G_CHECK_FREESPACE / 500; then

		# Userdata location verify
		G_CHECK_USERDATA

		# Start installations for software
		Run_Installations

		# Unmask systemd-logind if set in dietpi.txt / libpam-systemd was installed / Kodi
		if [[ $(readlink /etc/systemd/system/systemd-logind.service) == '/dev/null' ]] &&
			( grep -q '^[[:blank:]]*AUTO_UNMASK_LOGIND=1' /DietPi/dietpi.txt ||
			dpkg-query -s 'libpam-systemd' &> /dev/null ||
			(( ${aSOFTWARE_INSTALL_STATE[31]} > 0 )) ); then

			G_RUN_CMD systemctl unmask systemd-logind
			# systemd-logind is currently a static unit, but to be failsafe:
			systemctl enable systemd-logind &> /dev/null
			systemctl start systemd-logind &> /dev/null

		fi

		# Upload DietPi-Survey Data, if opted in, prompt user choice, if no settings file exists
		/DietPi/dietpi/dietpi-survey 1

		G_DIETPI-NOTIFY 3 "$G_PROGRAM_NAME" 'Installation completed'

		if (( $DISABLE_REBOOT )); then

			# - Start services (restart to reload webserver confs)
			/DietPi/dietpi/dietpi-services restart

		else

			# - Reboot
			sync
			Banner_Reboot
			reboot

		fi

	fi

}
